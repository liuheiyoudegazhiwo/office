"use strict";
Object.defineProperties(exports, { __esModule: { value: true }, [Symbol.toStringTag]: { value: "Module" } });
const Vue = require("vue");
const TUIChatEngine = require("@tencentcloud/chat-uikit-engine");
const universalApi = require("@tencentcloud/universal-api");
require("../../../../adapter-vue.js");
const env = require("../../../../utils/env.js");
const index = require("../toolbar-item-container/index.vue.js");
const imageLight = require("../../../../assets/icon/image-light.svg.js");
const imageDark = require("../../../../assets/icon/image-dark.svg.js");
const imageUni = require("../../../../assets/icon/image-uni.png.js");
const cameraUni = require("../../../../assets/icon/camera-uni.png.js");
const utils = require("../../utils/utils.js");
const index$1 = require("../../offlinePushInfoManager/index.js");
const config = require("../../config.js");
const _sfc_main = /* @__PURE__ */ Vue.defineComponent({
  __name: "index",
  props: {
    // Image source: only valid for uni-app version, web version only supports selecting images from the album.
    // album: Select from album
    // camera: Take a photo using the camera
    imageSourceType: {
      type: String,
      default: "album"
    }
  },
  setup(__props) {
    const props = __props;
    const inputRef = Vue.ref();
    const currentConversation = Vue.ref();
    const theme = config.default.getTheme();
    const IMAGE_TOOLBAR_SHOW_MAP = {
      web_album: {
        icon: theme === "dark" ? imageDark.default : imageLight.default,
        title: "图片"
      },
      uni_album: {
        icon: imageUni.default,
        title: "图片"
      },
      uni_camera: {
        icon: cameraUni.default,
        title: "拍照"
      }
    };
    TUIChatEngine.TUIStore.watch(TUIChatEngine.StoreName.CONV, {
      currentConversation: (conversation) => {
        currentConversation.value = conversation;
      }
    });
    const imageToolbarForShow = Vue.computed(() => {
      if (env.isUniFrameWork) {
        return props.imageSourceType === "camera" ? IMAGE_TOOLBAR_SHOW_MAP["uni_camera"] : IMAGE_TOOLBAR_SHOW_MAP["uni_album"];
      } else {
        return IMAGE_TOOLBAR_SHOW_MAP["web_album"];
      }
    });
    const onIconClick = () => {
      var _a, _b, _c, _d;
      if (env.isUniFrameWork) {
        if (env.isWeChat && ((_a = universalApi.TUIGlobal) == null ? void 0 : _a.chooseMedia)) {
          (_b = universalApi.TUIGlobal) == null ? void 0 : _b.chooseMedia({
            count: 1,
            mediaType: ["image"],
            sizeType: ["original", "compressed"],
            sourceType: [props.imageSourceType],
            // Use camera or select from album.
            success: function(res) {
              sendImageMessage(res);
            }
          });
        } else {
          (_c = universalApi.TUIGlobal) == null ? void 0 : _c.chooseImage({
            count: 1,
            sourceType: [props.imageSourceType],
            // Use camera or select from album.
            success: function(res) {
              sendImageMessage(res);
            }
          });
        }
      } else {
        if ((_d = inputRef.value) == null ? void 0 : _d.click) {
          inputRef.value.click();
        }
      }
    };
    const sendImageInWeb = (e) => {
      var _a, _b;
      if (((_b = (_a = e == null ? void 0 : e.target) == null ? void 0 : _a.files) == null ? void 0 : _b.length) <= 0) {
        return;
      }
      sendImageMessage(e == null ? void 0 : e.target);
      e.target.value = "";
    };
    const sendImageMessage = (files) => {
      var _a, _b, _c, _d, _e;
      if (!files) {
        return;
      }
      const options = {
        to: ((_b = (_a = currentConversation == null ? void 0 : currentConversation.value) == null ? void 0 : _a.groupProfile) == null ? void 0 : _b.groupID) || ((_d = (_c = currentConversation == null ? void 0 : currentConversation.value) == null ? void 0 : _c.userProfile) == null ? void 0 : _d.userID),
        conversationType: (_e = currentConversation == null ? void 0 : currentConversation.value) == null ? void 0 : _e.type,
        payload: {
          file: files
        },
        needReadReceipt: utils.isEnabledMessageReadReceiptGlobal()
      };
      const offlinePushInfoCreateParams = {
        conversation: currentConversation.value,
        payload: options.payload,
        messageType: TUIChatEngine.TYPES.MSG_IMAGE
      };
      const sendMessageOptions = {
        offlinePushInfo: index$1.default.create(offlinePushInfoCreateParams)
      };
      TUIChatEngine.TUIChatService.sendImageMessage(options, sendMessageOptions);
    };
    return (_ctx, _cache) => {
      return Vue.openBlock(), Vue.createBlock(index.default, {
        iconFile: Vue.unref(imageToolbarForShow).icon,
        title: Vue.unref(imageToolbarForShow).title,
        iconWidth: Vue.unref(env.isUniFrameWork) ? "32px" : "20px",
        iconHeight: Vue.unref(env.isUniFrameWork) ? "25px" : "18px",
        needDialog: false,
        onOnIconClick: onIconClick
      }, {
        default: Vue.withCtx(() => [
          !Vue.unref(env.isUniFrameWork) ? (Vue.openBlock(), Vue.createElementBlock("div", {
            key: 0,
            class: Vue.normalizeClass(["image-upload", !Vue.unref(env.isPC) && "image-upload-h5"])
          }, [
            Vue.createElementVNode("input", {
              ref_key: "inputRef",
              ref: inputRef,
              title: "图片",
              type: "file",
              "data-type": "image",
              accept: "image/gif,image/jpeg,image/jpg,image/png,image/bmp,image/webp",
              onChange: sendImageInWeb
            }, null, 544)
          ], 2)) : Vue.createCommentVNode("", true)
        ]),
        _: 1
      }, 8, ["iconFile", "title", "iconWidth", "iconHeight"]);
    };
  }
});
exports.default = _sfc_main;
