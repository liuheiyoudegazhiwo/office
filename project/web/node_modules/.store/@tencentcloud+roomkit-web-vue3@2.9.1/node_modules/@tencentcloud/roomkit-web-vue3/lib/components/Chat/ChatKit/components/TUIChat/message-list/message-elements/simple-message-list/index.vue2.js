"use strict";
Object.defineProperties(exports, { __esModule: { value: true }, [Symbol.toStringTag]: { value: "Module" } });
const Vue = require("vue");
require("../../../../../adapter-vue.js");
const TUIChatEngine = require("@tencentcloud/chat-uikit-engine");
const back = require("../../../../../assets/icon/back.svg.js");
const videoPlay = require("../../../../../assets/icon/video-play.png.js");
const Icon = require("../../../../common/Icon.vue.js");
const messageContainer = require("./message-container.vue.js");
const index$1 = require("../message-record/index.vue.js");
const index = require("../../../emoji-config/index.js");
const env = require("../../../../../utils/env.js");
const customEmoji = require("../../../emoji-config/custom-emoji.js");
const defaultEmoji = require("../../../emoji-config/default-emoji.js");
const _hoisted_1 = { class: "header-container" };
const _hoisted_2 = { key: 0 };
const _hoisted_3 = { key: 1 };
const _hoisted_4 = { class: "title" };
const _hoisted_5 = { key: 0 };
const _hoisted_6 = {
  key: 0,
  class: "message-text"
};
const _hoisted_7 = {
  key: 0,
  class: "text"
};
const _hoisted_8 = ["src"];
const _hoisted_9 = {
  key: 1,
  class: "message-image"
};
const _hoisted_10 = ["src"];
const _hoisted_11 = {
  key: 2,
  class: "message-video"
};
const _hoisted_12 = ["onClick"];
const _hoisted_13 = ["src"];
const _hoisted_14 = ["poster"];
const _hoisted_15 = ["src"];
const _hoisted_16 = {
  key: 3,
  class: "message-audio"
};
const _hoisted_17 = {
  key: 4,
  class: "message-face"
};
const _hoisted_18 = ["src"];
const _hoisted_19 = {
  key: 5,
  class: "message-file"
};
const _hoisted_20 = { key: 6 };
const _hoisted_21 = ["onClickCapture"];
const _hoisted_22 = { key: 8 };
const _sfc_main = /* @__PURE__ */ Vue.defineComponent({
  __name: "index",
  props: {
    messageID: { default: "" },
    isMounted: { type: Boolean, default: false }
  },
  emits: ["closeOverlay"],
  setup(__props, { emit: __emit }) {
    const emits = __emit;
    const props = __props;
    const TYPES = TUIChatEngine.TYPES;
    const isDownloadOccurError = Vue.ref(false);
    const messageListStack = Vue.ref([]);
    const currentMergeMessageInfo = Vue.ref({
      title: "",
      messageList: []
    });
    const simpleMessageListRef = Vue.ref();
    Vue.watch(() => messageListStack.value.length, async (newValue) => {
      isDownloadOccurError.value = false;
      if (newValue < 1) {
        return;
      }
      const stackTopMessageInfo = messageListStack.value[messageListStack.value.length - 1];
      if (stackTopMessageInfo.downloadKey && stackTopMessageInfo.messageList.length === 0) {
        try {
          const res = await TUIChatEngine.TUIChatService.downloadMergedMessages({
            payload: stackTopMessageInfo,
            type: TUIChatEngine.TYPES.MSG_MERGER
          });
          messageListStack.value[messageListStack.value.length - 1] = res.payload;
        } catch (error) {
          isDownloadOccurError.value = true;
        }
      }
      currentMergeMessageInfo.value = messageListStack.value[messageListStack.value.length - 1];
    });
    Vue.watch(() => props.isMounted, (newValue) => {
      if (newValue) {
        if (!props.messageID) {
          throw new Error("messageID is required when first render of simple-message-list.");
        }
        const sdkMessagePayload = TUIChatEngine.TUIStore.getMessageModel(props.messageID).getMessage().payload;
        messageListStack.value = [sdkMessagePayload];
      } else {
        messageListStack.value = [];
      }
    }, {
      immediate: true
    });
    const isReturn = Vue.computed(() => {
      return messageListStack.value.length > 1;
    });
    const isMergeMessageInfoLoaded = Vue.computed(() => {
      var _a;
      return ((_a = currentMergeMessageInfo.value) == null ? void 0 : _a.messageList) ? currentMergeMessageInfo.value.messageList.length > 0 : false;
    });
    function entryNextLevel(e, sdkMessage) {
      messageListStack.value.push(sdkMessage.messageBody[0].payload);
      e.stopPropagation();
    }
    function backPreviousLevel() {
      messageListStack.value.pop();
      if (messageListStack.value.length < 1) {
        emits("closeOverlay");
      }
    }
    function previewVideoInUniapp(url) {
      if (env.isUniFrameWork) {
        const encodedUrl = encodeURIComponent(url);
        uni.navigateTo({
          url: `/TUIKit/components/TUIChat/video-play?videoUrl=${encodedUrl}`
        });
      }
    }
    function resolveBigFaceUrl(bigFaceKey) {
      let url = "";
      if (bigFaceKey.indexOf("@custom") > -1) {
        url = customEmoji.CUSTOM_BIG_EMOJI_URL + bigFaceKey;
      } else {
        url = defaultEmoji.DEFAULT_BIG_EMOJI_URL + bigFaceKey;
        if (url.indexOf("@2x") === -1) {
          url += "@2x.png";
        } else {
          url += ".png";
        }
      }
      return url;
    }
    return (_ctx, _cache) => {
      return Vue.openBlock(), Vue.createElementBlock("div", {
        class: Vue.normalizeClass({
          "simple-message-list-container": true,
          "simple-message-list-container-mobile": Vue.unref(env.isMobile)
        })
      }, [
        Vue.createElementVNode("div", _hoisted_1, [
          Vue.createElementVNode("span", {
            class: "back",
            onClick: backPreviousLevel
          }, [
            Vue.createVNode(Icon.default, {
              class: "close-icon",
              file: Vue.unref(back.default),
              size: "18px"
            }, null, 8, ["file"]),
            Vue.unref(isReturn) ? (Vue.openBlock(), Vue.createElementBlock("span", _hoisted_2, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.返回")), 1)) : (Vue.openBlock(), Vue.createElementBlock("span", _hoisted_3, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.关闭")), 1))
          ]),
          Vue.createElementVNode("span", _hoisted_4, Vue.toDisplayString(Vue.unref(currentMergeMessageInfo).title), 1)
        ]),
        Vue.unref(isDownloadOccurError) ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_5, " Load Merge Message Error ")) : Vue.unref(isMergeMessageInfoLoaded) ? (Vue.openBlock(), Vue.createElementBlock("div", {
          key: 1,
          ref_key: "simpleMessageListRef",
          ref: simpleMessageListRef,
          class: "message-list"
        }, [
          (Vue.openBlock(true), Vue.createElementBlock(Vue.Fragment, null, Vue.renderList(Vue.unref(currentMergeMessageInfo).messageList, (item) => {
            return Vue.openBlock(), Vue.createElementBlock("div", {
              key: item.ID,
              class: Vue.normalizeClass({
                "message-item": true
              })
            }, [
              Vue.createVNode(messageContainer.default, {
                sender: item.nick,
                avatar: item.avatar,
                type: item.messageBody[0].type,
                time: item.time
              }, {
                default: Vue.withCtx(() => [
                  item.messageBody[0].type === Vue.unref(TYPES).MSG_TEXT ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_6, [
                    (Vue.openBlock(true), Vue.createElementBlock(Vue.Fragment, null, Vue.renderList(Vue.unref(index.parseTextToRenderArray)(item.messageBody[0].payload["text"]), (textInfo, index2) => {
                      return Vue.openBlock(), Vue.createElementBlock("span", {
                        key: index2,
                        class: "message-text-container"
                      }, [
                        textInfo.type === "text" ? (Vue.openBlock(), Vue.createElementBlock("span", _hoisted_7, Vue.toDisplayString(textInfo.content), 1)) : (Vue.openBlock(), Vue.createElementBlock("img", {
                          key: 1,
                          class: "simple-emoji",
                          src: textInfo.content,
                          alt: "small-face"
                        }, null, 8, _hoisted_8))
                      ]);
                    }), 128))
                  ])) : item.messageBody[0].type === Vue.unref(TYPES).MSG_IMAGE ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_9, [
                    Vue.createElementVNode("img", {
                      class: "image",
                      src: item.messageBody[0].payload["imageInfoArray"][2]["url"],
                      mode: "widthFix",
                      alt: "image"
                    }, null, 8, _hoisted_10)
                  ])) : item.messageBody[0].type === Vue.unref(TYPES).MSG_VIDEO ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_11, [
                    Vue.unref(env.isUniFrameWork) ? (Vue.openBlock(), Vue.createElementBlock("div", {
                      key: 0,
                      onClick: ($event) => previewVideoInUniapp(item.messageBody[0].payload["remoteVideoUrl"])
                    }, [
                      Vue.createElementVNode("image", {
                        class: "image",
                        src: item.messageBody[0].payload["thumbUrl"],
                        mode: "widthFix",
                        alt: "image"
                      }, null, 8, _hoisted_13),
                      Vue.createVNode(Icon.default, {
                        class: "video-play-icon",
                        file: Vue.unref(videoPlay.default)
                      }, null, 8, ["file"])
                    ], 8, _hoisted_12)) : (Vue.openBlock(), Vue.createElementBlock("video", {
                      key: 1,
                      class: "video",
                      controls: "",
                      poster: item.messageBody[0].payload["thumbUrl"]
                    }, [
                      Vue.createElementVNode("source", {
                        src: item.messageBody[0].payload["remoteVideoUrl"],
                        type: "video/mp4"
                      }, null, 8, _hoisted_15)
                    ], 8, _hoisted_14))
                  ])) : item.messageBody[0].type === Vue.unref(TYPES).MSG_AUDIO ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_16, [
                    Vue.createElementVNode("span", null, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.语音")) + " ", 1),
                    Vue.createElementVNode("span", null, Vue.toDisplayString(item.messageBody[0].payload.second) + "s", 1)
                  ])) : item.messageBody[0].type === Vue.unref(TYPES).MSG_FACE ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_17, [
                    Vue.createElementVNode("img", {
                      class: "image",
                      src: resolveBigFaceUrl(item.messageBody[0].payload.data),
                      alt: "face"
                    }, null, 8, _hoisted_18)
                  ])) : item.messageBody[0].type === Vue.unref(TYPES).MSG_FILE ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_19, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.[文件]")), 1)) : item.messageBody[0].type === Vue.unref(TYPES).MSG_LOCATION ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_20, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.[地理位置]")), 1)) : item.messageBody[0].type === Vue.unref(TYPES).MSG_MERGER ? (Vue.openBlock(), Vue.createElementBlock("div", {
                    key: 7,
                    class: "message-merger",
                    onClickCapture: ($event) => entryNextLevel($event, item)
                  }, [
                    Vue.createVNode(index$1.default, {
                      disabled: "",
                      renderData: item.messageBody[0].payload
                    }, null, 8, ["renderData"])
                  ], 40, _hoisted_21)) : item.messageBody[0].type === Vue.unref(TYPES).MSG_CUSTOM ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_22, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.[自定义消息]")), 1)) : Vue.createCommentVNode("", true)
                ]),
                _: 2
              }, 1032, ["sender", "avatar", "type", "time"])
            ]);
          }), 128))
        ], 512)) : Vue.createCommentVNode("", true)
      ], 2);
    };
  }
});
exports.default = _sfc_main;
