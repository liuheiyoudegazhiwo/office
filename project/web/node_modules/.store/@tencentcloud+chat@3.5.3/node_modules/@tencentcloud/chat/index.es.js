let e={SDK_READY:"sdkStateReady",SDK_NOT_READY:"sdkStateNotReady",SDK_DESTROY:"sdkDestroy",MESSAGE_RECEIVED:"onMessageReceived",ROOM_CUSTOM_DATA_RECEIVED:"onRoomCustomDataReceived",MESSAGE_MODIFIED:"onMessageModified",MESSAGE_REVOKED:"onMessageRevoked",MESSAGE_READ_BY_PEER:"onMessageReadByPeer",MESSAGE_READ_RECEIPT_RECEIVED:"onMessageReadReceiptReceived",MESSAGE_EXTENSIONS_UPDATED:"onMessageExtensionsUpdated",MESSAGE_EXTENSIONS_DELETED:"onMessageExtensionsDeleted",MESSAGE_REACTIONS_UPDATED:"onMessageReactionsUpdated",CONVERSATION_LIST_UPDATED:"onConversationListUpdated",TOTAL_UNREAD_MESSAGE_COUNT_UPDATED:"onTotalUnreadMessageCountUpdated",CONVERSATION_GROUP_LIST_UPDATED:"onConversationGroupListUpdated",CONVERSATION_IN_GROUP_UPDATED:"onConversationInGroupUpdated",GROUP_LIST_UPDATED:"onGroupListUpdated",GROUP_ATTRIBUTES_UPDATED:"groupAttributesUpdated",GROUP_COUNTER_UPDATED:"onGroupCounterUpdated",TOPIC_CREATED:"onTopicCreated",TOPIC_DELETED:"onTopicDeleted",TOPIC_UPDATED:"onTopicUpdated",PROFILE_UPDATED:"onProfileUpdated",USER_STATUS_UPDATED:"onUserStatusUpdated",BLACKLIST_UPDATED:"blacklistUpdated",FRIEND_LIST_UPDATED:"onFriendListUpdated",FRIEND_GROUP_LIST_UPDATED:"onFriendGroupListUpdated",FRIEND_APPLICATION_LIST_UPDATED:"onFriendApplicationListUpdated",MY_FOLLOWERS_LIST_UPDATED:"onMyFollowersListUpdated",MY_FOLLOWING_LIST_UPDATED:"onMyFollowingListUpdated",MUTUAL_FOLLOWERS_LIST_UPDATED:"onMutualFollowersListUpdated",KICKED_OUT:"kickedOut",ERROR:"error",NET_STATE_CHANGE:"netStateChange",ALL_RECEIVE_MESSAGE_OPT_UPDATED:"onAllReceiveMessageOptUpdated"},t={MSG_TEXT:"TIMTextElem",MSG_IMAGE:"TIMImageElem",MSG_SOUND:"TIMSoundElem",MSG_AUDIO:"TIMSoundElem",MSG_FILE:"TIMFileElem",MSG_FACE:"TIMFaceElem",MSG_VIDEO:"TIMVideoFileElem",MSG_GEO:"TIMLocationElem",MSG_LOCATION:"TIMLocationElem",MSG_GRP_TIP:"TIMGroupTipElem",MSG_GRP_SYS_NOTICE:"TIMGroupSystemNoticeElem",MSG_CUSTOM:"TIMCustomElem",MSG_MERGER:"TIMRelayElem",MSG_PRIORITY_HIGH:"High",MSG_PRIORITY_NORMAL:"Normal",MSG_PRIORITY_LOW:"Low",MSG_PRIORITY_LOWEST:"Lowest",CONV_C2C:"C2C",CONV_GROUP:"GROUP",CONV_TOPIC:"TOPIC",CONV_SYSTEM:"@TIM#SYSTEM",CONV_AT_ME:1,CONV_AT_ALL:2,CONV_AT_ALL_AT_ME:3,CONV_MARK_TYPE_STAR:1,CONV_MARK_TYPE_UNREAD:2,CONV_MARK_TYPE_FOLD:4,CONV_MARK_TYPE_HIDE:8,GRP_PRIVATE:"Private",GRP_WORK:"Private",GRP_PUBLIC:"Public",GRP_CHATROOM:"ChatRoom",GRP_MEETING:"ChatRoom",GRP_AVCHATROOM:"AVChatRoom",GRP_COMMUNITY:"Community",GRP_ROOM:"Room",GRP_LIVE:"Live",GRP_MBR_ROLE_OWNER:"Owner",GRP_MBR_ROLE_ADMIN:"Admin",GRP_MBR_ROLE_MEMBER:"Member",GRP_MBR_ROLE_CUSTOM:"Custom",GRP_TIP_MBR_JOIN:1,GRP_TIP_MBR_QUIT:2,GRP_TIP_MBR_KICKED_OUT:3,GRP_TIP_MBR_SET_ADMIN:4,GRP_TIP_MBR_CANCELED_ADMIN:5,GRP_TIP_GRP_PROFILE_UPDATED:6,GRP_TIP_MBR_PROFILE_UPDATED:7,GRP_TIP_BAN_AVCHATROOM_MEMBER:10,GRP_TIP_UNBAN_AVCHATROOM_MEMBER:11,MSG_REMIND_ACPT_AND_NOTE:"AcceptAndNotify",MSG_REMIND_ACPT_NOT_NOTE:"AcceptNotNotify",MSG_REMIND_DISCARD:"Discard",RECEIVE_WITH_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_MSG_EXCEPT_AT:"NotReceiveMsgExceptAt",GENDER_UNKNOWN:"Gender_Type_Unknown",GENDER_FEMALE:"Gender_Type_Female",GENDER_MALE:"Gender_Type_Male",KICKED_OUT_MULT_ACCOUNT:"multipleAccount",KICKED_OUT_MULT_DEVICE:"multipleDevice",KICKED_OUT_USERSIG_EXPIRED:"userSigExpired",KICKED_OUT_REST_API:"REST_API_Kick",ALLOW_TYPE_ALLOW_ANY:"AllowType_Type_AllowAny",ALLOW_TYPE_NEED_CONFIRM:"AllowType_Type_NeedConfirm",ALLOW_TYPE_DENY_ANY:"AllowType_Type_DenyAny",FORBID_TYPE_NONE:"AdminForbid_Type_None",FORBID_TYPE_SEND_OUT:"AdminForbid_Type_SendOut",JOIN_OPTIONS_FREE_ACCESS:"FreeAccess",JOIN_OPTIONS_NEED_PERMISSION:"NeedPermission",JOIN_OPTIONS_DISABLE_APPLY:"DisableApply",JOIN_STATUS_SUCCESS:"JoinedSuccess",JOIN_STATUS_ALREADY_IN_GROUP:"AlreadyInGroup",JOIN_STATUS_WAIT_APPROVAL:"WaitAdminApproval",INVITE_OPTIONS_DISABLE_INVITE:"DisableInvite",INVITE_OPTIONS_NEED_PERMISSION:"NeedPermission",INVITE_OPTIONS_FREE_ACCESS:"FreeAccess",GRP_PROFILE_OWNER_ID:"ownerID",GRP_PROFILE_CREATE_TIME:"createTime",GRP_PROFILE_LAST_INFO_TIME:"lastInfoTime",GRP_PROFILE_MEMBER_NUM:"memberNum",GRP_PROFILE_MAX_MEMBER_NUM:"maxMemberNum",GRP_PROFILE_JOIN_OPTION:"joinOption",GRP_PROFILE_INVITE_OPTION:"inviteOption",GRP_PROFILE_INTRODUCTION:"introduction",GRP_PROFILE_NOTIFICATION:"notification",GRP_PROFILE_MUTE_ALL_MBRS:"muteAllMembers",SNS_ADD_TYPE_SINGLE:"Add_Type_Single",SNS_ADD_TYPE_BOTH:"Add_Type_Both",SNS_DELETE_TYPE_SINGLE:"Delete_Type_Single",SNS_DELETE_TYPE_BOTH:"Delete_Type_Both",SNS_APPLICATION_TYPE_BOTH:"Pendency_Type_Both",SNS_APPLICATION_SENT_TO_ME:"Pendency_Type_ComeIn",SNS_APPLICATION_SENT_BY_ME:"Pendency_Type_SendOut",SNS_APPLICATION_AGREE:"Response_Action_Agree",SNS_APPLICATION_AGREE_AND_ADD:"Response_Action_AgreeAndAdd",SNS_CHECK_TYPE_BOTH:"CheckResult_Type_Both",SNS_CHECK_TYPE_SINGLE:"CheckResult_Type_Single",SNS_TYPE_NO_RELATION:"CheckResult_Type_NoRelation",SNS_TYPE_A_WITH_B:"CheckResult_Type_AWithB",SNS_TYPE_B_WITH_A:"CheckResult_Type_BWithA",SNS_TYPE_BOTH_WAY:"CheckResult_Type_BothWay",NET_STATE_CONNECTED:"connected",NET_STATE_CONNECTING:"connecting",NET_STATE_DISCONNECTED:"disconnected",MSG_AT_ALL:"__kImSDK_MesssageAtALL__",READ_ALL_C2C_MSG:"readAllC2CMessage",READ_ALL_GROUP_MSG:"readAllGroupMessage",READ_ALL_MSG:"readAllMessage",USER_STATUS_UNKNOWN:0,USER_STATUS_ONLINE:1,USER_STATUS_OFFLINE:2,USER_STATUS_UNLOGINED:3,IOS_OFFLINE_PUSH_NO_SOUND:"push.no_sound",IOS_OFFLINE_PUSH_DEFAULT_SOUND:"default"};class s{constructor(){this.cache=[],this.options=null}use(e){if("function"!=typeof e)throw"middleware must be a function";return this.cache.push(e),this}next(e){if(this.middlewares&&0<this.middlewares.length)return this.middlewares.shift().call(this,this.options,this.next.bind(this))}run(e){return this.middlewares=this.cache.map(function(e){return e}),this.options=e,this.next()}}class i{constructor(e=0,t=0){this.high=e,this.low=t}equal(e){return null!==e&&this.low===e.low&&this.high===e.high}toString(){var e=Number(this.high).toString(16);let t=Number(this.low).toString(16);if(t.length<8){let e=8-t.length;for(;e;)t="0"+t,e--}return e+t}}let n={TEST:{CHINA:{DEFAULT:"wss://wss-dev.tim.qq.com"},OVERSEA:{DEFAULT:"wss://wss-dev.tim.qq.com"},SINGAPORE:{DEFAULT:"wss://wsssgp-dev.im.qcloud.com"},KOREA:{DEFAULT:"wss://wsskr-dev.im.qcloud.com"},GERMANY:{DEFAULT:"wss://wssger-dev.im.qcloud.com"},IND:{DEFAULT:"wss://wssind-dev.im.qcloud.com"},JPN:{DEFAULT:"wss://wssjpn-dev.im.qcloud.com"},USA:{DEFAULT:"wss://wssusa-dev.im.qcloud.com"},INDONESIA:{DEFAULT:"wss://wssidn-dev.im.qcloud.com"}},PRODUCTION:{CHINA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",IPV6:"wss://wssv6.im.qcloud.com",BACKUP:"wss://wss.tim.qq.com",BACKUP_WEB:"wss://*w4c.my-cpaas.com",STAT:"https://events.im.qcloud.com",ANYCAST:"wss://162.14.13.203"},OVERSEA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",IPV6:"wss://wssv6.im.qcloud.com",BACKUP:"wss://wss.my-imcloud.com",BACKUP_WEB:"wss://*w4c.my-cpaas.com",STAT:"https://api.my-imcloud.com"},SINGAPORE:{DEFAULT0:"wss://*w4s.my-imcloud.com",DEFAULT:"wss://wsssgp.im.qcloud.com",IPV6:"wss://wsssgpv6.im.qcloud.com",BACKUP:"wss://wsssgp.my-imcloud.com",BACKUP_WEB:"wss://*w4s.my-cpaas.com",STAT:"https://apisgp.my-imcloud.com",ANYCAST:"wss://162.14.19.159"},KOREA:{DEFAULT0:"wss://*w4k.my-imcloud.com",DEFAULT:"wss://wsskr.im.qcloud.com",IPV6:"wss://wsskrv6.im.qcloud.com",BACKUP:"wss://wsskr.my-imcloud.com",BACKUP_WEB:"wss://*w4k.my-cpaas.com",STAT:"https://apikr.my-imcloud.com",ANYCAST:"wss://162.14.13.104"},GERMANY:{DEFAULT0:"wss://*w4g.my-imcloud.com",DEFAULT:"wss://wssger.im.qcloud.com",IPV6:"wss://wssgerv6.im.qcloud.com",BACKUP:"wss://wssger.my-imcloud.com",BACKUP_WEB:"wss://*w4g.my-cpaas.com",STAT:"https://apiger.my-imcloud.com",ANYCAST:"wss://162.14.3.17"},IND:{DEFAULT0:"wss://*w4i.my-imcloud.com",DEFAULT:"wss://wssind.my-imcloud.com",IPV6:"wss://wssindv6.im.qcloud.com",BACKUP:"wss://wssind.im.qcloud.com",BACKUP_WEB:"wss://*w4i.my-cpaas.com",STAT:"https://apiind.my-imcloud.com",ANYCAST:"wss://162.14.19.46"},JPN:{DEFAULT0:"wss://*w4j.my-imcloud.com",DEFAULT:"wss://wssjpn.im.qcloud.com",IPV6:"wss://wssjpnv6.im.qcloud.com",BACKUP:"wss://wssjpn.my-imcloud.com",BACKUP_WEB:"wss://*w4j.my-cpaas.com",STAT:"https://apijpn.my-imcloud.com"},USA:{DEFAULT0:"wss://*w4u.my-imcloud.com",DEFAULT:"wss://wssusa.im.qcloud.com",IPV6:"wss://wssusav6.im.qcloud.com",BACKUP:"wss://wssusa.my-imcloud.com",BACKUP_WEB:"wss://*w4u.my-cpaas.com",STAT:"https://apiusa.my-imcloud.com",ANYCAST:"wss://162.14.10.42"},INDONESIA:{DEFAULT0:"wss://*w4y.my-imcloud.com",DEFAULT:"wss://wssidn.im.qcloud.com",IPV6:"wss://wssidnv6.im.qcloud.com",BACKUP:"wss://wssidn.my-imcloud.com",BACKUP_WEB:"wss://*w4y.my-cpaas.com",STAT:"https://apiidn.my-imcloud.com",ANYCAST:"wss://43.129.34.169"}}},o={ANDROID:2,IOS:3,MAC:4,WEB:7,WX_MP:8,QQ_MP:9,TT_MP:10,BAIDU_MP:11,ALI_MP:12,IPAD:13,UNI_NATIVE_APP:15,DONUT_NATIVE_APP:19,NS_NATIVE_APP:20,RN_NATIVE_APP:21},r="1.7.3",a=537048168,c="CHINA",l="OVERSEA",u="SINGAPORE",d="KOREA",_="GERMANY",h="IND",p="JPN",g="USA",m="INDONESIA",f={HOST:{CURRENT:{DEFAULT:"wss://wss.im.qcloud.com",STAT:"https://events.im.qcloud.com"},setCurrent(e=c){this.CURRENT=n.PRODUCTION[e]}},NAME:{OPEN_IM:"openim",OPEN_IM_MSG_EXT:"openim_msg_ext_http_svc",GRP:"group_open_http_svc",GRP_AV:"group_open_avchatroom_http_svc",GRP_COMMUNITY:"million_group_open_http_svc",GRP_ATTR:"group_open_attr_http_svc",FD:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GRP_NO_AUTH:"group_open_http_noauth_svc",BIG_GRP_POLLING:"group_open_long_polling_http_svc",BIG_GRP_POLLING_NO_AUTH:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",WEB_IM:"webim",IM_COS_SIGN:"im_cos_sign_svr",CUSTOM_UPLOAD:"im_cos_msg",HEARTBEAT:"heartbeat",IM_OPEN_PUSH:"im_open_push",IM_OPEN_STATUS:"im_open_status",IM_LONG_MSG:"im_long_msg",IM_CONFIG_MANAGER:"im_sdk_config_mgr",STAT_SERVICE:"StatSvc",OVERLOAD_PUSH:"OverLoadPush",IM_MSG_AUDIT_MGR:"im_msg_audit_mgr",TUIROOM_SVR:"tui_room_svr",IM_OPEN_TRANSLATE:"im_open_translate",IM_OPEN_SPEECH:"im_open_speech",MSG_SEARCH:"message_search",GRP_SEARCH:"group_search",GRP_MEMBER_SEARCH:"group_member_search",USER_SEARCH:"user_search",FOLLOW:"follow",OFFLINE_PUSH_REPORT:"offline_push_report",IM_MSG_LOGIC:"im_msg_db_logic"}},M={SEARCH_GRP_SNS:new i(0,Math.pow(2,1)).toString(),AV_HISTORY_MSG:new i(0,Math.pow(2,2)).toString(),GRP_COMMUNITY:new i(0,Math.pow(2,3)).toString(),MSG_TO_SPECIFIED_GRP_MBR:new i(0,Math.pow(2,4)).toString(),AV_MBR_LIST:new i(0,Math.pow(2,6)).toString(),USER_STATUS:new i(0,Math.pow(2,7)).toString(),CONV_MARK:new i(0,Math.pow(2,9)).toString(),CONV_GROUP:new i(0,Math.pow(2,10)).toString(),AV_BAN_MBR:new i(0,Math.pow(2,11)).toString(),MSG_EXT:new i(0,Math.pow(2,13)).toString(),GRP_COUNTER:new i(0,Math.pow(2,15)).toString(),PLUGIN_TRANSLATE:new i(Math.pow(2,6)).toString(),PLUGIN_VOICE_TO_TEXT:new i(Math.pow(2,7)).toString(),PLUGIN_CS:new i(Math.pow(2,8)).toString(),PLUGIN_PUSH:new i(Math.pow(2,9)).toString(),PLUGIN_BOT:new i(Math.pow(2,10)).toString(),MSG_REACTION:new i(Math.pow(2,16)).toString(),FOLLOW:new i(Math.pow(2,20)).toString()},I="c2c_text_message",C="c2c_custom_message",T="group_text_message",y="group_custom_message",v="user_profile",E="group_profile",S=(f.HOST.setCurrent(c),"undefined"!=typeof wx&&"function"==typeof wx.getSystemInfoSync&&Boolean(wx.getSystemInfoSync().fontSizeSetting)),D=S&&"function"==typeof wx.createGamePortal,R="undefined"!=typeof qq&&"function"==typeof qq.getSystemInfoSync&&Boolean(qq.getSystemInfoSync().fontSizeSetting),L="undefined"!=typeof tt&&"function"==typeof tt.getSystemInfoSync&&Boolean(tt.getSystemInfoSync().fontSizeSetting),A="undefined"!=typeof swan&&"function"==typeof swan.getSystemInfoSync&&Boolean(swan.getSystemInfoSync().fontSizeSetting),O="undefined"!=typeof my&&"function"==typeof my.getSystemInfoSync&&Boolean(my.getSystemInfoSync().fontSizeSetting),N="undefined"!=typeof jd&&"function"==typeof jd.getSystemInfoSync,P="undefined"!=typeof uni&&"undefined"==typeof window&&"function"==typeof uni.requireNativePlugin,U=S&&"object"==typeof wx.miniapp,G="undefined"!=typeof uni,k=S||R||L||A||O||P||N,w="undefined"==typeof window&&!k&&"undefined"!=typeof global&&void 0!==global.NativeScriptGlobals,b="undefined"!=typeof global&&(void 0!==global.nativeModuleProxy||void 0!==global.ReactNative),F="undefined"!=typeof uni?!k:"undefined"!=typeof window&&!k&&!b,$=R?qq:L?tt:A?swan:O?my:S?wx:P?uni:N?jd:{},q=F&&window&&window.navigator&&window.navigator.userAgent||"",x=/(micromessenger|webbrowser)/i.test(q),V=function(){let e="WEB";return x?e="WEB":R?e="QQ_MP":L?e="TT_MP":A?e="BAIDU_MP":O?e="ALI_MP":S?e=U?"DONUT_NATIVE_APP":"WX_MP":P?e="UNI_NATIVE_APP":w?e="NS_NATIVE_APP":b&&(e="RN_NATIVE_APP"),o[e]}(),B=/iPad/i.test(q),K=/iPhone/i.test(q)&&!B,H=/iPod/i.test(q),W=K||B||H,Y=function(){var e=q.match(/OS (\d+)_/i);return e&&e[1]?e[1]:null}(),z=/Android/i.test(q),j=function(){var e,t,s=q.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);return s?(e=s[1]&&parseFloat(s[1]),t=s[2]&&parseFloat(s[2]),e&&t?parseFloat(s[1]+"."+s[2]):e||null):null}(),J=/Edge/i.test(q),X=!J&&/Chrome/i.test(q),Z=/MSIE/.test(q)||-1<q.indexOf("Trident")&&-1<q.indexOf("rv:11.0"),Q=function(){var e=/MSIE\s(\d+)\.\d/.exec(q);let t=e&&parseFloat(e[1]);return t=!t&&/Trident\/7.0/i.test(q)&&/rv:11.0/.test(q)?11:t}(),ee=/Safari/i.test(q)&&!X&&!z&&!J,te=/Windows/i.test(q),se=/MAC OS X/i.test(q),ie=F&&"undefined"!=typeof Worker&&!Z,ne=z||W,oe=F&&void 0!==window.tencent_cloud_im_csig_flutter_for_web_25F_cy,re=function(){var e;return"undefined"!=typeof window&&void 0!==window.navigator&&(e=window.navigator.standalone,!(!W||e||ee))}(),ae,ce,le=(ae="undefined"!=typeof console?console:"undefined"!=typeof global&&global.console?global.console:"undefined"!=typeof window&&window.console?window.console:{},function(){}),ue=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],de=ue.length;for(;de--;)ce=ue[de],console[ce]||(ae[ce]=le);var _e=ae;let he=0,pe=function(){return(new Date).getTime()+he},ge=function(){he=0},me=function(){return Math.floor(pe()/1e3)},fe=0;function Me(){return Et()?"%c Chat %c":"Chat"}function Ie(){(e=new Date).setTime(pe());var e;return e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){let t;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e}return t}(e.getMilliseconds())}let Ce={arguments2String(s){let i="";if(1===s.length)i=s[0];else for(let e=0,t=s.length;e<t;e++){if(qe(s[e]))try{i+=Ve(s[e])?JSON.stringify(s[e],["message","code"]):JSON.stringify(s[e])}catch(e){i+=e?e.message:"";break}else i+=s[e];i+=" "}return i},_exec(e,t){Et()?_e[e](Me(),"background:#0abf5b; padding:1px; border-radius:3px; color: #fff","background:transparent",Ie(),t):_e[e](`${Me()} ${Ie()} `+t)},d:function(){var e;fe<=-1&&(e=this.arguments2String(arguments),this._exec("debug",e))},l:function(){var e;fe<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},log:function(){var e;fe<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},i:function(){var e;fe<=1&&(e=this.arguments2String(arguments),this._exec("info",e))},w:function(){var e;fe<=2&&(e=this.arguments2String(arguments),this._exec("warn",e))},e:function(){var e;fe<=3&&(e=this.arguments2String(arguments),this._exec("error",e))},setLevel:function(e){e<4&&this._exec("log","set level from "+fe+" to "+e),fe=e},getLevel:function(){return fe}},Te={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},ye={NICK:"Tag_Profile_IM_Nick",GENDER:"Tag_Profile_IM_Gender",BIRTHDAY:"Tag_Profile_IM_BirthDay",LOCATION:"Tag_Profile_IM_Location",SELFSIGNATURE:"Tag_Profile_IM_SelfSignature",ALLOWTYPE:"Tag_Profile_IM_AllowType",LANGUAGE:"Tag_Profile_IM_Language",AVATAR:"Tag_Profile_IM_Image",MESSAGESETTINGS:"Tag_Profile_IM_MsgSettings",ADMINFORBIDTYPE:"Tag_Profile_IM_AdminForbidType",LEVEL:"Tag_Profile_IM_Level",ROLE:"Tag_Profile_IM_Role"},ve="Gender_Type_",Ee={UNKNOWN:ve+"Unknown",FEMALE:ve+"Female",MALE:ve+"Male"},Se={NONE:"AdminForbid_Type_None",SEND_OUT:"AdminForbid_Type_SendOut"},De={NEED_CONFIRM:"AllowType_Type_NeedConfirm",ALLOW_ANY:"AllowType_Type_AllowAny",DENY_ANY:"AllowType_Type_DenyAny"},Re="@TGS#_",Le="@TOPIC#_",Ae=Object.prototype.hasOwnProperty;function Oe(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(be(e)){for(var t in e)if(Ae.call(e,t))return!1;return!0}return!!(Ne(e)||Pe(e)||Ue(e))&&0===e.size}let Ne=function(e){return"map"===Ke(e)},Pe=function(e){return"set"===Ke(e)},Ue=function(e){return"file"===Ke(e)},Ge=function(e){return null!==e&&("number"==typeof e&&!isNaN(+e)||"object"==typeof e&&e.constructor===Number)},ke=function(e){return"string"==typeof e},we=function(e){return null!==e&&"object"==typeof e},be=function(e){if("object"!=typeof e||null===e)return!1;e=Object.getPrototypeOf(e);if(null===e)return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return e===t},Fe=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"array"===Ke(e)},$e=function(e){return void 0===e},qe=function(e){return Fe(e)||we(e)},xe=function(e){return"function"==typeof e},Ve=function(e){return e instanceof Error},Be=function(e){return"filelist"===Ke(e)},Ke=function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()},He=function(e){return"string"==typeof e&&(e=e[0],!/[^a-zA-Z0-9]/.test(e))},We=(Date.now||(Date.now=function(){return(new Date).getTime()}),function(s,i,r,o){if(!qe(s)||!qe(i))return 0;let n=0;var a,l=Object.keys(i);for(let e=0,t=l.length;e<t;e++)if(a=l[e],!($e(i[a])||r&&r.includes(a)))if(qe(s[a])&&qe(i[a]))n+=We(s[a],i[a],r,o);else{if(o&&o.includes(i[a]))continue;s[a]!==i[a]&&(s[a]=i[a],n+=1)}return n}),Ye=function(e,t){var s,i,r=new Map;for([s,i]of e.entries())i&&r.set(s,t?JSON.stringify(i):JSON.parse(JSON.stringify(i)));return r},ze=function(e){if(0===e.length)return 0;let t=0,s=0,i;for(var r="undefined"!=typeof document&&void 0!==document.characterSet?document.characterSet:"UTF-8";void 0!==e[t];)i=e[t++].charCodeAt[t]<=255?1:!1===r?3:2,s+=i;return s},je=function(e){e=e||99999999;return Math.round(Math.random()*e)},Je="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",Xe=Je.length,Ze=function(e,t){for(var s in e)if(e[s]===t)return!0;return!1},Qe={},et=function(e){return-1===e.indexOf("http://")||-1===e.indexOf("https://")?"https://"+e:e.replace(/https|http/,"https")};function st(i,e){if(!Fe(i)||!Fe(e))return!1;let r=!1;return e.forEach(({key:t,value:e})=>{var s=i.find(e=>e.key===t);s?s.value!==e&&(s.value=e,r=!0):(i.push({key:t,value:e}),r=!0)}),r}function it(e){var t;if(be(e)&&be(e.webhookInfo))return t=[],e.webhookInfo.disableCloudMessagePreHook&&t.push("ForbidBeforeSendMsgCallback"),e.webhookInfo.disableCloudMessagePostHook&&t.push("ForbidAfterSendMsgCallback"),0!==t.length?t:void 0}let nt=e=>e===t.GRP_AVCHATROOM,ot=({type:e,groupID:s})=>e===t.GRP_COMMUNITY||(""+s).startsWith(Re)&&!(""+s).includes(Le),rt=e=>(""+e).startsWith(Re)&&(""+e).includes(Le),at=e=>ke(e)&&e.slice(0,3)===t.CONV_C2C,ct=e=>ke(e)&&e.slice(0,5)===t.CONV_GROUP,lt=e=>ke(e)&&e===t.CONV_SYSTEM;function ut(t,s){let i={};return Object.keys(t).forEach(e=>{i[e]=s(t[e],e)}),i}function dt(i){return b?Promise.resolve({width:0,height:0}):k?new Promise((t,e)=>{$.getImageInfo({src:i,success(e){t({width:e.width,height:e.height})},fail(){t({width:0,height:0})}})}):Z&&9===Q?Promise.resolve({width:0,height:0}):new Promise((e,t)=>{let s=new Image;s.onload=function(){e({width:this.width,height:this.height}),s=null},s.onerror=function(){e({width:0,height:0}),s=null},s.src=i})}function _t(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return""+(e()+e())+e()+e()+e()+e()+e()+e()}function ht(){let e="unknown";if(se&&(e="mac"),te&&(e="windows"),W&&(e="ios"),z&&(e="android"),k)try{var t=$.getSystemInfoSync().platform;void 0!==t&&(e=t)}catch(e){}return e}function pt(i,r){i=i.split("."),r=r.split(".");let e=Math.max(i.length,r.length);for(;i.length<e;)i.push("0");for(;r.length<e;)r.push("0");for(let s=0;s<e;s++){let e=parseInt(i[s]),t=parseInt(r[s]);if(e>t)return 1;if(e<t)return-1}return 0}function gt(e){let{originUrl:t,originWidth:s,originHeight:i,min:r=198}=e,o=parseInt(s),n=parseInt(i),a={url:void 0,width:0,height:0};if((o<=n?o:n)<=r)a.url=t,a.width=o,a.height=n;else{n<=o?(a.width=Math.ceil(o*r/n),a.height=r):(a.width=r,a.height=Math.ceil(n*r/o));let e=t&&-1<t.indexOf("?")?t+"&":t+"?";a.url=198===r?e+"imageView2/3/w/198/h/198":e+"imageView2/3/w/720/h/720"}if($e(t)){let{url:e,...t}=a;return t}return a}function mt(t){var e=t[2];t[2]=t[1],t[1]=e;for(let e=0;e<t.length;e++)t[e].setType(e)}function ft(e){e=e.servcmd;return e.slice(e.indexOf(".")+1)}function Mt(e,t){return Math.round(Number(e)*Math.pow(10,t))/Math.pow(10,t)}function It(e,t){return e.includes(t)}function Ct(e,t){return e.includes(t)}function Tt(e){return e.split(Le)[0]}let yt=function(e,s,i){if($e(s))return"";switch(e){case t.MSG_TEXT:return s.text;case t.MSG_IMAGE:return i?"[Image]":"[图片]";case t.MSG_LOCATION:return i?"[Location]":"[位置]";case t.MSG_AUDIO:return i?"[Voice]":"[语音]";case t.MSG_VIDEO:return i?"[Video]":"[视频]";case t.MSG_FILE:return i?"[File]":"[文件]";case t.MSG_CUSTOM:return i?"[Custom Messages]":"[自定义消息]";case t.MSG_GRP_TIP:return i?"[Group Notification]":"[群提示消息]";case t.MSG_GRP_SYS_NOTICE:return i?"[Group System Message]":"[群系统通知]";case t.MSG_FACE:return i?"[Animated Sticker]":"[动画表情]";case t.MSG_MERGER:return i?"[Chat Record]":"[聊天记录]";default:return""}};function vt(t){var s=[];if(ke(t)){var i=t.length;if(0!==i)for(let e=i-1;0<=e;e--)"1"===t[e]&&s.push(Math.pow(2,i-e-1))}return s}function Et(){return!Z&&!k}function St(e){return"the length of userIDList cannot exceed "+e}function Dt(e,t=!0,s=!0){var i=Date.now();return t?s?i-e+" ms":Math.round((i-e)/1e3)+" s":s?i-e:Math.round((i-e)/1e3)}function Rt(e){let t=e&&1<e?!0:!1;return t}function Lt(s,i,r){if(void 0===i)return!0;let o=!0;if(be(i))Object.keys(i).forEach(e=>{var t=1===s.length?s[0][e]:void 0;o=!!At(t,i[e],r,e)&&o});else if(Fe(i))for(let e=0;e<i.length;e++)o=!!At(s[e],i[e],r,i[e].name)&&o;if(o)return o;throw new Error("Params validate failed.")}function At(e,t,s,i){if(void 0===t)return!0;let r=!0;var o,n;return t.required&&Oe(e)&&(Ce.e(`[${s}] Missing required params: "${i}".`),r=!1),Oe(e)||(o=Ke(e))===(n=t.type.toLowerCase())||"asyncfunction"===o&&"function"===n||(Ce.e(`[${s}] Invalid params: type check failed for "${i}". Expected ${t.type}.`),r=!1),t.validator&&!t.validator(e,s,i)&&(Ce.e(`[${s}] Invalid params: custom validator check failed for "${i}".`),r=!1),r}let Ot="unSend",Nt="success",Pt="fail",Ut="notStart",Gt="pending",kt="resolved",wt="rejected",bt=function(e){return!(!e||!(at(e)||ct(e)||lt(e))&&((e=gs("InvalidConversationID",e))&&Ce.w(e),1))},Ft=function(e){""!==e.desc&&""!==gs("API_REFER")&&Ce.w(`[${e.api}] | ${e.paramName} | ${e.desc}, `+gs("API_REFER")+e.api)},$t=function(){return gs("StringRequiredLog")},qt=function(e){return gs("NonEmptyStringRequiredLog",e)},xt=function(){return gs("NumberRequiredLog")},Vt=function(){return gs("UndefinedNotAllowedLog")},Bt=function(){return gs("FileRequiredLog")},Kt=function(){return gs("FunctionRequiredLog")},Ht=function(){return gs("ArrayRequiredLog")},Wt=function(){return gs("NonEmptyArrayLog")},Yt=function(){return gs("CallbackMissingLog")},zt=function(){return gs("PositiveIntegerRequiredLog")},jt=function(e,t){return gs("StringNotLongerThanLog",e,t)},Jt=function(e,t){return gs("NumberGreaterThanLog",e,t)},Xt=function(e,t){return gs("NumberGreaterOrEqualLog",e,t)},Zt=function(e){return gs("KeyValueStringRequiredLog",e)},Qt=function(){return gs("PlainObjectRequiredLog")},es=function(){return gs("NonEmptyContentRequiredLog")},ts=function(){return gs("FileNotSelectedLog")},ss=function(){return gs("MessageInstanceRequiredLog")},is=function(){return gs("NonAnonymousFunctionLog")},ns=function(){return gs("MessageExtensionNotAvailableLog")},os=function(){return gs("MessageReactionRequiredLog")},rs=function(e,t){return gs("ContainsUnsupportedTypeLog",e,t)},as={type:"String",required:!0},cs={type:"Array",required:!0},ls={type:"Object",required:!0},us={type:"Boolean",required:!0},ds={type:"number",required:!0},_s=function(e,t,s,{allowUndefined:i,allowEmpty:r,maxLength:o}){return $e(e)?!!i||(Ft({api:t,paramName:s,desc:Vt()}),!1):Fe(e)?!(0===e.length&&(Ft({api:t,paramName:s,desc:Wt()}),!r)||o&&e.length>o&&(Ft({api:t,paramName:s,desc:(i=s,r=o,gs("MaximumArrayLengthLog",i,r))}),1)):(Ft({api:t,paramName:s,desc:Ht()}),!1)},hs=function(e,t,s,{allowUndefined:i,min:r,max:o}){return $e(e)?!!i||(Ft({api:t,paramName:s,desc:Vt()}),!1):Ge(e)?Ge(r)&&e<r?(Ft({api:t,paramName:s,desc:0===r?Xt(s,r):Jt(s,r-1)}),!1):!(Ge(o)&&o<e&&(Ft({api:t,paramName:s,desc:(i=s,r=o,gs("MaximumNumberLog",i,r))}),1)):(Ft({api:t,paramName:s,desc:xt()}),!1)},ps={keywordListForMsg:{type:"Array",required:!1,validator:(e,t,s)=>_s(e,t,s,{allowUndefined:!0,allowEmpty:!0,maxLength:5})},keywordListExceptMsg:{type:"Array",required:!0,validator:(e,t,s)=>_s(e,t,s,{allowUndefined:!1,allowEmpty:!1,maxLength:5})},keywordListMatchType:{type:"String",required:!1,validator:(e,t,s)=>!e||"or"===e||"and"===e||Ft({api:t,paramName:s,desc:e+" is invalid match type"})},cursor:{type:"String",required:!1},count:{type:"Number",required:!1,validator:(e,t,s)=>hs(e,t,s,{allowUndefined:!0,min:1,max:100})},groupTypeList:{type:"Array",required:!1,validator:(e,s,i)=>{if(!e)return!0;if(!_s(e,s,i,{allowUndefined:!0,allowEmpty:!0}))return!1;let r=[t.GRP_PUBLIC,t.GRP_COMMUNITY,t.GRP_WORK,t.GRP_MEETING];return!(0<e.filter(e=>-1===r.indexOf(e)).length&&(Ft({api:s,paramName:i,desc:rs(i,"group")}),1))}}},gs=null,ms={hookGetAPITips:function(e){gs=e},login:{userID:as,userSig:as},addToBlacklist:{userIDList:cs},removeFromBlacklist:{userIDList:cs},on:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:qt(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Kt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:is()}),!0)}],once:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:qt(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Kt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:is()}),!0)}],off:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:qt(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Kt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:is()}),!0)}],sendMessage:[{name:"message",...ls}],setMessageExtensions:[{name:"message",...ls,validator:(e,t,s)=>e.status===Nt&&!0===e.isSupportExtension||(Ft({api:t,paramName:s,desc:ns()}),!1)},{name:"extensions",...cs}],getMessageExtensions:[{name:"message",...ls,validator:(e,t,s)=>e.status===Nt&&!0===e.isSupportExtension||(Ft({api:t,paramName:s,desc:ns()}),!1)}],deleteMessageExtensions:[{name:"message",...ls,validator:(e,t,s)=>e.status===Nt&&!0===e.isSupportExtension||(Ft({api:t,paramName:s,desc:ns()}),!1)}],addMessageReaction:[{name:"message",...ls,validator:(e,t,s)=>e.status===Nt||(Ft({api:t,paramName:s,desc:os()}),!1)},{name:"reactionID",...as}],removeMessageReaction:[{name:"message",...ls,validator:(e,t,s)=>e.status===Nt||(Ft({api:t,paramName:s,desc:os()}),!1)},{name:"reactionID",...as}],getMessageReactions:{messageList:{...cs}},getAllUserListOfMessageReaction:{message:{...ls,validator:(e,t,s)=>e.status===Nt||(Ft({api:t,paramName:s,desc:os()}),!1)},reactionID:{...as},nextSeq:{type:"Number"},count:{type:"Number"}},getMessageList:{conversationID:{...as,validator:e=>bt(e)},nextReqMessageID:{type:"String"},count:{type:"Number",validator:(e,t,s)=>!(!$e(e)&&!/^[1-9][0-9]*$/.test(e)&&(Ft({api:t,paramName:s,desc:zt()}),1))}},getMessageListHopping:{conversationID:{...as,validator:e=>bt(e)},sequence:{type:"Number"},time:{type:"Number"},direction:{type:"Number",validator:(e,t,s)=>!(!$e(e)&&0!==e&&1!==e&&(Ft({api:t,paramName:s,desc:gs("0Or1RequiredLog")}),1))},count:{type:"Number",validator:(e,t,s)=>!(!$e(e)&&!/^[1-9][0-9]*$/.test(e)&&(Ft({api:t,paramName:s,desc:zt}),1))}},setMessageRead:{conversationID:{...as,validator:e=>bt(e)}},setAllMessageRead:{scope:{type:"String",required:!1,validator:(e,s,i)=>!e||-1!==[t.READ_ALL_C2C_MSG,t.READ_ALL_GROUP_MSG,t.READ_ALL_MSG].indexOf(e)||(Ft({api:s,paramName:i,desc:gs("ValidScopeRequired")}),!1)}},getConversationProfile:[{name:"conversationID",...as,validator:e=>bt(e)}],clearHistoryMessage:[{name:"conversationID",...as,validator:e=>bt(e)}],pinConversation:{conversationID:{...as,validator:e=>bt(e)},isPinned:{...us}},setConversationDraft:{conversationID:{...as,validator:e=>bt(e)},draftText:{type:"String",validator:(e,t,s)=>!!ke(e)||(Ft({api:t,paramName:s,desc:$t()}),!1)}},setConversationCustomData:{conversationIDList:{...cs},customData:{type:"String",validator:(e,t,s)=>ke(e)?!(256<e.length&&(Ft({api:t,paramName:s,desc:jt(s,256)}),1)):(Ft({api:t,paramName:s,desc:$t()}),!1)}},markConversation:{conversationIDList:{...cs},markType:{type:"number",validator:(e,t,s)=>{return Ge(e)?e<=0?(Ft({api:t,paramName:s,desc:Jt(s,0)}),!1):!(e>=Math.pow(2,64)&&(Ft({api:t,paramName:s,desc:(e=s,gs("NumberLessThanLog",e,"Math.pow(2,64)"))}),1)):(Ft({api:t,paramName:s,desc:xt()}),!1)}},enableMark:{...us}},createConversationGroup:{conversationIDList:{...cs},groupName:{...as,validator:(e,t,s)=>!(!e||32<e.length&&(Ft({api:t,paramName:s,desc:jt(s,32)}),1))}},deleteConversationGroup:[{name:"groupName",...as}],renameConversationGroup:{oldName:{...as},newName:{...as,validator:(e,t,s)=>!(!e||32<e.length&&(Ft({api:t,paramName:s,desc:jt(s,32)}),1))}},addConversationsToGroup:{conversationIDList:{...cs},groupName:{...as}},deleteConversationsFromGroup:{conversationIDList:{...cs},groupName:{...as}},getGroupList:{groupProfileFilter:{type:"Array"}},getGroupProfile:{groupID:as,groupCustomFieldFilter:{type:"Array"},memberCustomFieldFilter:{type:"Array"}},getGroupProfileAdvance:{groupIDList:cs},createGroup:{name:as},joinGroup:{groupID:as,type:{type:"String"},applyMessage:{type:"String"}},quitGroup:[{name:"groupID",...as}],handleApplication:{message:ls,handleAction:as,handleMessage:{type:"String"}},changeGroupOwner:{groupID:as,newOwnerID:as},updateGroupProfile:{groupID:as,muteAllMembers:{type:"Boolean"}},dismissGroup:[{name:"groupID",...as}],searchGroupByID:[{name:"groupID",...as}],getGroupOnlineMemberCount:[{name:"groupID",...as}],initGroupAttributes:{groupID:as,groupAttributes:{...ls,validator:(t,s,i)=>{let r=!0;return Object.keys(t).forEach(e=>{if(!ke(t[e]))return Ft({api:s,paramName:i,desc:Zt("value")}),r=!1}),r}}},setGroupAttributes:{groupID:as,groupAttributes:{...ls,validator:(t,s,i)=>{let r=!0;return Object.keys(t).forEach(e=>{if(!ke(t[e]))return Ft({api:s,paramName:i,desc:Zt("value")}),r=!1}),r}}},deleteGroupAttributes:{groupID:as,keyList:{type:"Array",validator:(e,s,i)=>{if($e(e)||!Fe(e))return Ft({api:s,paramName:i,desc:Ht()}),!1;if(Oe(e))return!0;{let t=!0;return e.forEach(e=>{if(!ke(e))return Ft({api:s,paramName:i,desc:gs("StringArrayRequiredLog")}),t=!1}),t}}}},getGroupAttributes:{groupID:as,keyList:{type:"Array",validator:(e,s,i)=>{if($e(e)||!Fe(e))return Ft({api:s,paramName:i,desc:Ht()}),!1;if(Oe(e))return!0;{let t=!0;return e.forEach(e=>{if(!ke(e))return Ft({api:s,paramName:i,desc:Zt("key")}),t=!1}),t}}}},setGroupCounters:{groupID:as,counters:ls},increaseGroupCounter:{groupID:as,key:as,value:ds},decreaseGroupCounter:{groupID:as,key:as,value:ds},getGroupCounters:{groupID:as},getGroupMemberList:{groupID:as,count:{type:"Number"}},getGroupMemberProfile:{groupID:as,userIDList:cs,memberCustomFieldFilter:{type:"Array"}},addGroupMember:{groupID:as,userIDList:cs},setGroupMemberRole:{groupID:as,userID:as,role:as},setGroupMemberMuteTime:{groupID:as,userID:as,muteTime:{type:"Number",validator:e=>0<=e}},setGroupMemberNameCard:{groupID:as,userID:{type:"String"},nameCard:{type:"String",validator:(e,t,s)=>ke(e)?(e.length,!0):(Ft({api:t,paramName:s,desc:$t()}),!1)}},setGroupMemberCustomField:{groupID:as,userID:{type:"String"},memberCustomField:cs},deleteGroupMember:{groupID:as},markGroupMemberList:{groupID:as,markType:{type:"number",validator:(e,t,s)=>Ge(e)?!(e<1e3&&(Ft({api:t,paramName:s,desc:Xt(s,1e3)}),1)):(Ft({api:t,paramName:s,desc:xt()}),!1)},userIDList:{...cs},enableMark:{...us}},createTextMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>be(e)?ke(e.text)?0!==e.text.length||(Ft({api:t,paramName:"payload.text",desc:es()}),!1):(Ft({api:t,paramName:"payload.text",desc:$t()}),!1):(Ft({api:t,paramName:s,desc:Qt()}),!1)}},createTextAtMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>be(e)?ke(e.text)?0===e.text.length?(Ft({api:t,paramName:"payload.text",desc:es()}),!1):!(e.atUserList&&!Fe(e.atUserList)&&(Ft({api:t,paramName:"payload.atUserList",desc:Ht()}),1)):(Ft({api:t,paramName:"payload.text",desc:$t()}),!1):(Ft({api:t,paramName:s,desc:Qt()}),!1)}},createCustomMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>be(e)?e.data&&!ke(e.data)?(Ft({api:t,paramName:"payload.data",desc:$t()}),!1):e.description&&!ke(e.description)?(Ft({api:t,paramName:"payload.description",desc:$t()}),!1):!(e.extension&&!ke(e.extension)&&(Ft({api:t,paramName:"payload.extension",desc:$t()}),1)):(Ft({api:t,paramName:"payload",desc:Qt()}),!1)}},createImageMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>{if(!be(e))return Ft({api:t,paramName:s,desc:Qt()}),!1;if($e(e.file))return Ft({api:t,paramName:"payload.file",desc:Vt()}),!1;if(F){if(!(e.file instanceof HTMLInputElement||Ue(e.file)))return be(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(Ft({api:t,paramName:"payload.file",desc:ts()}),!1):(Ft({api:t,paramName:"payload.file",desc:Bt()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Ft({api:t,paramName:"payload.file",desc:ts()}),!1}return!0},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Yt()}),!0)}}},createAudioMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>!!be(e)||(Ft({api:t,paramName:s,desc:Qt()}),!1)},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Yt()}),!0)}},createVideoMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>{if(!be(e))return Ft({api:t,paramName:s,desc:Qt()}),!1;if($e(e.file))return Ft({api:t,paramName:"payload.file",desc:Vt()}),!1;if(F){if(!(e.file instanceof HTMLInputElement||Ue(e.file)))return be(e.file)&&"undefined"!=typeof uni?!!Ue(e.file.tempFile)||(Ft({api:t,paramName:"payload.file",desc:ts()}),!1):(Ft({api:t,paramName:"payload.file",desc:Bt()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Ft({api:t,paramName:"payload.file",desc:ts()}),!1}return!0}},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Yt()}),!0)}},createFaceMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>be(e)?Ge(e.index)?!!ke(e.data)||(Ft({api:t,paramName:"payload.data",desc:$t()}),!1):(Ft({api:t,paramName:"payload.index",desc:xt()}),!1):(Ft({api:t,paramName:s,desc:Qt()}),!1)}},createFileMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>{if(!be(e))return Ft({api:t,paramName:s,desc:Qt()}),!1;if($e(e.file))return Ft({api:t,paramName:"payload.file",desc:Vt()}),!1;if(F){if(!(e.file instanceof HTMLInputElement||Ue(e.file)))return be(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(Ft({api:t,paramName:"payload.file",desc:ts()}),!1):(Ft({api:t,paramName:"payload.file",desc:Bt()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Ft({api:t,paramName:"payload.file",desc:ts()}),!1}return!0}},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Yt()}),!0)}},createLocationMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>be(e)?ke(e.description)?Ge(e.longitude)?!!Ge(e.latitude)||(Ft({api:t,paramName:"payload.latitude",desc:xt()}),!1):(Ft({api:t,paramName:"payload.longitude",desc:xt()}),!1):(Ft({api:t,paramName:"payload.description",desc:$t()}),!1):(Ft({api:t,paramName:s,desc:Qt()}),!1)}},createMergerMessage:{to:as,conversationType:as,payload:{...ls,validator:(e,t,s)=>{if(Oe(e.messageList))return Ft({api:t,paramName:"payload.messageList",desc:Wt()}),!1;if(Oe(e.compatibleText))return Ft({api:t,paramName:"payload.compatibleText",desc:qt("compatibleText")}),!1;let i=!1;return e.messageList.forEach(e=>{e.status===Pt&&(i=!0)}),!i||(Ft({api:t,paramName:"payload.messageList",desc:gs("MergeFailedMessageLog")}),!1)}}},revokeMessage:[{name:"message",...ls,validator:(e,s,i)=>Oe(e)?(Ft({api:s,paramName:i,desc:ss()}),!1):e.conversationType===t.CONV_SYSTEM?(Ft({api:s,paramName:i,desc:gs("MessageCanBeRevokedDesc")}),!1):!0!==e.isRevoked||(Ft({api:s,paramName:i,desc:gs("MessageRevokedLog")}),!1)}],deleteMessage:[{name:"messageList",...cs,validator:(e,t,s)=>!Oe(e)||(Ft({api:t,paramName:s,desc:Wt()}),!1)}],translateText:{sourceTextList:cs,sourceLanguage:as,targetLanguage:as},convertVoiceToText:{message:{...ls,validator:(e,s,i)=>Oe(e)?(Ft({api:s,paramName:i,desc:ss()}),!1):e.type===t.MSG_AUDIO&&e.status===Nt||(Ft({api:s,paramName:i,desc:gs("AudioMessageRequiredLog")}),!1)}},modifyMessage:[{name:"message",...ls,validator:(e,s,i)=>Oe(e)?(Ft({api:s,paramName:i,desc:ss()}),!1):e.conversationType===t.CONV_SYSTEM?(Ft({api:s,paramName:i,desc:gs("MessageCanBeModifiedLog")}),!1):!0!==e._onlineOnlyFlag||(Ft({api:s,paramName:i,desc:gs("OnlineMessageNotSupportLog")}),!1)}],searchCloudMessages:{keywordList:ps.keywordListForMsg,keywordListMatchType:ps.keywordListMatchType,cursor:ps.cursor,senderUserIDList:{type:"Array",required:!1,validator:(e,t,s)=>_s(e,t,s,{allowUndefined:!0,allowEmpty:!0,maxLength:5})},messageTypeList:{type:"Array",required:!1,validator:(e,s,i)=>{if(!e)return!0;if(!_s(e,s,i,{allowUndefined:!0,allowEmpty:!0}))return!1;let r=[t.MSG_TEXT,t.MSG_IMAGE,t.MSG_AUDIO,t.MSG_FILE,t.MSG_VIDEO,t.MSG_LOCATION,t.MSG_CUSTOM,t.MSG_MERGER];return!(0<e.filter(e=>-1===r.indexOf(e)).length&&(Ft({api:s,paramName:i,desc:rs(i,"message")}),1))}},conversationID:{type:"String",required:!1,validator:e=>!e||bt(e)},timePosition:{type:"number",required:!1,validator:(e,t,s)=>hs(e,t,s,{allowUndefined:!0,min:0})},timePeriod:{type:"number",required:!1,validator:(e,t,s)=>hs(e,t,s,{allowUndefined:!0,min:0})}},searchCloudUsers:{keywordList:ps.keywordListExceptMsg,keywordListMatchType:ps.keywordListMatchType,cursor:ps.cursor,count:ps.count,miniBirthday:{type:"Number",required:!1,validator:(e,t,s)=>hs(e,t,s,{allowUndefined:!0,min:0})},maxBirthday:{type:"Number",required:!1,validator:(e,t,s)=>hs(e,t,s,{allowUndefined:!0,min:0})},gender:{type:"String",required:!1,validator:(e,s,i)=>!e||e===t.GENDER_FEMALE||e===t.GENDER_MALE||Ft({api:s,paramName:i,desc:e+" is invalid match type"})}},searchCloudGroups:{keywordList:ps.keywordListExceptMsg,keywordListMatchType:ps.keywordListMatchType,cursor:ps.cursor,count:ps.count,groupTypeList:ps.groupTypeList},searchCloudGroupMembers:{keywordList:ps.keywordListExceptMsg,keywordListMatchType:ps.keywordListMatchType,cursor:ps.cursor,count:ps.count,groupTypeList:ps.groupTypeList,groupIDList:{type:"Array",required:!1,validator:(e,t,s)=>_s(e,t,s,{allowUndefined:!0,allowEmpty:!0})}},getUserProfile:{userIDList:{type:"Array",validator:(e,t,s)=>Fe(e)?(0===e.length&&Ft({api:t,paramName:s,desc:Wt()}),!0):(Ft({api:t,paramName:s,desc:Ht()}),!1)}},updateMyProfile:{profileCustomField:{type:"Array",validator:(e,t,s)=>!!$e(e)||!!Fe(e)||(Ft({api:t,paramName:s,desc:Ht()}),!1)}},setSelfStatus:{customStatus:{type:"String",validator:(e,t,s)=>!!ke(e)||(Ft({api:t,paramName:s,desc:$t()}),!1)}},getUserStatus:{userIDList:{type:"Array",validator:(e,t,s)=>Fe(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Wt()}),!1):(Ft({api:t,paramName:s,desc:Ht()}),!1)}},subscribeUserStatus:{userIDList:{type:"Array",validator:(e,t,s)=>Fe(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Wt()}),!1):(Ft({api:t,paramName:s,desc:Ht()}),!1)}},unsubscribeUserStatus:{userIDList:{type:"Array",validator:(e,t,s)=>!e||!!Fe(e)||(Ft({api:t,paramName:s,desc:Ht()}),!1)}},addFriend:{to:as,source:{type:"String",required:!0,validator:(e,t,s)=>!(!e||(e.startsWith("AddSource_Type_")?8<e.replace("AddSource_Type_","").length&&(Ft({api:t,paramName:s,desc:jt("keyword",8)}),1):(Ft({api:t,paramName:s,desc:gs("SourcePrefixLog")}),1)))},remark:{type:"String",required:!1,validator:(e,t,s)=>!(ke(e)&&96<e.length&&(Ft({api:t,paramName:s,desc:jt(s,96)}),1))}},deleteFriend:{userIDList:cs},checkFriend:{userIDList:cs},getFriendProfile:{userIDList:cs},updateFriend:{userID:as,remark:{type:"String",required:!1,validator:(e,t,s)=>!(ke(e)&&96<e.length&&(Ft({api:t,paramName:s,desc:jt(s,96)}),1))},friendCustomField:{type:"Array",required:!1,validator:(e,s,i)=>{if(e){if(!Fe(e))return Ft({api:s,paramName:i,desc:Ht()}),!1;let t=!0;return e.forEach(e=>ke(e.key)&&-1!==e.key.indexOf("Tag_SNS_Custom")?ke(e.value)?8<e.key.replace("Tag_SNS_Custom_","").length?(Ft({api:s,paramName:i,desc:jt("keyword",8)}),t=!1):void 0:(Ft({api:s,paramName:i,desc:Zt("value")}),t=!1):(Ft({api:s,paramName:i,desc:gs("FriendCustomFieldPrefixLog")}),t=!1)),t}return!0}}},acceptFriendApplication:{userID:as},refuseFriendApplication:{userID:as},deleteFriendApplication:{userID:as},createFriendGroup:{name:as},deleteFriendGroup:{name:as},addToFriendGroup:{name:as,userIDList:cs},removeFromFriendGroup:{name:as,userIDList:cs},renameFriendGroup:{oldName:as,newName:as},sendMessageReadReceipt:[{name:"messageList",type:"Array",validator:(e,t,s)=>Fe(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Wt()}),!1):(Ft({api:t,paramName:s,desc:Ht()}),!1)}],getMessageReadReceiptList:[{name:"messageList",type:"Array",validator:(e,t,s)=>Fe(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Wt()}),!1):(Ft({api:t,paramName:s,desc:Ht()}),!1)}],createTopicInCommunity:{groupID:as,topicName:as},deleteTopicFromCommunity:{groupID:as,topicIDList:{type:"Array",validator:(e,t,s)=>!e||!!Fe(e)||(Ft({api:t,paramName:s,desc:Ht()}),!1)}},updateTopicProfile:{groupID:as,topicID:as},getTopicList:{groupID:as,topicIDList:{type:"Array",validator:(e,t,s)=>!e||!!Fe(e)||(Ft({api:t,paramName:s,desc:Ht()}),!1)}},followUser:[{name:"userIDList",...cs}],unfollowUser:[{name:"userIDList",...cs}],getMyFollowingList:[{name:"startIndex",...as,required:!1}],getMyFollowersList:[{name:"startIndex",...as,required:!1}],getMutualFollowersList:[{name:"startIndex",...as,required:!1}],getUserFollowInfo:[{name:"userIDList",...cs,required:!1}],checkFollowType:[{name:"userIDList",...cs}],addSignalingListener:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:qt(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Kt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:is()}),!0)}],removeSignalingListener:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:qt(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Kt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:is()}),!0)}],invite:{userID:as},inviteSync:[{...ls,validator:(e,t,s)=>be(e)?!!ke(e.userID)||(Ft({api:t,paramName:"options.userID",desc:$t()}),!1):(Ft({api:t,paramName:"options",desc:Qt()}),!1)},{name:"successCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Kt()}),!0)},{name:"errorCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Kt()}),!0)}],inviteInGroup:{groupID:as,inviteeList:cs},inviteInGroupSync:[{...ls,validator:(e,t,s)=>be(e)?ke(e.groupID)?!!Fe(e.inviteeList)||(Ft({api:t,paramName:"options.inviteeList",desc:Ht()}),!1):(Ft({api:t,paramName:"options.groupID",desc:$t()}),!1):(Ft({api:t,paramName:"options",desc:Qt()}),!1)},{name:"successCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Kt()}),!0)},{name:"errorCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Kt()}),!0)}],accept:{inviteID:as},reject:{inviteID:as},getSignalingInfo:[{name:"message",...ls,validator:(e,t,s)=>!Oe(e)||(Ft({api:t,paramName:s,desc:ss()}),!1)}],modifyInvitation:{inviteID:as,data:as}},fs={login:1,logout:1,getLoginUser:1,getServerTime:1,on:1,once:1,off:1,setLogLevel:1,registerPlugin:1,destroy:1,isReady:1,createTextMessage:1,createTextAtMessage:1,createImageMessage:1,createAudioMessage:1,createVideoMessage:1,createCustomMessage:1,createFaceMessage:1,createFileMessage:1,createLocationMessage:1,createMergerMessage:1,downloadMergerMessage:1,createForwardMessage:1,sendMessage:1,resendMessage:1,revokeMessage:1,deleteMessage:1,translateText:1,convertVoiceToText:1,modifyMessage:1,sendMessageReadReceipt:1,getGroupMessageReadMemberList:1,getMessageReadReceiptList:1,setMessageExtensions:1,getMessageExtensions:1,deleteMessageExtensions:1,addMessageReaction:1,removeMessageReaction:1,getMessageReactions:1,getAllUserListOfMessageReaction:1,getMessageList:1,findMessage:1,getMessageListHopping:1,setMessageRead:1,setAllMessageRead:1,getConversationList:1,getConversationProfile:1,deleteConversation:1,setConversationDraft:1,pinConversation:1,getTotalUnreadMessageCount:1,setConversationCustomData:1,markConversation:1,createConversationGroup:1,getConversationGroupList:1,deleteConversationGroup:1,renameConversationGroup:1,addConversationsToGroup:1,deleteConversationsFromGroup:1,clearHistoryMessage:1,setMessageRemindType:1,setAllReceiveMessageOpt:1,getAllReceiveMessageOpt:1,getGroupList:1,getGroupProfile:1,createGroup:1,joinGroup:1,updateGroupProfile:1,quitGroup:1,dismissGroup:1,changeGroupOwner:1,searchGroupByID:1,getGroupApplicationList:1,handleGroupApplication:1,initGroupAttributes:1,setGroupAttributes:1,deleteGroupAttributes:1,getGroupAttributes:1,setGroupCounters:1,increaseGroupCounter:1,decreaseGroupCounter:1,getGroupCounters:1,getJoinedCommunityList:1,createTopicInCommunity:1,deleteTopicFromCommunity:1,updateTopicProfile:1,getTopicList:1,getGroupMemberProfile:1,getGroupMemberList:1,addGroupMember:1,deleteGroupMember:1,setGroupMemberNameCard:1,setGroupMemberMuteTime:1,setGroupMemberRole:1,setGroupMemberCustomField:1,getGroupOnlineMemberCount:1,markGroupMemberList:1,getMyProfile:1,getUserProfile:1,updateMyProfile:1,setSelfStatus:1,getUserStatus:1,subscribeUserStatus:1,unsubscribeUserStatus:1,getBlacklist:1,addToBlacklist:1,removeFromBlacklist:1,searchCloudMessages:1,searchCloudUsers:1,searchCloudGroups:1,searchCloudGroupMembers:1,getFriendList:1,addFriend:1,deleteFriend:1,checkFriend:1,updateFriend:1,getFriendProfile:1,getFriendApplicationList:1,refuseFriendApplication:1,deleteFriendApplication:1,acceptFriendApplication:1,setFriendApplicationRead:1,getFriendGroupList:1,createFriendGroup:1,renameFriendGroup:1,deleteFriendGroup:1,addToFriendGroup:1,removeFromFriendGroup:1,followUser:1,unfollowUser:1,getMyFollowingList:1,getMyFollowersList:1,getMutualFollowersList:1,getUserFollowInfo:1,checkFollowType:1,callExperimentalAPI:1,addSignalingListener:1,removeSignalingListener:1,invite:1,inviteSync:1,inviteInGroup:1,inviteInGroupSync:1,cancel:1,accept:1,reject:1,getSignalingInfo:1,modifyInvitation:1},Ms=1,Is=2,Cs=3,Ts=4,ys=6,vs=7,Es=8,Ss=10,Ds=11,Rs=12,Ls=13,As=14,Os=15,Ns=17,Ps=18,Us=19,Gs=20,ks=21,ws=23,bs=24,Fs=25,$s=26,qs=27,xs=28,Vs=29,Bs=30,Ks=31,Hs=32,Ws=33,Ys=34,zs=35,js=36,Js=37,Xs=38,Zs=function(e){return{code:0,data:e||{}}};class Qs extends Error{constructor(e){super();var{code:e,message:t,data:s}=e;this.code=e,t?this.message=t:this._getErrMsg&&(this.message=this._getErrMsg(this.code)),this.data=s||{}}}let ei={NO_SDKAPPID:2e3,NO_ACCOUNT_TYPE:2001,NO_IDENTIFIER:2002,NO_USERSIG:2003,NO_TINYID:2022,NO_A2KEY:2023,USER_NOT_LOGGED_IN:2024,REPEAT_LOGIN:2025,COS_UNDETECTED:2040,COS_GET_SIG_FAIL:2041,MSG_SEND_FAIL:2100,MSG_SEND_FAIL_NOT_IN_AV:2101,MSG_INSTANCE_REQUIRED:2105,MSG_INVALID_CONV_TYPE:2106,MSG_F_IS_EMPTY:2108,MSG_ONPROGRESS_ERR:2109,MSG_REVOKE_FAIL:2110,MSG_DELETE_FAIL:2111,MSG_UNREAD_ALL_FAIL:2112,READ_RECEIPT_MSG_LIST_EMPTY:2114,MSG_SEND_GRP_WITH_TOPIC_FAIL:2115,CANNOT_DELETE_GRP_SYSTEM_NOTICE:2116,TRANSLATE_TEXT_FAIL:2117,VOICE_TO_TEXT_FAIL:2118,UNSUPPORTED_VOICE_FORMAT:2119,MSG_I_SELECT_F_FIRST:2251,MSG_I_TYPES_LIMIT:2252,MSG_I_SIZE_LIMIT:2253,MSG_A_UPLOAD_FAIL:2300,MSG_A_SIZE_LIMIT:2301,MSG_V_UPLOAD_FAIL:2350,MSG_V_SIZE_LIMIT:2351,MSG_V_TYPES_LIMIT:2352,MSG_F_UPLOAD_FAIL:2400,MSG_F_SELECT_F_FIRST:2401,MSG_F_SIZE_LIMIT:2402,MSG_F_URL_IS_EMPTY:2403,MSG_MERGER_TYPE_INVALID:2450,MSG_MERGER_KEY_INVALID:2451,MSG_MERGER_DOWNLOAD_FAIL:2452,MSG_FORWARD_TYPE_INVALID:2453,MSG_FORWARD_INVALID_ELEMENTS:2454,MSG_MODIFY_CONFLICT:2480,MSG_MODIFY_DISABLED_IN_AV:2481,CONV_NOT_FOUND:2500,USER_OR_GRP_NOT_FOUND:2501,CONV_UN_RECORDED_TYPE:2502,INVALID_CONV_ID:2503,ILLEGAL_GRP_TYPE:2600,ILLEGAL_GRP_ID:2602,CANNOT_FIND_GRP:2603,CANNOT_CHANGE_OWNER_IN_AV:2620,CANNOT_CHANGE_OWNER_TO_SELF:2621,MEMBER_NOT_IN_GRP:2623,JOIN_GRP_FAIL:2660,CANNOT_ADD_MEMBER_IN_AV:2661,CANNOT_JOIN_NON_AV_WITHOUT_LOGIN:2662,NOT_OWNER:2681,INVALID_MEMBER_ROLE:2683,CANNOT_SET_SELF_MEMBER_ROLE:2684,CANNOT_MUTE_SELF:2685,BAN_DURATION_INVALID:2686,OPERATION_NOT_SUPPORTED_IN_AV:2687,NOT_MY_FRIEND:2700,ALREADY_MY_FRIEND:2701,FRIEND_GRP_EXISTED:2710,FRIEND_GRP_NOT_EXIST:2711,FRIEND_APPLICATION_NOT_EXIST:2716,UPDATE_PROFILE_INVALID_PARAM:2721,UPDATE_PROFILE_NO_KEY:2722,CANNOT_ADD_SELF_TO_BLACKLIST:2742,NETWORK_ERROR:2800,NETWORK_TIMEOUT:2801,NO_NETWORK:2805,UNCAUGHT_ERROR:2903,INVALID_OPERATION:2905,INVALID_TRTC_CMD:2995,OVER_FREQUENCY_LIMIT:2996,NO_PROTOCOL:2997,NO_MODULE:2998,SDK_IS_NOT_READY:2999,LOGGING_IN:3e3,LOGIN_FAILED:3001,KICKED_OUT_MULT_DEVICE:3002,KICKED_OUT_MULT_ACCOUNT:3003,KICKED_OUT_USERSIG_EXPIRED:3004,LOGGED_OUT:3005,KICKED_OUT_REST_API:3006,ILLEGAL_TOPIC_ID:3021,NO_USE:3122,PROFANITY_FOUND:3123,OPTIONS_IS_EMPTY:3153,MSG_A2KEY_EXPIRED:20002,ACCOUNT_A2KEY_EXPIRED:70001,HELLO_ANSWER_KICKED_OUT:1002,OPEN_SERVICE_OVERLOAD_ERROR:60022,SIGNALING_INVALID_INVITE_ID:8010,SIGNALING_NO_PERMISSION:8011,SIGNALING_ALREADY_EXISTS:8012,INVALID_CANCEL_MESSAGE:8020},ti=null,si=function(e){ti=e},ii=function(e){return Promise.resolve(Zs(e))},ni=function(t,s=!1){if(t instanceof Qs)return s&&null!==ti&&ti.emit(e.ERROR,t),Promise.reject(t);if(t instanceof Error){let t=new Qs({code:ei.UNCAUGHT_ERROR});return s&&null!==ti&&ti.emit(e.ERROR,t),Promise.reject(t)}return $e(t)||$e(t.code)?Promise.reject(new Qs({code:ei.UNCAUGHT_ERROR})):(t=new Qs(t),s&&null!==ti&&ti.emit(e.ERROR,t),Promise.reject(t))};class oi{constructor(e){this._m=e,this._n=""}isLoggedIn(){return this._m.get(Rs).isLoggedIn()}isOversea(){return this._m.get(Rs).isOversea()}isPrivateNetWork(){var e=this._m.get(Rs);return e.isPrivateNetWork()&&!e.getFileDownloadProxy()}getFileDownloadProxy(){return this._m.get(Rs).getFileDownloadProxy()}getDownloadFileAuthKey(){return this._m.get(Rs).getDownloadFileAuthKey()}getMyUserID(){return this._m.get(Rs).getUserID()}getMyTinyID(){return this._m.get(Rs).getTinyID()}getSDKAppID(){return this._m.get(Rs).getSDKAppID()}isIntl(){return this._m.get(Rs).isIntl()}isUsingChatCore(){return this._m.get(Rs).isUsingChatCore()}isDevMode(){return this._m.get(Rs).isDevMode()}get(e){return this._m.get(e)}getPlatform(){return V}getCloudConfig(e){return this._m.get(ws).getCloudConfig(e)}emitOEvt(e,t){this._m.getOEmitInst().emit(e,t)}emitIEvt(e,t){this._m.getIEmitInst().emit(e,t)}getIEmitInst(){return this._m.getIEmitInst()}req(e){return this._m.get(Gs).req(e)}canIUse(e){return this._m.get(qs).canIUse(e)}getErrMsg(e,t,s){return this._m.getErrMsg(e,t,s)}warn(e,t,s){e=this.getErrMsg(e,t,s);e&&Ce.w(e)}noUse(e){var t=ei.NO_USE;return ni({code:t,message:this.getErrMsg(t,e)})}}let ri={LOGIN:"wslogin",LOGOUT:"wslogout",HELLO:"wshello",KICK_OTHER:"KickOther",SYNC_UNREAD_MSG:"getmsg",SEND_C2C_MSG:"sendmsg",SEND_GRP_MSG:"send_group_msg",GET_USER_PROFILE:"portrait_get_all",UPDATE_MY_PROFILE:"portrait_set",GET_BL:"black_list_get",ADD_TO_BL:"black_list_add",RM_FROM_BL:"black_list_delete",GET_FD_LIST:"friend_get",GET_FD_PROFILE:"friend_get_specified",CHECK_FD:"friend_check",DEL_FD:"friend_delete",ADD_FD:"friend_add",UPDATE_FD:"friend_update",RESPOND_FD_APPLICATION:"friend_response",GET_FD_APPLICATION_LIST:"pendency_get",DEL_FD_APPLICATION:"pendency_delete",REFUSE_FD_APPLICATION:"pendency_refuse",REPORT_FD_APPLICATION:"pendency_report",GET_FD_GRP_LIST:"group_get",CREATE_FD_GRP:"group_add",DEL_FD_GRP:"group_delete",UPDATE_FD_GRP:"group_update",REVOKE_C2C_MSG:"msgwithdraw",SET_C2C_MSG_READ:"msgreaded",SET_C2C_PEER_MUTE_NOTIFICATIONS:"set_c2c_peer_mute_notifications",GET_C2C_PEER_MUTE_NOTIFICATIONS:"get_c2c_peer_mute_notifications",GET_C2C_ROAMING_MSG:"getroammsg",GET_C2C_PEER_READ_TIME:"get_peer_read_time",DEL_C2C_MSG:"delete_c2c_msg_ramble",MODIFY_C2C_MSG:"modify_c2c_msg",MODIFY_C2C_MSG_EXT:"set_key_values",GET_C2C_MSG_EXT:"get_key_values",ADD_C2C_MSG_REACTION:"reaction_add",RM_C2C_MSG_REACTION:"reaction_del",GET_C2C_MSG_REACTIONS:"reaction_multi_stat",GET_C2C_MSG_REACTION_USER_LIST:"reaction_iterate",PAGING_GET_CONV_LIST:"page_get",DEL_CONV:"batch_delete",CLEAR_HISTORY_MSG:"clear_msg",PIN_CONV:"top",DEL_GROUP_AT_TIPS:"deletemsg",SET_CONV_CUSTOM_DATA:"set_conv_custom_data",MARK_CONV:"mark_contact",CREATE_CONV_GRP:"create_contact_group",DEL_CONV_GRP:"del_contact_group",RENAME_CONV_GRP:"update_contact_group",ADD_CONV_TO_GRP:"add_conv_to_group",DEL_CONV_FROM_GRP:"del_conv_from_group",GET_CONV_GRP_LIST:"get_contact_group",SEARCH_CONV_GRP_MARK:"search_contact_group",GET_GRP_LIST:"get_joined_group_list",GET_GRP_PROFILE:"get_group_self_member_info",CREATE_GRP:"create_group",DISMISS_GRP:"destroy_group",UPDATE_GRP_PROFILE:"modify_group_base_info",APPLY_JOIN_GRP:"apply_join_group",APPLY_JOIN_GRP_NOAUTH:"apply_join_group_noauth",QUIT_GRP:"quit_group",SEARCH_GRP:"get_group_public_info",CHANGE_GRP_OWNER:"change_group_owner",HANDLE_GRP_APPLICATION:"handle_apply_join_group",HANDLE_INVITE_JOIN_GRP:"handle_invite_join_permission_group",HANDLE_GRP_INVITATION:"handle_invite_join_group",REVOKE_GRP_MSG:"group_msg_recall",SET_GRP_MSG_READ:"msg_read_report",SET_ALL_MSG_READ:"read_all_unread_msg",GET_GRP_ROAMING_MSG:"group_msg_get",GET_READ_RECEIPT:"get_group_msg_receipt",SEND_READ_RECEIPT:"group_msg_receipt",SEND_C2C_READ_RECEIPT:"c2c_msg_read_receipt",GET_READ_RECEIPT_DETAIL:"get_group_msg_receipt_detail",GET_GRP_RECEIPTS_BY_USERS:"get_group_msg_receipts_by_users",GET_GRP_PENDENCY:"get_pendency",DEL_GRP_SYSTEM_NOTICE:"deletemsg",AV_POLLING:"get_msg",AV_NOAUTH_POLLING:"get_msg_noauth",GET_ONLINE_MBR_NUM:"get_online_member_num",DEL_GRP_MSG:"delete_group_ramble_msg_by_seq",MODIFY_GRP_MSG:"modify_group_msg",SET_GRP_ATTR:"set_group_attr",MODIFY_GRP_ATTR:"modify_group_attr",DEL_GRP_ATTR:"delete_group_attr",CLEAR_GRP_ATTR:"clear_group_attr",GET_GRP_ATTR:"get_group_attr",MODIFY_GRP_MSG_EXT:"group_set_key_values",GET_GRP_MSG_EXT:"group_get_key_values",GET_GRP_NOTIFY:"batch_get_group_notify",UPDATE_GRP_COUNTER:"update_group_counter",GET_GRP_COUNTER:"get_group_counter",ADD_GRP_MSG_REACTION:"group_reaction_add",RM_GRP_MSG_REACTION:"group_reaction_del",GET_GRP_MSG_REACTIONS:"group_reaction_multi_stat",GET_GRP_MSG_REACTION_USER_LIST:"group_reaction_iterate",GET_GRP_MBR_LIST:"get_group_member_info",GET_AV_MBR_LIST:"get_members",GET_GRP_MBR_PROFILE:"get_specified_group_member_info",ADD_GRP_MBR:"add_group_member",DEL_GRP_MBR:"delete_group_member",BAN_AV_MBR:"ban_group_member",MODIFY_GRP_MBR_INFO:"modify_group_member_info",MARK_AV_MBR_INFO:"modify_user_info",COS_SIGN:"cos",COS_PRE_SIG:"pre_sig",SIMPLE_COS_PRE_SIG:"simple_sig",GET_IMAGE_INFO:"get_imageinfo",GET_IP:"get_final_ip",VIDEO_COVER:"video_cover",SSO_STAT:"tim_web_report_v2",PING:"alive",MSG_PUSH:"msg_push",CS:"query",GRP_CS:"query_grp",MBR_CS:"query_grp_member",USER_CS:"query_user",MULTI_MSG_PUSH:"multi_msg_push_ws",MSG_PUSH_ACK:"ws_msg_push_ack",STATUS_FORCE_OFFLINE:"stat_forceoffline",UPLOAD_MERGER_MSG:"save_relay_json_msg",DOWNLOAD_MERGER_MSG:"get_relay_json_msg",FETCH_CLOUD_CTRL_CONFIG:"fetch_config",PUSHED_CLOUD_CTRL_CONFIG:"push_configv2",FETCH_COMMERCIAL_CONFIG:"fetch_imsdk_purchase_bitsv2",PUSHED_COMMERCIAL_CONFIG:"push_imsdk_purchase_bitsv2",OVERLOAD_NOTIFY:"notify2",CREATE_TOPIC:"create_topic",DEL_TOPIC:"destroy_topic",UPDATE_TOPIC_PROFILE:"modify_topic",GET_TOPIC_LIST:"get_topic",SET_SELF_STATUS:"ws_set_custom_status",GET_USER_STATUS:"ws_get_user_status",SUB_USER_STATUS:"ws_status_subscribe",UNSUB_USER_STATUS:"ws_status_unsubscribe",STAT_BACKGROUND:"ws_stat_background",STAT_FOREGROUND:"ws_stat_foreground",SET_TOKEN:"ws_stat_settoken",PUSH_REPORT:"uniapp_sdk_report",GET_PROFANITY_LIST:"get_local_words",TRANSLATE_TEXT:"ws_batch_trans_text",VOICE_TO_TEXT:"ws_sentence_recognition",FOLLOW:"follow_add",UNFOLLOW:"follow_delete",GET_FOLLOW:"follow_get",GET_FOLLOW_INFO:"follow_get_info",CHECK_FOLLOW_TYPE:"follow_check",SET_ALL_RECEIVE_MSG_OPT:"ws_set_do_not_disturb",GET_ALL_RECEIVE_MSG_OPT:"ws_get_do_not_disturb"},ai="networkRTT",ci="messageE2EDelay",li="sendMessageC2C",ui="sendMessageGroup",di="sendMessageGroupAV",_i="sendMessageRichMedia",hi="cosUpload",pi="messageReceivedGroup",gi="messageReceivedGroupAVPush",mi="messageReceivedGroupAVPull",fi={[ai]:2,[ci]:3,[li]:4,[ui]:5,[di]:6,[_i]:7,[pi]:8,[gi]:9,[mi]:10,[hi]:11},Mi={info:4,warning:5,error:6},Ii={wifi:1,"2g":2,"3g":3,"4g":4,"5g":5,unknown:6,none:7,online:8},Ci={login:4,plugin_search:16,plugin_translate:16,plugin_voice_to_text:16,plugin_cs:16,plugin_push:16,plugin_bot:16,plugin_emoji_reaction:16,tui_key_features:16};class Ti{constructor(e){this._n="SSOLogData",this.eventType=Ci[e]||0,this.timestamp=0,this.networkType=8,this.code=0,this.message="",this.moreMessage="",this.extension=e,this.costTime=0,this.duplicate=!1,this.level=4,this.uiPlatform=void 0,this._sentFlag=!1,this._startts=pe()}static bindEventStatModule(e){Ti.prototype._eventStatModule=e}static bindNetMonitorModule(e){Ti.prototype._netMonitorModule=e}updateTimeStamp(){this.timestamp=pe()}start(e){return this._startts=e,this}end(e=!1){if(!this._sentFlag){if(this._netMonitorModule){let e=this._netMonitorModule.getNetworkType();this.setNetworkType(e)}var t=pe();0===this.costTime&&(this.costTime=t-this._startts),this.setMoreMessage(`startts:${this._startts} endts:`+t),e?(this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)):setTimeout(()=>{this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)},0)}}setError(t){if(t instanceof Error){if(!this._sentFlag){let e=!0;if(e=this._netMonitorModule?this._netMonitorModule.isOnline():e)t.code&&this.setCode(t.code),t.message&&this.setMoreMessage(t.message);else{let e=ei.NO_NETWORK;this.setCode(e)}this.setLevel("error")}}else Ce.w(this._n+".setError value not instanceof Error, please check!");return this}setCode(e){return $e(e)||this._sentFlag||("ECONNABORTED"===e&&(this.code=103),Ge(e)?this.code=e:Ce.w(this._n+".setCode value not a number, please check!",e,typeof e)),this}setMessage(e){return $e(e)||this._sentFlag||(Ge(e)&&(this.message=e.toString()),ke(e)&&(this.message=e)),this}setCostTime(e){return this.costTime=e,this}setLevel(e){return $e(e)||this._sentFlag||(this.level=Mi[e]),this}setMoreMessage(e){return Oe(this.moreMessage)?this.moreMessage=""+e:this.moreMessage+=" "+e,this}setNetworkType(e){return $e(e)?Ce.w(this._n+".setNetworkType value is undefined, please check!"):(e=Ii[e.toLowerCase()],$e(e)||(this.networkType=e)),this}getStartTs(){return this._startts}setUIPlatform(e){return this.uiPlatform=e,this}setExtension(e){return this.extension=e,this}setEventType(e){return this.eventType=e,this}}class yi{constructor(e){this.type=t.MSG_TEXT,this.content={text:e.text||""}}setText(e){this.content.text=e}sendable(){return 0!==this.content.text.length}}function vi(e,t,s,i=[]){if(!e)return e;let r=e;return t&&(e.startsWith("http://")?r=e.replace(/^http:\/\/[^/]+/,t):e.startsWith("https://")&&(r=e.replace(/^https:\/\/[^/]+/,t))),r=s&&-1===r.indexOf("authKey=")&&Di(r,i)?-1<r.indexOf("?")?r+"&authKey="+s:r+"?authKey="+s:r}function Ei(e,s,i=[]){var r=s[0].content||s[0].payload;if(e===t.MSG_IMAGE)r.imageInfoArray.forEach(e=>{Di(e.imageUrl,i)&&(e.imageUrl=Si(e.imageUrl))});else if(e===t.MSG_VIDEO)Di(r.snapshotUrl,i)&&(r.snapshotUrl=Si(r.snapshotUrl),r.thumbUrl=Si(r.thumbUrl)),Di(r.remoteVideoUrl,i)&&(r.remoteVideoUrl=Si(r.remoteVideoUrl));else if(e===t.MSG_AUDIO)Di(r.remoteAudioUrl,i)&&(r.remoteAudioUrl=Si(r.remoteAudioUrl));else if(e===t.MSG_FILE)Di(r.fileUrl,i)&&(r.fileUrl=Si(r.fileUrl));else if(e===t.MSG_MERGER){let{downloadKey:e="",messageList:t=[]}=s[0].content||s[0].payload;Oe(e)&&t.forEach(e=>{Ei(e.messageBody[0].type,e.messageBody,i)})}return s}function Si(e){if(!e)return e;if(-1===e.indexOf("authKey="))return e;var e=e.split("?"),t=e[1].split("&");let s=0;for(let e=0;e<t.length;e++)if(-1<t[e].indexOf("authKey=")){s=e;break}return t.splice(s,1),0<t.length?e[0]+"?"+t.join("&"):e[0]}function Di(e,t){let s=!1;if(e){var e=e.match(/:\/\/([0-9]?\.)?(.[^/:]+)/),i=e&&e[2]||"";if(i.includes("rich-dev"))return!0;for(let e=0;e<t.length;e++)if(i.endsWith(t[e])){s=!0;break}}return s}class Ri{constructor(e,s,i,r){this._imageMemoryURL="",this._fileDownloadProxy=s,this._authKey=i,this._fileDNList=r,k||b?this.createImageDataASURL(e.file):this.createImageDataASURLInWeb(e.file),this._initImageInfoModel(),this.type=t.MSG_IMAGE,this._percent=0,this.content={imageFormat:e.imageFormat||Te.UNKNOWN,uuid:e.uuid,imageInfoArray:[]},this.initImageInfoArray(e.imageInfoArray),this._autoFixUrl()}_initImageInfoModel(){let t=this;this._ImageInfoModel=function(e){this.instanceID=je(9999999),this.sizeType=e.type||0,this.type=0,this.size=e.size||0,this.width=e.width||0,this.height=e.height||0,this.imageUrl=e.imageUrl||e.url||"",this.url=vi(e.url||t._imageMemoryURL,t._fileDownloadProxy,t._authKey,t._fileDNList)},this._ImageInfoModel.prototype={setSizeType(e){this.sizeType=e},setType(e){this.type=e},setImageUrl(e){e&&(this.imageUrl=vi(e,t._fileDownloadProxy,t._authKey,t._fileDNList))},getImageUrl(){return this.imageUrl}}}initImageInfoArray(e){let t=0,s=null,i;for(;t<=2;)i=$e(e)||$e(e[t])?{type:0,size:0,width:0,height:0,url:""}:e[t],(s=new this._ImageInfoModel(i)).setSizeType(t+1),s.setType(t),this.addImageInfo(s),t++;this.updateAccessSideImageInfoArray()}updateImageInfoArray(t){var s,i=this.content.imageInfoArray.length;for(let e=0;e<i;e++)s=this.content.imageInfoArray[e],t[e].size&&(s.size=t[e].size),t[e].url&&s.setImageUrl(t[e].url),t[e].width&&(s.width=t[e].width),t[e].height&&(s.height=t[e].height)}_autoFixUrl(){var t=this.content.imageInfoArray.length;let s="",i="";var r=["http","https"],o=null;for(let e=0;e<t;e++)this.content.imageInfoArray[e].url&&""!==(o=this.content.imageInfoArray[e]).imageUrl&&(i=o.imageUrl.slice(0,o.imageUrl.indexOf("://")+1),s=o.imageUrl.slice(o.imageUrl.indexOf("://")+1),r.indexOf(i)<0&&(i="https:"),this.content.imageInfoArray[e].setImageUrl([i,s].join("")))}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateImageFormat(e){this.content.imageFormat=Te[e.toUpperCase()]||Te.UNKNOWN}createImageDataASURLInWeb(e){void 0!==e&&0<e.files.length&&(this._imageMemoryURL=window.URL.createObjectURL(e.files[0]))}createImageDataASURL(e){e&&e.url&&(this._imageMemoryURL=e.url)}replaceImageInfo(e,t){this.content.imageInfoArray[t]instanceof this._ImageInfoModel||(this.content.imageInfoArray[t]=e)}addImageInfo(e){3<=this.content.imageInfoArray.length||this.content.imageInfoArray.push(e)}updateAccessSideImageInfoArray(){var e=this.content.imageInfoArray,{width:t=0,height:s=0}=e[0];0!==t&&0!==s&&(mt(e),Object.assign(e[2],gt({originWidth:t,originHeight:s,min:720})))}sendable(){return 0!==this.content.imageInfoArray.length&&""!==this.content.imageInfoArray[0].imageUrl&&0!==this.content.imageInfoArray[0].size}}class Li{constructor(e){this.type=t.MSG_FACE,this.content=e||null}sendable(){return null!==this.content}}class Ai{constructor(e,s,i,r){this.type=t.MSG_AUDIO,this._percent=0,this._fileDownloadProxy=s,this._authKey=i,this._fileDNList=r,this.content={downloadFlag:2,second:e.second,size:e.size,url:vi(e.url,this._fileDownloadProxy,this._authKey,this._fileDNList),remoteAudioUrl:vi(e.url||"",this._fileDownloadProxy,this._authKey,this._fileDNList),uuid:e.uuid}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateAudioUrl(e){this.content.remoteAudioUrl=vi(e,this._fileDownloadProxy,this._authKey,this._fileDNList)}sendable(){return""!==this.content.remoteAudioUrl}}let Oi={from:!0,groupID:!0,groupName:!0,to:!0};class Ni{constructor(e){this.type=t.MSG_GRP_TIP,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"remarkInfo":break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;case"operatorInfo":this.content.operatorInfo={},this._initOperatorInfo(t[e]);break;case"memberInfoList":case"msgMemberInfo":this._updateMemberList(t[e]);break;case"memberExtraInfo":case"onlineMemberInfo":break;case"memberNum":this.content[e]=t[e],this.content.memberCount=t[e];break;case"newGroupProfile":this.content.newGroupProfile={},this._initNewGroupProfile(t[e]);break;default:this.content[e]=t[e]}}),this.content.userIDList||(this.content.userIDList=[this.content.operatorID])}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];Oi[i]&&(this.content.groupProfile[i]=t[i])}}_initOperatorInfo(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];this.content.operatorInfo[i]=t[i]}}_updateMemberList(e){Oe(this.content.memberList)?this.content.memberList=e:this.content.memberList.forEach(t=>{e.forEach(e=>{t.userID===e.userID&&Object.assign(t,e)})})}_initNewGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];this.content.newGroupProfile[i]="muteAllMembers"!==i?t[i]:1===t[i]}}}let Pi={from:!0,groupID:!0,groupName:!0,to:!0,groupType:!0};class Ui{constructor(e){this.type=t.MSG_GRP_SYS_NOTICE,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"memberInfoList":break;case"remarkInfo":this.content.handleMessage=t[e];break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;default:this.content[e]=t[e]}})}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];Pi[i]&&("groupName"===i?this.content.groupProfile.name=t[i]:this.content.groupProfile[i]=t[i])}}}class Gi{constructor(e,s,i,r){this.type=t.MSG_FILE,this._percent=0;var o=this._getFileInfo(e);this.content={downloadFlag:2,fileUrl:vi(e.url||e.fileUrl,s,i,r)||"",uuid:e.uuid,fileName:o.name||"",fileSize:o.size||0}}_getFileInfo(e){if(!$e(e.fileName)&&!$e(e.fileSize))return{size:e.fileSize,name:e.fileName};var t=e.file.files[0];if(P){if(t.path&&-1!==t.path.indexOf(".")){let e=t.path.slice(t.path.lastIndexOf(".")+1).toLowerCase();t.type=e,t.name||(t.name=je(999999)+"."+e)}t.name||(t.type="",t.name=t.path.slice(t.path.lastIndexOf("/")+1).toLowerCase()),t.suffix&&(t.type=t.suffix),t.url||(t.url=t.path)}return{size:t.size,name:t.name}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateFileUrl(e){this.content.fileUrl=e}sendable(){return""!==this.content.fileUrl&&""!==this.content.fileName&&0!==this.content.fileSize}}class ki{constructor(e){this.type=t.MSG_CUSTOM,this.content={data:e.data||"",description:e.description||"",extension:e.extension||""}}setData(e){return this.content.data=e,this}setDescription(e){return this.content.description=e,this}setExtension(e){return this.content.extension=e,this}sendable(){return 0!==this.content.data.length||0!==this.content.description.length||0!==this.content.extension.length}}class wi{constructor(e,s,i,r){this.type=t.MSG_VIDEO,this._percent=0,this._fileDownloadProxy=s,this._authKey=i,this._fileDNList=r,this.content={remoteVideoUrl:vi(e.remoteVideoUrl||e.videoUrl||"",this._fileDownloadProxy,this._authKey,this._fileDNList),videoFormat:e.videoFormat,videoSecond:parseInt(e.videoSecond,10),videoSize:e.videoSize,videoUrl:vi(e.videoUrl,this._fileDownloadProxy,this._authKey,this._fileDNList),videoDownloadFlag:2,videoUUID:e.videoUUID,thumbUUID:e.thumbUUID,thumbFormat:e.thumbFormat,thumbWidth:e.thumbWidth,snapshotWidth:e.thumbWidth,thumbHeight:e.thumbHeight,snapshotHeight:e.thumbHeight,thumbSize:e.thumbSize,snapshotSize:e.thumbSize,thumbDownloadFlag:2,thumbUrl:vi(e.thumbUrl,this._fileDownloadProxy,this._authKey,this._fileDNList),snapshotUrl:vi(e.thumbUrl,this._fileDownloadProxy,this._authKey,this._fileDNList)}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateVideoUrl(e){e&&(this.content.remoteVideoUrl=vi(e,this._fileDownloadProxy,this._authKey,this._fileDNList))}updateSnapshotInfo(e){var{snapshotUrl:e,snapshotWidth:t,snapshotHeight:s}=e;Oe(e)||(this.content.thumbUrl=this.content.snapshotUrl=e),Oe(t)||(this.content.thumbWidth=this.content.snapshotWidth=Number(t)),Oe(s)||(this.content.thumbHeight=this.content.snapshotHeight=Number(s))}sendable(){return""!==this.content.remoteVideoUrl}}class bi{constructor(e){this.type=t.MSG_LOCATION;var{description:e,longitude:s,latitude:i}=e;this.content={description:e,longitude:s,latitude:i}}sendable(){return!0}}class Fi{constructor(e,s,i,r){var o,n;this.from=e.from,this.messageSender=e.from,this.time=e.time,this.messageSequence=e.sequence,this.clientSequence=e.clientSequence||e.sequence,this.messageRandom=e.random,this.cloudCustomData=e.cloudCustomData||"",this.clientTime=e.clientTime||void 0,e.ID?(this.ID=e.ID||"",this.nick=e.nick||"",this.avatar=e.avatar||"",e.messageBody?this.messageBody=JSON.parse(JSON.stringify(e.messageBody)):this.messageBody=[{type:e.type,payload:e.payload}],e.conversationType?e.conversationType.startsWith(t.CONV_C2C)?this.receiverUserID=e.to:e.conversationType.startsWith(t.CONV_GROUP)&&(this.receiverGroupID=e.to):e.receiverGroupID?this.receiverGroupID=e.receiverGroupID:e.receiverUserID&&(this.receiverUserID=e.receiverUserID),this.messageReceiver=e.to||e.messageReceiver):(this.nick=e.nick||"",this.avatar=e.avatar||"",this.messageBody=[],o=e.elements[0].type,n=e.elements[0].content,this._patchRichMediaPayload(o,n),this._updateRichMediaDownloadUrl(o,n,s,i,r),o===t.MSG_MERGER?this.messageBody.push({type:o,payload:new $i(n,s,i,r).content}):this.messageBody.push({type:o,payload:n}),e.groupID&&(this.receiverGroupID=e.groupID,this.messageReceiver=e.groupID),e.to&&(this.receiverUserID=e.to,this.messageReceiver=e.to),this.ID=`${e.tinyID}-${e.clientTime}-`+e.random)}_patchRichMediaPayload(e,s){e===t.MSG_IMAGE?s.imageInfoArray.forEach(e=>{!e.imageUrl&&e.url&&(e.imageUrl=e.url,e.sizeType=e.type,1===e.type?e.type=0:3===e.type&&(e.type=1))}):e===t.MSG_VIDEO?!s.remoteVideoUrl&&s.videoUrl&&(s.remoteVideoUrl=s.videoUrl):e===t.MSG_AUDIO?!s.remoteAudioUrl&&s.url&&(s.remoteAudioUrl=s.url):e===t.MSG_FILE&&!s.fileUrl&&s.url&&(s.fileUrl=s.url,s.url=void 0)}_updateRichMediaDownloadUrl(e,s,i,r,o){(i||r)&&(e===t.MSG_IMAGE?s.imageInfoArray.forEach(e=>{e.imageUrl=vi(e.imageUrl,i,r,o),e.url=vi(e.url,i,r,o)}):e===t.MSG_VIDEO?(s.remoteVideoUrl=vi(s.remoteVideoUrl,i,r,o),s.videoUrl=vi(s.videoUrl,i,r,o),s.thumbUrl=vi(s.thumbUrl,i,r,o),s.snapshotUrl=vi(s.thumbUrl,i,r,o),s.snapshotHeight=s.thumbHeight,s.snapshotWidth=s.thumbWidth):e===t.MSG_AUDIO?(s.remoteAudioUrl=vi(s.remoteAudioUrl,i,r,o),s.url=vi(s.url,i,r,o)):e===t.MSG_FILE&&(s.fileUrl=vi(s.fileUrl,i,r,o)))}}var $i=class{constructor(n,a,l,d){if(this.type=t.MSG_MERGER,this.content={downloadKey:"",pbDownloadKey:"",messageList:[],title:"",abstractList:[],compatibleText:"",version:0,layersOverLimit:!1},n.downloadKey){let{downloadKey:e,pbDownloadKey:t,title:s,abstractList:i,compatibleText:r,version:o}=n;this.content.downloadKey=e,this.content.pbDownloadKey=t,this.content.title=s,this.content.abstractList=i,this.content.compatibleText=r,this.content.version=o||0}else if(Oe(n.messageList))1===n.layersOverLimit&&(this.content.layersOverLimit=!0);else{let{messageList:e,title:t,abstractList:s,compatibleText:i,version:r}=n,o=[];e.forEach(e=>{Oe(e)||(e=new Fi(e,a,l,d),o.push(e))}),this.content.messageList=o,this.content.title=t,this.content.abstractList=s,this.content.compatibleText=i,this.content.version=r||0}}sendable(){return!Oe(this.content.messageList)||!Oe(this.content.downloadKey)}};let qi={1:t.MSG_PRIORITY_HIGH,2:t.MSG_PRIORITY_NORMAL,3:t.MSG_PRIORITY_LOW,4:t.MSG_PRIORITY_LOWEST};class xi{constructor(e){this.ID="",this.conversationID=e.conversationID||null,this.conversationType=e.conversationType||t.CONV_C2C,this.conversationSubType=e.conversationSubType,this.time=e.time||Math.ceil(Date.now()/1e3),this.sequence=e.sequence||0,this.clientSequence=e.clientSequence||e.sequence||0,this.random=e.random||0===e.random?e.random:je(),this.priority=this._computePriority(e.priority),this.nick=e.nick||"",this.avatar=e.avatar||"",this.isPeerRead=!1,this.nameCard="",this.hasRiskContent=Rt(e.checkResult),this._elements=[],this.isPlaceMessage=e.isPlaceMessage||0,this.isRevoked=2===e.isPlaceMessage||8===e.msgFlagBits,this.from=e.from||null,this.to=e.to||null,this.flow="",this.isSystemMessage=e.isSystemMessage||!1,this.protocol=e.protocol||"JSON",this.isResend=!1,this.isRead=!1,this.status=e.status||Nt,this._onlineOnlyFlag=!1,this._groupAtInfoList=[],this._relayFlag=!1,this.atUserList=[],this.cloudCustomData=e.cloudCustomData||"",this.isDeleted=!1,this.isModified=!!e.messageVersion,this._isExcludedFromUnreadCount=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromUnreadCount),this._isExcludedFromLastMessage=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromLastMessage),this.clientTime=e.clientTime||me()||0,this.senderTinyID=e.senderTinyID||e.tinyID||"",this.readReceiptInfo=e.readReceiptInfo||{readCount:void 0,unreadCount:void 0,isPeerRead:void 0,timestamp:0},this.needReadReceipt=!0===e.needReadReceipt||1===e.needReadReceipt,this.version=e.messageVersion||0,this.isBroadcastMessage=e.isBroadcastMessage||!1,this._receiverList=e.receiverList||void 0,this.isSupportExtension=!0===e.isSupportExtension||1===e.isSupportExtension,this._cmConfigID=e.customModerationConfigurationID,this.revoker=e.revokerInfo&&e.revokerInfo.revoker||"",this.revokerInfo=e.revokerInfo||{userID:"",nick:"",avatar:""},this.revokeReason=e.revokeReason||"",this.reInitialize(e.currentUser),this.extractGroupInfo(e.groupProfile||null),this.handleGroupAtInfo(e),this.initC2CReadReceiptInfo(e)}get elements(){return this._elements}getElements(){return this._elements}extractGroupInfo(e){null!==e&&(ke(e.nick)&&(this.nick=e.nick),ke(e.avatar)&&(this.avatar=e.avatar),e=e.messageFromAccountExtraInformation,be(e))&&ke(e.nameCard)&&(this.nameCard=e.nameCard)}handleGroupAtInfo(e){e.payload&&e.payload.atUserList&&e.payload.atUserList.forEach(e=>{e!==t.MSG_AT_ALL?(this._groupAtInfoList.push({groupAtAllFlag:0,groupAtUserID:e}),this.atUserList.push(e)):(this._groupAtInfoList.push({groupAtAllFlag:1}),this.atUserList.push(t.MSG_AT_ALL))}),Fe(e.groupAtInfo)&&e.groupAtInfo.forEach(e=>{0===e.groupAtAllFlag?this.atUserList.push(e.groupAtUserID):1===e.groupAtAllFlag&&this.atUserList.push(t.MSG_AT_ALL)})}getGroupAtInfoList(){return this._groupAtInfoList}_initProxy(){this._elements[0]&&(this.payload=this._elements[0].content,this.type=this._elements[0].type)}reInitialize(e){e&&(this.status=this.from?Nt:Ot,!this.from)&&(this.from=e),this._initFlow(e),this._initSequence(e),this._concatConversationID(e),this.generateMessageID()}isSendable(){return 0!==this._elements.length&&(!0===this._relayFlag||"function"==typeof this._elements[0].sendable&&this._elements[0].sendable())}_initTo(e){this.conversationType===t.CONV_GROUP&&(this.to=e.groupID)}_initSequence(e){0===this.clientSequence&&e&&(this.clientSequence=function(i){if(!i)return!1;if(void 0===Qe[i]){var r=new Date;let e=("3"+r.getHours()).slice(-2),t=("0"+r.getMinutes()).slice(-2),s=("0"+r.getSeconds()).slice(-2);Qe[i]=parseInt([e,t,s,"0001"].join("")),e=null,t=null,s=null,Ce.l("autoIncrementIndex start index:"+Qe[i])}return Qe[i]++}(e)),0===this.sequence&&this.conversationType===t.CONV_C2C&&(this.sequence=this.clientSequence)}generateMessageID(){this.from===t.CONV_SYSTEM&&(this.senderTinyID="144115198244471703"),this.ID=`${this.senderTinyID}-${this.clientTime}-`+this.random}_initFlow(e){""!==e&&(e===this.from?(this.flow="out",this.isRead=!0):this.flow="in")}_concatConversationID(e){var s=this["to"],i=this.conversationType;i!==t.CONV_SYSTEM?(e=i===t.CONV_C2C?e===this.from?s:this.from:this.to,this.conversationID=e?""+i+e:null):this.conversationID=t.CONV_SYSTEM}isElement(e){return e instanceof yi||e instanceof Ri||e instanceof Li||e instanceof Ai||e instanceof Gi||e instanceof wi||e instanceof Ni||e instanceof Ui||e instanceof ki||e instanceof bi||e instanceof $i}setElement(s,i,r,o){if(this.isElement(s))this._elements=[s];else{var n=e=>{if(e.type&&e.content)switch(e.type){case t.MSG_TEXT:this.setTextElement(e.content);break;case t.MSG_IMAGE:this.setImageElement(e.content,i,r,o);break;case t.MSG_AUDIO:this.setAudioElement(e.content,i,r,o);break;case t.MSG_FILE:this.setFileElement(e.content,i,r,o);break;case t.MSG_VIDEO:this.setVideoElement(e.content,i,r,o);break;case t.MSG_CUSTOM:this.setCustomElement(e.content);break;case t.MSG_LOCATION:this.setLocationElement(e.content);break;case t.MSG_GRP_TIP:this.setGroupTipElement(e.content);break;case t.MSG_GRP_SYS_NOTICE:this.setGroupSystemNoticeElement(e.content);break;case t.MSG_FACE:this.setFaceElement(e.content);break;case t.MSG_MERGER:this.setMergerElement(e.content,i,r,o)}};if(Fe(s))for(let e=0;e<s.length;e++)n(s[e]);else n(s)}this._initProxy()}clearElement(){this._elements.length=0}setTextElement(e){e="string"==typeof e?e:e.text,e=new yi({text:e});this._elements.push(e)}setImageElement(e,t,s,i){e=new Ri(e,t,s,i);this._elements.push(e)}setAudioElement(e,t,s,i){e=new Ai(e,t,s,i);this._elements.push(e)}setFileElement(e,t,s,i){e=new Gi(e,t,s,i);this._elements.push(e)}setVideoElement(e,t,s,i){e=new wi(e,t,s,i);this._elements.push(e)}setLocationElement(e){e=new bi(e);this._elements.push(e)}setCustomElement(e){e=new ki(e);this._elements.push(e)}setGroupTipElement(e){let s={};var i=e.operationType;if(Oe(e.memberInfoList)?e.operatorInfo&&(s=e.operatorInfo):i!==t.GRP_TIP_MBR_JOIN&&i!==t.GRP_TIP_MBR_KICKED_OUT&&i!==t.GRP_TIP_MBR_SET_ADMIN&&i!==t.GRP_TIP_MBR_CANCELED_ADMIN||(s=e.memberInfoList[0]),!Oe(e.memberExtraInfo)){let t=e.memberExtraInfo["reason"];e.msgMemberInfo.forEach(e=>{e.reason=t})}var{nick:i,avatar:r}=s,i=(ke(i)&&(this.nick=i),ke(r)&&(this.avatar=r),new Ni(e));this._elements.push(i)}setGroupSystemNoticeElement(e){e=new Ui(e);this._elements.push(e)}setFaceElement(e){e=new Li(e);this._elements.push(e)}setMergerElement(e,t,s,i){e=new $i(e,t,s,i);this._elements.push(e)}setIsRead(e){this.isRead=e}setRelayFlag(e){this._relayFlag=e}_computePriority(s){if(!$e(s)){if(ke(s)&&-1!==Object.values(qi).indexOf(s))return s;if(Ge(s)){let e=""+s;if(-1!==Object.keys(qi).indexOf(e))return qi[e]}}return t.MSG_PRIORITY_NORMAL}setNickAndAvatar(e){var{nick:e,avatar:t}=e;ke(e)&&(this.nick=e),ke(t)&&(this.avatar=t)}setNameCard(e){ke(e)&&(this.nameCard=e)}initC2CReadReceiptInfo(e){var{readReceiptSentByPeer:e,timestamp:s=0}=e;this.conversationType===t.CONV_C2C&&!0===this.needReadReceipt&&(this.readReceiptInfo.isPeerRead=1===e,this.readReceiptInfo.timestamp=s)}}function Vi(e){var t=e.lastIndexOf(".");return-1===t?e:e.slice(0,t)}function Bi(e){let{androidInfo:t={},androidOPPOChannelID:s=""}=e,i=t.OPPOChannelID||s,{sound:r="",FCMChannelID:o="",...n}=t;return{...n,Sound:Vi(r),OPPOChannelID:i,GoogleChannelID:o}}function Ki(e){var{apnsInfo:e={},ignoreIOSBadge:t=!1,disableVoipPush:s}=e,t=!0===e.ignoreIOSBadge||!0===t?1:0;let i=void 0;return $e(s)||(i=!1===s?1:0),$e(e.disableVoipPush)||(i=!1===e.disableVoipPush?1:0),{...e,badgeMode:t,isVoipPush:i}}function Hi(e){if(be(e))return{pushFlag:!0===e.disablePush?1:0,title:e.title||"",desc:e.description||"",ext:e.extension||"",apnsInfo:Ki(e),androidInfo:Bi(e)}}class Wi extends oi{constructor(e){super(e),this._n="C2CModule",this._msgFromUnreadDBMap=new Map,this._noticeFromUnreadDBList=[]}onNewMessage(t){var{dataList:t,isInstantMessage:s,C2CRemainingUnreadList:i,C2CPairUnreadList:r,isSyncingEnded:o}=t,{conversationOptionsList:t,messageList:i,isUnreadC2CMessage:r}=(s||Ce.l(this._n+".onNewMessage C2CPairUnreadList:",r,"C2CRemainingUnreadList:",i),this._assembly({dataList:t,C2CRemainingUnreadList:i,C2CPairUnreadList:r,isInstantMessage:s})),n=Oe(n=i)?[]:n.filter(e=>!0===e.isModified),t=(0<n.length&&this.emitOEvt(e.MESSAGE_MODIFIED,n),this.get(Ds).onNewMessage({conversationOptionsList:t,isInstantMessage:s,isUnreadC2CMessage:r,isSyncingEnded:o}),Oe(n=i)?[]:n.filter(e=>!1===e.isModified));s&&0<t.length&&this.emitOEvt(e.MESSAGE_RECEIVED,t),i.length=0}_assembly({dataList:n,C2CRemainingUnreadList:i,C2CPairUnreadList:r,isInstantMessage:a}){var l=null,d=[],c=[],_={},u=this.get($s);let h=!1;var p=this.get(Ds),g=this.get(Ts),e=this.get(Ns),m=this.getFileDownloadProxy(),f=this.getDownloadFileAuthKey(),M=e.getFileDNList();for(let o=0,e=n.length;o<e;o++)if(this._isC2CNotice(n[o]))this._noticeFromUnreadDBList.push(n[o].eventArray[0].c2CNotifyMsgArray[0]);else{let s=n[o],r=(s.currentUser=this.getMyUserID(),s.conversationType=t.CONV_C2C,s.isSystemMessage=!!s.isSystemMessage,($e(s.nick)||$e(s.avatar))&&(h=!0),(l=new xi(s)).setElement(s.elements,m,f,M),l.setNickAndAvatar({nick:s.nick,avatar:s.avatar}),l)["conversationID"];if(a){if(this._msgFromUnreadDBMap.get(l.ID))continue;let i=!1;if(l.from!==this.getMyUserID()){let s=p.getLatestMessageSentByPeer(r);if(s){let{nick:e,avatar:t}=s;h?l.setNickAndAvatar({nick:e,avatar:t}):e===l.nick&&t===l.avatar||(i=!0)}}else{let s=p.getLatestMessageSentByMe(r);if(s){let{nick:e,avatar:t}=s;e===l.nick&&t===l.avatar||(p.modifyMessageSentByMe({conversationID:r,latestNick:l.nick,latestAvatar:l.avatar}),g.mockOnNickAvatarModified(l.nick,l.avatar))}}let e=1===n[o].isModified;if(p.isMessageSentByCurrentInstance(l)?l.isModified=e:e=!1,0===s.msgLifeTime)l._onlineOnlyFlag=!0,p.isMessageSentByCurrentInstance(l)||c.push(l);else{if(!p.pushIntoMessageList(c,l,e))continue;i&&(p.modifyMessageSentByPeer({conversationID:r,latestNick:l.nick,latestAvatar:l.avatar}),p.updateUserProfileSpecifiedKey({conversationID:r,nick:l.nick,avatar:l.avatar}))}a&&0<l.clientTime&&u.addMessageDelay(l.clientTime)}else this._msgFromUnreadDBMap.set(l.ID,l);if(0!==s.msgLifeTime){if(!1===l._onlineOnlyFlag){let e=p.getLastMessageTime(r);if(!(Ge(e)&&l.time<e)&&a)if($e(_[r])){let e=0;"in"!==l.flow||l._isExcludedFromUnreadCount||(e=1),_[r]=d.push({conversationID:r,unreadCount:e,type:l.conversationType,subType:l.conversationSubType,lastMessage:l._isExcludedFromLastMessage?"":l})-1}else{let e=_[r];d[e].type=l.conversationType,d[e].subType=l.conversationSubType,d[e].lastMessage=l._isExcludedFromLastMessage?"":l,"in"!==l.flow||l._isExcludedFromUnreadCount||d[e].unreadCount++}}}else l._onlineOnlyFlag=!0}this._handleNoticeFromUnreadDB();let o=!1;if(Fe(r)&&0<r.length)for(let s=0,e=r.length;s<e;s++)if(r[s].from!==t.CONV_SYSTEM){o=!0;let e=d.find(({conversationID:e})=>e===""+t.CONV_C2C+r[s].from);e?e.unreadCount=r[s].unreadCount:d.push({conversationID:""+t.CONV_C2C+r[s].from,unreadCount:r[s].unreadCount,type:t.CONV_C2C})}if(Fe(i))for(let s=0,e=i.length;s<e;s++)d.find(({conversationID:e})=>e===""+t.CONV_C2C+i[s].from)||d.push({conversationID:""+t.CONV_C2C+i[s].from,type:t.CONV_C2C,lastMsgTime:i[s].lastMsgTime});return{conversationOptionsList:d,messageList:c,isUnreadC2CMessage:o}}getMessageListFromUnreadDB(){return[...this._msgFromUnreadDBMap.values()]}_isC2CNotice(e){e=e.eventArray;return!(!Fe(e)||10!==e[0].event)}_handleNoticeFromUnreadDB(){var e=this._noticeFromUnreadDBList.length;if(0!==e){Ce.l(this._n+"._handleNoticeFromUnreadDB count:"+e);let t=[];this._noticeFromUnreadDBList.forEach(e=>{e.hasOwnProperty("c2cMessageRevokedNotify")&&t.push(e)}),this.onMsgRevoked({dataList:t}),this._noticeFromUnreadDBList.length=0,t.length=0}}onMsgRevoked(s,i){let n=this.get(Ds),a=[],l;s.dataList.forEach(e=>{e.c2cMessageRevokedNotify&&(e=e.c2cMessageRevokedNotify["revokedInfos"],$e(e)||e.forEach(e=>{var s=this.getMyUserID()===e.from?""+t.CONV_C2C+e.to:""+t.CONV_C2C+e.from,i=(l=n.revoke(s,e.sequence,e.random),e.revokerInfo&&e.revokerInfo.revoker),r=e.revokerInfo&&e.revokerInfo.reason||"";let o;l?o=l:(o={conversationID:s,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(o.ID=`${e.tinyID}-${e.clientTime}-`+e.random),e.time&&(o.time=e.time)),o&&(o.revoker=i,o.revokeReason=r,o.revokerInfo={userID:i,nick:"",avatar:""},a.push(o))}))}),0!==a.length&&(Ce.l(`${this._n}.onMsgRevoked count:${a.length} updateUnreadCount:`+i),n.onMessageRevoked(a,i),n.updateRevokerInfo(a).then(t=>{this.emitOEvt(e.MESSAGE_REVOKED,t)}))}onMsgReadReceipt(e){e.dataList.forEach(e=>{if(!Oe(e.c2cMessageReadReceipt)){let r=e.c2cMessageReadReceipt["to"];e.c2cMessageReadReceipt.uinPairReadArray.forEach(e=>{var e=e["peerReadTime"],s=(Ce.l(`${this._n}.onMsgReadReceipt to:${r} peerReadTime:`+e),""+t.CONV_C2C+r),i=this.get(Ds);i.recordPeerReadTime(s,e),i.updateMsgIsPeerReadProp(s,e)})}})}onMsgReadNotice(e){e.dataList.forEach(e=>{if(!Oe(e.c2cMessageReadNotice)){let i=this.get(Ds);e.c2cMessageReadNotice.uinPairReadArray.forEach(e=>{var{from:e,peerReadTime:s}=e,e=(Ce.l(this._n+`.onMsgReadNotice from:${e} lastReadTime:`+s),""+t.CONV_C2C+e);i.updateIsReadAfterReadReport({conversationID:e,lastMessageTime:s}),i.updateUnreadCount(e)})}})}onMsgModified(e){Ce.l(this._n+".onMsgModified options:",e);let s=this.get(Ds);e.dataList.forEach(e=>{s.onMessageModified({...e,conversationType:t.CONV_C2C})})}onReadReceiptList(e){Ce.l(this._n+".onReadReceiptList options:",e),this.get(Ds).updateReadReceiptInfo(e.dataList)}sendMessage(e,t){e=this._createC2CMessagePack(e,t);return this.req(e)}_createC2CMessagePack(e,i){let t=null,s=(i&&(i.offlinePushInfo&&(t=i.offlinePushInfo),!0===i.onlineUserOnly)&&(t?t.disablePush=!0:t={disablePush:!0}),"");ke(e.cloudCustomData)&&0<e.cloudCustomData.length&&(s=e.cloudCustomData);var r=[];if(be(i)&&be(i.messageControlInfo)){let{excludedFromUnreadCount:e,excludedFromLastMessage:t,excludedFromContentModeration:s}=i.messageControlInfo;!0===e&&r.push("NoUnread"),!0===t&&r.push("NoLastMsg"),!0===s&&r.push("NoMsgCheck")}var o=this.isOnlineMessage(e,i)?0:void 0,n=JSON.parse(JSON.stringify(e.getElements())),a=this.get(Ns).getFileDNList();return{P:ri.SEND_C2C_MSG,data:{fromAccount:this.getMyUserID(),toAccount:e.to,msgBody:Ei(e.type,n,a),cloudCustomData:s,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:o,nick:e.nick,avatar:e.avatar,offlinePushInfo:Hi(t),messageControlInfo:0!==o?r:void 0,clientTime:e.clientTime,needReadReceipt:!0===e.needReadReceipt?1:0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID,forbidCallbackControl:it(i)}}}isOnlineMessage(e,t){return!(!t||!0!==t.onlineUserOnly)}revokeMessage(e){return this.req({P:ri.REVOKE_C2C_MSG,data:{msgInfo:{fromAccount:e.from,toAccount:e.to,msgSeq:e.sequence,msgRandom:e.random,msgTimeStamp:e.time}}})}deleteMessage(e){var{to:e,keyList:t}=e;return Ce.l(this._n+`.deleteMessage toAccount:${e} count:`+t.length),this.req({P:ri.DEL_C2C_MSG,data:{fromAccount:this.getMyUserID(),to:e,keyList:t}})}modifyRemoteMessage(e){var s,{from:e,to:i,version:r=0,sequence:o,random:n,time:a,payload:l,type:d,cloudCustomData:c,_elements:_}=e;let u=void 0;return(s=d)!==t.MSG_TEXT&&s!==t.MSG_CUSTOM&&s!==t.MSG_LOCATION&&s!==t.MSG_FACE||(1<_.length&&_.splice(0,1,{type:d,content:l}),u=_),this.req({P:ri.MODIFY_C2C_MSG,data:{from:e,to:i,version:r,sequence:o,random:n,time:a,elements:u,cloudCustomData:c}})}setMessageRead({conversationID:t,lastMessageTime:s}){let i=this._n+".setMessageRead",e=`convID:${t} lastMessageTime:`+s,r=(Ce.l(i+" "+e),Ge(s)||this.warn("DoNotModifyLastTime"),new Ti("setMessageRead"));return r.setMessage(e),this.req({P:ri.SET_C2C_MSG_READ,data:{C2CMsgReaded:{cookie:"",C2CMsgReadedItem:[{toAccount:t.replace("C2C",""),lastMessageTime:s,receipt:1}]}}}).then(()=>{r.end(),Ce.l(i+" ok");var e=this.get(Ds);return e.updateIsReadAfterReadReport({conversationID:t,lastMessageTime:s}),e.updateUnreadCount(t),Zs()}).catch(e=>(r.setError(e).end(),Ce.l(i+" failed. error:",e),ni(e)))}getRoamingMessage(e){let l=this._n+".getRoamingMessage",{peerAccount:s,conversationID:d,count:i,lastMessageTime:r,messageKey:o}=e,c=`peerAccount:${s} count:${i||15} lastMessageTime:${r||0} messageKey:`+o,_=(Ce.l(l+" "+c),new Ti("getRoamingMessage"));return this.req({P:ri.GET_C2C_ROAMING_MSG,data:{peerAccount:s,count:i||15,lastMessageTime:r||0,messageKey:o}}).then(e=>{var{complete:e,messageList:s,messageKey:i,lastMessageTime:r}=e.data;$e(s)?Ce.l(l+` ok. complete:${e} but messageList is undefined!`):Ce.l(l+` ok. complete:${e} count:`+s.length),_.setMessage(c+` complete:${e} length:`+s.length).end();let o=this.get(Ds),n=1===e;n&&o.setCompleted(d);e=[],s=o.onRoamingMessage(s,d,!0,e),o.modifyMessageList(d),o.updateIsRead(d),o.updateRoamingMsgKeyAndTime(d,i,r),i=o.getPeerReadTime(d);if(Ce.l(l+` update isPeerRead property. convID:${d} peerReadTime:`+i),i)o.updateMsgIsPeerReadProp(d,i);else{let e=d.replace(t.CONV_C2C,"");this.getRemotePeerReadTime([e]).then(()=>{o.updateMsgIsPeerReadProp(d,o.getPeerReadTime(d))})}let a="";if(0<s.length)a=s[0].ID;else{let e=o.getLocalOldestMessage(d);e&&(a=e.ID)}return Ce.l(l+` nextReqID:${a} storedMsgCount:`+s.length),{nextReqID:a,storedMessageList:s,assembledMessageList:e,isPullingCompleted:n}}).catch(e=>(_.setMessage(c).setError(e).end(),Ce.w(l+" failed. error:",e),ni(e)))}getRoamingMessagesHopping(e){let a=this._n+".getRoamingMessagesHopping",{peerAccount:s,time:i=0,count:r,direction:l}=e,d=""+t.CONV_C2C+s,c=`peerAccount:${s} count:${r} time:${i} direction:`+l,_=(Ce.l(a+" "+c),new Ti("getRoamingMessagesHopping"));return this.req({P:ri.GET_C2C_ROAMING_MSG,data:{peerAccount:s,count:r+1,lastMessageTime:i,direction:l}}).then(e=>{var{complete:e,messageList:s=[],lastMessageTime:i}=e.data,r=`complete:${e} count:`+s.length;Ce.l(a+" ok. "+r),_.setMessage(c+" "+r).end(),1!==e&&(1===l?s.pop():s.shift());let o=this.get(Ds),n=o.onRoamingMessage(s,d,!1);this._modifyMessageList(d,n);r=this._computeResult({complete:e,lastMessageTime:i,resultList:n}),o.storeHoppingMessageList(r.messageList),s=o.getPeerReadTime(d);if(Ce.l(a+` update isPeerRead property. convID:${d} peerReadTime:`+s),s)o.updateMsgIsPeerReadProp(d,s);else{let e=d.replace(t.CONV_C2C,"");this.getRemotePeerReadTime([e]).then(()=>{o.updateMsgIsPeerReadProp(d,o.getPeerReadTime(d))})}return Zs(r)}).catch(e=>(_.setMessage(c).setError(e).end(),Ce.w(a+" failed. error:",e),ni(e)))}_computeResult(e){var{complete:e=0,lastMessageTime:t,resultList:s=[]}=e,s={messageList:[...s],isCompleted:!1,nextMessageTime:""};return 1===e?s.isCompleted=!0:s.nextMessageTime=t,s}_modifyMessageList(e,s){e=this.get(Ds).getLocalConversation(e);if(e){var i=e.userProfile.nick,r=e.userProfile.avatar,e=this.get(Ts).getNickAndAvatarByUserID(this.getMyUserID()),o=e.nick,n=e.avatar;for(let t=s.length-1;0<=t;t--){let e=s[t];"in"===e.flow&&(e.nick!==i&&e.setNickAndAvatar({nick:i}),e.avatar!==r)&&e.setNickAndAvatar({avatar:r}),"out"===e.flow&&(e.nick!==o&&e.setNickAndAvatar({nick:o}),e.avatar!==n)&&e.setNickAndAvatar({avatar:n})}}}getRemotePeerReadTime(o){let n=this._n+".getRemotePeerReadTime";if(Oe(o))return Promise.resolve();let a=new Ti("getRemotePeerReadTime");return Ce.l(n+" userIDList:"+o),this.req({P:ri.GET_C2C_PEER_READ_TIME,data:{userIDList:o}}).then(e=>{var s=e.data["peerReadTimeList"];Ce.l(n+" ok. peerReadTimeList:"+s);let i="";var r=this.get(Ds);for(let e=0;e<o.length;e++)i+=`${o[e]}-${s[e]} `,0<s[e]&&r.recordPeerReadTime(""+t.CONV_C2C+o[e],s[e]);a.setMessage(i).end()}).catch(e=>{a.setError(e).end(),Ce.w(n+" failed. error:",e)})}sendReadReceipt(e){let s=e[0].conversationID.replace(t.CONV_C2C,""),i=new Ti("sendReadReceipt"),r=(i.setMessage("peerAccount:"+s),this.getMyUserID()),o=e.filter(e=>e.from!==r&&!0===e.needReadReceipt).map(e=>{var{from:e,to:t,sequence:s,random:i,time:r,clientTime:o}=e;return{fromAccount:e,toAccount:t,sequence:s,random:i,time:r,clientTime:o}});if(0===o.length)return ni({code:ei.READ_RECEIPT_MSG_LIST_EMPTY});let n=this._n+".sendReadReceipt";return Ce.l(n+`. peerAccount:${s} length:`+o.length),this.req({P:ri.SEND_C2C_READ_RECEIPT,data:{peerAccount:s,messageInfoList:o}}).then(e=>(i.end(),Ce.l(n+" ok"),Zs())).catch(e=>(i.setError(e).end(),Ce.w(n+" failed. error:",e),ni(e)))}getReadReceiptList(e){var s=e[0].conversationID.replace(t.CONV_C2C,"");return Ce.l(this._n+`.getReadReceiptList peerAccount:${s} msgCount:`+e.length),ii({messageList:e})}getMessageExtensions(e,t){return Ce.l(this._n+".getMessageExtensions startSequence:"+t),this.req({P:ri.GET_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),startSequence:t}})}modifyMsgExts(e,t,s=1){return Ce.l(this._n+".modifyMsgExts operateType:"+s),this.req({P:ri.MODIFY_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),extensionList:t,operateType:s}})}getMessageKey(e){var{clientSequence:e,random:t,time:s}=e;return e+`_${t}_`+s}reset(){Ce.l(this._n+".reset"),this._msgFromUnreadDBMap.clear(),this._noticeFromUnreadDBList.length=0}}let Yi={A2KEY_AND_TINYID_UPDATED:"_inner1",CLOUD_CONFIG:"_inner2",PROFILE_UPDATED:"_inner3",CONV_SYNC_COMPLETED:"_inner4",C2C_UNREAD_HANDLE_COMPLETED:"_inner5"};class zi{constructor(e){this._convM=e,this._map=new Map,this._n="MsgListHandler",this._latestMsgSentByPeerMap=new Map,this._latestMsgSentByMeMap=new Map,this._hoppingMsgMap=new Map,this.TOPIC_MSG_LIMIT=1e3,this._convM.getIEmitInst().on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){var e=this._convM.getCloudConfig("topic_msg_limit");$e(e)||(this.TOPIC_MSG_LIMIT=Number(e)),Ce.l(this._n+"._onCloudConfig topicMsgLimit:"+this.TOPIC_MSG_LIMIT)}onCheckTimer(e){if(e%20==0&&0<this._map.size)for(var[t,s]of this._map)t.includes(Le)&&s.size>=this.TOPIC_MSG_LIMIT&&this._convM.clearMemMsg(t,!0)}pushIn(e,t=!1){var s=e["conversationID"];let i=!0;this._map.has(s)||this._map.set(s,new Map);var r=this._getUniqueIDOfMsg(e);if(this._map.get(s).has(r)){let e=this._map.get(s).get(r);if(!t||!0===e.isModified)return i=!1}return this._map.get(s).set(r,e),this._setLatestMsgSentByPeer(s,e),this._setLatestMsgSentByMe(s,e),i}unshift(e,s){let r;if(Fe(e)?0<e.length&&(r=e[0].conversationID,this._unshiftMultipleMsgs(e,s)):(r=e.conversationID,this._unshiftSingleMsg(e,s)),r){let s=Array.from(this._map.get(r).values()),i=s.length;if(0!==i){for(let e=i-1;0<=e;e--)if("out"===s[e].flow){this._setLatestMsgSentByMe(r,s[e]);break}if(r.startsWith(t.CONV_C2C))for(let e=i-1;0<=e;e--)if("in"===s[e].flow){this._setLatestMsgSentByPeer(r,s[e]);break}}}}_unshiftSingleMsg(e,t){var s,i,r=e["conversationID"],o=this._getUniqueIDOfMsg(e);this._map.has(r)?(s=this._map.get(r),i=Array.from(s),s.has(o)||(i.unshift([o,e]),this._map.set(r,new Map(i)),t.push(e))):(this._map.set(r,new Map),this._map.get(r).set(o,e),t.push(e))}_unshiftMultipleMsgs(s,i){let e=s.length,r=[],t=s[0].conversationID,o=this._map.get(t),n=this._map.has(t)?Array.from(o):[];for(let t=0;t<e;t++){let e=this._getUniqueIDOfMsg(s[t]);o&&o.has(e)||(r.push([e,s[t]]),i.push(s[t]))}this._map.set(t,new Map(r.concat(n)))}remove(e){var t=e["conversationID"],e=this._getUniqueIDOfMsg(e);this._map.has(t)&&this._map.get(t).delete(e)}revoke(e,t,s){var i;return this._map.has(e)?(i=this._map.get(e),this._updateMsgIsRevoked(i,t,s)):this._hoppingMsgMap.has(e)?(i=this._hoppingMsgMap.get(e),this._updateMsgIsRevoked(i,t,s)):null}_updateMsgIsRevoked(e,t,s){for(var[,i]of e)if(i.sequence===t&&($e(s)||i.random===s))return i.isRevoked||(i.isRevoked=!0),i}removeByConvID(e){var t=this._map.has(e);Ce.l(this._n+`.removeByConvID convID:${e} has:`+t),t&&(this._map.delete(e),this._latestMsgSentByPeerMap.delete(e),this._latestMsgSentByMeMap.delete(e))}findMessage(e){let t=null;return t=(t=this._findMsg(e,this._map))||this._findMsg(e,this._hoppingMsgMap)}_findMsg(i,e){let r=null;for(var[,o]of e){let t=[...o.values()],s=t.length;for(let e=0;e<s;e++)if(t[e].ID===i){r=t[e];break}}return r}updateMsgIsPeerReadProp(e,t){let s=[];var i;return this._map.has(e)?(i=this._map.get(e),s=this._updateMsgIsPeerReadProp(i,t)):this._hoppingMsgMap.has(e)&&(i=this._hoppingMsgMap.get(e),s=this._updateMsgIsPeerReadProp(i,t)),Ce.l(this._n+`.updateMsgIsPeerReadProp convID:${e} peerReadTime:${t} count:`+s.length),s}_updateMsgIsPeerReadProp(e,t){var s,i=[];for([,s]of e)s.time<=t&&!s.isPeerRead&&"out"===s.flow&&(s.isPeerRead=!0,i.push(s));return i}updateMsgIsModifiedProp(e){var t=e["conversationID"];this._map.has(t)&&(e=this._getUniqueIDOfMsg(e),t=this._map.get(t).get(e))&&(t.isModified=!0)}hasLocalMsgList(e){return this._map.has(e)}getLocalMsgList(e){return this.hasLocalMsgList(e)?[...this._map.get(e).values()]:[]}getLocalMaxSeq(e){return this.hasLocalMsgList(e)?(e=[...this._map.get(e).values()].map(e=>e.sequence),Math.max(...e)):0}getLocalMaxTime(e){return this.hasLocalMsgList(e)?(e=[...this._map.get(e).values()].map(e=>e.time),Math.max(...e)):0}hasLocalMsg(e,t){let s=!1;var i=this.getLocalMsgList(e),r=i.length;for(let e=0;e<r;e++)i[e].ID===t&&(s=!0);return s}getLocalMsg(e,t){let s=null;var i=this.getLocalMsgList(e),r=i.length;for(let e=0;e<r;e++)if(i[e].ID===t){s=i[e];break}return s}getLocalLastMsg(e){e=this.getLocalMsgList(e);return e[e.length-1]}getLocalSecondLastMsg(e){e=this.getLocalMsgList(e);return e[e.length-2]}getLocalOldestMsg(e){return this.getLocalMsgList(e)[0]}_setLatestMsgSentByPeer(e,s){e.startsWith(t.CONV_C2C)&&"in"===s.flow&&this._latestMsgSentByPeerMap.set(e,s)}_setLatestMsgSentByMe(e,t){"out"===t.flow&&this._latestMsgSentByMeMap.set(e,t)}getLatestMsgSentByPeer(e){return this._latestMsgSentByPeerMap.get(e)}getLatestMsgSentByMe(e){return this._latestMsgSentByMeMap.get(e)}modifyMsgSentByPeer(e){var{conversationID:e,latestNick:r,latestAvatar:o}=e,n=this._map.get(e);if(!Oe(n)){var a=Array.from(n.values()),n=a.length;if(0!==n){let t=null,s=0,i=!1;for(let e=n-1;0<=e;e--)"in"===a[e].flow&&((t=a[e]).nick!==r&&(t.setNickAndAvatar({nick:r}),i=!0),t.avatar!==o&&(t.setNickAndAvatar({avatar:o}),i=!0),i)&&(s+=1);Ce.l(this._n+`.modifyMsgSentByPeer convID:${e} count:`+s)}}}modifyMsgSentByMe(e){var{conversationID:e,latestNick:r,latestAvatar:o}=e,n=this._map.get(e);if(!Oe(n)){var a=Array.from(n.values()),n=a.length;if(0!==n){let t=null,s=0,i=!1;for(let e=n-1;0<=e;e--)"out"===a[e].flow&&((t=a[e]).nick!==r&&(t.setNickAndAvatar({nick:r}),i=!0),t.avatar!==o&&(t.setNickAndAvatar({avatar:o}),i=!0),i)&&(s+=1);Ce.l(this._n+`.modifyMsgSentByMe convID:${e} count:`+s)}}}getTopicConvIDList(s){return[...this._map.keys()].filter(e=>e.startsWith(""+t.CONV_GROUP+s))}onMsgModified(s,n){if(this._map.has(s)||this._hoppingMsgMap.has(s)){let r=this._n+".onMsgModified",e=this._getUniqueIDOfMsg(n),o=this._getTargetMsg(s,e),t=!!o;if(Ce.l(r+` convID:${s} uniqueID:${e} has:`+t),t){let{messageVersion:e,elements:t,cloudCustomData:s,checkResult:i}=n;return Ce.l(r+` localVersion:${o.version} remoteVersion:`+e),o.version<e?(o.version=e,o._elements=JSON.parse(JSON.stringify(t)),o.payload=o._elements[0].content,o.type=o._elements[0].type,o.cloudCustomData=s,o.isModified=!0,o.hasRiskContent=Rt(i),{isUpdated:!0,message:o}):{isUpdated:!1,message:o}}}return{isUpdated:!1,message:null}}_getUniqueIDOfMsg(e){var{from:e,to:t,random:s,sequence:i,time:r}=e;return e+`-${t}-${s}-${i}-`+r}_getTargetMsg(e,t){if(this._map.has(e))return this._map.get(e).get(t);let s=void 0;if(this._hoppingMsgMap.has(e)){var i=[...this._hoppingMsgMap.get(e).values()];for(let e=0;e<i.length;e++)if(this._getUniqueIDOfMsg(i[e])===t){s=i[e];break}}return s}storeHoppingMsgList(i){if(0!==i.length){let e=i[0]["conversationID"],s=i.length;this._hoppingMsgMap.has(e)||this._hoppingMsgMap.set(e,new Map);var r=this._hoppingMsgMap.get(e);for(let t=0;t<s;t++){let e=i[t];r.has(e.ID)||r.set(e.ID,e)}}}getHoppingMsg(e,t){if(this._hoppingMsgMap.has(e))return this._hoppingMsgMap.get(e).get(t)}reset(){this._map.clear(),this._latestMsgSentByPeerMap.clear(),this._latestMsgSentByMeMap.clear(),this._hoppingMsgMap.clear()}}function ji(e){this.mixin(e)}ji.mixin=function(e){e=e.prototype||e;e._isReady=!1,e.ready=function(e,t=!1){if(e)return this._isReady?void(t?e.call(this):setTimeout(e,1)):(this._readyQueue=this._readyQueue||[],void this._readyQueue.push(e))},e.triggerReady=function(){this._isReady=!0,setTimeout(()=>{var e=this._readyQueue;this._readyQueue=[],e&&0<e.length&&e.forEach(function(e){e.call(this)},this)},1)},e.resetReady=function(){this._isReady=!1,this._readyQueue=[]},e.isReady=function(){return this._isReady}};let Ji=["jpg","jpeg","gif","png","bmp","image","webp"],Xi=["mp4","quicktime","mov"],Zi=1,Qi=2,en=3,tn=255;class sn{constructor(e){Oe(e)||(this.userID=e.userID||"",this.nick=e.nick||"",this.gender=e.gender||"",this.birthday=e.birthday||0,this.location=e.location||"",this.selfSignature=e.selfSignature||"",this.allowType=e.allowType||t.ALLOW_TYPE_ALLOW_ANY,this.language=e.language||0,this.avatar=e.avatar||"",this.messageSettings=e.messageSettings||0,this.adminForbidType=e.adminForbidType||t.FORBID_TYPE_NONE,this.level=e.level||0,this.role=e.role||0,this.lastUpdatedTime=0,this.profileCustomField=[],Oe(e.profileCustomField))||e.profileCustomField.forEach(e=>{this.profileCustomField.push({key:e.key,value:e.value})})}validate(s){let e=!0,t="";if(Oe(s))return{valid:!1,tips:"empty options"};if(s.profileCustomField){let t=s.profileCustomField.length;var i=null;for(let e=0;e<t;e++){if(i=s.profileCustomField[e],!ke(i.key)||-1===i.key.indexOf("Tag_Profile_Custom"))return{valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!ke(i.value))return{valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}}for(var r in s)if(Object.prototype.hasOwnProperty.call(s,r)){if("profileCustomField"===r)continue;if(Oe(s[r])&&!ke(s[r])&&!Ge(s[r])){t="key:"+r+", invalid value:"+s[r],e=!1;continue}switch(r){case"nick":ke(s[r])||(t="nick must be a string",e=!1),500<ze(s[r])&&(t=`nick name limited: must less than or equal to 500 bytes, current size: ${ze(s[r])} bytes`,e=!1);break;case"gender":Ze(Ee,s.gender)||(t="key:gender, invalid value:"+s.gender,e=!1);break;case"birthday":Ge(s.birthday)||(t="birthday must be a number",e=!1);break;case"location":ke(s.location)||(t="location must be a string",e=!1);break;case"selfSignature":ke(s.selfSignature)||(t="selfSignature must be a string",e=!1);break;case"allowType":Ze(De,s.allowType)||(t="key:allowType, invalid value:"+s.allowType,e=!1);break;case"language":Ge(s.language)||(t="language must be a number",e=!1);break;case"avatar":ke(s.avatar)||(t="avatar must be a string",e=!1);break;case"messageSettings":0!==s.messageSettings&&1!==s.messageSettings&&(t="messageSettings must be 0 or 1",e=!1);break;case"adminForbidType":Ze(Se,s.adminForbidType)||(t="key:adminForbidType, invalid value:"+s.adminForbidType,e=!1);break;case"level":Ge(s.level)||(t="level must be a number",e=!1);break;case"role":Ge(s.role)||(t="role must be a number",e=!1);break;default:t="unknown key:"+r+"  "+s[r],e=!1}}return{valid:e,tips:t}}}class nn{constructor(e){this.MAX_LENGTH=e,this.map=new Map}set(e){if(this.map.size>=this.MAX_LENGTH){let e=this.map.entries().next().value[0];this.map.delete(e)}this.map.set(e,1)}has(e){return this.map.has(e)}delete(e){this.has(e)&&this.map.delete(e)}reset(){this.map.clear()}}let on=["groupID","name","avatar","type","introduction","notification","ownerID","selfInfo","createTime","infoSequence","lastInfoTime","lastMessage","nextMessageSeq","memberNum","maxMemberNum","memberList","joinOption","groupCustomField","muteAllMembers","isSupportTopic","inviteOption","_lastRevokedTime"];class rn{constructor(e){this.groupID="",this.name="",this.avatar="",this.type="",this.introduction="",this.notification="",this.ownerID="",this.createTime="",this.infoSequence="",this.lastInfoTime="",this.selfInfo={messageRemindType:"",joinTime:"",nameCard:"",role:"",userID:"",memberCustomField:void 0,readedSequence:0,excludedUnreadSequenceList:void 0},this.lastMessage={lastTime:"",lastSequence:"",fromAccount:"",messageForShow:""},this.nextMessageSeq="",this.memberNum="",this.memberCount="",this.maxMemberNum="",this.maxMemberCount="",this.joinOption="",this.inviteOption="",this.groupCustomField=[],this.muteAllMembers=!1,this.isSupportTopic=!1,this._lastRevokedTime=0,this._initGroup(e)}set memberNum(e){}set maxMemberNum(e){}get memberNum(){return this.memberCount}get maxMemberNum(){return this.maxMemberCount}_initGroup(e){for(var t in e)on.indexOf(t)<0||("selfInfo"!==t?("memberNum"===t&&(this.memberCount=e[t]),"maxMemberNum"===t&&(this.maxMemberCount=e[t]),"isSupportTopic"!==t?this[t]=e[t]:this.isSupportTopic=1===e[t]):this.updateSelfInfo(e[t]))}updateGroup(e){e.appid=void 0,e.grossTopicNextMsgSeq=void 0,e.selfInfo&&(e.selfInfo.grossTopicReadSeq=void 0);e=JSON.parse(JSON.stringify(e));e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),$e(e.muteAllMembers)||("On"===e.muteAllMembers?e.muteAllMembers=!0:e.muteAllMembers=!1),e.groupCustomField&&st(this.groupCustomField,e.groupCustomField),$e(e.memberNum)||(this.memberCount=e.memberNum),$e(e.maxMemberNum)||(this.maxMemberCount=e.maxMemberNum),$e(e.isSupportTopic)||(this.isSupportTopic=Ge(e.isSupportTopic)?1===e.isSupportTopic:e.isSupportTopic),We(this,e,["members","errorCode","lastMsgTime","groupCustomField","memberNum","maxMemberNum","isSupportTopic"]),Fe(e.members)&&0<e.members.length&&e.members.forEach(e=>{e.userID===this.selfInfo.userID&&We(this.selfInfo,e,["sequence"])})}updateSelfInfo({nameCard:e,joinTime:t,role:s,messageRemindType:i,readedSequence:r,excludedUnreadSequenceList:o}){e={nameCard:e,joinTime:t,role:s,messageRemindType:i,readedSequence:r,excludedUnreadSequenceList:o};We(this.selfInfo,{...e},[],["",null,void 0,0,NaN])}setSelfNameCard(e){this.selfInfo.nameCard=e}}let an=function(e,t,s){return $e(e)?{lastTime:0,lastSequence:0,fromAccount:"",messageForShow:"",payload:null,type:"",isRevoked:!1,cloudCustomData:"",onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:!1,revoker:null}:s&&e.ID||e instanceof xi?{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",messageForShow:yt(e.type,e.payload,t),payload:e.payload||null,type:e.type||null,isRevoked:e.isRevoked||!1,cloudCustomData:e.cloudCustomData||"",onlineOnlyFlag:e._onlineOnlyFlag||!1,nick:e.nick||"",nameCard:e.nameCard||"",version:e.version||0,isPeerRead:e.isPeerRead||!1,revoker:e.revoker||null}:{...e,messageForShow:yt(e.type,e.payload,t)}};class cn{constructor(e,t,s=!1){this.conversationID=e.conversationID||"",this.unreadCount=e.unreadCount||0,this.type=e.type||"",this.lastMessage=an(e.lastMessage,t,s),e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),this._isInfoCompleted=!1,this.peerReadTime=e.peerReadTime||0,this.groupAtInfoList=[],this.remark="",this.isPinned=e.isPinned||!1,this.messageRemindType=e.messageRemindType,this.markList=e.markList||[],this.customData=e.customData||"",this.conversationGroupList=e.conversationGroupList||[],this.draftText=e.draftText||"",this._initProfile(e),this.subType=this.groupProfile?this.groupProfile.type:""}get toAccount(){return this.conversationID.startsWith(t.CONV_C2C)?this.conversationID.replace(t.CONV_C2C,""):this.conversationID.startsWith(t.CONV_GROUP)?this.conversationID.replace(t.CONV_GROUP,""):""}_initProfile(s){Object.keys(s).forEach(e=>{switch(e){case"userProfile":this.userProfile=s.userProfile;break;case"groupProfile":this.groupProfile=s.groupProfile}}),$e(this.userProfile)&&this.type===t.CONV_C2C?this.userProfile=new sn({userID:s.conversationID.replace("C2C","")}):$e(this.groupProfile)&&this.type===t.CONV_GROUP&&(this.groupProfile=new rn({groupID:s.conversationID.replace("GROUP","")}))}updateUnreadCount(e){var{nextUnreadCount:e,isFromGetConversations:s,isUnreadC2CMessage:i}=e;$e(e)||(nt(this.subType)?this.unreadCount=0:s&&this.type===t.CONV_GROUP||s&&this.type===t.CONV_TOPIC||i&&this.type===t.CONV_C2C?this.unreadCount=e:this.unreadCount=this.unreadCount+e)}updateLastMessage(e){this.lastMessage=an(e)}updateGroupAtInfoList(s){if(!this._isNeedMergeGroupAtInfo(s)){let[...e]=s.groupAtType;-1!==e.indexOf(t.CONV_AT_ME)&&-1!==e.indexOf(t.CONV_AT_ALL)&&(e=[t.CONV_AT_ALL_AT_ME]);s={from:s.from,groupID:s.groupID,topicID:s.topicID,messageSequence:s.sequence,atTypeArray:e,__random:s.__random,__sequence:s.__sequence};this.groupAtInfoList.push(s)}}_isNeedMergeGroupAtInfo(s){let{groupID:e,sequence:i}=s;if(!ot({groupID:e}))return!1;let r=!1;return this.groupAtInfoList.forEach(e=>{e.messageSequence===i&&(-1<e.atTypeArray.indexOf(t.CONV_AT_ME)&&-1<s.groupAtType.indexOf(t.CONV_AT_ALL)&&(e.atTypeArray=[t.CONV_AT_ALL_AT_ME]),-1<e.atTypeArray.indexOf(t.CONV_AT_ALL)&&-1<s.groupAtType.indexOf(t.CONV_AT_ME)&&(e.atTypeArray=[t.CONV_AT_ALL_AT_ME],e.__random=s.__random,e.__sequence=s.__sequence),r=!0)}),r}clearGroupAtInfoList(){this.groupAtInfoList.length=0}reduceUnreadCount(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}isLastMessageRevoked({sequence:e,time:s}){return this.type===t.CONV_C2C&&e===this.lastMessage.lastSequence&&s===this.lastMessage.lastTime||this.type===t.CONV_GROUP&&e===this.lastMessage.lastSequence}setLastMessageRevoked(e){this.lastMessage.isRevoked=e}setLastMessageRevoker(e){this.lastMessage.revoker=e}setDraftText(e){this.draftText=e}}let ln={[t.MSG_REMIND_ACPT_AND_NOTE]:0,[t.MSG_REMIND_DISCARD]:1,[t.MSG_REMIND_ACPT_NOT_NOTE]:2};class un{constructor(e){this._convM=e,this._n="MsgRemindHandler"}onAllRcvMsgOptNotify(t){t=this._handleResult(t);this._convM.emitOEvt(e.ALL_RECEIVE_MESSAGE_OPT_UPDATED,t)}getC2CMsgRemindType(t){let s=this._n+".getC2CMsgRemindType";return this._convM.req({P:ri.GET_C2C_PEER_MUTE_NOTIFICATIONS,data:{toAccount:this._convM.getMyUserID(),userIDList:t}}).then(e=>{Ce.l(s+" ok. userIDList:"+t);e=e.data.muteFlagList;this._convM.onC2CMsgRemindTypeFetched(e)}).catch(e=>{Ce.e(s+" failed. error:",e)})}set(e){return e.groupID?this._setGroupMsgRemindType(e):Fe(e.userIDList)?this._setC2CMsgRemindType(e):void 0}_setGroupMsgRemindType(t){let s=this._n+"._setGroupMsgRemindType",{groupID:e,messageRemindType:i}=t,r=`groupID:${e} messageRemindType:`+i,o=new Ti("_setGroupMsgRemindType");o.setMessage(r);var n=this._get(vs);return n?n.modifyGroupMemberInfo({groupID:e,messageRemindType:i,userID:this._convM.getMyUserID()}).then(()=>{o.end(),Ce.l(s+" ok. "+r);var e=this.onGroupMsgRemindTypeUpdated(t);return this._convM.onTotalUnreadCountUpdate(),Zs(e)}).catch(e=>(o.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e))):ni({code:ei.NO_MODULE})}onGroupMsgRemindTypeUpdated(t){var{groupID:r,messageRemindType:o}=t;Ce.l(this._n+`.onGroupMsgRemindTypeUpdated groupID:${r} messageRemindType:`+o);let s=this._get(vs).getLocalGroupProfile(r);if(s&&(s.selfInfo.messageRemindType=o),rt(r)){let t=r,s=Tt(t),i=this._get(Ss).getLocalTopic(s,t);return i&&i.updateSelfInfo({messageRemindType:o})&&this._convM.emitOEvt(e.TOPIC_UPDATED,{groupID:s,topic:i}),{topic:i}}return this._convM.patchMsgRemindType({ID:r,isC2CConversation:!1,messageRemindType:o})&&this._emitConvUpdate(),{group:s}}_setC2CMsgRemindType(e){let o=this._n+"._setC2CMsgRemindType",{userIDList:t,messageRemindType:n}=e,a=t.slice(0,30),s=ln[n]||0,l=`userIDList:${a} messageRemindType:`+n,d=new Ti("_setC2CMsgRemindType");return d.setMessage(l),this._convM.req({P:ri.SET_C2C_PEER_MUTE_NOTIFICATIONS,data:{userIDList:a,muteFlag:s}}).then(e=>{d.end();let t=e.data["errorList"],s=[],i=[];Fe(t)&&t.forEach(e=>{s.push(e.userID),i.push({userID:e.userID,code:e.errorCode})});e=a.filter(e=>-1===s.indexOf(e));Ce.l(o+` ok. ${l} successUserIDList:${e} failureUserIDList:`+JSON.stringify(i));let r=0;return e.forEach(e=>{this._convM.patchMsgRemindType({ID:e,isC2CConversation:!0,messageRemindType:n})&&(r+=1)}),1<=r&&this._emitConvUpdate(),a.length=s.length=0,this._convM.onTotalUnreadCountUpdate(),ii({successUserIDList:e.map(e=>({userID:e})),failureUserIDList:i})}).catch(e=>(d.setError(e).end(),Ce.e(o+" failed. error:",e),ni(e)))}_get(e){return this._convM.get(e)}_emitConvUpdate(){this._convM.emitConvUpdate(!0,!1)}setAllRcvMsgOpt(e){let s=this._n+".setAllRcvMsgOpt",{messageRemindType:i=t.MSG_REMIND_ACPT_NOT_NOTE,isRepeated:r=!0}=e,{startTime:o=0,endTime:n=0}=this._calcStartAndEndTime(e),a=JSON.stringify(e),l=new Ti("setAllRcvMsgOpt");return l.setMessage(a),Ce.l(s+" options:"+a),this._convM.req({P:ri.SET_ALL_RECEIVE_MSG_OPT,data:{messageRemindType:ln[i],startTime:o,endTime:n,isRepeated:r?1:0}}).then(e=>(l.end(),Ce.l(s+" ok."),Zs(e))).catch(e=>(l.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}_calcStartAndEndTime(e){var{startHour:e=0,startMinute:t=0,startSecond:s=0,duration:i=0,isRepeated:r=!0}=e,o=new Date,n=o.getFullYear(),a=o.getMonth(),o=o.getDate(),n=Math.round(new Date(n,a,o,e,t,s).getTime()/1e3);let l=r&&86400<=i?n+86400:n+i;return{startTime:n,endTime:l}}getAllRcvMsgOpt(){let t=this._n+".getAllRcvMsgOpt",s=new Ti("getAllRcvMsgOpt");return this._convM.req({P:ri.GET_ALL_RECEIVE_MSG_OPT,data:{toAccount:this._convM.getMyUserID()}}).then(e=>{e=e.data,s.setMessage(JSON.stringify(e)).end(),Ce.l(t+" ok. data:"+JSON.stringify(e)),e=this._handleResult(e);return Zs(e)}).catch(e=>(s.setError(e).end(),Ce.e(t+" failed. error:",e),ni(e)))}_handleResult(e){var{messageRemindType:e,startTime:s,endTime:i,isRepeated:r}=e;let o=t.MSG_REMIND_ACPT_AND_NOTE;return 1===e&&(o=t.MSG_REMIND_DISCARD),{messageRemindType:o=2===e?t.MSG_REMIND_ACPT_NOT_NOTE:o,startTime:s,endTime:i,isRepeated:1===r}}reset(){Ce.l(this._n+".reset")}}class dn{constructor(e){this._convM=e,this._n="ConvGroupHandler",this._convGroupMap=new Map,this._startIndex=0,this._pagingStatus=Ut}setConvCustomData(e){let s=this._n+".setConvCustomData",{conversationIDList:i,customData:r}=e,o=(Ce.l(s+" options:",e),new Ti("setConvCustomData")),n=(o.setMessage(JSON.stringify(e)),{fromAccount:this._getMyUserID(),itemList:[]}),a=[],l=[];return i.forEach(e=>{var s;return this._hasLocalConv(e)?at(e)||ct(e)?(s={operationType:2,contactItem:void 0,customMark:r},at(e)?s.contactItem={type:1,toAccount:e.replace(t.CONV_C2C,"")}:ct(e)&&(s.contactItem={type:2,groupID:e.replace(t.CONV_GROUP,"")}),void n.itemList.push(s)):(this._onConvIDInvalid(l,e),!0):(this._onConvNotFound(l,e),!0)}),l.length===i.length?ii({successConversationIDList:a,failureConversationIDList:l}):this._convM.req({P:ri.SET_CONV_CUSTOM_DATA,data:n}).then(e=>{o.end(),Ce.l(s+" ok");e=e.data.resultItem;if(Fe(e)){let t,s,i=!1;e.forEach(e=>{t=this._concatConvID(e.contactItem),0===e.resultCode?(a.push(t),(s=this._getLocalConv(t))&&s.customData!==r&&(s.customData=r,i=!0)):l.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&this._emitConvUpdate()}return Zs({successConversationIDList:a,failureConversationIDList:l})}).catch(e=>(o.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}markConv(e){if(!this._convM.canIUse(M.CONV_MARK))return this._convM.noUse("markConv");let s=this._n+".markConv",{conversationIDList:i,markType:r,enableMark:o}=e,n=(Ce.l(s+" options:",e),new Ti("markConv")),a=(n.setMessage(JSON.stringify(e)),void 0),l=void 0;e=this._getFlagBit(r);!0===o?l=[e]:a=[e];let d={fromAccount:this._getMyUserID(),itemList:[]},c=[],_=[];return i.forEach(e=>{var s;return this._hasLocalConv(e)?at(e)||ct(e)?(s={operationType:1,contactItem:void 0,clearMark:a,setMark:l},at(e)?s.contactItem={type:1,toAccount:e.replace(t.CONV_C2C,"")}:ct(e)&&(s.contactItem={type:2,groupID:e.replace(t.CONV_GROUP,"")}),void d.itemList.push(s)):(this._onConvIDInvalid(_,e),!0):(this._onConvNotFound(_,e),!0)}),_.length===i.length?ii({successConversationIDList:c,failureConversationIDList:_}):this._convM.req({P:ri.MARK_CONV,data:d}).then(e=>{n.end(),Ce.l(s+" ok");e=e.data.resultItem;if(Fe(e)){let t,s,i=!1;e.forEach(e=>{if(t=this._concatConvID(e.contactItem),0===e.resultCode){if(c.push(t),s=this._getLocalConv(t)){let e=s.markList.indexOf(r);!0===o?-1===e&&(s.markList.push(r),i=!0):-1!==e&&(s.markList.splice(e,1),i=!0)}}else _.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&this._emitConvUpdate()}return Zs({successConversationIDList:c,failureConversationIDList:_})}).catch(e=>(n.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}getLocalConvGroupList(){return Ce.l(this._n+".getLocalConvGroupList pagingStatus:"+this._pagingStatus),this._pagingStatus===wt?this.getRemoteConvGroupList().then(()=>Zs([...this._convGroupMap.values()])):ii([...this._convGroupMap.values()])}searchConvGroupAndMark(e,t){let s=this._n+".searchConvGroupAndMark",i=[];return e.forEach(e=>{1===t?i.push({type:1,toAccount:e}):2===t&&i.push({type:2,groupID:e})}),Ce.l(s+` type:${t} list:`,e),this._convM.req({P:ri.SEARCH_CONV_GRP_MARK,data:{fromAccount:this._getMyUserID(),contactItem:i}}).then(e=>{var{contactItem:e,groupItem:t}=e.data;Ce.l(s+" ok. contactItem:",e,"groupItem:",t),this._fillConvGroupMap(t),this._handleContactItem(e),this._emitConvUpdate()}).catch(e=>{Ce.w(s+" failed. error:",e)})}_fillConvGroupMap(e){Fe(e)&&e.forEach(e=>{var{convGroupID:e,groupName:t}=e;this._convGroupMap.set(e,t)})}_handleContactItem(e){if(Fe(e)){let o,n;e.forEach(e=>{let t=[],{standardMark:s,customData:i,convGroupIDList:r}=e;Fe(r)&&r.forEach(e=>{this._convGroupMap.has(e)&&t.push(this._convGroupMap.get(e))}),n=this._concatConvID(e),(o=this._getLocalConv(n))&&(o.markList=vt(s),o.customData=i||"",o.conversationGroupList=[...t])})}}getRemoteConvGroupList(){let r=this._n+".getRemoteConvGroupList";return this._pagingStatus=Gt,this._convM.req({P:ri.GET_CONV_GRP_LIST,data:{fromAccount:this._getMyUserID(),startIndex:this._startIndex}}).then(e=>{var{completeFlag:e,contactItem:t,nextStartIndex:s=0,groupItem:i}=e.data;if(this._startIndex=s,Ce.l(r+` completeFlag:${e} nextStartIndex:${s}, groupItem:`,i,"contactItem:",t),this._fillConvGroupMap(i),this._handleContactItem(t),0===e)return this.getRemoteConvGroupList();1===e&&(this._pagingStatus=kt,this._emitConvUpdate(),this._emitConvGroupListUpdate())}).catch(e=>{this._pagingStatus=wt,Ce.w(r+" failed. error:",e)})}createConvGroup(e){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("createConvGroup");let s=this._n+".createConvGroup",i=(Ce.l(s+" options:",e),new Ti("createConvGroup")),{groupName:o,conversationIDList:r}=(i.setMessage(JSON.stringify(e)),e),n={fromAccount:this._getMyUserID(),itemList:[{groupName:o,contactItem:[]}]},a=[],l=[];return r.forEach(e=>this._hasLocalConv(e)?at(e)||ct(e)?void(at(e)?n.itemList[0].contactItem.push({type:1,toAccount:e.replace(t.CONV_C2C,"")}):ct(e)&&n.itemList[0].contactItem.push({type:2,groupID:e.replace(t.CONV_GROUP,"")})):(this._onConvIDInvalid(l,e),!0):(this._onConvNotFound(l,e),!0)),l.length===r.length?ii({successConversationIDList:a,failureConversationIDList:l}):this._convM.req({P:ri.CREATE_CONV_GRP,data:n}).then(e=>{i.end(),Ce.l(s+" ok");var e=e.data["groupResultItem"],{groupItem:e,resultItem:r}=e[0];if(be(e)&&(this._convGroupMap.set(e.convGroupID,e.groupName),this._emitConvGroupListUpdate()),Fe(r)){let t,s,i=!1;r.forEach(e=>{t=this._concatConvID(e.contactItem),0===e.resultCode?(a.push(t),(s=this._getLocalConv(t))&&-1===s.conversationGroupList.indexOf(o)&&(s.conversationGroupList.push(o),i=!0)):l.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&(this._emitConvUpdate(),this._emitConvGroupListUpdate())}return Zs({successConversationIDList:a,failureConversationIDList:l})}).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}deleteConvGroup(t){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("deleteConvGroup");let s=this._n+".deleteConvGroup",i=(Ce.l(s+" groupName:"+t),new Ti("deleteConvGroup"));return i.setMessage(t),this._convM.req({P:ri.DEL_CONV_GRP,data:{fromAccount:this._getMyUserID(),groupName:[t]}}).then(e=>{i.end(),Ce.l(s+" ok");e=e.data.groupItem;if(Fe(e)){let t=!1;e.forEach(e=>{this._convGroupMap.has(e.convGroupID)&&(this._convGroupMap.delete(e.convGroupID),t=!0)}),!0===t&&this._emitConvGroupListUpdate()}this._eraseFromConversationGroupList([t])}).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}renameConvGroup(e){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("renameConvGroup");let r=this._n+".renameConvGroup",o=(Ce.l(r+" options:",e),new Ti("renameConvGroup")),{oldName:n,newName:a}=(o.setMessage(JSON.stringify(e)),e);return this._convM.req({P:ri.RENAME_CONV_GRP,data:{fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:1,oldName:n,newName:a}}}).then(e=>{o.end(),Ce.l(r+" ok");e=e.data.updateGroupResult,e=e.convGroupID,this._convGroupMap.set(e,a),this._emitConvGroupListUpdate(),e=this._convM.getLocalConvList();let t,s,i=!1;e.forEach(e=>{t=e.conversationGroupList,-1!==(s=t.indexOf(n))&&(t.splice(s,1,a),i=!0)}),!0===i&&this._emitConvUpdate()}).catch(e=>(o.setError(e).end(),Ce.e(r+" failed. error:",e),ni(e)))}addConvsToGroup(e){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("addConvsToGroup");let s=this._n+".addConvsToGroup",i=(Ce.l(s+" options:",e),new Ti("addConvsToGroup")),{conversationIDList:r,groupName:o}=(i.setMessage(JSON.stringify(e)),e),n={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:o,updateItem:[]}},a=[],l=[];return r.forEach(e=>this._hasLocalConv(e)?at(e)||ct(e)?void(at(e)?n.updateGroup.updateItem.push({operationType:1,contactItem:{type:1,toAccount:e.replace(t.CONV_C2C,"")}}):ct(e)&&n.updateGroup.updateItem.push({operationType:1,contactItem:{type:2,groupID:e.replace(t.CONV_GROUP,"")}})):(this._onConvIDInvalid(l,e),!0):(this._onConvNotFound(l,e),!0)),l.length===r.length?ii({successConversationIDList:a,failureConversationIDList:l}):this._convM.req({P:ri.ADD_CONV_TO_GRP,data:n}).then(e=>{i.end(),Ce.l(s+" ok");e=e.data.updateGroupResult.contactResultItem;if(Fe(e)){let t,s,i=!1;e.forEach(e=>{t=this._concatConvID(e.contactItem),0===e.resultCode?(s=this._getLocalConv(t))&&-1===s.conversationGroupList.indexOf(o)&&(s.conversationGroupList.push(o),a.push(t),i=!0):l.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(o))}return Zs({successConversationIDList:a,failureConversationIDList:l})}).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}deleteConvsFromGroup(e){var s="deleteConvsFromGroup";if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse(s);let i=this._n+"."+s,r=(Ce.l(i+" options:",e),new Ti(s)),{conversationIDList:o,groupName:n}=(r.setMessage(JSON.stringify(e)),e),a={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:n,updateItem:[]}},l=[],d=[];return o.forEach(e=>this._hasLocalConv(e)?at(e)||ct(e)?void(at(e)?a.updateGroup.updateItem.push({operationType:2,contactItem:{type:1,toAccount:e.replace(t.CONV_C2C,"")}}):ct(e)&&a.updateGroup.updateItem.push({operationType:2,contactItem:{type:2,groupID:e.replace(t.CONV_GROUP,"")}})):(this._onConvIDInvalid(d,e),!0):(this._onConvNotFound(d,e),!0)),d.length===o.length?ii({successConversationIDList:l,failureConversationIDList:d}):this._convM.req({P:ri.DEL_CONV_FROM_GRP,data:a}).then(e=>{r.end(),Ce.l(i+" ok");e=e.data.updateGroupResult.contactResultItem;if(Fe(e)){let t,s,i=!1;e.forEach(e=>{if(t=this._concatConvID(e.contactItem),0===e.resultCode){if(s=this._getLocalConv(t)){let e=s.conversationGroupList.indexOf(n);-1!==e&&(s.conversationGroupList.splice(e,1),l.push(t),i=!0)}}else d.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(n))}return Zs({successConversationIDList:l,failureConversationIDList:d})}).catch(e=>(r.setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)))}onConvMarkUpdated(e){if(!Oe(e)){let r,o,n=(Ce.l(this._n+".onConvMarkUpdated markItemList:",e),!1);e.forEach(e=>{var{recentContactItem:e,optType:t,standardMark:s,customMark:i}=e;if(r=this._concatConvID(e),o=this._getLocalConv(r))if(1===t)n=this._diffStandardMark(o,s);else if(2===t)n=this._diffCustomMark(o,i);else if(3===t){let e=this._diffStandardMark(o,s),t=this._diffCustomMark(o,i);n=e||t}}),!0===n&&this._emitConvUpdate()}}_diffStandardMark(e,t){t=vt(t);let s=!1;return!0!==function(s,i){if(s!==i){if(!s||!i)return!1;if(s.length!==i.length)return!1;for(let e=0,t=s.length;e<t;e++)if(s[e]!==i[e])return!1}return!0}(e.markList,t)&&(e.markList=t,s=!0),s}_diffCustomMark(e,t){let s=!1;return e.customData!==t&&void 0!==t&&(e.customData=t,s=!0),s}onConvGroupCreated(e){Ce.l(this._n+".onConvGroupCreated resultList:",e);let r=!1,s=!1;Fe(e)&&(e.forEach(e=>{let{groupID:t,groupName:i}=e.msgGroupItem;this._convGroupMap.get(t)!==i&&(this._convGroupMap.set(t,i),s=!0);e=e.msgRecentContactItem;if(Fe(e)){let t,s;e.forEach(e=>{t=this._concatConvID(e),(s=this._getLocalConv(t))&&-1===s.conversationGroupList.indexOf(i)&&(s.conversationGroupList.push(i),r=!0)})}}),!0===r&&this._emitConvUpdate(),!0===s)&&this._emitConvGroupListUpdate()}onConvGroupDeleted(e){Ce.l(this._n+".onConvGroupDeleted groupItemList:",e);let i=[];if(Fe(e)){let s=!1;e.forEach(e=>{var{groupID:e,groupName:t}=e;this._convGroupMap.has(e)&&(this._convGroupMap.delete(e),s=!0,i.push(t))}),!0===s&&this._emitConvGroupListUpdate()}this._eraseFromConversationGroupList(i)}_eraseFromConversationGroupList(t){Oe(t)||(this._convM.getLocalConvList().forEach(e=>{e.conversationGroupList=e.conversationGroupList.filter(e=>!t.includes(e))}),this._emitConvUpdate())}onConvGroupNameUpdated(e){Ce.l(this._n+".onConvGroupNameUpdated options:",e);let{groupID:r,groupName:o,oldGroupName:n}=e;if(this._convGroupMap.get(r)!==o){this._convGroupMap.set(r,o),this._emitConvGroupListUpdate();e=this._convM.getLocalConvList();let t,s,i=!1;e.forEach(e=>{t=e.conversationGroupList,-1!==(s=t.indexOf(n))&&(t.splice(s,1,o),i=!0)}),!0===i&&this._emitConvUpdate()}}onConvInGroupUpdated(e){Ce.l(this._n+".onConvInGroupUpdated options:",e);let{oldGroupName:n,recentContactUpdateGroupItem:t}=e;if(Fe(t)){let s,i,r,o=!1;t.forEach(e=>{var{contactOptType:e,recentContactItem:t}=e;s=this._concatConvID(t),(i=this._getLocalConv(s))&&(r=i.conversationGroupList.indexOf(n),1===e?-1===r&&(i.conversationGroupList.push(n),o=!0):2===e&&-1!==r&&(i.conversationGroupList.splice(r,1),o=!0))}),!0===o&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(n))}}onConvAddedToOrDeletedFromGroup(e){Ce.l(this._n+".onConvAddedToOrDeletedFromGroup options:",e);let{msgRecentContactItem:t,msgRecentContactUpdateContactItem:r}=e,s=this._concatConvID(t),o=this._getLocalConv(s);if(o&&Fe(r)){let s,i=!1;r.forEach(e=>{var{groupOptType:e,recentContactGroupItem:t}=e,t=t["groupName"];s=o.conversationGroupList.indexOf(t),1===e?-1===s&&(o.conversationGroupList.push(t),i=!0):2===e&&-1!==s&&(o.conversationGroupList.splice(s,1),i=!0),!0===i&&this._emitConvInGroupUpdate(t)}),!0===i&&this._emitConvUpdate()}}onConvGroupListSynced(e){Fe(e)&&0!==e.length&&(Ce.l(this._n+".onConvGroupListSynced groupItem:",e),this._fillConvGroupMap(e))}getConvGroupListByID(e){if(!Oe(e)){let t=[];return e.forEach(e=>{this._convGroupMap.has(e)&&t.push(this._convGroupMap.get(e))}),t}}_onConvNotFound(e,t){e.push({conversationID:t,code:ei.CONV_NOT_FOUND,message:this._convM.getErrMsg(ei.CONV_NOT_FOUND)})}_onConvIDInvalid(e,t){e.push({conversationID:t,code:ei.INVALID_CONV_ID,message:this._convM.getErrMsg(ei.INVALID_CONV_ID)})}_getFlagBit(e){var t=e.toString(2),s=t.length;for(let e=s-1;0<=e;e--)if("1"===t[e])return s-e-1}_concatConvID(e){var{type:e,to:s,groupID:i,userID:r}=e;let o;return 1===e?$e(r)?$e(s)||(o=""+t.CONV_C2C+s):o=""+t.CONV_C2C+r:2===e&&(o=""+t.CONV_GROUP+i),o}_getMyUserID(){return this._convM.getMyUserID()}_getLocalConv(e){return this._convM.getLocalConversation(e)}_hasLocalConv(e){return this._convM.hasLocalConversation(e)}_emitConvUpdate(){this._convM.emitConvUpdate(!0,!1)}_emitConvGroupListUpdate(){this._convM.emitOEvt(e.CONVERSATION_GROUP_LIST_UPDATED,[...this._convGroupMap.values()])}_emitConvInGroupUpdate(t){var s={groupName:t,conversationList:[]},i=this._convM.getLocalConvList();s.conversationList=i.filter(e=>e.conversationGroupList.includes(t)),this._convM.emitOEvt(e.CONVERSATION_IN_GROUP_UPDATED,s)}reset(){Ce.l(this._n+".reset"),this._convGroupMap.clear(),this._startIndex=0,this._pagingStatus=Ut}}class _n extends oi{constructor(e){super(e),this._n="ConvModule",ji.mixin(this),this._msgListHandler=new zi(this),this._msgRemindHandler=new un(this),this._convGroupHandler=new dn(this),this._sll=new nn(100),this._pagingStatus=Ut,this._pagingTs=0,this._pagingStartIdx=0,this._pagingPinnedTs=0,this._pagingPinnedStartIdx=0,this._pagingConvIDMap=new Map,this._convIDFromUnreadDBMap=new Map,this._convMap=new Map,this._tmpGroupList=[],this._tmpGroupAtTipsList=[],this._peerReadTimeMap=new Map,this._completedMap=new Map,this._roamingMsgKeyAndTimeMap=new Map,this._remoteGroupReadSeqMap=new Map,this._convTotalUnreadCount=0,this._pagingGetCostList=[],this._convMapForDiff=new Map,this._partialUpdatedConvMap=new Map,this._everClearedMap=new Map,this._bPullOnInvite=!0,this._initListeners()}_initListeners(){var e=this.getIEmitInst();e.on(Yi.A2KEY_AND_TINYID_UPDATED,this._init,this),e.on(Yi.PROFILE_UPDATED,this._onProfileUpdated,this),e.on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_init(){Ce.l(this._n+"._init");var t=this.get(Ls).getItem("conversationMap"),s=this.isIntl(),i=this.isUsingChatCore();if(t){var r=t.length;for(let e=0;e<r;e++){var o=t[e];if(o){if(this._isNonExistentAccount(o.conversationID))continue;if(o.groupProfile&&nt(o.groupProfile.type))continue}this._convMap.set(o.conversationID,new cn(t[e],s,i))}this.emitConvUpdate(!0,!1)}this.ready(()=>{0<this._tmpGroupList.length&&(this.updateConvGroupProfile(this._tmpGroupList),this._tmpGroupList.length=0)}),this.syncConvList()}_isNonExistentAccount(e){let s;return"@TLS#ERROR"===(s=e.startsWith(t.CONV_C2C)?e.replace(t.CONV_C2C,""):s)||"@TLS#NOT_FOUND"===s}onCheckTimer(e){this.isLoggedIn()&&this._msgListHandler.onCheckTimer(e)}onMessageSent(e){this._onSendOrRcvMsg({conversationOptionsList:e.conversationOptionsList,isInstantMessage:!0})}onNewMessage(e){this._onSendOrRcvMsg(e)}_onSendOrRcvMsg(e){var{conversationOptionsList:t,isInstantMessage:s=!0,isUnreadC2CMessage:i=!1,updateUnreadCount:r=!0,isSyncingEnded:o=!1}=e;this._isReady?0===t.length?o&&this.emitIEvt(Yi.C2C_UNREAD_HANDLE_COMPLETED):(!0===s&&this._checkNewConv(t),this._updateLocalConvList({conversationOptionsList:t,isInstantMessage:s,isUnreadC2CMessage:i,isFromGetConversations:!1,updateUnreadCount:r}),s||(this._convIDFromUnreadDBMap=new Map([...this._convIDFromUnreadDBMap,...t.map(e=>[e.conversationID,1])]),this._diffAndDeleteConv(),o&&this.emitIEvt(Yi.C2C_UNREAD_HANDLE_COMPLETED)),0<t.filter(e=>!this._isConvNeedShow(e.conversationID)).length||this.emitConvUpdate()):this.ready(()=>{this._onSendOrRcvMsg(e)})}updateConvGroupProfile(e){if(!Fe(e)||0!==e.length)if(0===this._convMap.size)this._tmpGroupList=e;else{let r=!1;e.forEach(s=>{var i=""+t.CONV_GROUP+s.groupID;if(this._convMap.has(i)){r=!0;let e=this._convMap.get(i);e.groupProfile=JSON.parse(JSON.stringify(s)),e.lastMessage.lastSequence<s.nextMessageSeq&&(e.lastMessage.lastSequence=s.nextMessageSeq-1),e.subType||(e.subType=s.type)}}),r&&this.emitConvUpdate(!0,!1)}}onMessageRevoked(e,o){if(0!==e.length){let s=null,i=!1,r=[];e.forEach(e=>{(s=this._convMap.get(e.conversationID))&&(o&&s.reduceUnreadCount()&&(i=s.type!==t.CONV_TOPIC),s.type===t.CONV_TOPIC?r.push(e):s.isLastMessageRevoked({sequence:e.sequence,time:e.time})&&(s.setLastMessageRevoked(!0),s.setLastMessageRevoker(e.revoker),i=!0))}),this.get(Ss).onMessageRevoked(r),i&&this.emitConvUpdate(!0,!1)}}updateRevokerInfo(s){var i=new Set;for(let t=0;t<s.length;t++){let e=s[t]["revoker"];i.add(e)}let t=[...i],r=this.get(Ts);return new Promise(e=>{r.getUserProfile({userIDList:t}).then(i=>{i=i.data;if(!Fe(i)||0===i.length)return e(s);let r={};for(let{userID:e,nick:t,avatar:s}of i)r[e]={nick:t,avatar:s};s.forEach(e=>{var t=e["revoker"];r[t]&&(e.revokerInfo.nick=r[t].nick||"",e.revokerInfo.avatar=r[t].avatar||"")}),e(s)}).catch(()=>{e(s)})})}isLastMessageRevoked(e){let s=!1;var{conversationID:i,sequence:r,time:o}=e,n=this._convMap.get(i);return n&&(s=n.type===t.CONV_TOPIC?this.get(Ss).isLastMessageRevoked({topicID:i.replace(t.CONV_GROUP,""),sequence:r}):n.isLastMessageRevoked({sequence:r,time:o})),Ce.l(this._n+".isLastMessageRevoked options:",e,"ret:"+s),s}onMessageDeleted(r){if(0!==r.length){let s=null;r.forEach(e=>{(s=this._msgListHandler.getLocalMsg(e.conversationID,e.ID))&&(s.isDeleted=!0),e!==s&&(e.isDeleted=!0)});var r=r[0].conversationID,o=this._msgListHandler.getLocalMsgList(r);let i={};for(let e=o.length-1;0<=e;e--)if(!o[e].isDeleted){i=o[e];break}var n=this._convMap.get(r);if(n){let e=!1;n.lastMessage.lastSequence===i.sequence&&n.lastMessage.lastTime===i.time||(Oe(i)&&(i=void 0),n.updateLastMessage(i),n.type!==t.CONV_TOPIC&&(e=!0),Ce.l(this._n+`.onMessageDeleted. update convID:${r} with lastMessage:`,n.lastMessage)),r.startsWith(t.CONV_C2C)&&this.updateUnreadCount(r),e&&this.emitConvUpdate(!0,!1)}}}onMessageModified(s){var i=this._n+".onMessageModified",{conversationType:r,from:o,to:n,time:a,sequence:l,elements:d,cloudCustomData:c,messageVersion:_}=s;let u=""+r+n;n===this.getMyUserID()&&r===t.CONV_C2C&&(u=""+r+o);var{isUpdated:r,message:h}=this._msgListHandler.onMsgModified(u,s),p=(!0===r&&this.emitOEvt(e.MESSAGE_MODIFIED,[h]),this._isTopicConv(u));if(null===h?Ce.l(i+" message is null! options:",s):Ce.l(i+` isUpdated:${r} isTopicMessage:${p} from:${o} to:${n} sequence:${h.sequence} time:`+h.time),p)this.get(Ss).onMessageModified(s);else{let t=this._convMap.get(u);if(t){let e=t.lastMessage;e&&e.lastTime===a&&e.lastSequence===l&&e.version!==_&&(Ce.l(i+` convID:${u} lastMessage updated`),e.type=d[0].type,e.payload=d[0].content,e.messageForShow=yt(e.type,e.payload,this.isIntl()),e.cloudCustomData=c,e.version=_,this.emitConvUpdate(!0,!1))}}return h}onNewGroupAtTips(e){e=e.dataList;let t=null;e.forEach(e=>{e.groupAtTips?t=e.groupAtTips:e.elements?t={...e.elements,sync:!0}:e.groupAtType&&(t={...e,sync:!0}),t.__random=e.random,t.__sequence=e.clientSequence,this._tmpGroupAtTipsList.push(t)}),Ce.l(this._n+".onNewGroupAtTips isReady:"+this._isReady,this._tmpGroupAtTipsList),this._isReady&&this._handleGroupAtTipsList()}_handleGroupAtTipsList(){if(0!==this._tmpGroupAtTipsList.length){let n=!1;this._tmpGroupAtTipsList.forEach(s=>{let{groupID:i,from:e,topicID:r,sync:o=!1}=s;if(e!==this.getMyUserID())if($e(r)){let e=this._convMap.get(""+t.CONV_GROUP+i);e&&(e.updateGroupAtInfoList(s),n=!0)}else{let e=this._convMap.get(""+t.CONV_GROUP+r);e&&(e.updateGroupAtInfoList(s),this.get(Ss).onAtInfoUpdated({topicID:r,groupAtInfoList:e.groupAtInfoList})),Oe(e)&&o&&(this.updateTopicConversation([{conversationID:""+t.CONV_GROUP+r,type:t.CONV_TOPIC}]),this._convMap.get(""+t.CONV_GROUP+r).updateGroupAtInfoList(s))}}),n&&this.emitConvUpdate(!0,!1),this._tmpGroupAtTipsList.length=0}}_checkNewConv(e){let s=[],i=[];e.forEach(e=>{this._convMap.has(e.conversationID)||(e.type===t.CONV_C2C?s.push(e.conversationID.replace(t.CONV_C2C,"")):e.type===t.CONV_GROUP&&i.push(e.conversationID.replace(t.CONV_GROUP,"")))}),0<s.length&&(this._onNewC2CConv(s),s=null),0<i.length&&(this._onNewGroupConv(i),i=null)}_onNewC2CConv(e){var t=this.get(ys);return Promise.all([t.getRemotePeerReadTime(e),this._msgRemindHandler.getC2CMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,1)])}_onNewGroupConv(e){var t=this.get(vs);return t?Promise.all([t.getMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,2)]):Promise.resolve()}_setStorageConvList(e=!1){var s=this.getLocalConvList().filter(e=>e.type===t.CONV_C2C||e.type===t.CONV_GROUP&&e.lastMessage.type!==t.MSG_GRP_TIP).slice(0,20).map(e=>({conversationID:e.conversationID,type:e.type,subType:e.subType,lastMessage:e.lastMessage,groupProfile:e.groupProfile,userProfile:e.userProfile}));this.get(Ls).setItem("conversationMap",s,e)}emitConvUpdate(t=!0,s=!0){var i=this.getLocalConvList();if(s){let e=this.get(vs);e&&e.updateGroupLastMessage(i)}t&&(this.get(Rs).isPartialUpdatedConvs()?(this._diffConvMap(this._convMapForDiff,this._convMap),0<this._partialUpdatedConvMap.size&&(this.emitOEvt(e.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate(),this._convMapForDiff.clear(),this._convMapForDiff=Ye(this._convMap,!0)),0===this._convMapForDiff.size&&(this._convMapForDiff=Ye(this._convMap,!0))):(this.emitOEvt(e.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate()))}_diffConvMap(e,t){for(var[s,i]of t)e.has(s)&&JSON.stringify(i)===e.get(s)||this._partialUpdatedConvMap.set(s,i)}getPartialUpdatedConvs(){var e=[...Ye(this._partialUpdatedConvMap,!1).values()];return this._partialUpdatedConvMap.clear(),e}getLocalConvList(){return[...this._convMap.values()].filter(e=>this._isConvNeedShow(e.conversationID))}getLocalConversation(e){return this._convMap.get(e)}hasLocalConversation(e){return this._convMap.has(e)}getLocalOldestMessage(e){return this._msgListHandler.getLocalOldestMsg(e)}syncConvList(e=!0){let i=new Ti("syncConvList");return this._pagingStatus===Ut&&this._convMap.clear(),this._pagingGetConvList(e).then(e=>{var t=function(e){if(Fe(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),(t/e.length).toFixed(0)}}(this._pagingGetCostList),s=function(e){if(Fe(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),t.toFixed(0)}}(this._pagingGetCostList),s=(this._pagingGetCostList.length=0,this._pagingStatus=kt,this._diffAndDeleteConv(),this.emitConvUpdate(!0,!1),this._setStorageConvList(),this._handleC2CPeerReadTime(),this.emitIEvt(Yi.CONV_SYNC_COMPLETED),`count:${this._convMap.size} sum:${s} avg:`+t);return Ce.l(this._n+".syncConvList. "+s),i.setMessage(s).end(),e}).catch(e=>(this._pagingStatus=wt,i.setMessage(this._pagingTs).setError(e).end(),ni(e)))}_diffAndDeleteConv(){if(this._isSyncCompleted()){let s=[];this._convMap.forEach((e,t)=>{!this._pagingConvIDMap.has(t)&&this._convIDFromUnreadDBMap.has(t)&&(this._convMap.delete(t),s.push(t))}),Ce.l(this._n+"._diffAndDeleteConv list:"+s),s=null}}_pagingGetConvList(e=!0){let a=this._n+"._pagingGetConvList",l=(Ce.l(a+` incrementalPullFlag:${e} ts:${this._pagingTs} startIdx:${this._pagingStartIdx} pinnedTs:${this._pagingPinnedTs} pinnedStartIdx:`+this._pagingPinnedStartIdx),Date.now());return this._pagingStatus=Gt,this.req({P:ri.PAGING_GET_CONV_LIST,data:{fromAccount:this.getMyUserID(),timeStamp:e?this._pagingTs:0,startIndex:e?this._pagingStartIdx:0,pinnedTimeStamp:e?this._pagingPinnedTs:0,pinnedStartIndex:e?this._pagingPinnedStartIdx:0,orderType:1}}).then(e=>{var{completeFlag:e,conversations:t=[],timeStamp:s,startIndex:i,pinnedTimeStamp:r,pinnedStartIndex:o,groupItem:n}=e.data;if(this._pagingGetCostList.push(Dt(l,!1)),Ce.l(a+` ok. completeFlag:${e} count:${t.length} cost:`+Dt(l)),this._convGroupHandler.onConvGroupListSynced(n),0<t.length){let e=this._getConvOptions(t);this._pagingConvIDMap=new Map([...this._pagingConvIDMap,...e.map(e=>[e.conversationID,1])]),this._updateLocalConvList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0}),this.isLoggedIn()&&this.emitConvUpdate()}if(!this._isReady){if(!this.isLoggedIn())return ii();this.triggerReady()}return this._pagingTs=s,this._pagingStartIdx=i,this._pagingPinnedTs=r,this._pagingPinnedStartIdx=o,1!==e?this._pagingGetConvList():(this._handleGroupAtTipsList(),this._convGroupHandler.getRemoteConvGroupList(),ii())}).catch(e=>{throw!this.isLoggedIn()||this._isReady||(Ce.w(a+" failed. error:",e),this.triggerReady()),e})}_updateLocalConvList(e){var t=e["isFromGetConversations"],s=Date.now(),e=this._getTmpConvListMapping(e)["newConvList"];this._convMap=new Map(this._sortConvList([...this._convMap])),t||this._updateUserOrGroupProfile(e),Ce.l(this._n+"._updateLocalConvList cost:"+Dt(s))}_getTmpConvListMapping(e){let{conversationOptionsList:d,isFromGetConversations:c,isInstantMessage:_,isUnreadC2CMessage:u=!1,updateUnreadCount:h}=e,s=[],r=[],i=this.get(vs),p=this.get(Es),g=this.isIntl(),m=this.isUsingChatCore();for(let l=0,e=d.length;l<e;l++){let o=new cn(d[l],g,m),{conversationID:n,type:a}=o;if(!this._isNonExistentAccount(n)){if(this._convMap.has(n)){let e=this._convMap.get(n);if(c&&a!==t.CONV_TOPIC){this._convMap.set(n,o),a===t.CONV_C2C?o.unreadCount=e.unreadCount:a===t.CONV_GROUP&&(o.groupProfile=JSON.parse(JSON.stringify(e.groupProfile)));continue}let s=["unreadCount","allowType","adminForbidType","payload"],i=(!1===_&&s.push("lastMessage"),"boolean"==typeof _&&s.push("isPinned"),d[l].lastMessage),r=!$e(i);r||d[l].type===t.CONV_TOPIC||this._onLastMsgNotExist(d[l]),$e(_)&&r&&null===e.lastMessage.payload&&(e.lastMessage.payload=i.payload),Oe(e.lastMessage.revoker)||(e.lastMessage.revoker=null),We(e,o,s,[null,void 0,"",0,NaN]),!0===h&&e.updateUnreadCount({nextUnreadCount:o.unreadCount,isFromGetConversations:c,isUnreadC2CMessage:u}),_&&r&&(i.payload&&(e.lastMessage.payload=i.payload),e.type===t.CONV_GROUP)&&(e.lastMessage.nameCard=i.nameCard,e.lastMessage.nick=i.nick),r&&e.lastMessage.cloudCustomData!==i.cloudCustomData&&(e.lastMessage.cloudCustomData=i.cloudCustomData||"")}else{if(a===t.CONV_GROUP&&i){let e=o.groupProfile["groupID"],t=i.getLocalGroupProfile(e);t&&(o.groupProfile=t,!0===h)&&o.updateUnreadCount({nextUnreadCount:0})}else if(a===t.CONV_C2C){let e=n.replace(t.CONV_C2C,"");p&&p.isMyFriend(e)&&(o.remark=p.getFriendRemark(e))}s.push(o),this._convMap.set(n,o)}this._convMap.get(n).type===t.CONV_TOPIC&&r.push(this._convMap.get(n))}}let o=this.get(Ss);for(let i=0,e=r.length;i<e;i++){let{conversationID:e,groupAtInfoList:s}=r[i];Oe(s)||o.onAtInfoUpdated({topicID:e.replace(t.CONV_GROUP,""),groupAtInfoList:s})}return{newConvList:s}}_onLastMsgNotExist(e){new Ti("lastMsgNotExist").setMessage(JSON.stringify(e)).end()}_sortConvList(e){let t=[],s=[],i=[],r=[];return e.forEach(e=>{(!0===e[1].isPinned?Oe(e[1].lastMessage.lastTime)?s:t:Oe(e[1].lastMessage.lastTime)?r:i).push(e)}),t.sort((e,t)=>t[1].lastMessage.lastTime-e[1].lastMessage.lastTime).concat(s).concat(i.sort((e,t)=>t[1].lastMessage.lastTime-e[1].lastMessage.lastTime)).concat(r)}_sortConvListAndEmitEvent(){this._convMap=new Map(this._sortConvList([...this._convMap])),this.emitConvUpdate(!0,!1)}_updateUserOrGroupProfile(o){if(0!==o.length){let e=[],i=[],s=this.get(Ts),r=this.get(vs);o.forEach(s=>{if(s.type===t.CONV_C2C)e.push(s.toAccount);else if(s.type===t.CONV_GROUP){let e=s.toAccount;r.hasLocalGroup(e)?s.groupProfile=r.getLocalGroupProfile(e):i.push(e)}}),Ce.l(`${this._n}._updateUserOrGroupProfile userIDList:${e} groupIDList:`+i),0<e.length&&s.getUserProfile({userIDList:e}).then(({data:e})=>{Fe(e)?e.forEach(e=>{this._doUpdateUserProfile(""+t.CONV_C2C+e.userID,e)}):this._doUpdateUserProfile(""+t.CONV_C2C+e.userID,e)}),0<i.length&&r.getGroupProfileAdvance({groupIDList:i,responseFilter:{groupBaseInfoFilter:["Type","Name","FaceUrl"]}}).then(({data:{successGroupList:e}})=>{let r=!1;e.forEach(s=>{var i=""+t.CONV_GROUP+s.groupID;if(this._convMap.has(i)){let e=this._convMap.get(i);We(e.groupProfile,s,[],[null,void 0,"",0,NaN]),!e.subType&&s.type&&(e.subType=s.type),r=!0}}),r&&this.emitConvUpdate()})}}_doUpdateUserProfile(e,t){this.hasLocalConversation(e)&&(this.getLocalConversation(e).userProfile=t,this.emitConvUpdate())}_getConvOptions(e){let i=[],s=e.filter(({type:e,userID:t})=>1===e&&!this._isNonExistentAccount(t)||2===e),r=this.getMyUserID(),o=s.map(e=>{var s;return $e(e.lastMsg)&&(e.lastMsg={elements:[]}),1===e.type?(s={userID:e.userID,nick:e.peerNick,avatar:e.peerAvatar},i.push(s),{conversationID:""+t.CONV_C2C+e.userID,type:t.CONV_C2C,lastMessage:{lastTime:e.time,lastSequence:e.sequence,fromAccount:e.lastC2CMsgFromAccount,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:null,payload:e.lastMsg.elements[0]?this._amendLayersOverLimitProp(e.lastMsg.elements[0].content):null,cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:8===e.lastMessageFlag,onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:e.lastC2CMsgFromAccount===r&&e.time<=e.c2cPeerReadTime,revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null},unreadCount:0,userProfile:new sn(s),peerReadTime:e.c2cPeerReadTime,isPinned:1===e.isPinned,customData:e.customMark||"",markList:vt(e.standardMark),conversationGroupList:this._convGroupHandler.getConvGroupListByID(e.contactGroupId),remark:e.friendRemark||"",messageRemindType:this._transMsgRemindType(e.messageRemindType)}):{conversationID:""+t.CONV_GROUP+e.groupID,type:t.CONV_GROUP,lastMessage:{lastTime:e.time,lastSequence:e.sequence,fromAccount:e.msgGroupFromAccount,...this._patchTypeAndPayload(e),cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:2===e.lastMessageFlag,onlineOnlyFlag:!1,nick:e.senderNick||"",nameCard:e.senderNameCard||"",revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null},groupProfile:new rn({groupID:e.groupID,name:e.groupNick,avatar:e.groupImage,type:e.groupType,nextMessageSeq:e.nextMessageSeq}),unreadCount:this._computeGroupUnreadCount(e),peerReadTime:0,isPinned:1===e.isPinned,version:0,customData:e.customMark||"",markList:vt(e.standardMark),conversationGroupList:this._convGroupHandler.getConvGroupListByID(e.contactGroupId),messageRemindType:this._transMsgRemindType(e.messageRemindType)}});return 0<i.length&&this.get(Ts).onConvProfileUpdated(i),o}_transMsgRemindType(e){let s="";return 0===e?s=t.MSG_REMIND_ACPT_AND_NOTE:1===e?s=t.MSG_REMIND_DISCARD:2===e?s=t.MSG_REMIND_ACPT_NOT_NOTE:3===e&&(s=t.NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT),s}_computeGroupUnreadCount(e){var{unreadCount:e=0,noUnreadCount:t=0}=e,e=e-t;return 0<e?e:0}_patchTypeAndPayload(e){let{event:s,elements:i=[],groupTips:r={}}=e.lastMsg;if($e(s)||Oe(r))return{type:i[0]?i[0].type:null,payload:i[0]?this._amendLayersOverLimitProp(i[0].content):null};{let e=new xi(r),s=(e.setElement({type:t.MSG_GRP_TIP,content:{...r.elements,groupProfile:r.groupProfile}}),JSON.parse(JSON.stringify(e.payload)));return e=null,{type:t.MSG_GRP_TIP,payload:s}}}_amendLayersOverLimitProp(e){var t=e["layersOverLimit"];return 0===t?e.layersOverLimit=!1:1===t&&(e.layersOverLimit=!0),e}getLocalMessageList(e){return this._msgListHandler.getLocalMsgList(e)}deleteLocalMessage(e){e instanceof xi&&this._msgListHandler.remove(e)}onConvDeleted(e){Fe(e)&&(e=e.map(e=>{var{type:e,userID:s,groupID:i}=e;return 1===e?""+t.CONV_C2C+s:2===e?""+t.CONV_GROUP+i:void 0}),Ce.l(this._n+".onConvDeleted convIDList:"+e),this.deleteLocalConvList(e))}onConvPinnedStatus(e,n){if(Fe(e)){let o=!1;e.forEach(e=>{var{type:e,userID:s,groupID:i}=e;let r;1===e?r=this.getLocalConversation(""+t.CONV_C2C+s):2===e&&(r=this.getLocalConversation(""+t.CONV_GROUP+i)),r&&(Ce.l(`${this._n}.onConvPinnedStatus convID:${r.conversationID} localPinned:${r.isPinned} remotePinned:`+n),n?r.isPinned||(r.isPinned=!0,o=!0):r.isPinned&&(r.isPinned=!1,o=!0))}),o&&this._sortConvListAndEmitEvent()}}getMessageList({conversationID:a,nextReqMessageID:e,count:t}){let l=this._n+".getMessageList",s=this.getLocalConversation(a),i="";if(s&&s.groupProfile&&(i=s.groupProfile.type),nt(i))return Ce.l(l+` not available in ${i}. convID:`+a),ii({messageList:[],nextReqMessageID:"",isCompleted:!0});($e(t)||15<t)&&(t=15),e||this._isMeInCommunity(a)||this.clearMemMsg(a);let d=this._computeRemainingCount({conversationID:a,nextReqMessageID:e}),r=this._completedMap.has(a);if(Ce.l(l+` convID:${a} isEverCleared:${this._isEverCleared(a)} nextReqMessageID:${e} remainingCount:${d} count:${t} isCompleted:`+r),this._needGetHistory({conversationID:a,remainingCount:d,count:t}))return this.getHistoryMessages({conversationID:a,nextReqMessageID:e,count:20}).then(e=>{var{nextReqID:e,storedMessageList:t,assembledMessageList:s,isPullingCompleted:i}=e,r=this._completedMap.has(a);let o=t,n=(0<d&&(o=this._msgListHandler.getLocalMsgList(a).slice(0,t.length+d)),{nextReqMessageID:void 0,messageList:void 0,isCompleted:void 0});this._isEverCleared(a)?(n.nextReqMessageID=e,n.messageList=s,n.isCompleted=i):(n.nextReqMessageID=r?"":e,n.messageList=o,n.isCompleted=r);t=n.messageList.filter(e=>e.isRevoked)||[],s=n.messageList.map(e=>e.sequence);return Ce.l(l+` ret.nextReqMessageID:${n.nextReqMessageID} ret.isCompleted:${n.isCompleted} sequenceList:`,s),Fe(t)&&0!==t.length?this.updateRevokerInfo(t).then(e=>(e.forEach(t=>{let s=t["revokerInfo"];n.messageList=n.messageList.map(e=>(e.ID===t.ID&&s&&(e.revokeReason=s.reason||"",e.revokerInfo={userID:s.revoker||e.revoker,nick:s.nick,avatar:s.avatar}),e))}),Zs(n))):Zs(n)});this.modifyMessageList(a);e=this._getMsgListFromMem({conversationID:a,nextReqMessageID:e,count:t});return ii(e)}_isEverCleared(e){return this._everClearedMap.has(e)}_getMsgListFromMem({conversationID:e,nextReqMessageID:t,count:s}){var i=this._n+"._getMsgListFromMem",r=this._msgListHandler.getLocalMsgList(e),o=r.length,n=at(e);let a=0;var l={isCompleted:!1,nextReqMessageID:"",messageList:[]},s=(t?(a=n?r.findIndex(e=>e.ID===t):r.findIndex(e=>e.sequence+""===t))>s?(l.messageList=r.slice(a-s,a),l.nextReqMessageID=n?r[a-s].ID:r[a-s].sequence+""):(l.messageList=r.slice(0,a),l.isCompleted=!0):s<o?(a=o-s,l.messageList=r.slice(a,o),l.nextReqMessageID=n?r[a].ID:r[a].sequence+""):(l.messageList=r.slice(0,o),l.isCompleted=!0),l.messageList.map(e=>e.sequence));return Ce.l(i+` convID:${e} ret.nextReqMessageID:${l.nextReqMessageID} ret.isCompleted:${l.isCompleted} sequenceList:`+s),l}getMessageListHopping(e){let{conversationID:i,sequence:r,time:o,count:n,direction:a=0}=e;if(($e(n)||15<n)&&(n=15),i.startsWith(t.CONV_C2C)){let e=this.get(ys),s=i.replace(t.CONV_C2C,"");return e.getRoamingMessagesHopping({peerAccount:s,time:o,count:n,direction:a})}if(i.startsWith(t.CONV_GROUP)){let e=this.get(vs),s=i.replace(t.CONV_GROUP,"");return e.getRoamingMessagesHopping({groupID:s,sequence:r,count:n,direction:a})}}_computeRemainingCount({conversationID:e,nextReqMessageID:t}){var s=this._msgListHandler.getLocalMsgList(e),i=s.length;if(Ce.l(this._n+`._computeRemainingCount convID:${e} nextReqMessageID:${t} length:`+i),!t)return i;let r=0;return at(e)?r=s.findIndex(e=>e.ID===t):ct(e)&&(r=-1!==t.indexOf("-")?s.findIndex(e=>e.ID===t):s.findIndex(e=>e.sequence+""===t)),r=-1===r?0:r}_needGetHistory({conversationID:e,remainingCount:t,count:s}){var i=this.getLocalConversation(e);let r="";return i&&i.groupProfile&&(r=i.groupProfile.type),!(lt(e)||nt(r)||!this._isEverCleared(e)&&(i=t<=s&&!this._completedMap.has(e),Ce.l(this._n+`._needGetHistory convID:${e} ret:`+i),!i))}_isTopicConv(e){e=e.replace(t.CONV_GROUP,"");return rt(e)}getHistoryMessages(n){var{conversationID:a,count:n,nextReqMessageID:l}=n;if(a!==t.CONV_SYSTEM){let r=15,o=(20<n&&(r=20),null);if(at(a)){let s=0,e="",i=!1;n=this._roamingMsgKeyAndTimeMap.has(a);if(l)if(i=!0,n)s=this._roamingMsgKeyAndTimeMap.get(a).lastMessageTime,e=this._roamingMsgKeyAndTimeMap.get(a).messageKey;else{let e=this._msgListHandler.findMessage(l);e&&(s=e.time,Ce.l(this._n+`.getHistoryMessages convID:${a} isRelayInfoExisted:${n} lastMessageTime:`+s))}return(o=this.get(ys)).getRoamingMessage({conversationID:a,peerAccount:a.replace(t.CONV_C2C,""),count:r,lastMessageTime:i?s:0,messageKey:i?e:""})}if(ct(a)){if(!(o=this.get(vs)))return ni({code:ei.NO_MODULE});let e=a.replace(t.CONV_GROUP,""),s=null,i=(this._convMap.has(a)&&!rt(e)&&(s=this._convMap.get(a).lastMessage),0);return l?i=Number(l):s&&(i=s.lastSequence),o.getRoamingMessage({conversationID:a,groupID:e,count:r,sequence:i})}}return ii()}patchConvLastMessage(s,i=!1){var r=this.getLocalConversation(s);if(r){let{messageForShow:e,payload:t}=r.lastMessage;if(Oe(e)||Oe(t)||i){let t=this._msgListHandler.getLocalMsgList(s);if(0!==t.length){let e=t[t.length-1];Ce.l(this._n+`.patchConvLastMessage bForceUpdate:${i} convID:${s} payload:`,e.payload),r.updateLastMessage(e)}}}}onRoamingMessage(s=[],e,i=!0,r){var o=e.startsWith(t.CONV_C2C)?t.CONV_C2C:t.CONV_GROUP;let n=null,a=[],l=[],d=0,c=s.length,_,u=o===t.CONV_GROUP,h=this.getFileDownloadProxy(),p=this.getDownloadFileAuthKey(),g=Fe(r),m=this.get(Ns).getFileDNList(),f=()=>{u?--d:++d},M=()=>u?d>=c:d<c;for(d=u?s.length-1:0,c=u?0:s.length;M();f())if(1!==s[d].isPlaceMessage)if((n=new xi(s[d])).to=s[d].to,o!==t.CONV_GROUP||$e(s[d].topicID)||(n.to=s[d].topicID),n.isSystemMessage=!!s[d].isSystemMessage,n.conversationType=o,_=4===s[d].event?{type:t.MSG_GRP_TIP,content:{...s[d].elements,groupProfile:s[d].groupProfile}}:s[d].elements,u||n.setNickAndAvatar({nick:s[d].nick,avatar:s[d].avatar}),Oe(_)){let e=new Ti("emptyMessageBody");e.setMessage(`from:${n.from} to:${n.to} sequence:${n.sequence} event:`+s[d].event),e.setLevel("warning").end()}else n.setElement(_,h,p,m),n.reInitialize(this.getMyUserID()),a.push(n),g&&r.push(n);return f=M=null,i?(this._msgListHandler.unshift(a,l),a=null,l):a}findMessage(e){return this._msgListHandler.findMessage(e)}_isMeInCommunity(e){let s=!0;return this._isTopicConv(e)&&(e=Tt(e.replace(t.CONV_GROUP,"")),this.get(vs).hasLocalGroup(e)||(s=!1,Ce.l(this._n+`._isMeInCommunity groupID:${e} ret:`+s))),s}deleteTopicRoamingInfo(e){ot({groupID:e})&&this._msgListHandler.getTopicConvIDList(e).forEach(e=>{this.clearMemMsg(e)})}deleteGroupRoamingInfo(e){e=""+t.CONV_GROUP+e;0<this._msgListHandler.getLocalMsgList(e).length&&this.clearMemMsg(e)}setMessageRead({conversationID:o}){let e=this.getLocalConversation(o),s=this._n+".setMessageRead";if(Ce.l(s+` convID:${o} unreadCount:`+(e?e.unreadCount:0)),!e)return ii();if(e.type!==t.CONV_GROUP&&e.type!==t.CONV_TOPIC||Oe(e.groupAtInfoList)||this.deleteGroupAtTips(o),0===e.unreadCount)return ii();let i=this._msgListHandler.getLocalLastMsg(o),r=e.lastMessage.lastTime;var n=this._msgListHandler.getLocalMaxTime(o),n=(r<n&&(Ce.l(`${s} update lastMessageTime from ${r} to `+n),r=n),this._msgListHandler.getLocalMaxSeq(o));let a=e.lastMessage.lastSequence;if(a<n&&(Ce.l(`${s} update lastMessageSeq from ${a} to `+n),a=n),e.type===t.CONV_TOPIC&&$e(i)){let e=this.get(Ss),s=o.replace(t.CONV_GROUP,""),i=Tt(s),r=e.getLocalTopic(i,s);r&&(a=r.nextMessageSeq-1)}let l=null;switch(e.type){case t.CONV_C2C:return(l=this.get(ys))?l.setMessageRead({conversationID:o,lastMessageTime:r}):ni({code:ei.NO_MODULE});case t.CONV_GROUP:case t.CONV_TOPIC:return(l=this.get(vs))?l.setMessageRead({conversationID:o,lastMessageSeq:a}):ni({code:ei.NO_MODULE});case t.CONV_SYSTEM:return e.unreadCount=0,this.emitConvUpdate(!0,!1),ii();default:return ii()}}setAllMessageRead(s={}){let i=this._n+".setAllMessageRead";s.scope||(s.scope=t.READ_ALL_MSG),Ce.l(i+" options:",s);var e=this._createSetAllMessageReadPack(s);if(0===e.readAllC2CMessage&&0===e.groupMessageReadInfoList.length)return ii();let r=new Ti("setAllMessageRead");return this.req({P:ri.SET_ALL_MSG_READ,data:e}).then(e=>{e=e.data,e=this._handleAllMsgRead(e);return r.setMessage(`scope:${s.scope} failureGroups:`+JSON.stringify(e)).end(),ii()}).catch(e=>(r.setError(e).end(),Ce.w(i+" failed. error:",e),ni({code:e&&e.code?e.code:ei.MSG_UNREAD_ALL_FAIL,message:e&&e.message?e.message:void 0})))}setConvCustomData(e){return this._convGroupHandler.setConvCustomData(e)}markConv(e){return this._convGroupHandler.markConv(e)}getConvGroupList(){return this._convGroupHandler.getLocalConvGroupList()}createConvGroup(e){return this._convGroupHandler.createConvGroup(e)}deleteConvGroup(e){return this._convGroupHandler.deleteConvGroup(e)}renameConvGroup(e){return this._convGroupHandler.renameConvGroup(e)}addConvsToGroup(e){return this._convGroupHandler.addConvsToGroup(e)}deleteConvsFromGroup(e){return this._convGroupHandler.deleteConvsFromGroup(e)}onConvMarkUpdated(e){this._convGroupHandler.onConvMarkUpdated(e)}onConvGroupCreated(e){this._convGroupHandler.onConvGroupCreated(e)}onConvGroupDeleted(e){this._convGroupHandler.onConvGroupDeleted(e)}onConvGroupNameUpdated(e){this._convGroupHandler.onConvGroupNameUpdated(e)}onConvInGroupUpdated(e){this._convGroupHandler.onConvInGroupUpdated(e)}onConvAddedToOrDeletedFromGroup(e){this._convGroupHandler.onConvAddedToOrDeletedFromGroup(e)}_getConvLastMessageSeq(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID);let s=e.lastMessage.lastSequence;return s=t&&s<t.sequence?t.sequence:s}_getConvLastMessageTime(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID);let s=e.lastMessage.lastTime;return s=t&&s<t.time?t.time:s}_createSetAllMessageReadPack(e){var s,i={readAllC2CMessage:0,groupMessageReadInfoList:[]},r=e["scope"];for([,s]of this._convMap)if(0<s.unreadCount)if(s.type===t.CONV_C2C&&0===i.readAllC2CMessage){if(r===t.READ_ALL_MSG)i.readAllC2CMessage=1;else if(r===t.READ_ALL_C2C_MSG){i.readAllC2CMessage=1;break}}else if(s.type===t.CONV_GROUP&&(r===t.READ_ALL_GROUP_MSG||r===t.READ_ALL_MSG)){let e=this._getConvLastMessageSeq(s);i.groupMessageReadInfoList.push({groupID:s.groupProfile.groupID,messageSequence:e})}return i}onPushedAllMessageRead(e){this._handleAllMsgRead(e)}_handleAllMsgRead(e){var{groupMessageReadInfoList:e,readAllC2CMessage:t}=e,e=this._parseGroupReadInfo(e);return 1<=this._updateAllConvUnreadCount({readAllC2CMessage:t})&&this.emitConvUpdate(!0,!1),e}_parseGroupReadInfo(s){var i=[];if(s&&s.length)for(let e=0,t=s.length;e<t;e++){var{groupID:r,sequence:o,retCode:n,lastMessageSeq:a}=s[e];$e(n)?this._remoteGroupReadSeqMap.set(r,a):(this._remoteGroupReadSeqMap.set(r,o),0!==n&&i.push(r+`-${o}-`+n))}return i}_updateAllConvUnreadCount(e){let s=e["readAllC2CMessage"],i=0;for(var[r,o]of this._convMap)if(1<=o.unreadCount){if(1===s&&o.type===t.CONV_C2C){let e=this._getConvLastMessageTime(o);this.updateIsReadAfterReadReport({conversationID:r,lastMessageTime:e})}else if(o.type===t.CONV_GROUP){let s=r.replace(t.CONV_GROUP,"");if(this._remoteGroupReadSeqMap.has(s)){let e=this._remoteGroupReadSeqMap.get(s),t=this._getConvLastMessageSeq(o);this.updateIsReadAfterReadReport({conversationID:r,remoteReadSequence:e}),t>=e&&this._remoteGroupReadSeqMap.delete(s)}}this.updateUnreadCount(r,!1)&&(i+=1)}return i}isRemoteRead(e){var{conversationID:s,sequence:i}=e,r=s.replace(t.CONV_GROUP,"");let o=!1;if(this._remoteGroupReadSeqMap.has(r)){let e=this._remoteGroupReadSeqMap.get(r);i<=e&&(o=!0,Ce.l(this._n+`.isRemoteRead convID:${s} msgSeq:${i} remoteReadSeq:`+e)),i>=e+10&&this._remoteGroupReadSeqMap.delete(r)}return o}updateIsReadAfterReadReport({conversationID:e,lastMessageSeq:t,lastMessageTime:s}){var i,r=this._msgListHandler.getLocalMsgList(e);if(0!==r.length)for(let e=r.length-1;0<=e;e--)if(i=r[e],!(s&&i.time>s||t&&i.sequence>t)){if("in"===i.flow&&i.isRead)break;i.setIsRead(!0)}}updateUnreadCount(r,e=!0){let s=!1,o=this.getLocalConversation(r),i=this._msgListHandler.getLocalMsgList(r);if(o){var n=o.unreadCount,a=i.filter(e=>!e.isRead&&!e._onlineOnlyFlag&&!e.isDeleted).length;if(n!==a&&(o.unreadCount=a,s=!0,Ce.l(this._n+`.updateUnreadCount from ${n} to ${a}, convID:`+r),!0===e)&&this.emitConvUpdate(!0,!1),s&&o.type===t.CONV_TOPIC){let e=o["unreadCount"],s=this.get(Ss),i=r.replace(t.CONV_GROUP,"");s.onUnreadCountUpdatedFromConv(i,e)}return s}}clearGroupAtInfoList(r,e=!0){var o=this.getLocalConversation(r);if(o&&0<o.groupAtInfoList.length){if(o.clearGroupAtInfoList(),Ce.l(this._n+".clearGroupAtInfoList convID:"+r),o.type===t.CONV_TOPIC){let e=o["groupAtInfoList"],s=this.get(Ss),i=r.replace(t.CONV_GROUP,"");s.onAtInfoUpdated({topicID:i,groupAtInfoList:e})}!0===e&&this.emitConvUpdate(!0,!1)}}updateReadReceiptInfo(s){let{userID:r,groupID:a,readReceiptList:l,timestamp:o=0}=s;if(!Oe(l)){let n=[];if($e(r)){if(!$e(a)){let o=""+t.CONV_GROUP+a;l.forEach(e=>{var{tinyID:e,clientTime:t,random:s,readCount:i,unreadCount:r}=e,e=e+`-${t}-`+s,t=this._msgListHandler.getLocalMsg(o,e)||this._msgListHandler.getHoppingMsg(o,e),s={groupID:a,messageID:e,readCount:0,unreadCount:0};t&&(Ge(i)&&(t.readReceiptInfo.readCount=i,s.readCount=i),Ge(r)&&(t.readReceiptInfo.unreadCount=r,s.unreadCount=r),n.push(s))})}}else{let i=""+t.CONV_C2C+r;l.forEach(t=>{var{tinyID:t,clientTime:s,random:e}=t,t=t+`-${s}-`+e,s=this._msgListHandler.getLocalMsg(i,t)||this._msgListHandler.getHoppingMsg(i,t);if(s&&!s.readReceiptInfo.isPeerRead){s.readReceiptInfo.isPeerRead=!0,s.readReceiptInfo.timestamp=o;let e={userID:r,messageID:t,isPeerRead:!0,timestamp:o};n.push(e)}})}0<n.length&&this.emitOEvt(e.MESSAGE_READ_RECEIPT_RECEIVED,n)}}updateIsRead(e){var i=this.getLocalConversation(e),r=this.getLocalMessageList(e);if(i&&0!==r.length&&!lt(i.type)){var o=[];for(let e=0,t=r.length;e<t;e++)"in"!==r[e].flow?"out"!==r[e].flow||r[e].isRead||r[e].setIsRead(!0):o.push(r[e]);let s=0;if(i.type===t.CONV_C2C){let e=o.slice(-i.unreadCount).filter(e=>e.isRevoked).length;s=o.length-i.unreadCount-e}else s=o.length-i.unreadCount;for(let e=0;e<s&&!o[e].isRead;e++)o[e].setIsRead(!0)}}deleteGroupAtTips(e){let s=this._n+".deleteGroupAtTips";Ce.l(s);var i=this._convMap.get(e);if(!i)return Promise.resolve();let r=i.groupAtInfoList;if(0===r.length)return Promise.resolve();let o=void 0,n=(e.startsWith(t.CONV_GROUP)&&(o=e.replace(t.CONV_GROUP,"")),[...r]);if((ot({groupID:o})||rt(o))&&0===(n=r.filter(e=>!e.atTypeArray.includes(t.CONV_AT_ALL))).length)return this.clearGroupAtInfoList(e,!1),Promise.resolve();let a=this.getMyUserID();return this.req({P:ri.DEL_GROUP_AT_TIPS,data:{messageListToDelete:n.map(e=>({from:e.from,to:a,messageSeq:e.__sequence,messageRandom:e.__random,groupID:$e(e.topicID)?e.groupID:e.topicID}))}}).then(()=>(Ce.l(s+" ok. count:"+r.length),this.clearGroupAtInfoList(e,!1),Promise.resolve())).catch(e=>(Ce.e(s+" failed. error:",e),ni(e)))}appendToMessageList(e){return this._msgListHandler.pushIn(e)}setMessageRandom(e){this._sll.set(e.random)}deleteMessageRandom(e){this._sll.delete(e.random)}pushIntoMessageList(e,t,s){return!(!this._msgListHandler.pushIn(t,s)||this._sll.has(t.random)&&!s||(e.push(t),0))}revoke(e,t,s){return this._msgListHandler.revoke(e,t,s)}getPeerReadTime(e){return this._peerReadTimeMap.get(e)}recordPeerReadTime(e,t){(!this._peerReadTimeMap.has(e)||this._peerReadTimeMap.get(e)<t)&&this._peerReadTimeMap.set(e,t)}updateMsgIsPeerReadProp(s,i){if(s.startsWith(t.CONV_C2C)&&0<i){let t=this._msgListHandler.updateMsgIsPeerReadProp(s,i);if(0<t.length&&this.emitOEvt(e.MESSAGE_READ_BY_PEER,t),this._convMap.has(s)){let e=this._convMap.get(s).lastMessage;Oe(e)||e.fromAccount===this.getMyUserID()&&e.lastTime<=i&&!e.isPeerRead&&(e.isPeerRead=!0,this.emitConvUpdate(!0,!1))}}}updateMsgIsModifiedProp(e){this._msgListHandler.updateMsgIsModifiedProp(e)}setCompleted(e){Ce.l(this._n+".setCompleted convID:"+e),this._completedMap.set(e,!0)}updateRoamingMsgKeyAndTime(e,t,s){this._roamingMsgKeyAndTimeMap.set(e,{messageKey:t,lastMessageTime:s})}getConvList(s){let i=this._n+".getConvList",e=`pagingStatus:${this._pagingStatus}, local conversation count:${this._convMap.size}, options:`+JSON.stringify(s);if(Ce.l(i+". "+e),this._pagingStatus===wt){let t=new Ti("getConvList");return t.setMessage(e),this.syncConvList().then(()=>{t.end();var e=this._getConvList(s);return Zs({conversationList:e,isSyncCompleted:this._isSyncCompleted()})}).catch(e=>(t.setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)))}let t=this._getConvList(s);return Ce.l(i+". returned conversation count:"+t.length),ii({conversationList:t,isSyncCompleted:this._isSyncCompleted()})}_getConvList(n){if($e(n))return this.getLocalConvList();if(Fe(n))return 0===n.length?[]:this.getLocalConvList().filter(e=>n.includes(e.conversationID));if(be(n)){let{type:t,markType:s,groupName:i,hasUnreadCount:r,hasGroupAtInfo:o}=n;return this.getLocalConvList().filter(e=>this._filterType(e,t)&&this._filterMarkType(e,s)&&this._filterGroupName(e,i)&&this._filterUnreadCount(e,r)&&this._filterGroupAtInfo(e,o))}return[]}_filterType(e,s){return s!==t.CONV_C2C&&s!==t.CONV_GROUP||e.type===s}_filterGroupName(e,t){return!ke(t)||(""===t?0===e.conversationGroupList.length:e.conversationGroupList.includes(t))}_filterMarkType(e,t){return!Ge(t)||(0===t?0===e.markList.length:e.markList.includes(t))}_filterUnreadCount(e,t){let s=!0;return!0===t?s=1<=e.unreadCount:!1===t&&(s=0===e.unreadCount),s}_filterGroupAtInfo(e,t){let s=!0;return!0===t?s=1<=e.groupAtInfoList.length:!1===t&&(s=0===e.groupAtInfoList.length),s}_handleC2CPeerReadTime(){for(var[e,s]of this._convMap)s.type===t.CONV_C2C&&this.recordPeerReadTime(e,s.peerReadTime)}_isPagingGetGroupListCompleted(){var e=this.get(vs);return!e||e.isPagingGetCompleted()}_getLocalGroupCount(){var e=this.get(vs);return e?e.getLocalGroupList().length:0}_hasLocalGroup(e){var s=this.get(vs);return!!s&&s.hasLocalGroup(e.replace(t.CONV_GROUP,""))}getConversationProfile(r){let o,s=!1;if(this._convMap.has(r)?o=this._convMap.get(r):(o=new cn({conversationID:r,type:at(r)?t.CONV_C2C:t.CONV_GROUP},this.isIntl(),this.isUsingChatCore()),s=!0),o._isInfoCompleted||o.type===t.CONV_SYSTEM)return ii({conversation:o});if(ct(r)){if(!this.get(vs))return ni({code:ei.NO_MODULE});if(!this._hasLocalGroup(r))return ii({conversation:o})}let n=this._n+".getConversationProfile",a=new Ti("getConversationProfile");return Ce.l(n+`. convID:${r} remark:${o.remark} lastMessage:`,o.lastMessage),this._getUserOrGroupProfile(o).then(e=>{a.setMessage(`convID:${r} unreadCount:`+e.data.conversation.unreadCount).end();var i=this.get(Es);if(i&&o.type===t.CONV_C2C){let s=r.replace(t.CONV_C2C,"");if(i.isMyFriend(s)){let e=i.getFriendRemark(s);o.remark!==e&&(o.remark=e,Ce.l(n+`. convID:${r} patch remark:`+o.remark))}}if(Ce.l(n+` ok. isNewConv:${s} convID:`+r),s){if(o.type===t.CONV_C2C)return this._onNewC2CConv([r.replace(t.CONV_C2C,"")]).then(()=>ii({conversation:o}));if(o.type===t.CONV_GROUP)return this._onNewGroupConv([r.replace(t.CONV_GROUP,"")]).then(()=>ii({conversation:o}))}return e}).catch(e=>(a.setError(e).setMessage("convID:"+r).end(),Ce.e(n+" failed. error:",e),ni(e)))}_getUserOrGroupProfile(s){return s.type===t.CONV_C2C?this.get(Ts).getUserProfile({userIDList:[s.toAccount]}).then(e=>{e=e.data;return 0===e.length?ni({code:ei.USER_OR_GRP_NOT_FOUND}):(s.userProfile=e[0],s._isInfoCompleted=!0,this._insertConvAfterTopmost(s),ii({conversation:s}))}):this.get(vs).getGroupProfile({groupID:s.toAccount}).then(e=>(s.groupProfile=e.data.group,s._isInfoCompleted=!0,this._insertConvAfterTopmost(s),ii({conversation:s})))}_insertConvAfterTopmost(e){var t,s;e instanceof cn&&!this._convMap.has(e.conversationID)&&(s=(t=[...this._convMap]).findIndex(e=>!1===e[1].isPinned),t.splice(s,0,[e.conversationID,e]),this._convMap=new Map(t),this._setStorageConvList(),this.emitConvUpdate(!0,!1))}_onProfileUpdated(e){e.data.forEach(e=>{var s=e["userID"];s===this.getMyUserID()?this._onMyProfileModified({latestNick:e.nick,latestAvatar:e.avatar}):(s=this._convMap.get(""+t.CONV_C2C+s))&&(s.userProfile=e)})}_onCloudConfig(e){"0"===this.getCloudConfig("pull_on_invite")&&(this._bPullOnInvite=!1),Ce.l(this._n+"._onCloudConfig bPullOnInvite:"+this._bPullOnInvite)}disableMsgPullOnInvite(){this._bPullOnInvite=!1}_isSyncCompleted(){return this._pagingStatus===kt}_errorLog(e,t,s,i){var r=new Error("Params validate failed."),o=""+this.getErrMsg("API_REFER")+e;throw Ce.w(`[${e}] | ${t} | ${this.getErrMsg(s,i)}, `+o),Ce.e(`[${e}] Invalid ${t}: type check failed for ${t}.`),r}_isValidConvID(e){return at(e)||ct(e)||lt(e)}deleteConversation(e){let t="deleteConversation";return ke(e)||we(e)||this._errorLog(t,"options","StringOrObjectRequiredLog"),ke(e)?(this._isValidConvID(e)||this._errorLog(t,"options","InvalidConversationID",e),Ce.l(`${this._n}.${t} convID:`+e),this.deleteConvList({conversationIDList:[e],flag:1})):(Fe(e.conversationIDList)||this._errorLog(t,"conversationIDList","ArrayRequiredLog"),0===e.conversationIDList.length&&this._errorLog(t,"conversationIDList","NonEmptyArrayLog"),e.conversationIDList.forEach(e=>{this._isValidConvID(e)||this._errorLog(t,"conversationIDList","InvalidConversationID",e)}),"clearHistoryMessage"in e&&"boolean"!=typeof e.clearHistoryMessage&&this._errorLog(t,"clearHistoryMessage","BooleanRequiredLog"),100<e.conversationIDList.length&&(e.conversationIDList=e.conversationIDList.slice(0,100)),this.deleteConvList(e))}deleteConvList(e){let{conversationIDList:t=[],clearHistoryMessage:s=!0,flag:i=0}=e,r=this._n+".deleteConvList",o=`convIDList:${t} clearHistoryMessage:`+s,n=(Ce.l(r+" "+o),new Ti("deleteConvList"));return n.setMessage(o),Promise.all([this.rmLocalOnlyConvList(t),this.rmLocalAndRemoteConvList(t,s)]).then(e=>{n.end();e=[...e[0],...e[1]];return 0===e.length?ni(new Qs({code:ei.CONV_NOT_FOUND})):(Ce.l(r+" ok"),ii(1===i?{conversationID:e[0]}:{conversationIDList:e}))}).catch(e=>(n.setError(e).end(),Ce.e(r+" failed. error:",e),ni(e)))}rmLocalOnlyConvList(e){return e.filter(e=>{var s;return!!this._convMap.has(e)&&((s=this.getLocalConversation(e).type)!==t.CONV_GROUP||this._hasLocalGroup(e)?s===t.CONV_SYSTEM&&(this.get(vs).deleteGroupSystemNotice({messageList:this._msgListHandler.getLocalMsgList(e)}),this.deleteLocalConv(e),!0):(this.deleteLocalConv(e),!0))})}rmLocalAndRemoteConvList(e,s){let i={fromAccount:this.getMyUserID(),conversationList:[],clearHistoryMessage:s?1:0};return e.forEach(e=>{var s;this._convMap.has(e)&&((s=this.getLocalConversation(e).type)===t.CONV_C2C?i.conversationList.push({toAccount:e.replace(s,""),type:1}):s===t.CONV_GROUP&&this._hasLocalGroup(e)&&i.conversationList.push({toGroupID:e.replace(s,""),type:2}))}),0===i.conversationList.length?[]:this.req({P:ri.DEL_CONV,data:i}).then(e=>{let s=[];return 0<e.data.resultList.length&&e.data.resultList.map(e=>{0===e.code&&(e=1===e.type?""+t.CONV_C2C+e.to:""+t.CONV_GROUP+e.groupID,s.push(e))}),this.deleteLocalConvList(s),s})}setConvDraft(e){var{conversationID:e,draftText:t}=e,s=this._n+".setConvDraft";return Ce.l(s+` convID:${e} draftText:`+t),this._convMap.has(e)?((s=this._convMap.get(e)).setDraftText(t),this.emitConvUpdate(),ii({code:0,conversation:s})):ni({code:ei.CONV_NOT_FOUND})}clearHistoryMessage(s){let e={fromAccount:this.getMyUserID(),toAccount:void 0,type:void 0,toGroupID:void 0};if(!this._convMap.has(s))return ni({code:ei.CONV_NOT_FOUND});var i=this._convMap.get(s).type;if(i===t.CONV_C2C)e.type=1,e.toAccount=s.replace(t.CONV_C2C,"");else{if(i!==t.CONV_GROUP)return i===t.CONV_SYSTEM?(this.get(vs).deleteGroupSystemNotice({messageList:this._msgListHandler.getLocalMsgList(s)}),ii({conversationID:s})):ni({code:ei.CONV_UN_RECORDED_TYPE});e.type=2,e.toGroupID=s.replace(t.CONV_GROUP,"")}let r=this._n+".clearHistoryMessage",o=new Ti("clearHistoryMessage");return o.setMessage("convID:"+s),Ce.l(r+". convID:"+s),this.setMessageRead({conversationID:s}).then(()=>this.req({P:ri.CLEAR_HISTORY_MSG,data:e})).then(()=>{o.end(),Ce.l(r+" ok"),this.clearMemMsg(s);var e=this.getLocalConversation(s);return e&&(e.updateLastMessage(),this._sortConvListAndEmitEvent()),ii({conversationID:s})}).catch(e=>(o.setError(e).end(),Ce.e(r+" failed. error:",e),ni(e)))}pinConversation(e){let{conversationID:s,isPinned:i}=e,r=this.getLocalConversation(s);if(r&&r.isPinned===i)return ii({conversationID:s});if(lt(s))return r&&(r.isPinned=i),this._sortConvListAndEmitEvent(),ii({conversationID:s});let o=null;if(at(s)?o={type:1,toAccount:s.replace(t.CONV_C2C,"")}:ct(s)&&(o={type:2,groupID:s.replace(t.CONV_GROUP,"")}),null===o)return ni({code:ei.INVALID_CONV_ID});let n=this._n+".pinConversation",a=`convID:${s} isPinned:`+i,l=new Ti("pinConversation");return l.setMessage(a),Ce.l(n+". "+a),this.req({P:ri.PIN_CONV,data:{fromAccount:this.getMyUserID(),operationType:!0===i?1:2,itemList:[o]}}).then(()=>(l.end(),Ce.l(n+" ok"),r?r.isPinned!==i&&(r.isPinned=i):this._convMap.set(s,new cn({conversationID:s,type:at(s)?t.CONV_C2C:t.CONV_GROUP,isPinned:i},this.isIntl(),this.isUsingChatCore())),this._sortConvListAndEmitEvent(),Zs({conversationID:s}))).catch(e=>(l.setError(e).end(),Ce.e(n+" failed. error:",e),ni(e)))}setMessageRemindType(e){return this._msgRemindHandler.set(e)}patchMsgRemindType(e){var{ID:s,isC2CConversation:i,messageRemindType:r}=e;let o=!1;i=this.getLocalConversation(i?""+t.CONV_C2C+s:""+t.CONV_GROUP+s);return i&&i.messageRemindType!==r&&(i.messageRemindType=r,o=!0),Ce.l(this._n+".patchMsgRemindType options:",e,"ret:"+o),o}onC2CMsgRemindTypeFetched(e){if(Fe(e)&&0<e.length){let s=0;e.forEach(e=>{var{userID:e,muteFlag:t}=e,t=this._transMsgRemindType(t);!0===this.patchMsgRemindType({ID:e,isC2CConversation:!0,messageRemindType:t})&&(s+=1)}),Ce.l(this._n+".onC2CMsgRemindTypeFetched updateCount:"+s),1<=s&&this.emitConvUpdate(!0,!1)}}onC2CMsgRemindTypeSynced(e){let i=this._n+".onC2CMsgRemindTypeSynced";e.dataList.forEach(t=>{if(!Oe(t.muteNotificationsSync)){var{to:t,muteFlag:s}=t.muteNotificationsSync,s=this._transMsgRemindType(s);let e=0;this.patchMsgRemindType({ID:t,isC2CConversation:!0,messageRemindType:s})&&(e+=1),Ce.l(i+" updateCount:"+e),1<=e&&this.emitConvUpdate(!0,!1)}})}onGroupMsgRemindTypeUpdated(e){this._msgRemindHandler.onGroupMsgRemindTypeUpdated(e)}deleteLocalConv(t,e=!0){var s=this._convMap.has(t);if(Ce.l(this._n+`.deleteLocalConv convID:${t} has:`+s),s&&(this._convMap.delete(t),this._convMapForDiff.delete(t),this.clearMemMsg(t),this._setStorageConvList(!0),e)){let e=!this._isTopicConv(t);this.emitConvUpdate(e,!1)}}pullMsgOnInvite(i){var r=this.get(vs);if(r){var o=this._n+".pullMsgOnInvite";if(Ce.l(o+" flag:"+this._bPullOnInvite),this._bPullOnInvite){var n=this.getLocalLastMessage(i),a=this.getLocalSecondLastMessage(i);let e=1,s=1;n&&(e=n.sequence),a&&(s=a.sequence);n=r.getGroupRemoteLastSeq(i.replace(t.CONV_GROUP,""));Ce.l(o+` convID:${i} localLastSeq:${e} localSecondLastSeq:${s} remoteLastSeq:`+n),this.clearMemMsg(i),1<e-s?this._recursiveGetMsgList([],i,!1,e,s):1<n-e&&this._recursiveGetMsgList([],i,!0,n,e)}}}_recursiveGetMsgList(r,o,n,a,l,e){this.getMessageList({conversationID:o,nextReqMessageID:e}).then(e=>{var{messageList:e,isCompleted:t,nextReqMessageID:s}=e.data,i=e.filter(e=>n?e.sequence>l&&e.sequence<=a:e.sequence>l&&e.sequence<a);r.unshift(...i),!t&&0<e.length&&e[0].sequence>l&&r.length<60?this._recursiveGetMsgList(r,o,n,a,l,s):this._emitMsgReceived(o,r)})}_emitMsgReceived(t,s){var i,r;0<s.length&&(s=s.filter((t,e,s)=>e===s.findIndex(e=>e.sequence===t.sequence)),i=this.hasLocalConversation(t),r=s.map(e=>e.sequence),Ce.l(`${this._n}._emitMsgReceived convID:${t} has:${i} count:${r.length} sequenceList:`,r),this.emitOEvt(e.MESSAGE_RECEIVED,s),i?this.patchConvLastMessage(t,!0):this.getConversationProfile(t).then(()=>{this.patchConvLastMessage(t,!0)}))}deleteLocalConvList(e){let t=!1;e.forEach(e=>{this._convMap.has(e)&&(this.deleteLocalConv(e,!1),t=!0)}),Ce.l(this._n+`.deleteLocalConvList convID:${e} isConvIDExisted:`+t),t&&this.emitConvUpdate(!0,!1)}isMessageSentByCurrentInstance(e){return!(!this._msgListHandler.hasLocalMsg(e.conversationID,e.ID)&&!this._sll.has(e.random))}modifyMessageList(e){var s,i;e.startsWith(t.CONV_C2C)&&this._convMap.has(e)&&(i=this._convMap.get(e),s=Date.now(),this._msgListHandler.modifyMsgSentByPeer({conversationID:e,latestNick:i.userProfile.nick,latestAvatar:i.userProfile.avatar}),i=this.get(Ts).getNickAndAvatarByUserID(this.getMyUserID()),this._msgListHandler.modifyMsgSentByMe({conversationID:e,latestNick:i.nick,latestAvatar:i.avatar}),Ce.l(this._n+`.modifyMessageList convID:${e} cost:`+Dt(s)))}updateUserProfileSpecifiedKey(e){Ce.l(this._n+".updateUserProfileSpecifiedKey options:",e);var{conversationID:t,nick:s,avatar:i}=e;if(this._convMap.has(t)){let e=this._convMap.get(t).userProfile;ke(s)&&e.nick!==s&&(e.nick=s),ke(i)&&e.avatar!==i&&(e.avatar=i),this.emitConvUpdate(!0,!1)}}_onMyProfileModified(t){var e=this.getLocalConvList(),s=Date.now();e.forEach(e=>{this.modifyMessageSentByMe({conversationID:e.conversationID,...t})}),Ce.l(this._n+"._onMyProfileModified. modify all messages sent by me, cost:"+Dt(s))}modifyMessageSentByMe(e){this._msgListHandler.modifyMsgSentByMe(e)}getLatestMessageSentByMe(e){return this._msgListHandler.getLatestMsgSentByMe(e)}modifyMessageSentByPeer(e){this._msgListHandler.modifyMsgSentByPeer(e)}getLatestMessageSentByPeer(e){return this._msgListHandler.getLatestMsgSentByPeer(e)}pushIntoNoticeResult(e,t){return!(!this._msgListHandler.pushIn(t)||this._sll.has(t.random)||(e.push(t),0))}getLocalLastMessage(e){return this._msgListHandler.getLocalLastMsg(e)}getLocalSecondLastMessage(e){return this._msgListHandler.getLocalSecondLastMsg(e)}checkAndPatchRemark(){let o=this.get(Es);if(0!==this._convMap.size&&o){var e=[...this._convMap.values()].filter(e=>e.type===t.CONV_C2C);if(0!==e.length){let r=0;e.forEach(s=>{var i=s.conversationID.replace(t.CONV_C2C,"");if(o.isMyFriend(i)){let e=o.getFriendRemark(i);s.remark!==e&&(s.remark=e,r+=1)}}),Ce.l(`${this._n}.checkAndPatchRemark. c2cConvCount:${e.length} patchedCount:`+r),0<r&&this.emitConvUpdate(!0,!1)}}}updateTopicConversation(e){this._updateLocalConvList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0})}sendReadReceipt(e){var s=e[0];let i=null;return s.conversationType===t.CONV_C2C?i=this._m.get(ys):s.conversationType===t.CONV_GROUP&&(i=this._m.get(vs)),i?i.sendReadReceipt(e):ni({code:ei.NO_MODULE})}getReadReceiptList(e){var s=e[0];let i=null;return s.conversationType===t.CONV_C2C?i=this._m.get(ys):s.conversationType===t.CONV_GROUP&&(i=this._m.get(vs)),i?i.getReadReceiptList(e):ni({code:ei.NO_MODULE})}getLastMessageTime(e){e=this.getLocalConversation(e);return e?e.lastMessage.lastTime:0}getTotalUnreadCount(){var e=this.getLocalConvList();let s=0;return e.forEach(e=>{e.type===t.CONV_SYSTEM||""!==e.messageRemindType&&e.messageRemindType!==t.MSG_REMIND_ACPT_AND_NOTE||(s+=e.unreadCount)}),s}onTotalUnreadCountUpdate(){var t=this.getTotalUnreadCount();this._convTotalUnreadCount!==t&&(Ce.l(`${this._n}.onTotalUnreadCountUpdate from ${this._convTotalUnreadCount} to `+t),this._convTotalUnreadCount=t,this.emitOEvt(e.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED))}_isConvNeedShow(e){var s,i,e=this.getLocalConversation(e);return!(!$e(e)&&(s=e.type===t.CONV_TOPIC,i=e.type===t.CONV_GROUP&&e.groupProfile.type===t.GRP_ROOM,e=e.type===t.CONV_GROUP&&e.groupProfile.type===t.GRP_LIVE,s||i||e))}setAllRcvMsgOpt(e){return this._msgRemindHandler.setAllRcvMsgOpt(e)}getAllRcvMsgOpt(){return this._msgRemindHandler.getAllRcvMsgOpt()}onAllRcvMsgOptNotify(e){this._msgRemindHandler.onAllRcvMsgOptNotify(e)}clearUnreadCount(e){e=this.getLocalConversation(e);e&&0<e.unreadCount&&(e.unreadCount=0,this.emitConvUpdate(!0,!1))}storeHoppingMessageList(e){this._msgListHandler.storeHoppingMsgList(e)}clearMemMsg(e,t=!1){Ce.l(this._n+`.clearMemMsg convID:${e} isOverLimit:`+t),this._msgListHandler.removeByConvID(e),this._completedMap.delete(e),this._roamingMsgKeyAndTimeMap.delete(e),this._everClearedMap.set(e,1)}reset(){Ce.l(this._n+".reset"),this._setStorageConvList(!0),this._pagingStatus=Ut,this._msgListHandler.reset(),this._msgRemindHandler.reset(),this._roamingMsgKeyAndTimeMap.clear(),this._sll.reset(),this._peerReadTimeMap.clear(),this._completedMap.clear(),this._convMap.clear(),this._pagingTs=0,this._pagingStartIdx=0,this._pagingPinnedTs=0,this._pagingPinnedStartIdx=0,this._remoteGroupReadSeqMap.clear(),this._convTotalUnreadCount=0,this._pagingGetCostList.length=0,this._pagingConvIDMap.clear(),this._convIDFromUnreadDBMap.clear(),this._pagingGetCostList.length=0,this._convMapForDiff.clear(),this._partialUpdatedConvMap.clear(),this._everClearedMap.clear(),this._bPullOnInvite=!0,this._convGroupHandler.reset(),this.resetReady()}}let hn=["topicID","topicName","avatar","introduction","notification","unreadCount","muteAllMembers","customData","groupAtInfoList","nextMessageSeq","selfInfo"],pn=function(e,t){return Oe(e)?{lastTime:0,lastSequence:0,fromAccount:"",payload:null,type:"",messageForShow:"",nick:"",avatar:"",version:0,cloudCustomData:"",isRevoked:!1,revoker:null}:{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",payload:e.payload||null,type:e.type||"",messageForShow:yt(e.type,e.payload,t),nick:e.nick||"",avatar:e.avatar||"",version:e.version||0,cloudCustomData:e.cloudCustomData||"",isRevoked:e.isRevoked||!1,revoker:e.revoker||null}};class gn{constructor(e,t){this.topicID="",this.topicName="",this.avatar="",this.introduction="",this.notification="",this.unreadCount=0,this.muteAllMembers=!1,this.customData="",this.groupAtInfoList=[],this.nextMessageSeq=0,this.lastMessage=pn(e.lastMessage,t),this.selfInfo={muteTime:0,readedSequence:0,messageRemindType:"",excludedUnreadSequenceList:void 0},this._initTopic(e)}_initTopic(e){for(var t in e)hn.indexOf(t)<0||("selfInfo"===t?this.updateSelfInfo(e[t]):this[t]="muteAllMembers"===t?1===e[t]:e[t])}updateUnreadCount(e=0){this.unreadCount=e}updateNextMessageSeq(e){this.nextMessageSeq=e}updateLastMessage(e){this.lastMessage=pn(e)}updateGroupAtInfoList(e){this.groupAtInfoList=JSON.parse(JSON.stringify(e))}updateTopic(e){$e(e.selfInfo)||this.updateSelfInfo(e.selfInfo),$e(e.muteAllMembers)||(this.muteAllMembers=1===e.muteAllMembers),We(this,e,["groupID","lastMessageTime","selfInfo","muteAllMembers","lastMsg"])}updateSelfInfo(e){return 0===We(this.selfInfo,e,[],[""])}reduceUnreadCount(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}isLastMessageRevoked({sequence:e}){return e===this.lastMessage.lastSequence}setLastMessageRevoked(e){this.lastMessage.isRevoked=e}setLastMessageRevoker(e){this.lastMessage.revoker=e}}class mn extends oi{constructor(e){super(e),this._n="TopicModule",this._topicMap=new Map,this._getTopicTimeMap=new Map,this.TOPIC_CACHE_TIME=300,this.TOPIC_LAST_ACTIVE_TIME=3600,this.getIEmitInst().on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){var e=this.getCloudConfig("topic_cache_time"),t=this.getCloudConfig("topic_last_active_time");$e(e)||(this.TOPIC_CACHE_TIME=Number(e)),$e(t)||(this.TOPIC_LAST_ACTIVE_TIME=Number(t))}onTopicCreated(t){var s=t["groupID"];this.resetGetTopicTime(s),this.emitOEvt(e.TOPIC_CREATED,t)}onTopicDeleted(t){let{groupID:s,topicIDList:i=[]}=t;i.forEach(e=>{this._deleteLocalTopic(s,e)}),this.emitOEvt(e.TOPIC_DELETED,t)}onTopicProfileUpdated(t){var{groupID:s,topicID:i}=t,i=this.getLocalTopic(s,i);i&&(i.updateTopic(t),this.emitOEvt(e.TOPIC_UPDATED,{groupID:s,topic:i}))}onTopicLatestMsg(e){var{topicLatestMessage:s,excludedUnreadSequenceList:i}=e||{};if(!Oe(s)){let{topicID:e}=s["groupProfile"];s.conversationType=t.CONV_GROUP,s.to=e;var r=new xi(s);r.setElement(s.elements),this.updateUnreadCountAndLastMsg(e,r,i)}}onMessageRemindTypeUpdated(t){var{groupID:s,topicID:i,messageRemindType:r}=t,o=this.getLocalTopic(s,i);if(o){let t=o.updateSelfInfo({messageRemindType:r});t&&this.emitOEvt(e.TOPIC_UPDATED,{groupID:s,topic:o}),Ce.l(this._n+`.onMessageRemindTypeUpdated topicID:${i} messageRemindType:${r} isUpdated:`+t)}}onAtInfoUpdated(t){var{topicID:t,groupAtInfoList:s}=t,i=Tt(t),t=this.getLocalTopic(i,t);t&&!$e(s)&&(t.updateGroupAtInfoList(s),this.emitOEvt(e.TOPIC_UPDATED,{groupID:i,topic:t}))}onUnreadCountUpdatedFromConv(t,s=0){var i=Tt(t),t=this.getLocalTopic(i,t);t&&t.unreadCount!==s&&(t.updateUnreadCount(s),0===s&&t.updateSelfInfo({readedSequence:t.lastMessage.lastSequence}),this.emitOEvt(e.TOPIC_UPDATED,{groupID:i,topic:t}))}onMessageSent(t){let{groupID:i,topicID:s,lastMessage:r}=t,o=this.getLocalTopic(i,s);if(o){let{sequence:t=0}=r,s=t+1;s>o.nextMessageSeq&&(o.updateNextMessageSeq(s),o.updateLastMessage(r),o.updateSelfInfo({readedSequence:t}),o.updateUnreadCount(0),this.emitOEvt(e.TOPIC_UPDATED,{groupID:i,topic:o}))}}onMessageModified(t){var s,{to:i,time:r,sequence:o,elements:n,cloudCustomData:a,messageVersion:l}=t,d=Tt(i),c=this.getLocalTopic(d,i);c&&(s=c.lastMessage,Ce.d(this._n+`.onMessageModified topicID:${i} lastMessage:`,JSON.stringify(s),"options:",JSON.stringify(t)),s)&&(null===s.payload||s.lastTime===r&&s.lastSequence===o&&s.version!==l)&&(s.type=n[0].type,s.payload=n[0].content,s.messageForShow=yt(s.type,s.payload,this.isIntl()),s.cloudCustomData=a,s.version=l,s.lastSequence=o,s.lastTime=r,this.emitOEvt(e.TOPIC_UPDATED,{groupID:d,topic:c}))}onMessageRevoked(t){if(0!==t.length){let s=null,i=null,r=!1;t.forEach(t=>{let e=t.to;if(i=Tt(e),s=this.getLocalTopic(i,e)){s.reduceUnreadCount()&&(r=!0),s.isLastMessageRevoked(t)&&(s.setLastMessageRevoked(!0),s.setLastMessageRevoker(t.revoker),r=!0);let e=s.selfInfo.excludedUnreadSequenceList||[];e.push(t.sequence),s.updateSelfInfo({excludedUnreadSequenceList:e})}}),r&&this.emitOEvt(e.TOPIC_UPDATED,{groupID:i,topic:s})}}isLastMessageRevoked(e){var{topicID:e,sequence:t}=e,s=Tt(e),s=this.getLocalTopic(s,e);let i=!1;return i=s?s.isLastMessageRevoked({sequence:t}):i}updateUnreadCountAndLastMsg(i,r,o){var n=Tt(i),a=this.getLocalTopic(n,i);if(a){let s=a.selfInfo.excludedUnreadSequenceList||[];if($e(o)||(s=o),r._isExcludedFromUnreadCount&&s.push(r.sequence),a.updateSelfInfo({excludedUnreadSequenceList:s}),Ce.l(`${this._n}.updateUnreadCountAndLastMsg seq:${r.sequence} lastSeq:`+a.lastMessage.lastSequence),r.sequence>a.lastMessage.lastSequence){a.updateLastMessage(r);let s=r.sequence+1;a.updateNextMessageSeq(s);r=this._computeUnreadCount(a),i=(a.updateUnreadCount(r),this.get(Ds).getLocalConversation(""+t.CONV_GROUP+i));i&&i.updateUnreadCount({nextUnreadCount:r,isFromGetConversations:!0}),this.emitOEvt(e.TOPIC_UPDATED,{groupID:n,topic:a})}}}getJoinedCommunityList(){return this.get(vs).syncCommunityWithTopic()}createTopicInCommunity(t){let s=this._n+".createTopicInCommunity",e=t["topicID"];if(!$e(e)&&!rt(e))return ni({code:ei.ILLEGAL_TOPIC_ID});if(t.topicName&&!1===this._filterProfanity("topicName",t))return ni({code:ei.PROFANITY_FOUND});if(t.introduction&&!1===this._filterProfanity("introduction",t))return ni({code:ei.PROFANITY_FOUND});if(t.notification&&!1===this._filterProfanity("notification",t))return ni({code:ei.PROFANITY_FOUND});let i=new Ti("createTopicInCommunity");return this.req({P:ri.CREATE_TOPIC,data:{...t}}).then(e=>{e=e.data.topicID;return i.setMessage("topicID:"+e).end(),Ce.l(s+" ok. topicID:"+e),this._updateTopicMap([{...t,topicID:e}]),Zs({topicID:e})}).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}deleteTopicFromCommunity(e){let s=this._n+".deleteTopicFromCommunity",{groupID:o,topicIDList:t=[]}=e,n=new Ti("deleteTopicFromCommunity");return n.setMessage(`groupID:${o} topicIDList:`+t),this.req({P:ri.DEL_TOPIC,data:{groupID:o,topicIDList:t}}).then(e=>{let{resultList:t=[]}=e.data,i=[],r=[];t.forEach(e=>{var{topicID:e,errorCode:t,errorInfo:s}=e;0===t?i.push({topicID:e}):r.push({topicID:e,code:t,message:s})});e=`success count:${i.length}, fail count:`+r.length;return n.setMoreMessage(e).end(),Ce.l(s+" ok. "+e),i.forEach(e=>{this._deleteLocalTopic(o,e.topicID)}),Zs({successTopicList:i,failureTopicList:r})}).catch(e=>(n.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}updateTopicProfile(e){let t=this._n+".updateTopicProfile";if(Ce.l(t+" options:",e),e.topicName&&!1===this._filterProfanity("topicName",e))return ni({code:ei.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return ni({code:ei.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return ni({code:ei.PROFANITY_FOUND});let s=new Ti("updateTopicProfile");return s.setMessage(`groupID:${e.groupID} topicID:`+e.topicID),$e(e.muteAllMembers)||(e.muteAllMembers=!0===e.muteAllMembers?"On":"Off"),this.req({P:ri.UPDATE_TOPIC_PROFILE,data:{...e}}).then(()=>(s.end(),Ce.l(t+" ok"),this._updateTopicMap([e]),Zs({topic:this.getLocalTopic(e.groupID,e.topicID)}))).catch(e=>(s.setError(e).end(),Ce.e(t+" failed. error:",e),ni(e)))}getTopicList(e){let i=this._n+".getTopicList",{groupID:r,topicIDList:s=[]}=e,l=0===s.length,d=new Ti("getTopicList");if(d.setMessage("groupID:"+r),this._getTopicTimeMap.has(r)){let{isGetAll:e,time:t}=this._getTopicTimeMap.get(r);if((e||!e&&!l)&&Date.now()-t<1e3*this.TOPIC_CACHE_TIME){let e=this._getLocalTopicList(r,s);if(l||e.length===s.length)return d.setMoreMessage("from cache, topic count:"+e.length).end(),Ce.l(i+` groupID:${r} from cache, topic count:`+e.length),ii({successTopicList:e,failureTopicList:[]})}}return this.req({P:ri.GET_TOPIC_LIST,data:{groupID:r,topicIDList:s}}).then(e=>{let{topicInfoList:t=[]}=e.data,o=[],n=[],a=[];t.forEach(e=>{var{topic:e,selfInfo:t,errorCode:s,errorInfo:i}=e,r=e["topicID"];0===s?(o.push({...e,selfInfo:t}),n.push(r)):a.push({topicID:r,code:s,message:i})}),this._updateTopicMap(o),this._handleTopicAtInfo(o);e=`success count:${n.length}, fail count:`+a.length;d.setMoreMessage(e).end(),Ce.l(i+` groupID:${r} from remote, `+e);let s=[];return Oe(n)||(this._getTopicTimeMap.set(r,{time:Date.now(),isGetAll:l}),s=this._getLocalTopicList(r,n)),Zs({successTopicList:s,failureTopicList:a})}).catch(e=>(d.setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)))}hasLocalTopic(e,t){return!!this._topicMap.has(e)&&this._topicMap.get(e).has(t)}getLocalTopic(e,t){let s=null;return s=this._topicMap.has(e)?this._topicMap.get(e).get(t):s}_getLocalTopicList(e,t=[]){e=this._topicMap.get(e);let s=[];return e&&(s=[...e.values()]),0===t.length?s:s.filter(e=>t.includes(e.topicID))}_deleteLocalTopic(e,t){this._topicMap.has(e)&&this._topicMap.get(e).has(t)&&(this._topicMap.get(e).delete(t),Ce.l(this._n+`._deleteLocalTopic groupID:${e} topicID:`+t))}_updateTopicMap(e){let o=[];e.forEach(e=>{var{groupID:s,topicID:i}=e;let r=null;this._topicMap.has(s)||this._topicMap.set(s,new Map),this._topicMap.get(s).has(i)?(r=this._topicMap.get(s).get(i)).updateTopic(e):(this._getTopicLastMessage(e),r=new gn(e,this.isIntl()),this._topicMap.get(s).set(i,r));e=this._computeUnreadCount(r);r.updateUnreadCount(e),o.push({conversationID:""+t.CONV_GROUP+i,type:t.CONV_TOPIC,unreadCount:e})}),0<o.length&&this.get(Ds).updateTopicConversation(o)}resetGetTopicTime(e){$e(e)?[...this._getTopicTimeMap.keys()].forEach(e=>{this._getTopicTimeMap.set(e,0)}):this._getTopicTimeMap.set(e,0)}getTopicListOnReconnected(){let e=[...this._topicMap.keys()],i=[],r=this.get(Ds);e.forEach(e=>{let s=[],t=this._getLocalTopicList(e);r.deleteTopicRoamingInfo(e),t.forEach(e=>{var{lastMessage:{lastTime:t=0}}=e;Date.now()-1e3*t<1e3*this.TOPIC_LAST_ACTIVE_TIME&&s.push(e.topicID)}),0<s.length&&i.push({groupID:e,topicIDList:s})}),Ce.l(this._n+".getTopicListOnReconnected. active community count:"+i.length),this._relayGetTopicList(i)}_relayGetTopicList(i){if(0!==i.length){let e=i.shift(),t=5<e.topicIDList.length?"topicIDList.length:"+e.topicIDList.length:"topicIDList:"+e.topicIDList,s=new Ti("relayGetTopicList");s.setMessage(t),Ce.l(this._n+"._relayGetTopicList. "+t),this.getTopicList(e).then(()=>{s.end(),this._relayGetTopicList(i)}).catch(e=>{s.setError(e).end(),this._relayGetTopicList(i)})}}_handleTopicAtInfo(e){0!==e.length&&e.forEach(e=>{let{groupID:t,topicID:s,groupAtInfoList:i}=e,r=[];$e(i)||(i.forEach(e=>{r.push({...e,groupID:t,topicID:s})}),this.get(Ds).onNewGroupAtTips({dataList:r}))})}_getTopicLastMessage(e){var t;$e(e.lastMsg)||(t={time:e.lastMsg.time,sequence:e.lastMsg.sequence,from:e.lastMsg.from,payload:e.lastMsg.elements[0]?e.lastMsg.elements[0].content:null,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:"",nick:e.lastMsg.nick,avatar:e.lastMsg.avatar,version:e.lastMsg.messageVersion,cloudCustomData:e.lastMsg.cloudCustomData,isRevoked:2===e.lastMsg.isPlaceMessage,revoker:Oe(e.lastMsg.revokerInfo)?null:e.lastMsg.revokerInfo.revoker},e.lastMessage=t)}deleteTopicListInCommunity(s){let e=this._getLocalTopicList(s),i=this.get(Ds);e.forEach(e=>{e=e.topicID;this._deleteLocalTopic(s,e),this._getTopicTimeMap.delete(s),i.deleteLocalConv(""+t.CONV_GROUP+e)})}_computeUnreadCount(s){let{excludedUnreadSequenceList:e,readedSequence:i}=s.selfInfo,r=s.nextMessageSeq-s.selfInfo.readedSequence-1;if(Fe(e)){let t=0;e.forEach(e=>{e>i&&e<=s.nextMessageSeq-1&&(t+=1)}),1<=t&&(r-=t)}return r<0?0:r}_filterProfanity(e,t){var s,i=this.get(Vs);return!i||({isAllowedToSend:i,modifiedText:s}=i.filterText(t[e],E),!0===i&&(t[e]=s,!0))}getMessageExtensions(e,t){Ce.l(this._n+".getMessageExtensions startSequence:"+t);var s=Tt(e.to);return this.req({P:ri.GET_GRP_MSG_EXT,data:{groupID:s,topicID:e.to,messageSequence:e.sequence,startSequence:t}})}modifyMsgExts(e,t,s=1){Ce.l(this._n+".modifyMsgExts operateType:"+s);var i=Tt(e.to);return this.req({P:ri.MODIFY_GRP_MSG_EXT,data:{groupID:i,topicID:e.to,messageSequence:e.sequence,extensionList:t,operateType:s}})}reset(){Ce.l(this._n+".reset"),this._topicMap.clear(),this._getTopicTimeMap.clear(),this.TOPIC_CACHE_TIME=300,this.TOPIC_LAST_ACTIVE_TIME=3600}}class fn{constructor(e){this._userM=e,this._n="ProfileHandler",this.TAG="profile",this.accountProfileMap=new Map,this.expirationTime=864e5}setExpirationTime(e){this.expirationTime=e}getUserProfile(e){let t=this._n+".getUserProfile",s=e.userIDList,i=(e.fromAccount=this._userM.getMyAccount(),100<s.length&&(Ce.w(t+" "+St(100)),s.length=100),[]),r=[];var o;for(let e=0,t=s.length;e<t;e++)o=s[e],this._userM.isMyFriend(o)&&this._contains(o)?r.push(this._getProfileFromMap(o)):i.push(o);if(0===i.length)return ii(r);e.toAccount=i;let n=e.bFromGetMyProfile||!1,a=[],l=(e.toAccount.forEach(e=>{a.push({toAccount:e,standardSequence:0,customSequence:0})}),e.userItem=a,new Ti("getUserProfile"));return l.setMessage(5<s.length?"userIDList.length:"+s.length:"userIDList:"+s),this._userM.req({P:ri.GET_USER_PROFILE,data:e}).then(e=>{l.end(),Ce.i(t+" ok");e=this._handleResponse(e).concat(r);return Zs(n?e[0]:e)}).catch(e=>(l.setError(e).end(),Ce.e(t+" failed. error:",e),ni(e)))}getMyProfile(){var e,t=this._userM.getMyAccount(),s=this._n+".getMyProfile";return Ce.l(s+" myAccount:"+t),this._fill(),this._contains(t)?(e=this._getProfileFromMap(t),Ce.d(s+" from cache, myProfile:"+JSON.stringify(e)),ii(e)):this.getUserProfile({fromAccount:t,userIDList:[t],bFromGetMyProfile:!0})}_handleResponse(e){var i,r=e.data["userProfileItem"];if(!Fe(r))return[];let o=[],t=Date.now();for(let s=0,e=r.length;s<e;s++){let{to:e,profileItem:t}=r[s];"@TLS#NOT_FOUND"!==e&&""!==e&&(i=this._update(e,this._getLatestProfileFromResponse(e,t))["latestProfile"],o.push(i))}return Ce.l(this._n+"._handleResponse cost:"+Dt(t)),o}_getLatestProfileFromResponse(e,s){var i={userID:e,profileCustomField:[]};if(!Oe(s))for(let e=0,t=s.length;e<t;e++)if(-1<s[e].tag.indexOf("Tag_Profile_Custom"))i.profileCustomField.push({key:s[e].tag,value:s[e].value});else switch(s[e].tag){case ye.NICK:i.nick=s[e].value;break;case ye.GENDER:i.gender=s[e].value;break;case ye.BIRTHDAY:i.birthday=s[e].value;break;case ye.LOCATION:i.location=s[e].value;break;case ye.SELFSIGNATURE:i.selfSignature=s[e].value;break;case ye.ALLOWTYPE:i.allowType=s[e].value;break;case ye.LANGUAGE:i.language=s[e].value;break;case ye.AVATAR:i.avatar=s[e].value;break;case ye.MESSAGESETTINGS:i.messageSettings=s[e].value;break;case ye.ADMINFORBIDTYPE:i.adminForbidType=s[e].value;break;case ye.LEVEL:i.level=s[e].value;break;case ye.ROLE:i.role=s[e].value;break;default:Ce.w(this._n+"._getLatestProfileFromResponse unknown tag:",s[e].tag,s[e].value)}return i}updateMyProfile(r){let o=this._n+".updateMyProfile";if(r.nick&&!1===this._userM.filterProfanity("nick",r))return ni({code:ei.PROFANITY_FOUND});if(r.selfSignature&&!1===this._userM.filterProfanity("selfSignature",r))return ni({code:ei.PROFANITY_FOUND});let n=new Ti("updateMyProfile");n.setMessage(JSON.stringify(r));var t=(new sn).validate(r);if(!t.valid)return n.setCode(ei.UPDATE_PROFILE_INVALID_PARAM).setMoreMessage("info:"+t.tips).end(),Ce.e(o+" info:"+t.tips),ni({code:ei.UPDATE_PROFILE_INVALID_PARAM});let s=[];for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&("profileCustomField"===e?r.profileCustomField.forEach(e=>{s.push({tag:e.key,value:e.value})}):s.push({tag:ye[e.toUpperCase()],value:r[e]}));if(0===s.length){let e=new Qs({code:ei.UPDATE_PROFILE_NO_KEY});return n.setError(e).end(),Ce.e(o+" failed. error:",e),ni(e)}let a=this._userM.getMyAccount();return this._userM.req({P:ri.UPDATE_MY_PROFILE,data:{fromAccount:a,profileItem:s}}).then(t=>{n.end(),Ce.i(o+" ok");var{isProfileUpdated:s,latestProfile:i}=this._update(a,r);return!0===s&&this._userM.emitOEvt(e.PROFILE_UPDATED,[i]),ii(i)}).catch(e=>(n.setError(e).end(),Ce.e(o+" failed. error:",e),ni(e)))}onProfileModified(s){var i=s.dataList;if(!Oe(i)){let t=i.length;Ce.d(`${this._n}.onProfileModified count:${t} dataList:`,s.dataList);var r,o=[];for(let s=0;s<t;s++){r=i[s].userID;let{isProfileUpdated:e,latestProfile:t}=this._update(r,this._getLatestProfileFromResponse(r,i[s].profileList));!0===e&&o.push(t)}0<o.length&&(this._userM.emitIEvt(Yi.PROFILE_UPDATED,o),this._userM.emitOEvt(e.PROFILE_UPDATED,o))}}_fill(){if(0===this.accountProfileMap.size){var s=this._getCachedProfiles(),i=Date.now();for(let e=0,t=s.length;e<t;e++)i-s[e].lastUpdatedTime<this.expirationTime&&this.accountProfileMap.set(s[e].userID,s[e]);Ce.l(this._n+"._fill from cache, size:"+this.accountProfileMap.size)}}_update(e,t){let s,i=!1;var r=Date.now();return this._contains(e)?(s=this._getProfileFromMap(e),t.profileCustomField&&!0===st(s.profileCustomField,t.profileCustomField)&&(s.lastUpdatedTime=r,i=!0),0<We(s,t,["profileCustomField"])&&(s.lastUpdatedTime=r,i=!0)):(s=new sn(t),!this._userM.isMyFriend(e)&&e!==this._userM.getMyAccount()||(s.lastUpdatedTime=r,i=!0,this.accountProfileMap.set(e,s))),this._flush(e===this._userM.getMyAccount()),!0===i&&Ce.l(this._n+`._update account:${e} isUpdated:`+i),{isProfileUpdated:i,latestProfile:s}}_flush(e){var t=[...this.accountProfileMap.values()],s=this._userM.getStorageModule();Ce.d(this._n+`._flush length:${t.length} flushAtOnce:`+e),s.setItem(this.TAG,t,e)}_contains(e){return this.accountProfileMap.has(e)}_getProfileFromMap(e){return this.accountProfileMap.get(e)}_getCachedProfiles(){var e=this._userM.getStorageModule().getItem(this.TAG);return Oe(e)?[]:e}onConvProfileUpdated(s){var i,r,o,n=[];for(let e=0,t=s.length;e<t;e++)r=(i=s[e]).userID,this._userM.isMyFriend(r)&&(this._contains(r)?(o=this._getProfileFromMap(r),0<We(o,i)&&n.push(r)):n.push(i.userID));0!==n.length&&(Ce.l(this._n+".onConvProfileUpdated toAccountList:"+n),this.getUserProfile({userIDList:n}))}getNickAndAvatarByUserID(e){return this._contains(e)?{nick:(e=this._getProfileFromMap(e)).nick,avatar:e.avatar}:{nick:"",avatar:""}}getUserNickAndAvatar(e){var t=[...new Set(e)];Ce.l(`${this._n}.getUserNickAndAvatar userIDList.length:${e.length} uniqueUserIDList.length:`+t.length);let s=[];if(0===e.length)return Promise.resolve(s);let i=this._createUserIDListGroup(t),r=[];return i.forEach(e=>{r.push(this.getUserProfile({userIDList:e}))}),Promise.all(r).then(e=>(e.forEach(e=>{e=e.data.map(({userID:e,nick:t,avatar:s})=>({userID:e,nick:t,avatar:s}));s.push(...e)}),s))}_createUserIDListGroup(e){var t=[];let s=0;for(;s<e.length;)t.push(e.slice(s,s+=100));return t}reset(){this._flush(!0),this.accountProfileMap.clear()}}class Mn{constructor(e){Oe||(this.userID=e.userID||"",this.timeStamp=e.timeStamp||0)}}class In{constructor(e){this._userM=e,this._n="BlacklistHandler",this._blacklistMap=new Map,this._startIndex=0}getLocalBlacklist(){return[...this._blacklistMap.keys()]}getBlacklist(){let r=this._n+".getBlacklist",t={fromAccount:this._userM.getMyAccount(),maxLimited:100,startIndex:this._startIndex},o=new Ti("getBlacklist");return this._userM.req({P:ri.GET_BL,data:t}).then(t=>{var{blackListItem:t,startIndex:s}=t.data,i=Oe(t)?0:t.length;o.setMessage("count:"+i).end(),Ce.i(r+" ok"),this._startIndex=s,this._handleResponse(t,!0),this._userM.emitOEvt(e.BLACKLIST_UPDATED,[...this._blacklistMap.keys()]),0!==this._startIndex&&this.getBlacklist()}).catch(e=>(o.setError(e).end(),Ce.e(r+" failed. error:",e),ni(e)))}addBlacklist(t){let s=new Ti("addToBlacklist"),i=this._n+".addBlacklist",r=this._userM.getMyAccount();if(1!==t.userIDList.length||t.userIDList[0]!==r)return t.userIDList.includes(r)&&(t.userIDList=t.userIDList.filter(e=>e!==r)),t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({P:ri.ADD_TO_BL,data:t}).then(e=>(s.setMessage(5<t.userIDList.length?"userIDList.length:"+t.userIDList.length:"userIDList:"+t.userIDList).end(),Ce.i(i+" ok"),this._handleResponse(e.resultItem,!0),Zs([...this._blacklistMap.keys()]))).catch(e=>(s.setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)));{let e=ei.CANNOT_ADD_SELF_TO_BLACKLIST,t=this._userM.getErrMsg(e);s.setCode(e).setMessage(t).end();var o=new Qs({code:e});return Ce.e(i+" failed. error:",o),ni(o)}}_handleResponse(o,n){if(!Oe(o)){let s,i,r;for(let e=0,t=o.length;e<t;e++)i=o[e].to,r=o[e].resultCode,!$e(r)&&0!==r||(n?((s=this._blacklistMap.has(i)?this._blacklistMap.get(i):new Mn).userID=i,Oe(o[e].addBlackTimeStamp)||(s.timeStamp=o[e].addBlackTimeStamp),this._blacklistMap.set(i,s)):this._blacklistMap.has(i)&&(s=this._blacklistMap.get(i),this._blacklistMap.delete(i)))}Ce.l(`${this._n}._handleResponse total:${this._blacklistMap.size} bAdd:`+n)}deleteBlacklist(t){let s=this._n+".deleteBlacklist",i=new Ti("removeFromBlacklist");return t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({P:ri.RM_FROM_BL,data:t}).then(e=>(i.setMessage(5<t.userIDList.length?"userIDList.length:"+t.userIDList.length:"userIDList:"+t.userIDList).end(),Ce.i(s+" ok"),this._handleResponse(e.data.resultItem,!1),Zs([...this._blacklistMap.keys()]))).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}onAccountDeleted(s){for(let t=0,e=s.length;t<e;t++){let e=s[t];this._blacklistMap.has(e)&&this._blacklistMap.delete(e)}let t=s.length;0<t&&(Ce.l(`${this._n}.onAccountDeleted count:${t} `+(t<30?"userIDList:"+s:"")),this._userM.emitOEvt(e.BLACKLIST_UPDATED,[...this._blacklistMap.keys()]))}onAccountAdded(s){var i,r=[];for(let e=0,t=s.length;e<t;e++)i=s[e],this._blacklistMap.has(i)||(this._blacklistMap.set(i,new Mn({userID:i})),r.push(i));0<r.length&&(Ce.l(this._n+`.onAccountAdded count:${r.length} userIDList:`,r),this._userM.emitOEvt(e.BLACKLIST_UPDATED,[...this._blacklistMap.keys()]))}reset(){this._blacklistMap.clear(),this._startIndex=0}}let Cn=function(e){var r=String(e).replace(/[=]+$/,"");let o="";if(r.length%4==1)return"";for(let e,t,s=0,i=0;t=r.charAt(i++);~t&&(e=s%4?64*e+t:t,s++%4)&&(o+=String.fromCharCode(255&e>>(-2*s&6))))t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(t);try{return decodeURIComponent(escape(o))}catch(e){return""}};class Tn{constructor(e){this._userM=e,this._n="UserStatusHandler",this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100,this._userM.getIEmitInst().on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){var e=this._userM.getCloudConfig("status_query_count"),t=this._userM.getCloudConfig("status_sub_count"),s=this._userM.getCloudConfig("status_unsub_count");Ce.l(this._n+`._onCloudConfig statusQueryCount:${e} statusSubscribeCount:${t} statusUnsubscribeCount:`+s),$e(e)||(this.MAX_QUERY_USER_COUNT=parseInt(e,10)),$e(e)||(this.MAX_SUBSCRIBE_USER_COUNT=parseInt(t,10)),$e(e)||(this.MAX_UNSUBSCRIBE_USER_COUNT=parseInt(s,10))}onUserStatusUpdated(t){let s=t["dataList"],i=this._userM.getMyUserID(),r=this._userM.get(Rs),o=s.map(e=>{var{to:e,statusType:t,customStatus:s}=e,s=Cn(s);return e===i&&r.setCustomStatus(s),{userID:e,statusType:t,customStatus:s}});Ce.l(this._n+".onUserStatusUpdated list:"+JSON.stringify(o)),this._userM.emitOEvt(e.USER_STATUS_UPDATED,o)}setSelfStatus(e){let t=this._n+".setSelfStatus";if(!1===this._userM.filterProfanity("customStatus",e))return ni({code:ei.PROFANITY_FOUND});let s=new Ti("setSelfStatus"),i=e["customStatus"];return this._userM.req({P:ri.SET_SELF_STATUS,data:{customStatus:i}}).then(e=>(s.setMessage("customStatus:"+i).end(),Ce.l(t+" ok. customStatus:"+i),this._userM.get(Rs).setCustomStatus(i),Zs({userID:this._userM.getMyUserID(),statusType:1,customStatus:i}))).catch(e=>(s.setError(e).end(),Ce.e(t+" failed. error:",e),ni(e)))}getUserStatus(e){let i=this._n+".getUserStatus",{userIDList:r=[]}=e,t=this._userM.getMyUserID(),s=[...r],o=void 0;var n=s.indexOf(t);if(-1<n){s.splice(n,1);let e=this._userM.get(Rs).getCustomStatus();o={userID:t,statusType:1,customStatus:e}}if(0===s.length)return ii({successUserList:[o],failureUserList:[]});if(!this._userM.canIUse(M.USER_STATUS))return this._userM.noUse("getUserStatus");s.length>this.MAX_QUERY_USER_COUNT&&(Ce.w(i+" "+St(this.MAX_QUERY_USER_COUNT)),s=r.slice(0,this.MAX_QUERY_USER_COUNT));let a=new Ti("getUserStatus");return this._userM.req({P:ri.GET_USER_STATUS,data:{userIDList:s}}).then(e=>{var{successUserList:e=[],failureUserList:t=[]}=e.data,e=e.map(e=>{var{userID:e,statusType:t,customStatus:s}=e;return{userID:e,statusType:t,customStatus:Cn(s)}}),t=t.map(e=>{var{userID:e,invalidUserID:t,errorCode:s,errorInfo:i}=e;return{userID:Oe(t)?e:t,code:s,message:i}}),s=($e(o)||e.unshift(o),`userID count:${r.length}, success count:${e.length}, fail count:`+t.length);return a.setMessage(s).end(),Ce.l(i+` ok. ${s}.`),Zs({successUserList:e,failureUserList:t})}).catch(e=>(a.setMessage("userID count:"+r.length).setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)))}subscribeUserStatus(e){var t="subscribeUserStatus";if(!this._userM.canIUse(M.USER_STATUS))return this._userM.noUse(t);let s=this._n+"."+t,{userIDList:i=[]}=e,r=[...i],o=(r.length>this.MAX_SUBSCRIBE_USER_COUNT&&(Ce.w(s+" "+St(this.MAX_SUBSCRIBE_USER_COUNT)),r=i.slice(0,this.MAX_SUBSCRIBE_USER_COUNT)),new Ti(t)),n="userID count:"+i.length;return Ce.l(s+" "+n),this._userM.req({P:ri.SUB_USER_STATUS,data:{userIDList:r}}).then(e=>{var{failureUserList:e=[]}=e.data,e=e.map(e=>{var{userID:e,invalidUserID:t,errorCode:s,errorInfo:i}=e;return{userID:Oe(t)?e:t,code:s,message:i}});return o.setMessage(n+" fail count:"+e.length).end(),Ce.l(s+` ok. fail count:${e.length}.`),Zs({failureUserList:e})}).catch(e=>(o.setMessage(n).setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}unsubscribeUserStatus(e){var t="unsubscribeUserStatus";if(!this._userM.canIUse(M.USER_STATUS))return this._userM.noUse(t);let s=this._n+"."+t,{userIDList:i=[]}=e||{},r=[...i],o=(i.length>this.MAX_UNSUBSCRIBE_USER_COUNT&&(Ce.w(s+" "+St(this.MAX_UNSUBSCRIBE_USER_COUNT)),r=i.slice(0,this.MAX_UNSUBSCRIBE_USER_COUNT)),new Ti(t)),n="userID count:"+i.length;Ce.l(s+" "+n);e={userIDList:r};return 0===r.length&&(e.userIDList=void 0,e.unsubscribeAll=1),this._userM.req({P:ri.UNSUB_USER_STATUS,data:e}).then(e=>{var{failureUserList:e=[]}=e.data,e=e.map(e=>{var{userID:e,invalidUserID:t,errorCode:s,errorInfo:i}=e;return{userID:Oe(t)?e:t,code:s,message:i}});return o.setMessage(n+" fail count:"+e.length).end(),Ce.l(s+` ok. fail count:${e.length}.`),Zs({failureUserList:e})}).catch(e=>(o.setMessage(n).setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}reset(){this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100}}class yn extends oi{constructor(e){super(e),this._n="UserModule",this._profileHandler=new fn(this),this._blacklistHandler=new In(this),this._userStatusHandler=new Tn(this),this.getIEmitInst().on(Yi.A2KEY_AND_TINYID_UPDATED,this.onContextUpdated,this)}onContextUpdated(e){this._profileHandler.getMyProfile(),this._blacklistHandler.getBlacklist()}mockOnNickAvatarModified(e,t){Ce.l(this._n+`._mockOnNickAvatarModified nick:${e} avatar:`+t),this.onProfileModified({dataList:[{pushType:1,userID:this.getMyUserID(),profileList:[{tag:ye.NICK,value:e},{tag:ye.AVATAR,value:t}]}]})}onProfileModified(e){this._profileHandler.onProfileModified(e)}onRelationChainModified(e){e=e.dataList;if(!Oe(e)){let t=[],s=(e.forEach(e=>{e.blackListDelAccount&&t.push(...e.blackListDelAccount)}),0<t.length&&this._blacklistHandler.onAccountDeleted(t),[]);e.forEach(e=>{e.blackListAddAccount&&s.push(...e.blackListAddAccount)}),0<s.length&&this._blacklistHandler.onAccountAdded(s)}}onConvProfileUpdated(e){this._profileHandler.onConvProfileUpdated(e)}getMyAccount(){return this.getMyUserID()}getMyNick(){return this._profileHandler.getNickAndAvatarByUserID(this.getMyUserID()).nick}getMyProfile(){return this._profileHandler.getMyProfile()}getStorageModule(){return this.get(Ls)}filterProfanity(e,t){var s,i=this.get(Vs);return!i||({isAllowedToSend:i,modifiedText:s}=i.filterText(t[e],v),!0===i&&(t[e]=s,!0))}isMyFriend(e){var t=this.get(Es);return!!t&&t.isMyFriend(e)}getUserProfile(e){return this._profileHandler.getUserProfile(e)}updateMyProfile(e){return this._profileHandler.updateMyProfile(e)}getNickAndAvatarByUserID(e){return this._profileHandler.getNickAndAvatarByUserID(e)}getUserNickAndAvatar(e){return this._profileHandler.getUserNickAndAvatar(e)}getLocalBlacklist(){var e=this._blacklistHandler.getLocalBlacklist();return ii(e)}addBlacklist(e){return this._blacklistHandler.addBlacklist(e)}deleteBlacklist(e){return this._blacklistHandler.deleteBlacklist(e)}onUserStatusUpdated(e){this._userStatusHandler.onUserStatusUpdated(e)}setSelfStatus(e){return this._userStatusHandler.setSelfStatus(e)}getUserStatus(e){return this._userStatusHandler.getUserStatus(e)}subscribeUserStatus(e){return this._userStatusHandler.subscribeUserStatus(e)}unsubscribeUserStatus(e){return this._userStatusHandler.unsubscribeUserStatus(e)}reset(){Ce.l(this._n+".reset"),this._profileHandler.reset(),this._blacklistHandler.reset(),this._userStatusHandler.reset()}}class vn{constructor(e,t){this._m=e,this._isLoggedIn=!1,this._SDKAppID=t.SDKAppID,this._userID=t.userID||"",this._userSig=t.userSig||"",this._version="3.5.3",this._a2Key="",this._tinyID="",this._customStatus="",this._contentType="json",this._unlimitedAVChatRoom=t.unlimitedAVChatRoom,this._scene=t.scene||"",this._oversea=t.oversea,this._instanceID=t.instanceID,this._statusInstanceID=0,this._isDevMode=t.devMode,this._isTestEnv=t.testEnv,this._proxyServer=t.proxyServer,this._fileUploadProxy=t.fileUploadProxy,this._fileDownloadProxy=t.fileDownloadProxy,this._applicationID=0,this._isPartialUpdatedConvs=t.partialUpdatedConversations,this._isIndependentDomainDisabled=t.disableIndependentDomain,this._isUsingChatCore=!1,this._uiPlatform=0,this._authKey="",this._customLoginInfo=""}isLoggedIn(){return this._isLoggedIn}isOversea(){return this._oversea}isPrivateNetWork(){return this._proxyServer}isDevMode(){return this._isDevMode}isTestEnv(){return this._isTestEnv}isPartialUpdatedConvs(){return this._isPartialUpdatedConvs}isIndependentDomainDisabled(){return this._isIndependentDomainDisabled}isSingaporeSite(){return 2e7<=this._SDKAppID&&this._SDKAppID<3e7||172e7<=this._SDKAppID&&this._SDKAppID<173e7}isKoreaSite(){return 3e7<=this._SDKAppID&&this._SDKAppID<4e7||173e7<=this._SDKAppID&&this._SDKAppID<174e7}isGermanySite(){return 4e7<=this._SDKAppID&&this._SDKAppID<5e7||174e7<=this._SDKAppID&&this._SDKAppID<175e7}isIndiaSite(){return 5e7<=this._SDKAppID&&this._SDKAppID<6e7||175e7<=this._SDKAppID&&this._SDKAppID<176e7}isJapanSite(){return 6e7<=this._SDKAppID&&this._SDKAppID<7e7||176e7<=this._SDKAppID&&this._SDKAppID<177e7}isUSASite(){return 7e7<=this._SDKAppID&&this._SDKAppID<8e7||177e7<=this._SDKAppID&&this._SDKAppID<178e7}isIndonesiaSite(){return 8e7<=this._SDKAppID&&this._SDKAppID<9e7||178e7<=this._SDKAppID&&this._SDKAppID<179e7}isIntl(){return 0===(e=this._SDKAppID)||2e7<=e&&e<9e7||172e7<=e&&e<179e7;var e}isUnlimitedAVChatRoom(){return this._unlimitedAVChatRoom}isUsingChatCore(){return this._isUsingChatCore}setUsingChatCore(e){this._isUsingChatCore=e}getUIPlatform(){return this._uiPlatform}setUIPlatform(e){this._uiPlatform=e}setUserID(e){this._userID=e}getUserID(){return this._userID}setUserSig(e){this._userSig=e}getUserSig(){return this._userSig}getSDKAppID(){return this._SDKAppID}setTinyID(e){this._tinyID=e,this._isLoggedIn=!0}getTinyID(){return this._tinyID}setCustomStatus(e){this._customStatus=e}getCustomStatus(){return this._customStatus}getScene(){return oe?window.tencent_cloud_im_csig_flutter_for_web_25F_cy:this._isTUIKit()?"tuikit":this._scene}getInstanceID(){return this._instanceID}getStatusInstanceID(){return this._statusInstanceID}setStatusInstanceID(e){this._statusInstanceID=e}getVersion(){return this._version}getA2Key(){return this._a2Key}setA2Key(e){this._a2Key=e}getContentType(){return this._contentType}getProxyServer(){return this._proxyServer}getFileUploadProxy(){return this._fileUploadProxy}getFileDownloadProxy(){return this._fileDownloadProxy}setApplicationID(e){this._applicationID=e}getApplicationID(){return this._applicationID}setDowloadFileAuthKey(e){this._authKey=e}getDownloadFileAuthKey(){return this._authKey}setCustomLoginInfo(e){this._customLoginInfo=e}getCustomLoginInfo(){return this._customLoginInfo}_isTUIKit(){let s=!1,t=!1,e=!1,i=!1,r=[];k&&(r=Object.keys($));for(let e=0,t=(r=F?G?Object.keys(uni):Object.keys(window):r).length;e<t;e++)if(r[e].toLowerCase().includes("uikit")){s=!0;break}if(r=null,k&&!xe($.createGamePortal)&&xe(getApp)&&!$e(getApp())){let e=getApp().globalData;be(e)&&!0===e.isTUIKit&&(t=!0)}!0===this._m.get(Ls).getStorageSync(`TIM_${this._SDKAppID}_isTUIKit`)&&(e=!0);let o=null;if(S&&!L&&"undefined"==typeof uni&&__wxConfig&&(o=__wxConfig.pages),R&&"undefined"==typeof uni&&__qqConfig&&(o=__qqConfig.pages),Fe(o)&&0<o.length){for(let e=0,t=o.length;e<t;e++)if(o[e].toLowerCase().includes("tui")){i=!0;break}o=null}return s||t||e||i}reset(){this._isLoggedIn=!1,this._userSig="",this._a2Key="",this._tinyID="",this._customStatus="",this._statusInstanceID=0}}let En={"k-vue2-pc":1,"k-vue2-h5":2,"k-vue2-h5-uni":3,"k-vue2-app-uni":4,"k-vue2-mp-uni":5,"k-vue2-pc-uni":6,"k-vue3-pc":7,"k-vue3-h5":8,"k-vue3-h5-uni":9,"k-vue3-app-uni":10,"k-vue3-mp-uni":11,"k-vue3-pc-uni":12,"k-rn":13};class Sn extends oi{constructor(e){super(e),this._n="SignModule",this._helloInterval=120,this._lastLoginTs=0,this._lastWsHelloTs=0,this._isWebUniapp=0,ji.mixin(this)}onCheckTimer(e){this.isLoggedIn()&&e%this._helloInterval==0&&this._hello()}getPushModule(){let e=void 0;var t=this.get(js),s=this.get(xs);return t.canIUseTIMPush()?e=t:s.canIUseOfflinePush()&&(e=s),e}login(e){if(this.isLoggedIn()){let e=this.getMyUserID();return(s=this.getErrMsg("RepeatLogin",e))&&Ce.w(s),ii({actionStatus:"OK",errorCode:0,errorInfo:s,repeatLogin:!0})}if(Date.now()-this._lastLoginTs<=15e3)return this.warn("LoggingIn",e.userID),ni({code:ei.REPEAT_LOGIN});Ce.l(this._n+".login userID:"+e.userID);var t,s=this._checkLoginInfo(e);return 0!==s.code?ni(s):({userID:s,userSig:e}=e,(t=this.get(Rs)).setUserID(s),t.setUserSig(e),this.get(Gs).updateProtocolConfig(),this._login())}_login(){let g=this.get(Rs),m=g.getScene(),t=0,e=m,f=(m&&m.startsWith("k-")&&(e=En[m],m="tuikit"),new Ti("login"));f.setMessage(""+e).setMoreMessage("identifier:"+this.getMyUserID());var s="tuikit"===m;let i=0;G?i=s?3===e||4===e||5===e||6===e?31:9===e||10===e||11===e||12===e?32:4:3:k?i=D?36:"tuikit"===m?12:11:F?i=oe?"flutter_web_uikit"===m?21:20:this._isReactUIKit()?ne?25:24:s?1===e||2===e?29:7===e||8===e?30:ne?17:14:ne?16:13:13===e&&(i=38),f.setUIPlatform(i),g.setUIPlatform(i);s=this.getPushModule();if(s){this._isWebUniapp=s.getUniAppPlatform();let e=this._getStatusInstanceID();g.setStatusInstanceID(e),this.get(Gs).updateProtocolConfig(),t=s.getDeviceBrand()}let M=this._n+"._login";return this._lastLoginTs=Date.now(),this.req({P:ri.LOGIN,data:{deviceBrand:t,isWebUniapp:this._isWebUniapp,customInfo:g.getCustomLoginInfo()}}).then(e=>{this._lastLoginTs=0;var t=Date.now();let s=null;var{a2Key:i,tinyID:r,helloInterval:o,instanceID:n,timeStamp:a,customStatus:l="",purchaseBits:d,authKey:c=""}=e.data,_=1e3*a,u=t-f.getStartTs(),u=_+parseInt(u/2)-t,t=f.getStartTs()+u,t=(f.start(t),_),_=u;if(he=_,(_=new Date).setTime(t),Ce.i(`baseTime from server:${_} offset:`+he),!r)throw s=new Qs({code:ei.NO_TINYID}),f.setError(s).end(),s;if(!i)throw s=new Qs({code:ei.NO_A2KEY}),f.setError(s).end(),s;t=this.get(ks).getSocketID(),_=Cn(l),l=`socketID:${t} scene:${m} helloInterval:${o} instanceID:${n} timeStamp:${a} offset:${u} customStatus:${_} isWebUniapp:`+this._isWebUniapp;Ce.l(M+" ok. "+l);let h="",p="";if(S&&xe($.getAccountInfoSync)){let e=$.getAccountInfoSync().miniProgram;e&&(h=e.appId,p=e.envVersion)}f.setMoreMessage(l+` href:${F?window.location.href:""} mpAppId:${h} envVersion:${p} authKey:`+c).end(),g.setA2Key(i),g.setTinyID(r),g.setStatusInstanceID(n),g.setCustomStatus(_),g.setDowloadFileAuthKey(c),d&&this.get(qs).onPushedConfig({errorCode:0,expiredTime:0,purchaseBits:d}),this.get(Gs).updateProtocolConfig(),this.emitIEvt(Yi.A2KEY_AND_TINYID_UPDATED),this._helloInterval=o,this.triggerReady();t=this.getPushModule();return t&&(uni.setStorageSync("timUniAppInstanceID",n),t.init()),this._fetchCloudControlConfig(),this.get(Vs).init(),e}).catch(e=>(f.setError(e).end(!0),this._m.setNotReadyReason(ei.LOGIN_FAILED),Ce.e(M+" failed. error:",e),this._lastLoginTs=0,this._m.onLoginFailed(),ni(e)))}logout(e=0){let t=this._n+".logout",s=this.isLoggedIn();return Ce.i(t+` type:${e} isLoggedIn:${s} isWebUniapp:`+this._isWebUniapp),s?(new Ti("logout").setMessage("identifier:"+this.getMyUserID()).end(!0),0===e&&this._m.setNotReadyReason(ei.LOGGED_OUT),this.req({P:ri.LOGOUT,data:{type:e,isWebUniapp:this._isWebUniapp}}).then(()=>(this.resetReady(),ii({}))).catch(e=>(Ce.e(t+" error:",e),this.resetReady(),ii({})))):ni({code:ei.USER_NOT_LOGGED_IN})}getLoginUser(){return this.isLoggedIn()?this.getMyUserID():""}_fetchCloudControlConfig(){this.get(ws).fetchConfig()}_getStatusInstanceID(){return uni.getStorageSync("timUniAppInstanceID")||0}_hello(){this._lastWsHelloTs=Date.now(),this.req({P:ri.HELLO,data:{isWebUniapp:this._isWebUniapp}}).catch(e=>{Ce.w(this._n+"._hello error:",e)})}getLastWsHelloTs(){return this._lastWsHelloTs}_checkLoginInfo(e){let t=0;return Oe(this.get(Rs).getSDKAppID())?t=ei.NO_SDKAPPID:Oe(e.userID)?t=ei.NO_IDENTIFIER:Oe(e.userSig)&&(t=ei.NO_USERSIG),{code:t}}_isReactUIKit(){return F&&void 0!==window.tencent_cloud_im_csig_react_uikit_23F_xa}onMultipleAccountKickedOut(s){new Ti("kickedOut").setMessage(`type:${t.KICKED_OUT_MULT_ACCOUNT} newInstanceInfo:`+JSON.stringify(s)).end(!0),Ce.w(`${this._n}.onMultipleAccountKickedOut userID:${this.getMyUserID()} newInstanceInfo:`,s),this.logout(1).then(()=>{this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_MULT_ACCOUNT}),this._m.setNotReadyReason(ei.KICKED_OUT_MULT_ACCOUNT),this._m.reset()})}onMultipleDeviceKickedOut(s){new Ti("kickedOut").setMessage(`type:${t.KICKED_OUT_MULT_DEVICE} newInstanceInfo:`+JSON.stringify(s)).end(!0),Ce.w(`${this._n}.onMultipleDeviceKickedOut userID:${this.getMyUserID()} newInstanceInfo:`,s),this.logout(1).then(()=>{this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_MULT_DEVICE}),this._m.setNotReadyReason(ei.KICKED_OUT_MULT_DEVICE),this._m.reset()})}onUserSigExpired(){new Ti("kickedOut").setMessage(t.KICKED_OUT_USERSIG_EXPIRED).end(!0),Ce.w(this._n+".onUserSigExpired userID:"+this.getMyUserID()),0!==this.get(Rs).getStatusInstanceID()&&(this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_USERSIG_EXPIRED}),this._m.setNotReadyReason(ei.KICKED_OUT_USERSIG_EXPIRED),this._m.reset())}onRestApiKickedOut(s){new Ti("kickedOut").setMessage(`type:${t.KICKED_OUT_REST_API} newInstanceInfo:`+JSON.stringify(s)).end(!0),Ce.w(`${this._n}.onRestApiKickedOut userID:${this.getMyUserID()} newInstanceInfo:`,s),0!==this.get(Rs).getStatusInstanceID()&&(this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_REST_API}),this._m.setNotReadyReason(ei.KICKED_OUT_REST_API),this._m.reset(),this.get(ks).onRestApiKickedOut())}reset(){Ce.l(this._n+".reset"),this.resetReady(),this._helloInterval=120,this._lastLoginTs=0,this._lastWsHelloTs=0,this._isWebUniapp=0}}function Dn(){return null}class Rn{constructor(e){this._m=e,this._n="StorageModule",this._storageQueue=new Map,this._errorTolerantHandle()}_errorTolerantHandle(){k||"undefined"!=typeof window&&this._canIUseCookies()||(this.getItem=Dn,this.setItem=Dn,this.removeItem=Dn,this.clear=Dn)}onCheckTimer(e){e%20==0&&0!==this._storageQueue.size&&this._doFlush()}_doFlush(){try{for(var[e,t]of this._storageQueue)this._setStorageSync(this._getKey(e),t);this._storageQueue.clear()}catch(e){Ce.w(this._n+"._doFlush error:",e)}}_getPrefix(){var e=this._m.get(Rs);return`TIM_${e.getSDKAppID()}_${e.getUserID()}_`}_getKey(e){return""+this._getPrefix()+e}getItem(e,t=!0){try{var s=t?this._getKey(e):e;return this.getStorageSync(s)}catch(e){return Ce.w(this._n+".getItem error:",e),{}}}setItem(t,s,e=!1,i=!0){if(e){let e=i?this._getKey(t):t;this._setStorageSync(e,s)}else this._storageQueue.set(t,s)}clear(){try{k?$.clearStorageSync():this._canIUseCookies()&&localStorage.clear()}catch(e){Ce.w(this._n+".clear error:",e)}}removeItem(e,t=!0){try{var s=t?this._getKey(e):e;this._removeStorageSync(s)}catch(e){Ce.w(this._n+".removeItem error:",e)}}getSize(e,s="b"){try{let t={size:0,limitSize:5242880,unit:s};if(Object.defineProperty(t,"leftSize",{enumerable:!0,get:()=>t.limitSize-t.size}),k&&(t.limitSize=1024*$.getStorageInfoSync().limitSize),e)t.size=JSON.stringify(this.getItem(e)).length+this._getKey(e).length;else if(k){let e=$.getStorageInfoSync()["keys"];e.forEach(e=>{t.size+=JSON.stringify(this.getStorageSync(e)).length+this._getKey(e).length})}else if(this._canIUseCookies())for(let e in localStorage)localStorage.hasOwnProperty(e)&&(t.size+=localStorage.getItem(e).length+e.length);return this._convertUnit(t)}catch(e){Ce.w(this._n+" error:",e)}}_convertUnit(e){var t,s={},i=e["unit"];for(t in s.unit=i,e)"number"==typeof e[t]&&("kb"===i.toLowerCase()?s[t]=Math.round(e[t]/1024):"mb"===i.toLowerCase()?s[t]=Math.round(e[t]/1024/1024):s[t]=e[t]);return s}_setStorageSync(e,t){k?O?my.setStorageSync({key:e,data:t}):$.setStorageSync(e,t):this._canIUseCookies()&&localStorage.setItem(e,JSON.stringify(t))}getStorageSync(e){return k?O?my.getStorageSync({key:e}).data:$.getStorageSync(e):this._canIUseCookies()?JSON.parse(localStorage.getItem(e)):{}}_removeStorageSync(e){k?O?my.removeStorageSync({key:e}):$.removeStorageSync(e):this._canIUseCookies()&&localStorage.removeItem(e)}_canIUseCookies(){return"undefined"!=typeof window&&navigator&&navigator.cookieEnabled&&localStorage}reset(){Ce.l(this._n+".reset"),this._doFlush()}}class Ln{constructor(e){this._n="SSOLogBody",this._report=[]}pushIn(e){Ce.d(this._n+".pushIn",this._report.length,e),this._report.push(e)}backfill(e){Fe(e)&&0!==e.length&&(Ce.d(this._n+".backfill",this._report.length,e.length),this._report.unshift(...e))}getLogsNumInMemory(){return this._report.length}isEmpty(){return 0===this._report.length}_reset(){this._report.length=0,this._report=[]}getLogsInMemory(){var e=this._report.slice();return this._reset(),e}}let An=function(e){var t=e.get(Rs);return{SDKType:10,SDKAppID:t.getSDKAppID(),SDKVersion:t.getVersion(),tinyID:Number(t.getTinyID()),userID:t.getUserID(),platform:e.getPlatform(),instanceID:t.getInstanceID(),traceID:pe()}};class On extends oi{constructor(e){super(e),this._n="EventStatModule",this.TAG="im-ssolog-event",this._reportBody=new Ln,this.MIN_THRESHOLD=20,this.MAX_THRESHOLD=100,this.WAITING_TIME=6e4,this.REPORT_LEVEL=[4,5,6],this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._lastReportTime=Date.now();e=this.getIEmitInst();e.on(Yi.A2KEY_AND_TINYID_UPDATED,this._onLoginSuccess,this),e.on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}reportAtOnce(){this._report()}_onLoginSuccess(){var e=this.get(Ls),t=e.getItem(this.TAG,!1);!Oe(t)&&xe(t.forEach)&&(Ce.l(this._n+"._onLoginSuccess. logs count:"+t.length),t.forEach(e=>{this._reportBody.pushIn(e)}),e.removeItem(this.TAG,!1))}_onCloudConfig(){var e=this.getCloudConfig("evt_rpt_threshold"),t=this.getCloudConfig("evt_rpt_waiting"),s=this.getCloudConfig("evt_rpt_level"),i=this.getCloudConfig("evt_rpt_sdkappid_bl"),r=this.getCloudConfig("evt_rpt_tinyid_wl");$e(e)||(this.MIN_THRESHOLD=Number(e)),$e(t)||(this.WAITING_TIME=Number(t)),$e(s)||(this.REPORT_LEVEL=s.split(",").map(e=>Number(e))),$e(i)||(this.REPORT_SDKAPPID_BLACKLIST=i.split(",").map(e=>Number(e))),$e(r)||(this.REPORT_TINYID_WHITELIST=r.split(","))}pushIn(e){e instanceof Ti&&(e.updateTimeStamp(),this._reportBody.pushIn(e),this._reportBody.getLogsNumInMemory()>=this.MIN_THRESHOLD)&&this._report()}onCheckTimer(){Date.now()<this._lastReportTime+this.WAITING_TIME||this._reportBody.isEmpty()||this._report()}_filterLogs(e){var t=this.get(Rs),s=t.getSDKAppID(),t=t.getTinyID();return It(this.REPORT_SDKAPPID_BLACKLIST,s)&&!Ct(this.REPORT_TINYID_WHITELIST,t)?[]:e.filter(e=>this.REPORT_LEVEL.includes(e.level))}_report(){if(!this._reportBody.isEmpty()){let t=this._reportBody.getLogsInMemory(),e=this._filterLogs(t);var s;0===e.length?this._lastReportTime=Date.now():(s={header:An(this),event:e},this.req({P:ri.SSO_STAT,data:{...s}}).then(()=>{this._lastReportTime=Date.now()}).catch(e=>{Ce.w(this._n+"._report failed. error:",e),this._lastReportTime=Date.now(),this._reportBody.backfill(t),this._reportBody.getLogsNumInMemory()>this.MAX_THRESHOLD&&this._flushAtOnce()}))}}_flushAtOnce(){var t=this.get(Ls),s=t.getItem(this.TAG,!1),i=this._reportBody.getLogsInMemory(),r=this._n+"._flushAtOnce";if(Oe(s))Ce.l(r+" count:"+i.length),t.setItem(this.TAG,i,!0,!1);else{let e=i.concat(s);e.length>this.MAX_THRESHOLD&&(e=e.slice(0,this.MAX_THRESHOLD)),Ce.l(r+" count:"+e.length),t.setItem(this.TAG,e,!0,!1)}}reset(){Ce.l(this._n+".reset"),this._lastReportTime=0,this._report(),this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[]}}let Nn="none",Pn="online";class Un{constructor(e){this._m=e,this._networkType=Pn,this._n="NetMonitorModule",this._mpNetworkStatusCallback=null,this._webOnlineCallback=null,this._webOfflineCallback=null,this._removeListener=null,this._m.getIEmitInst().on(Yi.A2KEY_AND_TINYID_UPDATED,this._startRN,this)}_startRN(){var e;b&&(e=this._m.get(Ps).getPlugin("chat-network-monitor"))&&(this._removeListener=e.addEventListener(e=>{var{isConnected:e=!1,type:t}=e;this._networkType!==t&&this._onNetworkStatusChange({isConnected:e,networkType:t})}))}start(){let t=this._n+".start";k?($.getNetworkType({success:e=>{this._networkType=e.networkType||e.subtype||"",e.networkType===Nn?Ce.w(t+" no network, please check!"):Ce.i(t+" networkType:"+e.networkType)}}),this._mpNetworkStatusCallback=this._onNetworkStatusChange.bind(this),$.onNetworkStatusChange(this._mpNetworkStatusCallback)):F&&(this._networkType=Pn,this._webOnlineCallback=this._onWebOnline.bind(this),this._webOfflineCallback=this._onWebOffline.bind(this),window.addEventListener("online",this._webOnlineCallback),window.addEventListener("offline",this._webOfflineCallback))}_onWebOnline(){this._onNetworkStatusChange({isConnected:!0,networkType:Pn})}_onWebOffline(){this._onNetworkStatusChange({isConnected:!1,networkType:Nn})}_onNetworkStatusChange(e){var{isConnected:e,networkType:t}=e,s=this._n+"._onNetworkStatusChange";let i=!1;var r=`previous:${this._networkType} current:`+t;e?(Ce.i(s+" "+r),this._networkType!==t&&(i=!0,this._networkType=t,this._m.get(ks).reConnect(!0))):this._networkType!==t&&(i=!0,this._networkType=t,Ce.w(s+" no network, please check!"),this._m.get(ks).offline()),i&&new Ti("networkChange").setMessage(`isConnected:${e} `+r).end()}isOnline(){return this._networkType!==Nn}getNetworkType(){return this._networkType}reset(){Ce.l(this._n+".reset"),k?null!==this._mpNetworkStatusCallback&&($.offNetworkStatusChange&&$.offNetworkStatusChange(this._mpNetworkStatusCallback),this._mpNetworkStatusCallback=null):F?(null!==this._webOnlineCallback&&(window.removeEventListener("online",this._webOnlineCallback),this._webOnlineCallback=null),null!==this._onWebOffline&&(window.removeEventListener("offline",this._webOfflineCallback),this._webOfflineCallback=null)):b&&this._removeListener&&(this._removeListener(),this._removeListener=null)}}function Gn(e,t){return e(t={exports:{}},t.exports),t.exports}var kn=Gn(function(e){var i=Object.prototype.hasOwnProperty,h="~";function s(){}function o(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function r(e,t,s,i,r){if("function"!=typeof s)throw new TypeError("The listener must be a function");s=new o(s,i||e,r),i=h?h+t:t;return e._events[i]?e._events[i].fn?e._events[i]=[e._events[i],s]:e._events[i].push(s):(e._events[i]=s,e._eventsCount++),e}function l(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function t(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(h=!1)),t.prototype.eventNames=function(){var e,t,s=[];if(0===this._eventsCount)return s;for(t in e=this._events)i.call(e,t)&&s.push(h?t.slice(1):t);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},t.prototype.listeners=function(e){var e=h?h+e:e,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var s=0,i=t.length,r=new Array(i);s<i;s++)r[s]=t[s].fn;return r},t.prototype.listenerCount=function(e){e=h?h+e:e,e=this._events[e];return e?e.fn?1:e.length:0},t.prototype.emit=function(e,t,s,i,r,o){var n=h?h+e:e;if(!this._events[n])return!1;var a,l=this._events[n],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,s),!0;case 4:return l.fn.call(l.context,t,s,i),!0;case 5:return l.fn.call(l.context,t,s,i,r),!0;case 6:return l.fn.call(l.context,t,s,i,r,o),!0}for(u=1,a=new Array(d-1);u<d;u++)a[u-1]=arguments[u];l.fn.apply(l.context,a)}else for(var c,_=l.length,u=0;u<_;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),d){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,s);break;case 4:l[u].fn.call(l[u].context,t,s,i);break;default:if(!a)for(c=1,a=new Array(d-1);c<d;c++)a[c-1]=arguments[c];l[u].fn.apply(l[u].context,a)}return!0},t.prototype.on=function(e,t,s){return r(this,e,t,s,!1)},t.prototype.once=function(e,t,s){return r(this,e,t,s,!0)},t.prototype.removeListener=function(e,t,s,i){e=h?h+e:e;if(this._events[e])if(t){var r=this._events[e];if(r.fn)r.fn!==t||i&&!r.once||s&&r.context!==s||l(this,e);else{for(var o=0,n=[],a=r.length;o<a;o++)(r[o].fn!==t||i&&!r[o].once||s&&r[o].context!==s)&&n.push(r[o]);n.length?this._events[e]=1===n.length?n[0]:n:l(this,e)}}else l(this,e);return this},t.prototype.removeAllListeners=function(e){return e?(e=h?h+e:e,this._events[e]&&l(this,e)):(this._events=new s,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=h,e.exports=t.EventEmitter=t});let wn=["rich.my-imcloud.com","imrich.qcloud.com"],bn=9999,Fn=1e4;class $n extends oi{constructor(e){super(e),this._n="UploadModule",this.TIMUploadPlugin=null,this.timUploadPlugin=null,this.COSSDK=null,this._cosUploadMethod=null,this.expiredTimeLimit=600,this.appid=0,this.bucketName="",this.ciUrl="",this.directory="",this.downloadUrl="",this.uploadUrl="",this.region="ap-shanghai",this.cos=null,this.cosOptions={secretId:"",secretKey:"",sessionToken:"",expiredTime:0},this.uploadFileType="",this.duration=900,this.tryCount=0,this.UPLOAD_SIZE_LIMIT={A:20971520,F:104857600,I:20971520,V:104857600},this.isSimpleCos=!1,this._fileDownloadProxy="",this._authKey="",this._fileDNList=wn;e=this.getIEmitInst();e.on(Yi.A2KEY_AND_TINYID_UPDATED,this._init,this),e.on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_init(){this._fileDownloadProxy=this.getFileDownloadProxy(),this._authKey=this.getDownloadFileAuthKey();var e,t=this.get(Ps);this.TIMUploadPlugin=t.getPlugin("tim-upload-plugin"),this.TIMUploadPlugin?this._initUploaderMethod():(e=k?"cos-wx-sdk":"cos-js-sdk",this.COSSDK=t.getPlugin(e),this.COSSDK?(this._getAuthorizationKey(),this.warn("CosReplacement",e)):this.warn("PluginUndetected"))}_onCloudConfig(){let e=this._n+"._onCloudConfig",t=this.getCloudConfig("upload_size_limit"),s=this.getCloudConfig("simple_cos"),i=this.getCloudConfig("file_dn_list");if(Ce.l(e+` uploadSizeLimit:${t} simpleCos:`+s),!$e(t))try{let e=JSON.parse(t);this.UPLOAD_SIZE_LIMIT={A:e.a?1048576*parseInt(e.a):this.UPLOAD_SIZE_LIMIT.A,F:e.f?1048576*parseInt(e.f):this.UPLOAD_SIZE_LIMIT.F,I:e.i?1048576*parseInt(e.i):this.UPLOAD_SIZE_LIMIT.I,V:e.v?1048576*parseInt(e.v):this.UPLOAD_SIZE_LIMIT.V}}catch(e){}if($e(s)||(this.isSimpleCos="1"===s),!$e(i))try{JSON.parse(i).forEach(e=>{this._fileDNList.includes(e)||this._fileDNList.push(e)})}catch(e){}}_getAuthorizationKey(){let s=this._n+"._getAuthorizationKey",i=new Ti("_getAuthorizationKey"),r=Math.ceil(Date.now()/1e3);this.req({P:ri.COS_SIGN,data:{duration:this.expiredTimeLimit}}).then(e=>{var e=e["data"],t=(Ce.l(s+" ok. data:",e),e.expiredTime-r);i.setMessage(`requestId:${e.requestId} requestTime:${r} expiredTime:${e.expiredTime} diff:${t}s`).end(),!k&&e.region&&(this.region=e.region),this.appid=e.appid,this.bucketName=e.bucketName,this.ciUrl=e.ciUrl,this.directory=e.directory,this.downloadUrl=e.downloadUrl,this.uploadUrl=e.uploadUrl,this.cosOptions={secretId:e.secretId,secretKey:e.secretKey,sessionToken:e.sessionToken,expiredTime:e.expiredTime},Ce.l(s+` ok. region:${this.region} bucketName:`+this.bucketName),this._initUploaderMethod()}).catch(e=>{i.setError(e).end(),Ce.w(s+" failed. error:",e)})}_getCosPreSigUrl(t){let r=this._n+"._getCosPreSigUrl",o=Math.ceil(Date.now()/1e3),n=new Ti("_getCosPreSigUrl"),e={uploadMethod:t.uploadMethod,platform:this.getPlatform(),SDKAppID:this.getSDKAppID(),userID:t.userID,conversationType:t.conversationType,uploadConfig:[{fileID:1,fileType:t.fileType,fileName:t.fileName}]},s=ri.SIMPLE_COS_PRE_SIG;return this.isSimpleCos||(e={fileType:t.fileType,fileName:t.fileName,uploadMethod:t.uploadMethod,duration:t.duration},s=ri.COS_PRE_SIG),this.req({P:s,data:e}).then(e=>{this.tryCount=0;var s=e.data||{};Ce.l(`${r} ok. isSimpleCos:${this.isSimpleCos} data:`,s);let i="";if(this.isSimpleCos){let{uploadUrl:e,fileKey:t}=s.preSig[0];i=`uploadIP:${s.uploadIP} uploadUrl:${e} fileKey:${t} cost:`+Dt(o)}else i=`requestId:${s.requestId} expiredTime:${s.expiredTime} diff:${s.expiredTime-o}s`;return n.setMessage(i).end(),s}).catch(e=>(-1===e.code&&(e.code=ei.COS_GET_SIG_FAIL),n.setError(e).end(),Ce.w(r+" failed. error:",e),this.tryCount<1?(this.tryCount++,this._getCosPreSigUrl(t)):(this.tryCount=0,ni({code:ei.COS_GET_SIG_FAIL}))))}_initUploaderMethod(){this.TIMUploadPlugin?(this.timUploadPlugin=new this.TIMUploadPlugin,this._cosUploadMethod=(e,t)=>{this.timUploadPlugin.uploadFile(e,t)}):this.appid&&(this.cos=k?new this.COSSDK({ForcePathStyle:!0,getAuthorization:this._getAuthorization.bind(this)}):new this.COSSDK({getAuthorization:this._getAuthorization.bind(this)}),this._cosUploadMethod=k?(e,t)=>{this.cos.postObject(e,t)}:(e,t)=>{this.cos.uploadFiles(e,t)})}onCheckTimer(e){!this.COSSDK||this.TIMUploadPlugin||this.isLoggedIn()&&e%60==0&&Math.ceil(Date.now()/1e3)>=this.cosOptions.expiredTime-120&&this._getAuthorizationKey()}getFileDNList(){return this._fileDNList}_getAuthorization(e,t){t({TmpSecretId:this.cosOptions.secretId,TmpSecretKey:this.cosOptions.secretKey,XCosSecurityToken:this.cosOptions.sessionToken,ExpiredTime:this.cosOptions.expiredTime})}upload(e){if(!0===e._relayFlag)return Promise.resolve();var s=this.get($s);switch(e.type){case t.MSG_IMAGE:return s.addTotalCount(hi),this._uploadImage(e);case t.MSG_FILE:return s.addTotalCount(hi),this._uploadFile(e);case t.MSG_AUDIO:return s.addTotalCount(hi),this._uploadAudio(e);case t.MSG_VIDEO:return s.addTotalCount(hi),this._uploadVideo(e);default:return Promise.resolve()}}_uploadImage(g){let e=this.get(Is),m=g.getElements()[0],t=e.getMessageOption(g.clientSequence);return this.doUploadImage({file:t.payload.file,to:t.to,message:g,onProgress:e=>{if(m.updatePercent(e),xe(t.onProgress))try{t.onProgress(e)}catch(e){return ni({code:ei.MSG_ONPROGRESS_ERR})}}}).then(e=>{var{location:e,fileType:t,fileSize:s,width:i,height:r,smallImageUrl:o,smallImageWidth:n,smallImageHeight:a,largeImageUrl:l,largeImageWidth:d,largeImageHeight:c,imageInfoArray:_}=e,e=this.isPrivateNetWork()?e:et(e);m.updateImageFormat(t);let u,h,p={size:s,url:e,width:i,height:r};if(_&&0<_.length)for(let t=0;t<_.length;t++){let e=_[t];1===e.type?u=e:2===e.type?h=e:p={...p,...e}}else h=o&&l?(u={url:o,width:n,height:a},{url:l,width:d,height:c}):(u=gt({originUrl:e,originWidth:i,originHeight:r,min:198}),gt({originUrl:e,originWidth:i,originHeight:r,min:720}));return m.updateImageInfoArray([{...p},{...h},{...u}]),g})}_uploadFile(s){let e=this.get(Is),i=s.getElements()[0],t=e.getMessageOption(s.clientSequence);return this.doUploadFile({file:t.payload.file,to:t.to,message:s,onProgress:e=>{if(i.updatePercent(e),xe(t.onProgress))try{t.onProgress(e)}catch(e){return ni({code:ei.MSG_ONPROGRESS_ERR})}}}).then(({location:e})=>{let t=e;return this.isPrivateNetWork()||(t=vi(t=et(e),this._fileDownloadProxy,this._authKey,this._fileDNList)),i.updateFileUrl(t),s})}_uploadAudio(t){let e=this.get(Is),s=t.getElements()[0],i=e.getMessageOption(t.clientSequence);return this.doUploadAudio({file:i.payload.file,to:i.to,message:t,onProgress:e=>{if(s.updatePercent(e),xe(i.onProgress))try{i.onProgress(e)}catch(e){return ni({code:ei.MSG_ONPROGRESS_ERR})}}}).then(({location:e})=>{e=this.isPrivateNetWork()?e:et(e);return s.updateAudioUrl(e),t})}_uploadVideo(s){let e=this.get(Is),i=s.getElements()[0],t=e.getMessageOption(s.clientSequence);return this.doUploadVideo({file:t.payload.file,to:t.to,message:s,onProgress:e=>{if(i.updatePercent(e),xe(t.onProgress))try{t.onProgress(e)}catch(e){return ni({code:ei.MSG_ONPROGRESS_ERR})}}}).then(e=>{var{location:e,snapshotInfo:t}=e,e=this.isPrivateNetWork()?e:et(e);return i.updateVideoUrl(e),Oe(t)||i.updateSnapshotInfo(t),s})}_checkSizeError(e){let t="";return"A"===e?t="audio":"I"===e?t="image":"V"===e?t="video":"F"===e&&(t="file"),ni({code:ei[`MSG_${e}_SIZE_LIMIT`],message:this.getErrMsg("UploadSizeLimit",t,this.UPLOAD_SIZE_LIMIT[e]/1048576+"MB")})}doUploadImage(s){if(!s.file||this._isEmptyFileList(s.file.files))return ni({code:ei.MSG_I_SELECT_F_FIRST});var e=this._checkImageType(s.file);if(!0!==e)return e;e=this._checkImageSize(s.file);if(!0!==e)return e;let i=null;return this._setUploadFileType(Zi),this.uploadByCOS(s).then(e=>{if(i=e,this.isPrivateNetWork())return dt(t);if(Fe(i.imageInfoArray)){let e=i.imageInfoArray.find(e=>3===e.type);if(e)return e}if(b)return{width:s.file.width,height:s.file.height};let t=et(e.location);return dt(t=this.COSSDK?t:vi(t,this._fileDownloadProxy,this._authKey,this._fileDNList))}).then(e=>(i.width=e.width,i.height=e.height,Promise.resolve(i)))}_checkImageType(e){var t="",t=k?e.url.slice(e.url.lastIndexOf(".")+1):b?e.type.split("/")[1]:e.files[0].name.slice(e.files[0].name.lastIndexOf(".")+1);return 0<=Ji.indexOf(t.toLowerCase())||ni({code:ei.MSG_I_TYPES_LIMIT})}_checkImageSize(e){return 0===(e=(k||b?e:e.files[0]).size)?ni({code:ei.MSG_F_IS_EMPTY}):e<this.UPLOAD_SIZE_LIMIT.I||this._checkSizeError("I")}doUploadFile(e){let t=null;return!e.file||this._isEmptyFileList(e.file.files)?(t={code:ei.MSG_F_SELECT_F_FIRST},ni(t)):e.file.files[0].size>this.UPLOAD_SIZE_LIMIT.F?this._checkSizeError("F"):0===e.file.files[0].size?(t={code:ei.MSG_F_IS_EMPTY},ni(t)):(this._setUploadFileType(tn),this.uploadByCOS(e))}doUploadVideo(e){return e.file.videoFile.size>this.UPLOAD_SIZE_LIMIT.V?this._checkSizeError("V"):0===e.file.videoFile.size?ni({code:ei.MSG_F_IS_EMPTY}):-1===Xi.indexOf(e.file.videoFile.type)?ni({code:ei.MSG_V_TYPES_LIMIT}):(this._setUploadFileType(Qi),k||b?this.handleVideoUpload({...e,file:e.file.videoFile}):F?this.handleVideoUpload(e):void 0)}handleVideoUpload(s){return new Promise((t,e)=>{this.uploadByCOS(s).then(e=>{t(e)}).catch(()=>{this.uploadByCOS(s).then(e=>{t(e)}).catch(()=>{e(new Qs({code:ei.MSG_V_UPLOAD_FAIL}))})})})}doUploadAudio(e){return e.file?e.file.size>this.UPLOAD_SIZE_LIMIT.A?this._checkSizeError("A"):0===e.file.size?ni({code:ei.MSG_F_IS_EMPTY}):(this._setUploadFileType(en),this.uploadByCOS(e)):ni({code:ei.MSG_A_UPLOAD_FAIL})}uploadByCOS(t){if(!xe(this._cosUploadMethod))return this.warn("PluginUndetected"),ni({code:ei.COS_UNDETECTED});if(this.timUploadPlugin)return this._uploadWithPreSigUrl(t);let l=new Ti("upload"),d=this._n+".uploadByCOS",c=Date.now(),_=this._getFile(t);return new Promise((o,n)=>{let e=k?this._createCosOptionsWXMiniApp(t):this._createCosOptionsWeb(t),a=this;this._cosUploadMethod(e,(s,i)=>{var r=Object.create(null);if(i){if(s||Fe(i.files)&&i.files[0].error){let e=new Qs({code:ei.MSG_F_UPLOAD_FAIL});return l.setError(e).end(),Ce.l(d+" failed. error:",i.files[0].error),403===i.files[0].error.statusCode&&this._getAuthorizationKey(),void n(e)}r.fileName=_.name,r.fileSize=_.size,r.fileType=_.type.slice(_.type.indexOf("/")+1).toLowerCase(),r.location=(k?i:i.files[0].data).Location;let e=Date.now()-c,t=`size:${a._formatFileSize(_.size)} time:${e}ms speed:`+a._formatSpeed(1e3*_.size/e);Ce.l(d+` success. name:${_.name} `+t),o(r);i=this.get($s);i.addCost(hi,e),i.addFileSize(hi,_.size),void l.setMessage(t).end()}else{let e=new Qs({code:ei.MSG_F_UPLOAD_FAIL});l.setError(e).end(),Ce.w(d+" failed. error:",s),403===s.statusCode&&this._getAuthorizationKey(),n(e)}})})}_uploadWithPreSigUrl(e){let _=this._n+"._uploadWithPreSigUrl",u=this._getFile(e);return this._createCosOptionsPreSigUrl(e).then(c=>new Promise((o,t)=>{let n=new Ti("upload"),{requestSnapshotUrl:a,...l}=c,d=Date.now();this._cosUploadMethod(l,(s,i)=>{if(s||403===i.statusCode){n.setError(new Qs(s)).end();let e={HttpStatusCode:bn,CostTime:Dt(d,!1),error:s,url:c.url};i.data&&i.data.uploadIP&&(e.uploadIP=i.data.uploadIP),this._uploadSSOLog(e),Ce.l(_+" failed, error:",s),void t(new Qs({code:ei.MSG_F_UPLOAD_FAIL}))}else{let e=Object.create(null),t=i.data.location||"";this.isPrivateNetWork()||0!==t.indexOf("https://")&&0!==t.indexOf("http://")||(t=t.split("//")[1]),e.fileName=u.name,e.fileSize=u.size,e.fileType=u.type.slice(u.type.indexOf("/")+1).toLowerCase(),e.location=t;var s=Dt(d,!1),r=`size:${this._formatFileSize(u.size)} time:${s}ms speed:${this._formatSpeed(1e3*u.size/s)} res:`+JSON.stringify(i.data),r=(Ce.l(_+` ok. name:${u.name} `+r),n.setMessage(r).end(),{HttpStatusCode:i.statusCode,FileSize:u.size,CostTime:s,url:c.url}),r=(i.data&&i.data.uploadIP&&(r.uploadIP=i.data.uploadIP),this._uploadSSOLog(r),this.get($s)),s=(r.addCost(hi,s),r.addFileSize(hi,u.size),[]);if(l.thumbUrl&&l.largeUrl&&s.push(this._getSmallImageInfoByUrl(l.thumbUrl,e),this._getLargeImageInfoByUrl(l.largeUrl,e)),this.uploadFileType===Zi&&this.isSimpleCos&&!this.isPrivateNetWork()&&(s.push(this._getImageInfoArray(l.downloadUrl,e)),i.data.uploadIP)&&s.push(this._getDownloadIP(l.downloadUrl.split("//")[1].split("/")[0],e)),a&&s.push(this._getSnapshotInfoByUrl(a,e)),0<s.length)return Promise.all(s).then(()=>{o(e)});o(e)}})}))}_getDownloadIP(e,s){let i=this._n+"._getDownloadIP",r=Date.now();return this.req({P:ri.GET_IP,data:{domainName:e}}).then(e=>{var t;e.data&&e.data.ip&&(Ce.l(i+` ok. downloadIP:${e.data.ip} cost:`+Dt(r)),(t=s.location.split("/"))[0]=e.data.ip,s.location=t.join("/"))}).catch(e=>{})}_getImageInfoArray(t,s){let i=this._n+"._getImageInfoArray",r=Date.now();return this.req({P:ri.GET_IMAGE_INFO,data:{imageUrl:t}}).then(e=>{e=e.data||{};return Ce.l(i+` ok. data: ${JSON.stringify(e)} cost:`+Dt(r)),s.imageInfoArray=e.imageInfoArray,e}).catch(e=>{s.imageInfoArray=void 0,this._uploadSSOLog({HttpStatusCode:Fn,CostTime:Dt(r,!1),url:t})})}_uploadSSOLog(t){if(this.isSimpleCos){var s=new Ti;s.setEventType(18),t.error&&s.setError(new Qs(t.error));let e=`HttpStatusCode:${t.HttpStatusCode}|CosRequestId:${t.CosRequestId||""}|FileAlreadyExist:${t.FileAlreadyExist||0}|FileSize:${t.FileSize||0}|CostTime:`+t.CostTime;t.uploadIP&&(e+="|FinalIP:"+t.uploadIP),s.setMessage("OK").setMoreMessage(t.url).setExtension(e).end()}}_getRawOrUploadProxyUrl(e){var t=this.get(Rs).getFileUploadProxy();let s=e;return s=t?e.replace(/^https:\/\/[^/]+/,t):s}_getFile(e){return Fe(e.file.files)||Be(e.file.files)?e.file.files[0]:e.file}_formatFileSize(e){return e<1024?e+"B":e<1048576?Math.floor(e/1024)+"KB":Math.floor(e/1048576)+"MB"}_formatSpeed(e){return e<=1048576?Mt(e/1024,1)+"KB/s":Mt(e/1048576,1)+"MB/s"}_createCosOptionsWeb(t){var e=this._getFile(t),s=e.name,s=s.slice(s.lastIndexOf(".")),s=this._genFileName(""+je(999999)+s);return{files:[{Bucket:this.bucketName+"-"+this.appid,Region:this.region,Key:this.directory+"/"+s,Body:e}],SliceSize:1048576,onProgress:e=>{if("function"==typeof t.onProgress)try{t.onProgress(e.percent)}catch(e){Ce.w("onProgress callback error:",e)}},onFileFinish:(e,t,s)=>{}}}_createCosOptionsWXMiniApp(t){var e=this._getFile(t),s=this._genFileName(e.name),e=e.url;return{Bucket:this.bucketName+"-"+this.appid,Region:this.region,Key:this.directory+"/"+s,FilePath:e,onProgress:e=>{if(Ce.l(JSON.stringify(e)),"function"==typeof t.onProgress)try{t.onProgress(e.percent)}catch(e){Ce.w("onProgress callback error:",e)}}}}_createCosOptionsPreSigUrl(a){let l="",d="",s=0;var i=this._getFile(a);if(k||b){if(a.message.type===t.MSG_FILE){let e=i.name,t=e.slice(e.lastIndexOf("."));l=this._genFileName(""+je(999999)+t)}else l=this._genFileName(i.name);d=i.url,s=1}else{let e=i.name,t=e.slice(e.lastIndexOf("."));l=this._genFileName(""+je(999999)+t),d=i,s=0}return this._getCosPreSigUrl({fileType:this.uploadFileType,fileName:l,uploadMethod:s,duration:this.duration,userID:a.message.from,conversationType:at(a.message.conversationID)?1:2}).then(e=>{var{uploadUrl:t,downloadUrl:s,requestSnapshotUrl:i,thumbUrl:r,largeUrl:o,fileKey:n}=this.isSimpleCos?e.preSig[0]:e,{uploadIP:e=""}=e;return{url:this._getRawOrUploadProxyUrl(t),fileType:this.uploadFileType,fileName:l,resources:d,downloadUrl:s,requestSnapshotUrl:i,thumbUrl:r,largeUrl:o,fileKey:n,uploadIP:!this.isPrivateNetWork()&&e,onProgress:e=>{if("function"==typeof a.onProgress)try{a.onProgress(e.percent)}catch(e){Ce.w("onProgress callback error:",e),Ce.e(e)}}}})}_genFileName(e){return _t()+"-"+e}_setUploadFileType(e){this.uploadFileType=e}_getSnapshotInfoByUrl(e,s){let i="_getSnapshotInfoByUrl",r=new Ti(i);return this.req({P:ri.VIDEO_COVER,data:{platform:this.getPlatform(),coverName:this._genFileName(je(99999)),requestSnapshotUrl:e}}).then(e=>{e=(e.data||{}).snapshotUrl;if(Ce.l(`${this._n}.${i} ok. snapshotUrl:`+e),r.setMessage("snapshotUrl:"+e).end(),Oe(e))return{};let t=vi(e,this._fileDownloadProxy,this._authKey,this._fileDNList);return dt(t).then(e=>{s.snapshotInfo={snapshotUrl:t,snapshotWidth:e.width,snapshotHeight:e.height}})}).catch(e=>(Ce.w(`${this._n}.${i} failed. error:`,e),r.setCode(e.errorCode).setMessage(e.errorInfo).end(),{}))}_getSmallImageInfoByUrl(t,s){return dt(vi(t,this._fileDownloadProxy,this._authKey,this._fileDNList)).then(e=>{s.smallImageUrl=t,s.smallImageWidth=e.width,s.smallImageHeight=e.height})}_getLargeImageInfoByUrl(t,s){return dt(vi(t,this._fileDownloadProxy,this._authKey,this._fileDNList)).then(e=>{s.largeImageUrl=t,s.largeImageWidth=e.width,s.largeImageHeight=e.height})}_isEmptyFileList(e){return!(!Be(e)||0!==e.length)}reset(){Ce.l(this._n+".reset")}}class qn{constructor(e){this._n="MergerMessageHandler",this._msgM=e}uploadMergerMessage(e,s){let i=this._n+".uploadMergerMessage",t=(Ce.d(i+" message:",e,"messageBytes:"+s),JSON.parse(JSON.stringify(e.payload)))["messageList"],r=t.length,o=this._msgM.get(Ns).getFileDNList(),n=new Ti("uploadMergerMessage");return t.forEach(e=>{Ei(e.messageBody[0].type,e.messageBody,o)}),this._msgM.req({P:ri.UPLOAD_MERGER_MSG,data:{messageList:t}}).then(e=>{Ce.d(i+" ok. response:",e.data);var{pbDownloadKey:e,downloadKey:t}=e.data,e={pbDownloadKey:e,downloadKey:t,messageNumber:r};return n.setMessage(r+`-${s}-`+t).end(),e}).catch(e=>{throw Ce.w(i+" failed. error:",e),n.setError(e).end(),e})}downloadMergerMessage(n){let t=this._n+".downloadMergerMessage",s=(Ce.d(t+" message:",n),n.payload)["downloadKey"],a=this._msgM.getFileDownloadProxy(),l=this._msgM.getDownloadFileAuthKey(),i=new Ti("downloadMergerMessage");return i.setMessage("downloadKey:"+s),this._msgM.req({P:ri.DOWNLOAD_MERGER_MSG,data:{downloadKey:s}}).then(r=>{Ce.d(t+" ok. response:",r.data);let o=this._msgM.get(Ns).getFileDNList();if(xe(n.clearElement)){let{downloadKey:e,pbDownloadKey:t,messageList:s,...i}=n.payload;n.clearElement(),n.setElement({type:n.type,content:{messageList:r.data.messageList,...i}},a,l,o)}else{let t=[];r.data.messageList.forEach(e=>{Oe(e)||(e=new Fi(e,a,l,o),t.push(e))}),n.payload.messageList=t,n.payload.downloadKey="",n.payload.pbDownloadKey=""}return i.end(),n}).catch(e=>{throw Ce.w(`${t} failed. key:${s} error:`,e),i.setError(e).end(),e})}createMergerMessagePack(e,s,i){return e.conversationType===t.CONV_C2C?this._createC2CMergerMessagePack(e,s,i):this._createGroupMergerMessagePack(e,s,i)}_createC2CMergerMessagePack(e,i,t){let s=null;i&&(i.offlinePushInfo&&(s=i.offlinePushInfo),!0===i.onlineUserOnly)&&(s?s.disablePush=!0:s={disablePush:!0});var r=[];if(be(i)&&be(i.messageControlInfo)){let{excludedFromUnreadCount:e,excludedFromLastMessage:t,excludedFromContentModeration:s}=i.messageControlInfo;!0===e&&r.push("NoUnread"),!0===t&&r.push("NoLastMsg"),!0===s&&r.push("NoMsgCheck")}let o="";ke(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData);var{pbDownloadKey:t,downloadKey:n,messageNumber:a}=t,{title:l,abstractList:d,compatibleText:c}=e.payload,_=this._msgM.get(ys),_=_&&_.isOnlineMessage(e,i)?0:void 0;return{P:ri.SEND_C2C_MSG,data:{fromAccount:this._msgM.getMyUserID(),toAccount:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:t,downloadKey:n,title:l,abstractList:d,compatibleText:c,messageNumber:a}}],cloudCustomData:o,clientTime:e.clientTime,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:_,offlinePushInfo:Hi(s),messageControlInfo:0!==_?r:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}_createGroupMergerMessagePack(e,i,t){let s=null;i&&i.offlinePushInfo&&(s=i.offlinePushInfo);var r=[];if(be(i)&&be(i.messageControlInfo)){let{excludedFromUnreadCount:e,excludedFromLastMessage:t,excludedFromContentModeration:s}=i.messageControlInfo;!0===e&&r.push("NoUnread"),!0===t&&r.push("NoLastMsg"),!0===s&&r.push("NoMsgCheck")}let o="";ke(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData);var{pbDownloadKey:t,downloadKey:n,messageNumber:a}=t,{title:l,abstractList:d,compatibleText:c}=e.payload,_=this._msgM.get(vs),i=_&&_.isOnlineMessage(e,i)?1:0;return{P:ri.SEND_GRP_MSG,data:{fromAccount:this._msgM.getMyUserID(),groupID:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:t,downloadKey:n,title:l,abstractList:d,compatibleText:c,messageNumber:a}}],random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:void 0,cloudCustomData:o,onlineOnlyFlag:i,offlinePushInfo:Hi(s),clientTime:e.clientTime,needReadReceipt:!0!==e.needReadReceipt||_.isMessageFromOrToAVChatroom(e.to)?0:1,messageControlInfo:0==i?r:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}}let xn={ERR_SVR_COMM_SENSITIVE_TEXT:80001,ERR_SVR_COMM_BODY_SIZE_LIMIT:80002,OPEN_SERVICE_OVERLOAD_ERROR:60022,ERR_SVR_MSG_PKG_PARSE_FAILED:20001,ERR_SVR_MSG_INTERNAL_AUTH_FAILED:20002,ERR_SVR_MSG_INVALID_ID:20003,ERR_SVR_MSG_PUSH_DENY:20006,ERR_SVR_MSG_IN_PEER_BLACKLIST:20007,ERR_SVR_MSG_BOTH_NOT_FRIEND:20009,ERR_SVR_MSG_NOT_PEER_FRIEND:20010,ERR_SVR_MSG_NOT_SELF_FRIEND:20011,ERR_SVR_MSG_SHUTUP_DENY:20012,ERR_SVR_GROUP_INVALID_PARAMETERS:10004,ERR_SVR_GROUP_PERMISSION_DENY:10007,ERR_SVR_GROUP_NOT_FOUND:10010,ERR_SVR_GROUP_INVALID_GROUPID:10015,ERR_SVR_GROUP_REJECT_FROM_THIRDPARTY:10016,ERR_SVR_GROUP_SHUTUP_DENY:10017,MSG_SEND_FAIL:2100,OVER_FREQUENCY_LIMIT:2996},Vn=[ei.MSG_ONPROGRESS_ERR,ei.MSG_I_SELECT_F_FIRST,ei.MSG_I_TYPES_LIMIT,ei.MSG_F_IS_EMPTY,ei.MSG_I_SIZE_LIMIT,ei.MSG_F_SELECT_F_FIRST,ei.MSG_F_SIZE_LIMIT,ei.MSG_V_SIZE_LIMIT,ei.MSG_V_TYPES_LIMIT,ei.MSG_A_UPLOAD_FAIL,ei.MSG_A_SIZE_LIMIT,ei.COS_UNDETECTED];function Bn(e){let t=!1;return Object.values(xn).includes(e)&&(t=!0),t=120001<=e&&e<=13e4||10100<=e&&e<=10200?!0:t}class Kn extends oi{constructor(e){super(e),this._n="MessageModule",this._messageOptionsMap=new Map,this._mergerMessageHandler=new qn(this)}createTextMessage(e){var t=this.getMyUserID(),s=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new xi(e)),e=ke(e.payload)?e.payload:e.payload.text,e=new yi({text:e}),t=this._getNickAndAvatarByUserID(t);return s.setElement(e),s.setNickAndAvatar(t),s.setNameCard(this._getNameCardByGroupID(s)),s}createImageMessage(i){let e=this.getMyUserID(),t=(i.currentUser=e,i.senderTinyID=this.getMyTinyID(),new xi(i));if(k){let e=i.payload["file"];if(Ue(e))return void this.warn("FileUnsupportedInMP","createImageMessage");let t=e.tempFiles[0].path||e.tempFiles[0].tempFilePath,s={url:t,name:t.slice(t.lastIndexOf("/")+1),size:e.tempFiles&&e.tempFiles[0].size||1,type:t.slice(t.lastIndexOf(".")+1).toLowerCase()};i.payload.file=s}else if(b){let e=i.payload["file"],t={url:e.uri,name:e.fileName,size:e.fileSize||1,type:e.type,width:e.width,height:e.height};i.payload.file=t}else if(F)if(Ue(i.payload.file)){let e=i.payload.file;i.payload.file={files:[e]}}else if(be(i.payload.file)&&"undefined"!=typeof uni){let e=i.payload.file.tempFiles[0];i.payload.file={files:[e]}}let s=new Ri({imageFormat:Te.UNKNOWN,uuid:this._generateUUID(i.payload.file),file:i.payload.file},this.getFileDownloadProxy(),this.getDownloadFileAuthKey(),wn),r=this._getNickAndAvatarByUserID(e);return t.setElement(s),t.setNickAndAvatar(r),t.setNameCard(this._getNameCardByGroupID(t)),this._messageOptionsMap.set(t.clientSequence,i),t}createAudioMessage(t){var s=t.payload["file"];if(k){let e={url:s.tempFilePath,name:s.tempFilePath.slice(s.tempFilePath.lastIndexOf("/")+1),size:s.fileSize,second:parseInt(s.duration)/1e3,type:s.tempFilePath.slice(s.tempFilePath.lastIndexOf(".")+1).toLowerCase()};t.payload.file=e}if(b){let e={url:s.uri,name:s.uri.slice(s.uri.lastIndexOf("/")+1),size:s.fileSize||1,second:Math.floor(s.duration/1e3),type:s.uri.slice(s.uri.lastIndexOf(".")+1).toLowerCase()};t.payload.file=e,Oe(s.uri)&&this.warn("VoiceFileInRN")}let e=this.getMyUserID();t.currentUser=e,t.senderTinyID=this.getMyTinyID();var i=new xi(t),s=new Ai({second:Math.floor(s.duration/1e3),size:s.fileSize||s.size||1,url:s.tempFilePath||s.uri,uuid:this._generateUUID(t.payload.file)},this.getFileDownloadProxy(),this.getDownloadFileAuthKey(),wn),r=this._getNickAndAvatarByUserID(e);return i.setElement(s),i.setNickAndAvatar(r),i.setNameCard(this._getNameCardByGroupID(i)),this._messageOptionsMap.set(i.clientSequence,t),i}createVideoMessage(t){let e=this.getMyUserID();t.currentUser=e,t.senderTinyID=this.getMyTinyID(),t.payload.file.thumbUrl="",t.payload.file.thumbSize=0;var s={};if(k){if(O)return void this.warn("VideoUnsupportedInAlipay");if(Ue(t.payload.file))return void this.warn("FileUnsupportedInMP","createVideoMessage");let e=t.payload["file"];Fe(e.tempFiles)&&(e=e.tempFiles[0]),s.url=e.tempFilePath,s.name=e.tempFilePath.slice(e.tempFilePath.lastIndexOf("/")+1),s.size=e.size||1,s.second=e.duration||0,s.type=e.tempFilePath.slice(e.tempFilePath.lastIndexOf(".")+1).toLowerCase()}else if(b){let e=t.payload["file"];s.url=e.uri,s.name=e.fileName,s.size=e.fileSize||1,s.second=e.duration||0,s.type=e.type.split("/")[1]}else if(F){if(Ue(t.payload.file)){let e=t.payload.file;t.payload.file.files=[e]}else if(be(t.payload.file)&&"undefined"!=typeof uni){let e=t.payload.file.tempFile;t.payload.file.files=[e]}let e=t.payload["file"];s.url=window.URL.createObjectURL(e.files[0]),s.name=e.files[0].name,s.size=e.files[0].size||1,s.second=e.files[0].duration||0,s.type=e.files[0].type.split("/")[1]}t.payload.file.videoFile=s;var i=new xi(t),s=new wi({videoFormat:s.type,videoSecond:Mt(s.second,0),videoSize:s.size,remoteVideoUrl:"",videoUrl:s.url,videoUUID:this._generateUUID(t.payload.file.videoFile),thumbUUID:this._generateUUID(t.payload.file.videoFile),thumbWidth:t.payload.file.width||200,thumbHeight:t.payload.file.height||200,thumbUrl:t.payload.file.thumbUrl,thumbSize:t.payload.file.thumbSize,thumbFormat:t.payload.file.thumbUrl.slice(t.payload.file.thumbUrl.lastIndexOf(".")+1).toLowerCase()},this.getFileDownloadProxy(),this.getDownloadFileAuthKey(),wn),r=this._getNickAndAvatarByUserID(e);return i.setElement(s),i.setNickAndAvatar(r),i.setNameCard(this._getNameCardByGroupID(i)),this._messageOptionsMap.set(i.clientSequence,t),i}createCustomMessage(e){var t=this.getMyUserID(),s=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new xi(e)),e=new ki({data:e.payload.data,description:e.payload.description,extension:e.payload.extension}),t=this._getNickAndAvatarByUserID(t);return s.setElement(e),s.setNickAndAvatar(t),s.setNameCard(this._getNameCardByGroupID(s)),s}createFaceMessage(e){var t=this.getMyUserID(),s=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new xi(e)),e=new Li(e.payload),t=this._getNickAndAvatarByUserID(t);return s.setElement(e),s.setNickAndAvatar(t),s.setNameCard(this._getNameCardByGroupID(s)),s}createMergerMessage(e){var t=this.getMyUserID(),t=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),this._getNickAndAvatarByUserID(t)),s=new xi(e),e=new $i(e.payload);return s.setElement(e),s.setNickAndAvatar(t),s.setNameCard(this._getNameCardByGroupID(s)),s.setRelayFlag(!0),s}createForwardMessage(e){var s,i,{to:r,conversationType:o,priority:n,payload:a,needReadReceipt:l,receiverList:d}=e;return Fe(a._elements)?(s=this.getMyUserID(),i=this._getNickAndAvatarByUserID(s),a.type===t.MSG_GRP_TIP?ni({code:ei.MSG_FORWARD_TYPE_INVALID}):(o={to:r,conversationType:o,conversationID:""+o+r,priority:n,isPlaceMessage:0,status:Ot,currentUser:s,senderTinyID:this.getMyTinyID(),cloudCustomData:e.cloudCustomData||a.cloudCustomData||"",needReadReceipt:l,receiverList:d,isSupportExtension:e.isSupportExtension||!1},(r=new xi(o)).setElement(a._elements[0]),r.setNickAndAvatar(i),r.setNameCard(this._getNameCardByGroupID(a)),r.setRelayFlag(!0),r)):ni({code:ei.MSG_FORWARD_INVALID_ELEMENTS})}downloadMergerMessage(e){return this._mergerMessageHandler.downloadMergerMessage(e)}createFileMessage(i){if(k){if(!S&&!R&&!P)return;let e,t=$.getSystemInfoSync().SDKVersion;if(S&&pt(t,e="2.5.0")<0)return void this.warn("WXChooseMessageFile");if(R&&pt(t,e="1.18.0")<0)return void this.warn("QQChooseMessageFile")}if(F||P){if(Ue(i.payload.file)){let e=i.payload.file;i.payload.file={files:[e]}}else if(be(i.payload.file)&&"undefined"!=typeof uni){let{tempFiles:e,files:t}=i.payload.file,s=null;Fe(e)?s=e[0]:Fe(t)&&(s=t[0]),i.payload.file={files:[s]}}}else if(S||R){let e=i.payload.file["tempFiles"],t={...e[0],url:e[0].path};i.payload.file={files:[t]}}else if(b){let e=i.payload["file"],t={...e,url:e.uri};i.payload.file={files:[t]}}let e=this.getMyUserID(),t=(i.currentUser=e,i.senderTinyID=this.getMyTinyID(),new xi(i)),s=new Gi({uuid:this._generateUUID(i.payload.file),file:i.payload.file}),r=this._getNickAndAvatarByUserID(e);return t.setElement(s),t.setNickAndAvatar(r),t.setNameCard(this._getNameCardByGroupID(t)),this._messageOptionsMap.set(t.clientSequence,i),t}createLocationMessage(e){var t=this.getMyUserID(),s=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new xi(e)),e=new bi(e.payload),t=this._getNickAndAvatarByUserID(t);return s.setElement(e),s.setNickAndAvatar(t),s.setNameCard(this._getNameCardByGroupID(s)),s}_onNoModule(){return ni({code:ei.NO_MODULE})}sendMessageInstance(n,a){if(!1===this.get(Vs).filterMessage(n,a))return n.hasRiskContent=!0,this._onSendMessageFailed(n,new Qs({code:ei.PROFANITY_FOUND}));let s=null;if(n.conversationType===t.CONV_C2C)s=this.get(ys);else{if(n.conversationType!==t.CONV_GROUP)return ni({code:ei.MSG_INVALID_CONV_TYPE});s=this.get(vs)}if(!s)return this._onNoModule();let l=this._n+".sendMessageInstance",d=this.get(Ds),c=s.isOnlineMessage(n,a),_;return this.get(Ns).upload(n).then(()=>(this._getSendMessageSpecifiedKey(n)===_i&&this.get($s).addSuccessCount(hi),this._guardForGroup(n).then(()=>{if(!n.isSendable())return ni({code:ei.MSG_F_URL_IS_EMPTY});this._addSendMessageTotalCount(n),_=Date.now();var e=function(t){let e="utf-8";F&&document&&(e=document.charset.toLowerCase());let s,i=0,r;if(r=t.length,"utf-8"===e||"utf8"===e)for(let e=0;e<r;e++)(s=t.codePointAt(e))<=127?i+=1:s<=2047?i+=2:s<=65535?i+=3:(i+=4,e++);else if("utf-16"===e||"utf16"===e)for(let e=0;e<r;e++)(s=t.codePointAt(e))<=65535?i+=2:(i+=4,e++);else i=t.replace(/[^\x00-\xff]/g,"aa").length;return i}(JSON.stringify(n));return n.type===t.MSG_MERGER&&11264<e?this._mergerMessageHandler.uploadMergerMessage(n,e).then(e=>{e=this._mergerMessageHandler.createMergerMessagePack(n,a,e);return this.req(e)}):(d.setMessageRandom(n),s.sendMessage(n,a))}).then(e=>{var{time:e,sequence:s,readReceiptCode:i,messageDropReason:r}=e.data;if(Ge(i)&&0!==i&&(new Ti("sendMessageWithReceipt").setMessage(`from:${n.from} to:${n.to} sequence:${s} readReceiptCode:`+i).end(),Ce.w(l+` readReceiptCode:${i} message:`+this.getErrMsg(i))),r){let e=new Ti("messageDropReason"),t=`from:${n.from} to:${n.to} sequence:${s} messageDropReason:`+r;e.setMessage(t).end(),Ce.w(l+" "+t)}if(this._addSendMessageSuccessCount(n,_),this._messageOptionsMap.delete(n.clientSequence),!0===n.isResend){let e=d.findMessage(n.ID);e&&(Ce.l(l+" resend ok. ID:"+e.ID),d.deleteLocalMessage(e))}n.status=Nt,n.time=e;let o=!1;if(n.conversationType===t.CONV_GROUP)n.sequence=s;else if(n.conversationType===t.CONV_C2C){let s=d.getLatestMessageSentByMe(n.conversationID);if(s){let{nick:e,avatar:t}=s;e===n.nick&&t===n.avatar||(o=!0)}}if(o&&d.modifyMessageSentByMe({conversationID:n.conversationID,latestNick:n.nick,latestAvatar:n.avatar}),!0===c)n._onlineOnlyFlag=!0;else{d.appendToMessageList(n);let e=n,s=(be(a)&&be(a.messageControlInfo)&&(!0===a.messageControlInfo.excludedFromLastMessage&&(n._isExcludedFromLastMessage=!0,e=""),!0===a.messageControlInfo.excludedFromUnreadCount)&&(n._isExcludedFromUnreadCount=!0),n.conversationType);rt(n.to)&&(s=t.CONV_TOPIC,this.get(Ss).onMessageSent({groupID:Tt(n.to),topicID:n.to,lastMessage:e})),d.onMessageSent({conversationOptionsList:[{conversationID:n.conversationID,unreadCount:0,type:s,subType:n.conversationSubType,lastMessage:e}]})}return n._relayFlag||"TIMImageElem"!==n.type||mt(n.payload.imageInfoArray),Zs({message:n})}))).catch(e=>this._onSendMessageFailed(n,e,c))}_guardForGroup(s){if(s.conversationType!==t.CONV_GROUP)return Promise.resolve();var i=this.get(vs);if(!i)return this._onNoModule();if(ot({groupID:s.to})){let e=i.getLocalGroupProfile(s.to);if(e&&e.isSupportTopic)return ni({code:ei.MSG_SEND_GRP_WITH_TOPIC_FAIL})}return i.guardForAVChatRoom(s)}_onSendMessageFailed(e,t,s=!1){var i=this._n+"._onSendMessageFailed",r=(e.status=Pt,80001!==t.code&&80004!==t.code||(e.hasRiskContent=!0),this.get(Ds)),o=(r.deleteMessageRandom(e),10100<=t.code&&t.code<=10200||120001<=t.code&&t.code<=13e4),s=(s||o||!0===r.appendToMessageList(e)&&Ce.l(i+" message stored, ID:"+e.ID),this._addSendMessageFailCountOnUser(e,t),new Ti("sendMessage"));let n=`head.seq:${t.data.headSeq} type:${e.type} from:${e.from} to:`+e.to;if(F){if("connection"in navigator){let e=navigator.connection;n+=` downlink:${e.downlink} effectiveType:${e.effectiveType} rtt:`+e.rtt}if("memory"in window.performance){let e=window.performance.memory;n+=` usedJSHeapSize:${e.usedJSHeapSize} totalJSHeapSize:${e.totalJSHeapSize} jsHeapSizeLimit:`+e.jsHeapSizeLimit}}return s.setMessage(n).setError(t).end(),Ce.e(i+` ${n} error:`,t),ni(new Qs({code:t&&t.code?t.code:ei.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}_getSendMessageSpecifiedKey(s){if([t.MSG_IMAGE,t.MSG_AUDIO,t.MSG_VIDEO,t.MSG_FILE].includes(s.type))return _i;if(s.conversationType===t.CONV_C2C)return li;if(s.conversationType===t.CONV_GROUP){let e=this.get(vs);if(e){var s=e.getLocalGroupProfile(s.to);if(s)return s=s.type,nt(s)?di:ui}}}_addSendMessageTotalCount(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get($s).addTotalCount(e)}_addSendMessageSuccessCount(e,t){var s=this._getSendMessageSpecifiedKey(e);if(s){let e=this.get($s);e.addSuccessCount(s),e.addCost(s,Dt(t,!1))}}_addSendMessageFailCountOnUser(e,t){var{code:t=-1}=t,s=this.get($s),e=this._getSendMessageSpecifiedKey(e);e===_i&&function(e){let t=!1;return t=Vn.includes(e)?!0:t}(t)?s.addFailedCountOfUserSide(hi):Bn(t)&&e&&s.addFailedCountOfUserSide(e)}resendMessage(e,t){return e.isResend=!0,e.status=Ot,this.sendMessageInstance(e,t)}revokeMessage(s){let e=null;if(s.conversationType===t.CONV_C2C?e=this.get(ys):s.conversationType===t.CONV_GROUP&&(e=this.get(vs)),!e)return this._onNoModule();let i=new Ti("revokeMessage"),r=(i.setMessage(`type:${s.type} from:${s.from} to:`+s.to),this._n+".revokeMessage");return e.revokeMessage(s).then(e=>{var t=e.data.recallRetList;if(Oe(t)||0===t[0].retCode)return Ce.i(r+" ok. ID:"+s.ID),s.isRevoked=!0,i.end(),this.get(Ds).onMessageRevoked([s]),Zs({message:s});{let e=new Qs({code:t[0].retCode,data:{message:s}});return i.setCode(e.code).setMoreMessage(e.message).end(),ni(e)}}).catch(e=>{i.setError(e).end();var t=new Qs({code:e&&e.code?e.code:ei.MSG_REVOKE_FAIL,message:e&&e.message?e.message:void 0,data:{message:s}});return Ce.w(r+" failed. error:",e),ni(t)})}deleteMessage(e){let s=null,i=e[0],r=i.conversationID,o="",n=[],a=[];if(i.conversationType===t.CONV_C2C)s=this.get(ys),o=r.replace(t.CONV_C2C,""),e.forEach(e=>{e&&e.status===Nt&&e.conversationID===r&&(e._onlineOnlyFlag||n.push(`${e.sequence}_${e.random}_`+e.time),a.push(e))});else if(i.conversationType===t.CONV_GROUP)s=this.get(vs),o=r.replace(t.CONV_GROUP,""),e.forEach(e=>{e&&e.status===Nt&&e.conversationID===r&&(e._onlineOnlyFlag||n.push(""+e.sequence),a.push(e))});else if(i.conversationType===t.CONV_SYSTEM)return ni({code:ei.CANNOT_DELETE_GRP_SYSTEM_NOTICE});if(!s)return this._onNoModule();if(0===n.length)return this._onMessageDeleted(a);30<n.length&&(n=n.slice(0,30),a=a.slice(0,30));let l=new Ti("deleteMessage"),d=(l.setMessage(`to:${o} count:`+n.length),this._n+".deleteMessage");return s.deleteMessage({to:o,keyList:n}).then(e=>(l.end(),Ce.i(d+" ok"),this._onMessageDeleted(a))).catch(e=>{l.setError(e).end(),Ce.w(d+" failed. error:",e);e=new Qs({code:e&&e.code?e.code:ei.MSG_DELETE_FAIL,message:e&&e.message?e.message:void 0});return ni(e)})}_onMessageDeleted(e){return this.get(Ds).onMessageDeleted(e),ii({messageList:e})}translateText(e){let r=this._n+".translateText",{sourceTextList:t,sourceLanguage:s,targetLanguage:i}=e,o=new Ti("translateText");return o.setMessage(`sourceLanguage:${s} targetLanguage:`+i),this.req({P:ri.TRANSLATE_TEXT,data:{sourceTextList:t,source:s||"auto",target:i,from:this.getMyTinyID(),SDKAppID:this.getSDKAppID()}}).then(e=>{var{error:e,requestID:t,translatedTextList:s}=e.data,i=e["code"];if(0===i)return o.end(),Ce.i(r+" ok. requestID:"+t),Zs({translatedTextList:s});throw{...e,requestID:t}}).catch(e=>(o.setCode(e.code).setMoreMessage(e.requestID).end(),Ce.w(r+" failed. error:",e),ni({code:ei.TRANSLATE_TEXT_FAIL})))}convertVoiceToText(e){var{message:e,language:t}=e;let s=e.payload.url;e.from===this.getMyUserID()&&"out"===e.flow&&(s=e.payload.remoteAudioUrl);e=/\.(wav|pcm|ogg-opus|speex|silk|mp3|m4a|aac|amr)/;if(!e.test(s))return ni({code:ei.UNSUPPORTED_VOICE_FORMAT});e=e.exec(s)[1]||"mp3";let i="16k_zh-PY",r=(t?"zh (cmn-Hans-CN)"===t?i="16k_zh":"en-US"===t?i="16k_en":"yue-Hant-HK"===t?i="16k_yue":"ja-JP"===t&&(i="16k_ja"):i="16k_zh-PY",`serviceType:${i} url:`+s),o=this._n+".convertVoiceToText",n=(Ce.i(o+" "+r),new Ti("convertVoiceToText"));return n.setMessage(r),this.req({P:ri.VOICE_TO_TEXT,data:{url:s,language:i,SDKAppID:this.getSDKAppID(),format:e}}).then(e=>{var{error:e,requestID:t,result:s}=e.data,i=e["code"];if(0===i)return n.end(),Ce.i(o+" ok. requestID:"+t),Zs({result:s});throw{...e,requestID:t}}).catch(e=>(n.setCode(e.code).setMoreMessage(e.requestID||"").end(),Ce.w(o+" failed. error:",e),ni({code:ei.VOICE_TO_TEXT_FAIL})))}modifyRemoteMessage(s){if(!1===this.get(Vs).filterMessage(s))return s.hasRiskContent=!0,ni({code:ei.PROFANITY_FOUND,data:{message:s}});let e=null;var{conversationType:i,to:r}=s;if(i===t.CONV_C2C)e=this.get(ys);else if(i===t.CONV_GROUP){if(!(e=this.get(vs)))return this._onNoModule();if(e.isMessageFromOrToAVChatroom(r))return ni({code:ei.MSG_MODIFY_DISABLED_IN_AV,data:{message:s}})}let o=new Ti("modifyMessage"),n=(o.setMessage("to:"+r),this._n+".modifyRemoteMessage");return e.modifyRemoteMessage(s).then(e=>{o.end(),Ce.i(n+" ok");e=this._onModifyRemoteMessageResp(s,e.data);return Zs({message:e})}).catch(e=>{var t;return o.setCode(e.code).setMoreMessage(e.message).end(),Ce.w(n+" failed. error:",e),20027===e.code?(t=this._onModifyRemoteMessageResp(s,e.data),ni({code:ei.MSG_MODIFY_CONFLICT,data:{message:t}})):ni({code:e.code,message:e.message,data:{message:s}})})}_onModifyRemoteMessageResp(e,t){Ce.d(this._n+"._onModifyRemoteMessageResp options:",t);var{conversationType:e,from:s,to:i,random:r,sequence:o,time:n}=e,{elements:t,messageVersion:a,cloudCustomData:l=""}=t;return this.get(Ds).onMessageModified({conversationType:e,from:s,to:i,time:n,random:r,sequence:o,elements:t,cloudCustomData:l,messageVersion:a})}_generateUUID(e){var t=this.get(Rs);let s=`${t.getSDKAppID()}-${t.getUserID()}-`+function(){let t="";for(let e=32;0<e;--e)t+=Je[Math.floor(Math.random()*Xe)];return t}();t=e.name||e.value||e.url||e.tempFilePath,e=t&&t.slice(t.lastIndexOf(".")+1);return s=e?s+"."+e:s}getMessageOption(e){return this._messageOptionsMap.get(e)}_getNickAndAvatarByUserID(e){return this.get(Ts).getNickAndAvatarByUserID(e)}_getNameCardByGroupID(s){if(s.conversationType===t.CONV_GROUP){let e=this.get(vs);if(e)return e.getMyNameCardByGroupID(s.to)}return""}reset(){Ce.l(this._n+".reset"),this._messageOptionsMap.clear()}}class Hn extends oi{constructor(e){super(e),this._n="MsgExtModule",this.msgExtMap=new Map,this.globalSeqMap=new Map,this.getMsgExtsMap=new Map}onMsgExtNotify(t){let{messageInfo:s,operateType:i,operateResultList:r,tinyID:o,globalSequence:n}=t.dataList,{clientTime:a,random:l}=s,d=o+`-${a}-`+l,c=[],_=[],u=(Ce.l(`${this._n}.onMsgExtNotify messageID:${d} operateType:${i} globalSequence:`+n),this._updateGlobalSeq(d,n),!1),h=!1;r.forEach(e=>{let{extensions:t=[],clearSequence:s}=e;1===i?(u=!0,t.forEach(e=>{c.push({key:e.key,value:e.value})}),this._updateLocalExt(d,t)):2===i?(h=!0,t.forEach(e=>{_.push(e.key)}),this._updateLocalExt(d,t)):3===i&&(h=!0,this._hasLocalExt(d)&&this._getLocalExt(d).forEach((e,t)=>{e.seq<=s&&!Oe(e.value)&&_.push(t)}),this._clearLocalExt(d,s))}),u&&this.emitOEvt(e.MESSAGE_EXTENSIONS_UPDATED,{messageID:d,extensions:c}),h&&this.emitOEvt(e.MESSAGE_EXTENSIONS_DELETED,{messageID:d,keyList:_})}setMessageExtensions(e,t){var s="setMessageExtensions";if(!this.canIUse(M.MSG_EXT))return this.noUse(s);let i=this._n+"."+s,{ID:r,conversationID:o,sequence:n,time:a}=e,l=[...t],d=(20<t.length&&(l=t.slice(0,20),Ce.w(i+". the length of extensions cannot exceed 20.")),`convID:${o} messageID:${r} sequence:${n} time:${a} count:`+l.length),c=new Ti(s);return c.setMessage(d),Ce.l(i+" "+d),this._modifyMsgExts(e,l).then(e=>{var{resultList:e,successCount:t,failureCount:s}=e,t=`successCount:${t} failCount:`+s;return c.setMoreMessage(t).end(),Ce.l(i+" ok. "+t),Zs({extensions:e})}).catch(e=>(c.setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)))}getMessageExtensions(e){var t="getMessageExtensions";if(!this.canIUse(M.MSG_EXT))return this.noUse(t);let s=this._n+"."+t,{ID:i,conversationID:r,sequence:o,time:n}=e,a=`convID:${r} messageID:${i} sequence:${o} time:`+n,l=new Ti(t),d=(l.setMessage(a),Ce.l(s+" "+a),void 0);return this.getMsgExtsMap.has(i)&&(d=this._getGlobalSeq(i)),this._getMsgExts(e,d).then(e=>(l.end(),Ce.l(s+" ok. extCount:"+e.length),$e(d)&&0<e.length&&this.getMsgExtsMap.set(i,1),Zs({extensions:e}))).catch(e=>(l.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}deleteMessageExtensions(e,t){var s="deleteMessageExtensions";if(!this.canIUse(M.MSG_EXT))return this.noUse(s);let r=this._n+"."+s,i=[],o=3,{ID:n,conversationID:a,sequence:l,time:d}=(Oe(t)||(o=2,t.forEach(e=>{i.push({key:e,value:"",seq:0})})),e),c=`convID:${a} messageID:${n} sequence:${l} time:${d} operateType:`+o,_=new Ti(s);return _.setMessage(c),Ce.l(r+" "+c),this._modifyMsgExts(e,i,o).then(e=>{var{resultList:e,successCount:t,failureCount:s}=e;let i="";return 2===o&&(i=`success count:${t} fail count:`+s),_.setMoreMessage(""+i).end(),Ce.l(r+" ok. "+i),Zs({extensions:e})}).catch(e=>(_.setError(e).end(),Ce.e(r+" failed. error:",e),ni(e)))}_modifyMsgExts(s,e,i=1){var r=rt(s.to)?t.CONV_TOPIC:s.conversationType;let o=void 0,n=(3!==i&&(o=this._getReqExts(s,e)),null);switch(r){case t.CONV_C2C:n=this.get(ys);break;case t.CONV_GROUP:n=this.get(vs);break;case t.CONV_TOPIC:n=this.get(Ss);break;default:return ni({code:ei.NO_MODULE})}return n.modifyMsgExts(s,o,i).then(e=>{var{extensions:e,seq:t}=e.data;let r=[],o=0,n=0,a=[];return(e=Oe(e)?[]:e).forEach(e=>{var{errorCode:e,extension:t}=e,{key:t,value:s,seq:i}=t;r.push({code:e,key:t,value:s}),0===e?o++:n++,a.push({key:t,value:s,seq:i})}),this._updateGlobalSeq(s.ID,t),0<a.length&&(this._updateLocalExt(s.ID,a),a=null),{resultList:r,successCount:o,failureCount:n}}).catch(e=>ni(e))}_getReqExts(e,t){let r=[];if(this._hasLocalExt(e.ID)){let i=this._getLocalExt(e.ID);t.forEach(e=>{var{key:e,value:t}=e;let s=0;i.has(e)&&(s=i.get(e).seq),r.push({key:e,value:t,seq:s})})}else t.forEach(e=>{var{key:e,value:t}=e;r.push({key:e,value:t,seq:0})});return r}_getMsgExts(r,e){let o=this._n+"._getMsgExts",{ID:n,to:s}=r,i=null;switch(rt(s)?t.CONV_TOPIC:r.conversationType){case t.CONV_C2C:i=this.get(ys);break;case t.CONV_GROUP:i=this.get(vs);break;case t.CONV_TOPIC:i=this.get(Ss);break;default:return ni({code:ei.NO_MODULE})}return i.getMessageExtensions(r,e).then(e=>{var{extensions:t,completeFlag:e,globalSequence:s,clearSequence:i}=e.data,t=Oe(t)?[]:t;if(Ce.l(o+` ok. completeFlag:${e} globalSequence:${s} clearSequence:${i} count:`+t.length),this._updateLocalExt(n,t),this._clearLocalExt(n,i),this._updateGlobalSeq(n,s),1===e)return this._getLocalExtList(n);{let e=t.slice(-1)[0].seq+1;return this._getMsgExts(r,e)}}).catch(e=>ni(e))}_hasLocalExt(e){return this.msgExtMap.has(e)}_getLocalExt(e){return this.msgExtMap.get(e)}_updateLocalExt(e,t){this._hasLocalExt(e)||this.msgExtMap.set(e,new Map);let i=this._getLocalExt(e);t.forEach(e=>{var{key:e,value:t="",seq:s}=e;i.set(e,{value:t,seq:s})})}_clearLocalExt(e,i){if(!(i<=0)&&this._hasLocalExt(e)){let s=this._getLocalExt(e);s.forEach((e,t)=>{e.seq<=i&&s.delete(t)})}}_getLocalExtList(e){let s=[];return this._hasLocalExt(e)&&this._getLocalExt(e).forEach((e,t)=>{e=e.value;Oe(e)||s.push({key:t,value:e})}),s}_getGlobalSeq(e){return this.globalSeqMap.get(e)}_updateGlobalSeq(e,t){this.globalSeqMap.set(e,t)}reset(){Ce.l(this._n+".reset"),this.msgExtMap.clear(),this.globalSeqMap.clear(),this.getMsgExtsMap.clear()}}class Wn extends oi{constructor(e){super(e),this._n="MsgReactionModule",this._reactedByMyselfMap=new Map,this._reactionInfoMap=new Map}onReactionNotifyList(t){var{dataList:t=[]}=t||{};t.forEach(t=>{let{C2CMessageInfo:s={},groupMessageInfo:i={},reactionList:r=[]}=t,{tinyID:o,clientTime:n,random:a}={...s,...i},l=o+`-${n}-`+a,d=[];r.forEach(e=>{$e(e.userIDList)&&(e.userIDList=[],e.count=0),d.push(...e.userIDList)}),Ce.l(this._n+`.onReactionNotifyList messageID:${l} reactionList:`+r.length),this._handleReactionSummary([{messageID:l,reactionList:r}],d).then(t=>{this.emitOEvt(e.MESSAGE_REACTIONS_UPDATED,{...t[0]})})})}onReactionNotify(t){var{C2CMessageInfo:t={},groupMessageInfo:s={},reactionID:i,operateType:r}=t.dataList||{},{tinyID:t,clientTime:s,random:o}={...t,...s},s=t+`-${s}-`+o,o=(Ce.l(this._n+`.onReactionNotify messageID:${s} reactionID:${i} operateType:`+r),1===r?this._addReactedByMyselfMap(s,i):this._removeReactedByMyselfMap(s,i),s+"-"+i);if(this._reactionInfoMap.has(o)){let t=this._reactionInfoMap.get(o);t.reactedByMyself=1===r,this.emitOEvt(e.MESSAGE_REACTIONS_UPDATED,{messageID:s,reactionList:[t]})}}addMessageReaction(t,s){var e="addMessageReaction";if(!this.canIUse(M.MSG_REACTION))return this.noUse(e);let i=this._n+"."+e,{ID:r,conversationID:o}=t,n=`convID:${o} messageID:${r} reactionID:`+s,a=new Ti(e);a.setMessage(n),Ce.l(i+" "+n);e=this._createReactionOperationPack(t,s,1);return this._addReactedByMyselfMap(t.ID,s),this.req(e).then(()=>(a.end(),Ce.l(i+" ok."),Zs())).catch(e=>(this._removeReactedByMyselfMap(t.ID,s),a.setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)))}removeMessageReaction(e,t){var s="removeMessageReaction";if(!this.canIUse(M.MSG_REACTION))return this.noUse(s);let i=this._n+"."+s,{ID:r,conversationID:o}=e,n=`convID:${o} messageID:${r} reactionID:`+t,a=new Ti(s);a.setMessage(n),Ce.l(i+" "+n);s=this._createReactionOperationPack(e,t,2);return this._removeReactedByMyselfMap(e.ID,t),this.req(s).then(()=>(a.end(),Ce.l(i+" ok."),Zs())).catch(e=>(a.setError(e).end(),Ce.e(i+" failed. error:",e),ni(e)))}getMessageReactions(e){var t="getMessageReactions";if(!this.canIUse(M.MSG_REACTION))return this.noUse(t);let s=this._n+"."+t,{messageList:i,maxUserCountPerReaction:r}=e,o=i[0]["conversationID"],n=`convID:${o} maxUserCountPerReaction:${r} msgCount:`+i.length,a=new Ti(t),l=(a.setMessage(n),Ce.l(s+" "+n),new Map),d=this._createReactionSummaryPack({...e,messageIDMap:l});return this.req(d).then(e=>{let{resultList:t=[]}=e.data,i=[],r=[];return t.forEach(e=>{var{messageKey:e,messageSequence:t,reactionList:s=[]}=e,t=$e(e)?l.get(t):l.get(e);i.push({messageID:t,reactionList:s}),s.forEach(e=>{r.push(...e.userIDList)})}),this._handleReactionSummary(i,r)}).then(e=>(a.end(),Ce.l(s+" ok."),l.clear(),Zs({resultList:e}))).catch(e=>(a.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}getAllUserListOfMessageReaction(e){var t="getAllUserListOfMessageReaction";if(!this.canIUse(M.MSG_REACTION))return this.noUse(t);let s=this._n+"."+t,{message:i,reactionID:r,nextSeq:o,count:n}=e,{ID:a,conversationID:l}=i,d=`convID:${l} messageID:${a} reactionID:${r} nextSeq:${o} count:`+n,c=new Ti(t),_=(c.setMessage(d),Ce.l(s+" "+d),{userList:[],nextSeq:0,isCompleted:!1}),u=this._createReactionUserListPack(e);return this.req(u).then(e=>{var{userIDList:e=[],nextSeq:t=0}=e.data;return _.nextSeq=t,_.isCompleted=0===t,this.get(Ts).getUserNickAndAvatar(e)}).then(e=>(_.userList=e,c.end(),Ce.l(s+" ok."),Zs(_))).catch(e=>(c.setError(e).end(),Ce.e(s+" failed. error:",e),ni(e)))}_createReactionOperationPack(s,i,r){let o=void 0;i={reactionID:i,userIDList:[this.getMyUserID()]};if(s.conversationType===t.CONV_C2C){let e=this.get(ys);o=1===r?ri.ADD_C2C_MSG_REACTION:ri.RM_C2C_MSG_REACTION,i.from=s.from,i.to=s.to,i.messageKey=e.getMessageKey(s)}if(s.conversationType===t.CONV_GROUP){let e=void 0,t=s.to;rt(s.to)&&(e=s.to,t=Tt(e)),o=1===r?ri.ADD_GRP_MSG_REACTION:ri.RM_GRP_MSG_REACTION,i.groupID=t,i.topicID=e,i.messageSequence=s.sequence}return{P:o,data:i}}_createReactionSummaryPack(s){let{messageList:i,maxUserCountPerReaction:r=10,messageIDMap:o}=s,n=i[0],a=void 0,l=void 0;if(n.conversationType===t.CONV_C2C){let s=this.get(ys),e=i.map(e=>{var t=s.getMessageKey(e);return o.set(t,e.ID),t});a=ri.GET_C2C_MSG_REACTIONS,l={from:n.from,to:n.to,messageKeyList:e,count:r}}if(n.conversationType===t.CONV_GROUP){let e=void 0,t=n.to;rt(n.to)&&(e=n.to,t=Tt(e));s=i.map(e=>(o.set(e.sequence,e.ID),e.sequence));a=ri.GET_GRP_MSG_REACTIONS,l={groupID:t,topicID:e,messageSequenceList:s,count:r}}return{P:a,data:l}}_createReactionUserListPack(e){var{message:s,reactionID:e,nextSeq:i=0,count:r=100}=e;let o=void 0;i={reactionID:e,nextSeq:i,count:100<r?100:r};if(s.conversationType===t.CONV_C2C){let e=this.get(ys);o=ri.GET_C2C_MSG_REACTION_USER_LIST,i.from=s.from,i.to=s.to,i.messageKey=e.getMessageKey(s)}if(s.conversationType===t.CONV_GROUP){let e=void 0,t=s.to;rt(s.to)&&(e=s.to,t=Tt(e)),o=ri.GET_GRP_MSG_REACTION_USER_LIST,i.groupID=t,i.topicID=e,i.messageSequence=s.sequence}return{P:o,data:i}}_handleReactionSummary(t,e){return this.get(Ts).getUserNickAndAvatar(e).then(l=>{let e=[];return t.forEach(n=>{let a=[];n.reactionList.forEach(t=>{let{reactionID:s,count:e,userIDList:i,reactedByMyself:r}=t,o=[];i.forEach(t=>{l.forEach(e=>{t===e.userID&&o.push(e)})});t={reactionID:s,totalUserCount:e,partialUserList:o,reactedByMyself:this._computeReactedByMyself({reactedByMyself:r,messageID:n.messageID,reactionID:s})};if(a.push(t),$e(r)&&!this._reactedByMyselfMap.has(n.messageID)){let e=n.messageID+"-"+s;this._reactionInfoMap.set(e,t)}}),e.push({messageID:n.messageID,reactionList:a})}),e})}_addReactedByMyselfMap(e,t){this._reactedByMyselfMap.has(e)||this._reactedByMyselfMap.set(e,[]);e=this._reactedByMyselfMap.get(e);-1===e.indexOf(t)&&e.push(t)}_removeReactedByMyselfMap(e,t){this._reactedByMyselfMap.has(e)&&-1<(t=(e=this._reactedByMyselfMap.get(e)).indexOf(t))&&e.splice(t,1)}_computeReactedByMyself({reactedByMyself:e,messageID:t,reactionID:s}){return $e(e)?!!this._reactedByMyselfMap.has(t)&&this._reactedByMyselfMap.get(t).includes(s):1===e}reset(){Ce.l(this._n+".reset"),this._reactedByMyselfMap.clear(),this._reactionInfoMap.clear()}}class Yn extends oi{constructor(e){super(e),this._n="ComboMsgModule"}sendMessage(e){let o=this._createMsg(e);if(null===o)return ni({code:ei.MSG_SEND_FAIL});this._addSendMessageTotalCount(o);let n=Date.now();return this.get(Ds).setMessageRandom(o),this._sendComboMessage(o,e).then(e=>{var{time:e,sequence:s,readReceiptCode:i}=e.data,i=(Ge(i)&&0!==i&&(new Ti("sendMessageWithReceipt").setMessage(`from:${o.from} to:${o.to} sequence:${s} readReceiptCode:`+i).end(),Ce.w(this._n+`.sendMessage readReceiptCode:${i} message:`+this.getErrMsg(i))),this._addSendMessageSuccessCount(o,n),this.get(Ds));o.status=Nt,o.time=e,o.conversationType===t.CONV_GROUP&&(o.sequence=s),i.appendToMessageList(o);let r=o;return!0===o._isExcludedFromLastMessage&&(r=""),i.onMessageSent({conversationOptionsList:[{conversationID:o.conversationID,unreadCount:0,type:o.conversationType,subType:o.conversationSubType,lastMessage:r}]}),Zs({message:o})}).catch(e=>this._onSendMessageFailed(o,e))}_sendComboMessage(e,s){var i=this._m.get(Gs);let r="";return e.conversationType===t.CONV_C2C&&(r=f.NAME.OPEN_IM+"."+ri.SEND_C2C_MSG),e.conversationType===t.CONV_GROUP&&(r=f.NAME.GRP+"."+ri.SEND_GRP_MSG),i.sendComboMessage({servcmd:r,data:s})}_createMsg(s){var i=this._n+"._createMsg";let r=null;try{var e=this.getMyUserID(),o={};if(o.senderTinyID=this.getMyTinyID(),o.currentUser=e,o.from=s.From_Account||e,s.GroupId?(o.conversationID=""+t.CONV_GROUP+s.GroupId,o.conversationType=t.CONV_GROUP,o.to=s.GroupId):s.To_Account&&(o.conversationID=""+t.CONV_C2C+s.To_Account,o.conversationType=t.CONV_C2C,o.to=s.To_Account),o.time=s.MsgTimeStamp||0,o.random=s.Random||s.MsgRandom||0,o.priority=s.MsgPriority,ke(s.CloudCustomData)&&0<s.CloudCustomData.length&&(o.cloudCustomData=s.CloudCustomData),Fe(s.SendMsgControl)&&(o.messageControlInfo={},s.SendMsgControl.includes("NoUnread")&&(o.messageControlInfo.excludedFromUnreadCount=1),s.SendMsgControl.includes("NoLastMsg"))&&(o.messageControlInfo.excludedFromLastMessage=1),o.conversationType===t.CONV_GROUP&&Fe(s.To_Account)&&0<s.To_Account.length){let e=s.To_Account;50<s.To_Account.length&&(e=s.To_Account.slice(0,50),Ce.w(i+" To_Account must be less than or equal to 50.")),o.receiverList=[...e],s.To_Account=[...e]}1!==s.IsNeedReadReceipt&&1!==s.NeedReadReceipt||(o.needReadReceipt=!0),1===s.SupportMessageExtension&&(o.isSupportExtension=!0),(r=new xi(o)).status=Ot,s.MsgClientTime=r.clientTime,r.conversationType===t.CONV_C2C&&(s.MsgSeq=r.sequence);var n,a=s.MsgBody.length;for(let e=0;e<a;e++)"TIMTextElem"===(n=s.MsgBody[e]).MsgType?r.setTextElement(n.MsgContent.Text):"TIMCustomElem"===n.MsgType?r.setCustomElement({data:n.MsgContent.Data||"",description:n.MsgContent.Desc||"",extension:n.MsgContent.Ext||""}):"TIMFaceElem"===n.MsgType&&r.setFaceElement({index:n.MsgContent.Index,data:n.MsgContent.Data});var l=r.getElements();r.payload=l[0].content,r.type=l[0].type}catch(e){r=null,Ce.e(i+" failed. error:",e)}return r}_onSendMessageFailed(e,t){e.status=Pt,this.get(Ds).deleteMessageRandom(e),this._addSendMessageFailCountOnUser(e,t);var s=new Ti("sendMessage"),i=`head.seq:${t.data.headSeq}  type:${e.type} from:${e.from} to:`+e.to;return s.setMessage(i).setError(t).end(),Ce.e(this._n+`._onSendMessageFailed ${i} error:`,t),ni(new Qs({code:t&&t.code?t.code:ei.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}_getSendMessageSpecifiedKey(s){if(s.conversationType===t.CONV_C2C)return li;if(s.conversationType===t.CONV_GROUP){let e=this.get(vs).getLocalGroupProfile(s.to);if(e)return s=e.type,nt(s)?di:ui}}_addSendMessageTotalCount(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get($s).addTotalCount(e)}_addSendMessageSuccessCount(e,t){var s=this._getSendMessageSpecifiedKey(e);if(s){let e=this.get($s);e.addSuccessCount(s),e.addCost(s,Dt(t,!1))}}_addSendMessageFailCountOnUser(e,t){var{code:t=-1}=t,s=this.get($s),e=this._getSendMessageSpecifiedKey(e);Bn(t)&&e&&s.addFailedCountOfUserSide(e)}}class zn extends oi{constructor(e){super(e),this._n="PluginModule",this.plugins={}}registerPlugin(t){let s="0";Object.keys(t).forEach(e=>{this.plugins[e]=t[e],"tim-upload-plugin"===e&&"function"==typeof t[e].getVersion&&(s=t[e].getVersion())}),new Ti("registerPlugin").setMessage(""+Object.keys(t)).setMoreMessage("version:"+s).end()}getPlugin(e){return this.plugins[e]}reset(){}}class jn extends oi{constructor(e){super(e),this._n="SyncUnreadMsgModule",this._cookie="",this._onlineSyncFlag=!1,this.getIEmitInst().on(Yi.A2KEY_AND_TINYID_UPDATED,this._init,this)}_init(){this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}_startSync(e){let{cookie:t,syncFlag:s,isOnlineSync:i}=e,r=this._n+"._startSync",o=(Ce.l(r+" options:",e),new Ti("syncUnread"));o.setMessage(JSON.stringify(e)),this.req({P:ri.SYNC_UNREAD_MSG,data:{cookie:t,syncFlag:s,isOnlineSync:i}}).then(e=>{var{cookie:t,syncFlag:s}=e.data,i=`$cookie:${t} syncFlag:`+s;Ce.l(r+" ok. "+i),this._cookie=t,o.setMoreMessage(i).end(),Oe(t)||(0===s||1===s?(this._dispatch({...e.data,isSyncingEnded:!1}),this._startSync({cookie:t,syncFlag:s,isOnlineSync:0})):2===s&&this._dispatch({...e.data,isSyncingEnded:!0}))}).catch(e=>{o.setError(e).end(),Ce.e(r+" failed. error:",e)})}_dispatch(e){e.eventArray&&this.get(Gs).onMessage({head:{},body:{eventArray:e.eventArray,isInstantMessage:this._onlineSyncFlag,isSyncingEnded:e.isSyncingEnded}}),this.get(ys).onNewMessage({dataList:e.messageList,isInstantMessage:!!e.isSyncingEnded&&this._onlineSyncFlag,C2CRemainingUnreadList:e.C2CRemainingUnreadList,C2CPairUnreadList:e.C2CPairUnreadList,isSyncingEnded:e.isSyncingEnded})}syncOnNeed(){Ce.l(this._n+".syncOnNeed cookie:"+this._cookie),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:1})}syncOnReconnected(){Ce.l(this._n+".syncOnReconnected cookie:"+this._cookie),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}reset(){Ce.l(this._n+".reset"),this._onlineSyncFlag=!1,this._cookie=""}}let Jn={req:{toAccount:"To_Account",fromAccount:"From_Account",to:"To_Account",from:"From_Account",groupID:"GroupId",groupAtUserID:"GroupAt_Account",extension:"Ext",data:"Data",description:"Desc",elements:"MsgBody",sizeType:"Type",downloadFlag:"Download_Flag",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",videoUrl:"",imageUrl:"URL",fileUrl:"Url",uuid:"UUID",priority:"MsgPriority",receiverUserID:"To_Account",receiverGroupID:"GroupId",messageSender:"SenderId",messageReceiver:"ReceiverId",nick:"From_AccountNick",avatar:"From_AccountHeadurl",messageNumber:"MsgNum",pbDownloadKey:"PbMsgKey",downloadKey:"JsonMsgKey",applicationType:"PendencyType",userIDList:"To_Account",groupNameList:"GroupName",userID:"To_Account",groupAttributeList:"GroupAttr",mainSequence:"AttrMainSeq",avChatRoomKey:"BytesKey",attributeControl:"AttrControl",sequence:"seq",messageControlInfo:"SendMsgControl",updateSequence:"UpdateSeq",clientTime:"MsgClientTime",sequenceList:"MsgSeqList",topicID:"TopicId",customData:"CustomString",isSupportTopic:"SupportTopic",isWebUniapp:"is_web_uniapp",isSupportExtension:"SupportMessageExtension",messageSequence:"MsgSeq",messageKey:"MsgKey",startSequence:"startSeq",simplifiedMessage:"DownsizeFlag",isRelayMessage:"IsRelayMsg",reactionID:"Reaction",messageSequenceList:"MsgSeqList",messageKeyList:"MsgKeyList",cmConfigID:"CustomModerationConfigID"},res:{MsgPriority:"priority",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",Download_Flag:"downloadFlag",GroupId:"groupID",Member_Account:"userID",MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",MsgSeq:"sequence",MsgRandom:"random",MsgTime:"time",MsgTimeStamp:"time",MsgContent:"content",MsgBody:"elements",From_AccountNick:"nick",From_AccountHeadurl:"avatar",GroupWithdrawInfoArray:"revokedInfos",GroupReadInfoArray:"groupMessageReadNotice",LastReadMsgSeq:"lastMessageSeq",WithdrawC2cMsgNotify:"c2cMessageRevokedNotify",C2cWithdrawInfoArray:"revokedInfos",C2cReadedReceipt:"c2cMessageReadReceipt",ReadC2cMsgNotify:"c2cMessageReadNotice",LastReadTime:"peerReadTime",MsgRand:"random",MsgType:"type",MsgShow:"messageShow",NextMsgSeq:"nextMessageSeq",FaceUrl:"avatar",ProfileDataMod:"profileModify",Profile_Account:"userID",ValueBytes:"value",ValueNum:"value",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgFrom_AccountExtraInfo:"messageFromAccountExtraInformation",Operator_Account:"operatorID",OpType:"operationType",ReportType:"operationType",UserId:"userID",User_Account:"userID",List_Account:"userIDList",MsgOperatorMemberExtraInfo:"operatorInfo",MsgMemberExtraInfo:"memberInfoList",ImageUrl:"avatar",NickName:"nick",MsgGroupNewInfo:"newGroupProfile",MsgAppDefinedData:"groupCustomField",Owner_Account:"ownerID",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupNotification:"notification",GroupApplyJoinOption:"joinOption",MsgKey:"messageKey",GroupInfo:"groupProfile",ShutupTime:"muteTime",Desc:"description",Ext:"extension",GroupAt_Account:"groupAtUserID",MsgNum:"messageNumber",PbMsgKey:"pbDownloadKey",JsonMsgKey:"downloadKey",MsgModifiedFlag:"isModified",PendencyItem:"applicationItem",PendencyType:"applicationType",AddTime:"time",AddSource:"source",AddWording:"wording",ProfileImImage:"avatar",PendencyAdd:"friendApplicationAdded",FrienPencydDel_Account:"friendApplicationDeletedUserIDList",Peer_Account:"userID",GroupAttr:"groupAttributeList",GroupAttrAry:"groupAttributeList",AttrMainSeq:"mainSequence",seq:"sequence",GroupAttrOption:"groupAttributeOption",BytesChangedKeys:"changedKeyList",GroupAttrInfo:"groupAttributeList",GroupAttrSeq:"mainSequence",PushChangedAttrValFlag:"isWithChangedAttributeInfo",SubKeySeq:"sequence",Val:"value",MsgGroupFromCardName:"senderNameCard",MsgGroupFromNickName:"senderNick",C2cNick:"peerNick",C2cImage:"peerAvatar",SendMsgControl:"messageControlInfo",NoLastMsg:"excludedFromLastMessage",NoUnread:"excludedFromUnreadCount",UpdateSeq:"updateSequence",MuteNotifications:"muteFlag",MsgClientTime:"clientTime",TinyId:"tinyID",GroupMsgReceiptList:"readReceiptList",ReadNum:"readCount",UnreadNum:"unreadCount",TopicId:"topicID",MillionGroupFlag:"communityType",SupportTopic:"isSupportTopic",MsgTopicNewInfo:"newTopicInfo",ShutupAll:"muteAllMembers",CustomString:"customData",TopicFaceUrl:"avatar",TopicIntroduction:"introduction",TopicNotification:"notification",TopicIdArray:"topicIDList",MsgVersion:"messageVersion",C2cMsgModNotifys:"c2cMessageModified",GroupMsgModNotifys:"groupMessageModified",ApplyJoinOption:"joinOption",MsgFlag:"messageRemindType",AtInfoList:"groupAtInfoList",AtFlagList:"groupAtType",AtMsgSeq:"sequence",BanDuration:"duration",BanDescription:"reason",NotVisible:"invisible",BytesTag:"tag",BytesValue:"value",RptBytesValue:"value",LatestSeq:"globalSequence",ClearSeq:"clearSequence",SupportMessageExtension:"isSupportExtension",ExtensionList:"extensions",GroupCounter:"counterList",Revoker_Account:"revoker",MsgExtensionNotify:"messageExtensionNotify",ExtensionC2cMsgInfo:"messageInfo",ExtensionGroupMsgInfo:"messageInfo",MsgOptType:"operateType",SetKVInfo:"operateResultList",DeleteKVInfo:"operateResultList",ClearKVInfo:"operateResultList",MsgKeyValue:"extensions",ClearMsgSeq:"clearSequence",MsgLastSeq:"globalSequence",InviteJoinOption:"inviteOption",MemberList_Account:"inviteeList",MsgMemberExtraInfoList:"inviteeInfoList",E:"event",GInf:"groupProfile",MCT:"clientTime",MR:"random",MP:"priority",MTS:"time",GId:"groupID",MS:"sequence",CCD:"cloudCustomData",F_Account:"from",F_Hd:"avatar",F_NN:"nick",GN:"groupName",GT:"groupType",IsSys:"isSystemMessage",OpInf:"operatorInfo",Img:"avatar",NN:"nick",OnlineInf:"onlineMemberInfo",ET:"expireTime",Num:"onlineMemberNum",Opt:"operationType",O_Account:"operatorID",RT:"operationType",UDF:"userDefinedField",L_Account:"userIDList",IsPlaceMsg:"isPlaceMessage",MsgCheckResult:"checkResult",Results:"resultList",Reaction:"reactionID",Reaction_Account:"userIDList",MsgReactionNotifyList:"messageReactionNotifyList",MsgReactionNotify:"messageReactionNotify",MsgReactionSummary:"reactionList",C2CMsgInfo:"C2CMessageInfo",GroupMsgInfo:"groupMessageInfo",int32_err_code:"errorCode",str_err_msg:"errorMsg",MsgDropReason:"messageDropReason",ReactedByMe:"reactedByMyself",Level:"messageRemindType",PeerReadTime:"timestamp",NoUnreadSeqList:"excludedUnreadSequenceList",NewMsg:"topicLatestMessage"},ignoreKeyWord:["C2C","ID","USP"]};function Xn(e,t){if("string"==typeof e||Array.isArray(e))return t=Object.assign({pascalCase:!1},t),0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length?"":1===e.length?t.pascalCase?e.toUpperCase():e.toLowerCase():(e=e=(e=e!==e.toLowerCase()?Zn(e):e).replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,(e,t)=>t.toUpperCase()).replace(/\d+(\w|$)/g,e=>e.toUpperCase()),t.pascalCase?e.charAt(0).toUpperCase()+e.slice(1):e);throw new TypeError("Expected the input to be `string | string[]`")}let Zn=t=>{let s=!1,i=!1,r=!1;for(let e=0;e<t.length;e++){var o=t[e];s&&/[a-zA-Z]/.test(o)&&o.toUpperCase()===o?(t=t.slice(0,e)+"-"+t.slice(e),s=!1,r=i,i=!0,e++):i&&r&&/[a-zA-Z]/.test(o)&&o.toLowerCase()===o?(t=t.slice(0,e-1)+"-"+t.slice(e-1),r=i,i=!1,s=!0):(s=o.toLowerCase()===o&&o.toUpperCase()!==o,r=i,i=o.toUpperCase()===o&&o.toLowerCase()!==o)}return t};function Qn(e,t){let i=0;return function s(e,r){var t;return 100<++i?(i--,e):Fe(e)?(t=e.map(e=>we(e)?s(e,r):e),i--,t):we(e)?(t=ut(t=function(s){let i=Object.create(null);return Object.keys(s).forEach(e=>{var t=(t=>{if(!He(t))return!1;if(t!==Xn(t))for(let e=0;e<Jn.ignoreKeyWord.length&&!t.includes(Jn.ignoreKeyWord[e]);e++);var e,s;return $e(r[t])?(s=t)[0].toUpperCase()+Xn(s).slice(1):r[t]})((s[e],e));t&&(i[t]=s[e])}),i}(e),(e,t)=>Fe(e)||we(e)?s(e,r):e),i--,t):void 0}(e,t)}function eo(e,r){return Fe(e)?e.map(e=>we(e)?eo(e,r):e):we(e)?ut(function(s){let i={};return Object.keys(s).forEach(e=>{var t;i[s[e],t=e,$e(r[t])?Xn(t):r[t]]=s[e]}),i}(e),e=>Fe(e)||we(e)?eo(e,r):e):void 0}let to=String.fromCharCode,so=function(e){let t=0|e.charCodeAt(0);if(55296<=t)if(t<56320){e=0|e.charCodeAt(1);if(56320<=e&&e<=57343){if(65535<(t=(t<<10)+e-56613888|0))return to(240|t>>>18,128|t>>>12&63,128|t>>>6&63,128|63&t)}else t=65533}else t<=57343&&(t=65533);return t<=2047?to(192|t>>>6,128|63&t):to(224|t>>>12,128|t>>>6&63,128|63&t)},io=function(e){var t=void 0===e?"":(""+e).replace(/[\x80-\uD7ff\uDC00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]?/g,so),s=0|t.length,i=new Uint8Array(s);let r=0;for(;r<s;r=r+1|0)i[r]=0|t.charCodeAt(r);return i};class no{constructor(e){var t=(this._handler=e).getURL();if(this._socket=null,this._workerSocket=null,this._id=je(),this._handler.getIsWorkerEnabled()){let e=URL.createObjectURL(new Blob([';let _socket = null;onmessage = function(event) {  if (event.data.cmd === "start") {    const url = event.data.url;    _socket = new WebSocket(url);    _socket.binaryType = "arraybuffer";    _socket.onopen = function() {      postMessage({ callback: "onOpen", extensions: _socket.extensions });    };    _socket.onclose = function(e) {      postMessage({ callback: "onOpen", e: { code: e.code, reason: e.reason } });    };    _socket.onmessage = function(e) {      postMessage({ callback: "onMessage", data: e.data });    };    _socket.onerror = function(e) {      postMessage({ callback: "onError", e: { isTrusted: "true" } });    };  } else if (event.data.cmd === "sendMessage") {    if (_socket !== null) {      _socket.send(event.data.data);    }  } else if (event.data.cmd === "stop") {    if (_socket !== null) {      _socket.close(event.data.code);      _socket = null;    }  }};'],{type:"application/javascript; charset=utf-8"})),r=(this._workerSocket=new Worker(e),this);this._workerSocket.onmessage=function(e){var{callback:t,e:s,extensions:i}=e.data;"onOpen"===t?r._onOpen(i):"onClose"===t?r._onClose(s):"onError"===t?r._onError(s):"onMessage"===t&&r._onMessage(e.data)},this._workerSocket.postMessage({cmd:"start",id:this._id,url:t})}else k?O?($.connectSocket({url:t,header:{"content-type":"application/json"}}),$.onSocketClose(this._onClose.bind(this)),$.onSocketOpen(this._onOpen.bind(this)),$.onSocketMessage(this._onMessage.bind(this)),$.onSocketError(this._onError.bind(this))):(this._socket=$.connectSocket({url:t,header:{"content-type":"application/json"},complete:()=>{}}),this._socket.onClose(this._onClose.bind(this)),this._socket.onOpen(this._onOpen.bind(this)),this._socket.onMessage(this._onMessage.bind(this)),this._socket.onError(this._onError.bind(this))):(this._socket=new WebSocket(t),this._socket.binaryType="arraybuffer",this._socket.onopen=this._onOpen.bind(this,this._socket.extensions),this._socket.onmessage=this._onMessage.bind(this),this._socket.onclose=this._onClose.bind(this),this._socket.onerror=this._onError.bind(this));this._canIUseBinaryFrame=e.canIUseBinaryFrame()}getID(){return this._id}_onOpen(e){this._handler.onOpen({id:this._id,res:JSON.stringify(e)})}_onClose(e){this._handler.onClose({id:this._id,e:e})}_onMessage(e){e=this._canIUseBinaryFrame?this._isAppCompressedData(e.data)?this._handler.inflate(e.data):function(e){var r=new Uint8Array(e);let o="",n=0;for(var a=r.length;n<a;){let t=r[n],s=0,i=0;if(t<=127?(s=0,i=255&t):t<=223?(s=1,i=31&t):t<=239?(s=2,i=15&t):t<=244&&(s=3,i=7&t),0<a-n-s){let e=0;for(;e<s;)t=r[n+e+1],i=i<<6|63&t,e+=1}else i=65533,s=a-n;o+=String.fromCodePoint(i),n+=s+1}return o}(e.data):e.data;this._handler.onMessage({data:e})}_isAppCompressedData(e){e=new Uint8Array(e);return 67===e[0]&&79===e[1]&&77===e[2]&&80===e[3]}_onError(e){this._handler.onError({id:this._id,e:e})}setIsWorkerEnabled(e){this._isWorkerEnabled=!0}close(e){this._workerSocket&&(this._workerSocket.postMessage({cmd:"stop",code:e}),this._workerSocket.terminate(),this._workerSocket=null),O?($.offSocketClose(),$.offSocketMessage(),$.offSocketOpen(),$.offSocketError(),$.closeSocket()):this._socket&&(k?(this._socket.onClose(()=>{}),this._socket.onOpen(()=>{}),this._socket.onMessage(()=>{}),this._socket.onError(()=>{})):(this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null),A?this._socket.close({code:e}):this._socket.close(e),this._socket=null)}send(e){this._workerSocket?this._workerSocket.postMessage({cmd:"sendMessage",data:this._canIUseBinaryFrame?io(e.data).buffer:e.data}):O?$.sendSocketMessage({data:e.data,fail:()=>{e.fail&&e.requestID&&e.fail(e.requestID)}}):this._socket&&(k?this._socket.send({data:this._canIUseBinaryFrame?io(e.data).buffer:e.data,fail:()=>{e.fail&&e.requestID&&e.fail(e.requestID)}}):this._socket.send(this._canIUseBinaryFrame?io(e.data):e.data))}}let oo=4e3,ro=4001,ao="connected",co="connecting",lo="disconnected";class uo{constructor(e){this._chM=e,this._n="SocketHandler",this._promiseMap=new Map,this._readyState=lo,this._simpleRequestMap=new Map,this.MAX_SIZE=100,this._startSequence=je(),this._startTs=0,this._reConnectFlag=!1,this._nextPingTs=0,this._reConnectCount=0,this.MAX_RECONNECT_COUNT=3,this._socketID=-1,this._random=0,this._socket=null,this._url="",this._onOpenTs=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0,this._currentSite=c,this._setWebsocketHost(),this._initConnection()}_setWebsocketHost(){var e=this._chM.get(Rs);this._currentSite=c,this._chM.isOversea()&&(this._currentSite=l),e.isSingaporeSite()?this._currentSite=u:e.isKoreaSite()?this._currentSite=d:e.isGermanySite()?this._currentSite=_:e.isIndiaSite()?this._currentSite=h:e.isJapanSite()?this._currentSite=p:e.isUSASite()?this._currentSite=g:e.isIndonesiaSite()&&(this._currentSite=m),f.HOST.setCurrent(this._currentSite)}_initConnection(){var e=this._chM.get(Rs).getSDKAppID()+"",t=this._chM.get(Rs).isIndependentDomainDisabled(),t=($e(f.HOST.CURRENT.BACKUP)?this._url=f.HOST.CURRENT.DEFAULT:""===this._url?this._url=t?f.HOST.CURRENT.DEFAULT:f.HOST.CURRENT.DEFAULT0.replace("*",e):-1<this._url.indexOf(e)?this._url=f.HOST.CURRENT.DEFAULT:this._url===f.HOST.CURRENT.DEFAULT?this._url=f.HOST.CURRENT.IPV6:this._url===f.HOST.CURRENT.IPV6?this._url=F?this._genRandomDomain():f.HOST.CURRENT.BACKUP:this._isWebBackupUrl(this._url)||this._url===f.HOST.CURRENT.BACKUP?this._url=this._canIUseAnyCast()?f.HOST.CURRENT.ANYCAST:f.HOST.CURRENT.DEFAULT:this._url===f.HOST.CURRENT.ANYCAST&&(f.HOST.CURRENT.ANYCAST="",this._url=f.HOST.CURRENT.DEFAULT),this._chM.get(Rs)),e=t.getProxyServer();Oe(e)||(this._url=e),t.isTestEnv()&&(this._url=n.TEST[this._currentSite].DEFAULT),this._connect(),this._nextPingTs=0}_genRandomDomain(){var e=Math.floor(10001*Math.random())+1e4;return f.HOST.CURRENT.BACKUP_WEB.replace("*",e)}_isWebBackupUrl(e){return e.includes("my-cpaas.com")}_canIUseAnyCast(){return F&&f.HOST.CURRENT.ANYCAST}onCheckTimer(e){e%1==0&&(this._checkPromiseMap(),this._checkNativeAppWS())}_checkPromiseMap(){0!==this._promiseMap.size&&this._promiseMap.forEach((e,t)=>{var{reject:e,timestamp:s,headSeq:i}=e;let r=15e3;-1!==t.indexOf(ri.LOGIN)?r=9e4:-1!==t.indexOf(ri.PING)&&(r=3e3),Date.now()-s>=r&&(Ce.l(this._n+"._checkPromiseMap request timeout, delete requestID:"+t),this._promiseMap.delete(t),e(new Qs({code:ei.NETWORK_TIMEOUT,data:{headSeq:i}})),this._chM.onRequestTimeout())})}_checkNativeAppWS(){P&&!this.isConnected()&&this._reConnect()}onOpen(e){var t,s;this._readyState!==lo&&(this._onOpenTs=Date.now(),{id:e,res:t}=e,this._socketID=e,s=Dt(this._startTs,!1),e=`socketID:${e} res:`+t,Ce.l(this._n+`._onOpen cost:${s} ms. `+e),new Ti("wsOnOpen").setMessage(s).setCostTime(s).setMoreMessage(e).end(),this._readyState=ao,this._reConnectCount=0,this._resend(),!0===this._reConnectFlag&&(this._chM.onReconnected(),this._reConnectFlag=!1),this._chM.onOpen())}onClose(e){var t=new Ti("wsOnClose"),{id:e,e:s}=e,i=`sourceSocketID:${e} currentSocketID:${this._socketID} code:${s.code} reason:`+s.reason;let r=0;0!==this._onOpenTs&&(r=Date.now()-this._onOpenTs),t.setMessage(r).setCostTime(r).setMoreMessage(i).setCode(s.code).end(!0),Ce.l(this._n+`._onClose ${i} onlineTime:`+r),e===this._socketID&&(this._readyState=lo,r<1e3?this._chM.onReconnectFailed():this._chM.onClose())}onError(e){var{id:e,e:t}=e,s=`sourceSocketID:${e} currentSocketID:`+this._socketID;new Ti("wsOnError").setMessage(t.errMsg||JSON.stringify(t,["message","code"])).setMoreMessage(s).setLevel("error").end(!0),Ce.w(this._n+"._onError",t,s),e===this._socketID&&(this._readyState=lo,this._chM.onError())}onMessage(t){let s;try{s=JSON.parse(t.data)}catch(e){new Ti("jsonParseError").setMessage(t.data).end()}if(s&&s.head){var o=this._getRequestIDFromHead(s.head);let r=s.body;if(!this._chM.get(Bs).isTRTCCommand(o)){let e=ft(s.head);r=eo(s.body,this._getResKeyMap(e))}if(Ce.d(`${this._n}.onMessage ret:${JSON.stringify(r)} requestID:${o} has:`+this._promiseMap.has(o)),this._setNextPingTs(),this._promiseMap.has(o)){let{resolve:e,reject:t,timestamp:s,headSeq:i}=this._promiseMap.get(o);this._promiseMap.delete(o),this._calcRTT(s),void(r.errorCode&&0!==r.errorCode?(this._chM.onErrorCodeNotZero(r),t(new Qs({code:r.errorCode,message:r.errorInfo||"",data:o.includes(ri.MODIFY_C2C_MSG)||o.includes(ri.MODIFY_GRP_MSG)?{elements:r.elements,messageVersion:r.messageVersion,cloudCustomData:r.cloudCustomData,headSeq:i}:{headSeq:i}}))):e(Zs(r)))}else this._chM.onMessage({head:s.head,body:r})}}_calcRTT(e){e=Date.now()-e;this._chM.get($s).addRTT(e)}_connect(){this._readyState!==co&&this._readyState!==ao&&(this._startTs=Date.now(),this._onOpenTs=0,this._readyState=co,this._socket=new no(this),this._socketID=this._socket.getID(),Ce.l(`${this._n}._connect isWorkerEnabled:${this.getIsWorkerEnabled()} socketID:${this._socketID} url:`+this.getURL()),new Ti("wsConnect").setMessage(`socketID:${this._socketID} url:`+this.getURL()).end())}getURL(){this._chM.isDevMode()&&(this._canIUseBinaryFrame=!1);var e=ht();(O||S&&"windows"===e||P)&&(this._canIUseBinaryFrame=!1);let t=-1;"ios"===e?t=Y||-1:"android"===e&&(t=j||-1);var s=this._chM.get(Rs),i=this._chM.getPlatform();let r=`sdkappid=${s.getSDKAppID()}&instanceid=${s.getInstanceID()}&random=${this._getRandom()}&platform=${i}&host=${e}&version=${t}&sdkversion=3.5.3`;return D&&(r+="&isminigame=1"),this._chM.canIUseInflate()&&(r+="&compress=gzip"),this._canIUseBinaryFrame?this._url+"/binfo?"+r:this._url+"/info?"+r}_closeConnection(e){Ce.l(this._n+"._closeConnection socketID:"+this._socketID),this._socket&&(this._socket.close(e),this._socketID=-1,this._socket=null,this._readyState=lo)}_resend(){if(Ce.l(this._n+"._resend reConnectFlag:"+this._reConnectFlag,`promiseMap.size:${this._promiseMap.size} simpleRequestMap.size:`+this._simpleRequestMap.size),0<this._promiseMap.size&&this._promiseMap.forEach((e,t)=>{var{uplinkData:e,resolve:s,reject:i}=e;-1!==t.indexOf(ri.AV_POLLING)?this._promiseMap.delete(t):(this._promiseMap.set(t,{resolve:s,reject:i,timestamp:Date.now(),uplinkData:e}),this._execute(t,e))}),0<this._simpleRequestMap.size){for(var[e,t]of this._simpleRequestMap)this._execute(e,t);this._simpleRequestMap.clear()}}send(s){s.head.seq=this._getSequence(),s.head.reqtime=Math.floor(Date.now()/1e3),s.head.cs=this._calcCheckSum(s.head.servcmd,s.body);let{keyMap:e,...i}=s,r=this._getRequestIDFromHead(s.head),o=JSON.stringify(i);return new Promise((e,t)=>{this._promiseMap.set(r,{resolve:e,reject:t,timestamp:Date.now(),uplinkData:o,headSeq:s.head.seq}),Ce.d(`${this._n}.send uplinkData:${JSON.stringify(i)} requestID:${r} readyState:`+this._readyState),this._readyState!==ao?this._reConnect():(this._execute(r,o),this._chM.get($s).addRequestCount())})}simplySend(e){e.head.seq=this._getSequence(),e.head.reqtime=Math.floor(Date.now()/1e3);let{keyMap:t,...s}=e,i=this._getRequestIDFromHead(e.head),r=JSON.stringify(s);this._readyState!==ao?(this._simpleRequestMap.size<this.MAX_SIZE?this._simpleRequestMap.set(i,r):Ce.l(this._n+".simplySend. simpleRequestMap is full, drop request!"),this._reConnect()):this._execute(i,r)}_execute(e,t){this._socket.send({data:t,fail:k?this._onSendFail.bind(this):void 0,requestID:e})}_onSendFail(e){Ce.l(this._n+"._onSendFail requestID:"+e),this._chM.onSendFail()}_getSequence(){var e;if(this._startSequence<2415919103)return e=this._startSequence,this._startSequence+=1,2415919103===this._startSequence&&(this._startSequence=je()),e}_getRequestIDFromHead(e){var{servcmd:e,seq:t}=e;return e+t}_getResKeyMap(e){e=this._chM.getKeyMap(e);return{...Jn.res,...e.res}}_reConnect(){this._readyState!==ao&&this._readyState!==co&&this.forcedReconnect()}forcedReconnect(){var e=this._n+".forcedReconnect";Ce.l(e+` count:${this._reConnectCount} readyState:`+this._readyState),this._reConnectFlag=!0,this._resetRandom(),this._reConnectCount<this.MAX_RECONNECT_COUNT?(this._reConnectCount+=1,this._closeConnection(ro),this._initConnection()):(this._reConnectCount=0,this._chM.get(Os).isOnline()?(Ce.w(e+" disconnected from wsserver but network is ok, continue..."),this._closeConnection(ro),this._initConnection()):this._chM.onReconnectFailed())}getReconnectFlag(){return this._reConnectFlag}_setNextPingTs(){this._nextPingTs=P?Date.now()+5e3:Date.now()+1e4}getNextPingTs(){return this._nextPingTs}isConnected(){return this._readyState===ao}canIUseBinaryFrame(){return this._canIUseBinaryFrame}getSocketID(){return this._socketID}inflate(e){if(this._chM.canIUseInflate())return this._chM.get(Js).inflate(e)}setIsWorkerEnabled(e){Ce.l(this._n+".setIsWorkerEnabled flag:"+e),this._isWorkerEnabled=e}getIsWorkerEnabled(){return this._isWorkerEnabled&&ie}_getRandom(){return 0===this._random&&(this._random=Math.random()),this._random}_resetRandom(){this._random=0}_calcCheckSum(e,t){if(-1!==e.indexOf(ri.PING)||-1!==e.indexOf(ri.LOGIN)||-1!==e.indexOf(ri.LOGOUT)||-1!==e.indexOf(ri.AV_POLLING)||-1!==e.indexOf(ri.AV_NOAUTH_POLLING))return 0;var s=io(JSON.stringify(t));let i=4294967295;for(let e=0,t=s.length;e<t;e++){i^=s[e];for(let e=0;e<8;e++)1==(1&i)?i=i>>>1^3988292384:i>>>=1}return(4294967295^i)>>>0}close(){Ce.l(this._n+".close"),this._closeConnection(oo),this._promiseMap.clear(),this._startSequence=je(),this._readyState=lo,this._simpleRequestMap.clear(),this._reConnectFlag=!1,this._reConnectCount=0,this._onOpenTs=0,this._url="",this._random=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0}}let _o=function(o,n,a){return new Promise((s,i)=>{var r="application/x-www-form-urlencoded;charset=UTF-8";if(k)$.request({url:n,data:a,method:o,timeout:3e3,header:{"content-type":r},success:e=>{e&&e.data&&e.data.NetCheckInfo&&Ce.l("getconninfo ok in miniapp. ret:",e.data),s()},fail:()=>{i(new Qs({code:ei.NETWORK_ERROR}))}});else{let e=new XMLHttpRequest,t=setTimeout(()=>{e.abort(),i(new Qs({code:ei.NETWORK_TIMEOUT}))},3e3);e.onreadystatechange=function(){4===e.readyState&&(t&&clearTimeout(t),200===e.status||304===e.status?(e.responseText&&-1<e.responseText.indexOf("NetCheckInfo")&&Ce.l("getconninfo ok in web. ret:",JSON.parse(e.responseText)),s()):i(new Qs({code:ei.NETWORK_ERROR})))},e.open(o,n,!0),e.setRequestHeader("Content-type",r),a?e.send(a):e.send()}})};class ho extends oi{constructor(e){super(e),this._n="ChannelModule",this._socketHandler=new uo(this),this._probing=!1,this._isAppShowing=!0,this._previousState=t.NET_STATE_CONNECTED,this._timerForNotLoggedIn=-1,this._timerForNotLoggedIn=setInterval(this.onCheckTimer.bind(this),1e3),this._fatalErrorFlag=!1,this._disconnectedTS=0,this._lastDiagnoseTS=0}onCheckTimer(e){this._socketHandler&&(this.isLoggedIn()?(0<this._timerForNotLoggedIn&&(clearInterval(this._timerForNotLoggedIn),this._timerForNotLoggedIn=-1),this._socketHandler.onCheckTimer(e)):this._socketHandler.onCheckTimer(1),this._checkNextPing())}onErrorCodeNotZero(e){this.get(Gs).onErrorCodeNotZero(e)}onMessage(e){this.get(Gs).onMessage(e)}send(e){return this._socketHandler?this._previousState!==t.NET_STATE_CONNECTED&&e.head.servcmd.includes(ri.SSO_STAT)?(this.reConnect(),this.isPrivateNetWork()?Promise.resolve():this._sendLogViaHTTP(e)):this._socketHandler.send(e):Promise.reject()}_sendLogViaHTTP(e){var t=`${f.HOST.CURRENT.STAT}/v4/imopenstat/tim_web_report_v2?sdkappid=${e.head.sdkappid}&reqtime=`+Date.now(),e=JSON.stringify(e.body);return _o("POST",t,e)}simplySend(e){return this._socketHandler?this._socketHandler.simplySend(e):Promise.reject()}onOpen(){this._ping()}onClose(){this._socketHandler&&this._socketHandler.getReconnectFlag()&&this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED),this.reConnect()}onError(){k&&!P&&this.warn("DomainNameInMP"),this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}getKeyMap(e){return this.get(Gs).getKeyMap(e)}onRequestTimeout(){3e4<=Date.now()-this._lastDiagnoseTS&&this.diagnose()}onSendFail(){this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}onReconnected(){Ce.l(this._n+".onReconnected cost:"+Dt(this._disconnectedTS,!0,!0)),this._m.restartTimer(),this.get(Gs).onReconnected(Dt(this._disconnectedTS,!1,!1)),this._disconnectedTS=0,this._emitNetStateChangeEvent(t.NET_STATE_CONNECTED)}onReconnectFailed(){Ce.l(this._n+".onReconnectFailed"),this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}setIsWorkerEnabled(e){this._socketHandler&&this._socketHandler.setIsWorkerEnabled(!1)}offline(){this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}reConnect(e=!1){let s=!1;this._socketHandler&&(s=this._socketHandler.getReconnectFlag());var i=`forcedFlag:${e} fatalErrorFlag:${this._fatalErrorFlag} previousState:${this._previousState} reconnectFlag:`+s;Ce.l(this._n+".reConnect "+i),this._fatalErrorFlag||!this._socketHandler||!0!==e&&this._previousState===t.NET_STATE_CONNECTING&&s||(this._socketHandler.forcedReconnect(),this._emitNetStateChangeEvent(t.NET_STATE_CONNECTING))}_emitNetStateChangeEvent(s){this._previousState!==s&&(Ce.l(`${this._n}._emitNetStateChangeEvent from ${this._previousState} to `+s),s===t.NET_STATE_DISCONNECTED&&0===this._disconnectedTS&&(this._disconnectedTS=Date.now(),this.diagnose()),this._previousState=s,this.emitOEvt(e.NET_STATE_CHANGE,{state:s}))}_ping(){var e;!0!==this._probing&&(this._probing=!0,e=this.get(Gs).getProtocolData({P:ri.PING}),this.send(e).then(()=>{this._probing=!1}).catch(e=>{this._probing=!1;var s=this.get(Os).isOnline();Ce.w(this._n+`._ping failed. bOnline:${s} error:`,e),e&&60002===e.code?(new Ti("error").setMessage(`code:${e.code} message:`+e.message).end(),this._fatalErrorFlag=!0,this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)):s?this.reConnect():this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}))}_checkNextPing(){this._socketHandler&&this._socketHandler.isConnected()&&Date.now()>=this._socketHandler.getNextPingTs()&&this._ping()}dealloc(){this._socketHandler&&(this._socketHandler.close(),this._socketHandler=null),-1<this._timerForNotLoggedIn&&clearInterval(this._timerForNotLoggedIn)}onRestApiKickedOut(){this._socketHandler&&(this._socketHandler.close(),this.reConnect(!0))}canIUseInflate(){return this._m.canIUseInflate()}getSocketID(){if(this._socketHandler)return this._socketHandler.getSocketID()}diagnose(){this.isPrivateNetWork()||(this._lastDiagnoseTS=Date.now(),this._diagnoseBySSO(),this._diagnoseByCDN())}_diagnoseBySSO(){var e=this._socketHandler.getURL(),t=e.split("/")[2];t.startsWith("ws")&&(t=`https://${t}/v3/netcheck/getconninfo?${e.slice(e.indexOf("info?")+5)}&reqtime=`+Date.now(),_o("GET",t).catch(e=>{Ce.w(this._n+"._diagnoseBySSO failed. error:",e)}))}_diagnoseByCDN(){var e=this._socketHandler.getURL(),e=`https://boce-cdn.my-imcloud.com/v3/netcheck/getconninfo?${e.slice(e.indexOf("info?")+5)}&reqtime=`+Date.now();_o("GET",e).catch(e=>{Ce.w(this._n+"._diagnoseByCDN failed. error:",e)})}reset(){Ce.l(this._n+".reset"),this._previousState=t.NET_STATE_CONNECTED,this._probing=!1,this._fatalErrorFlag=!1,this._timerForNotLoggedIn=setInterval(this.onCheckTimer.bind(this),1e3),this._disconnectedTS=0,this._lastDiagnoseTS=0}}class po{constructor(e){this._n="PHandler",this._sessionM=e,this._map=new Map,this._fillMap()}_fillMap(){this._map.clear();var i=this._sessionM.genCommonHead(),e=this._sessionM.genCosSpecifiedHead(),t=this._sessionM.genSSOReportHead();this._map.set(ri.LOGIN,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.LOGIN},body:{state:"Online",isWebUniapp:0,deviceBrand:0,customInfo:""},keyMap:{req:{deviceBrand:"InstType"},res:{InstId:"instanceID",HelloInterval:"helloInterval",RichMsgAuthKey:"authKey"}}}),this._map.set(ri.LOGOUT,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.LOGOUT},body:{type:0,isWebUniapp:0},keyMap:{req:{type:"wslogout_type"}}}),this._map.set(ri.HELLO,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.HELLO},body:{isWebUniapp:0},keyMap:{res:{NewInstInfo:"newInstanceInfo"}}}),this._map.set(ri.KICK_OTHER,{head:{...i,servcmd:f.NAME.STAT_SERVICE+"."+ri.KICK_OTHER},body:{}}),this._map.set(ri.COS_SIGN,{head:{...e,servcmd:f.NAME.IM_COS_SIGN+"."+ri.COS_SIGN},body:{cmd:"open_im_cos_svc",subCmd:"get_cos_token",duration:300,version:2},keyMap:{req:{userSig:"usersig",subCmd:"sub_cmd",cmd:"cmd",duration:"duration",version:"version"},res:{expired_time:"expiredTime",bucket_name:"bucketName",session_token:"sessionToken",tmp_secret_id:"secretId",tmp_secret_key:"secretKey"}}}),this._map.set(ri.COS_PRE_SIG,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ri.COS_PRE_SIG},body:{fileType:void 0,fileName:void 0,uploadMethod:0,duration:900},keyMap:{req:{userSig:"usersig",fileType:"file_type",fileName:"file_name",uploadMethod:"upload_method"},res:{expired_time:"expiredTime",request_id:"requestId",head_url:"headUrl",upload_url:"uploadUrl",download_url:"downloadUrl",ci_url:"ciUrl",snapshot_url:"requestSnapshotUrl"}}}),this._map.set(ri.SIMPLE_COS_PRE_SIG,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ri.SIMPLE_COS_PRE_SIG},body:{uploadMethod:0,platform:2,SDKAppID:0,userID:"",conversationType:1,uploadConfig:[{fileID:1,fileType:1,fileName:""}]},keyMap:{req:{platform:"uint32_platform",SDKAppID:"uint32_sdkappid",userID:"str_user_id",uploadMethod:"uint32_upload_method",conversationType:"uint32_scene",uploadConfig:"rpt_upload_object",fileID:"uint32_file_id",fileType:"uint32_file_type",fileName:"str_file_name"},res:{str_final_ip:"uploadIP",rpt_pre_sig:"preSig",uint32_file_id:"fileID",uint32_exist_flag:"existFlag",str_download_url:"downloadUrl",str_upload_url:"uploadUrl",str_snapshot_url:"requestSnapshotUrl",str_file_key:"fileKey"}}}),this._map.set(ri.GET_IMAGE_INFO,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ri.GET_IMAGE_INFO},body:{imageUrl:""},keyMap:{req:{imageUrl:"str_image_url"},res:{rpt_msg_image_info:"imageInfoArray",uint32_image_type:"type",str_url:"url",uint32_width:"width",uint32_height:"height",str_image_format:"imageFormat"}}}),this._map.set(ri.GET_IP,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ri.GET_IP},body:{domainName:""},keyMap:{req:{domainName:"str_domain"},res:{str_final_ip:"ip"}}}),this._map.set(ri.VIDEO_COVER,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ri.VIDEO_COVER},body:{version:1,platform:void 0,coverName:void 0,requestSnapshotUrl:void 0},keyMap:{req:{version:"version",platform:"platform",coverName:"cover_name",requestSnapshotUrl:"snapshot_url"},res:{error_code:"errorCode",error_msg:"errorInfo",download_url:"snapshotUrl"}}}),this._map.set(ri.FETCH_COMMERCIAL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ri.FETCH_COMMERCIAL_CONFIG},body:{SDKAppID:0},keyMap:{req:{SDKAppID:"uint32_sdkappid"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(ri.PUSHED_COMMERCIAL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ri.PUSHED_COMMERCIAL_CONFIG},body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(ri.FETCH_CLOUD_CTRL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ri.FETCH_CLOUD_CTRL_CONFIG},body:{SDKAppID:0,version:0},keyMap:{req:{SDKAppID:"uint32_sdkappid",version:"uint64_version"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(ri.PUSHED_CLOUD_CTRL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ri.PUSHED_CLOUD_CTRL_CONFIG},body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(ri.OVERLOAD_NOTIFY,{head:{...i,servcmd:f.NAME.OVERLOAD_PUSH+"."+ri.OVERLOAD_NOTIFY},body:{},keyMap:{res:{OverLoadServCmd:"overloadCommand",DelaySecs:"waitingTime"}}}),this._map.set(ri.SYNC_UNREAD_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.SYNC_UNREAD_MSG},body:{cookie:"",syncFlag:0,needAbstract:1,isOnlineSync:0,needSignaling:1,needCachedMsg:1},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",from:"From_Account",to:"To_Account",time:"MsgTimeStamp",sequence:"MsgSeq",random:"MsgRandom",elements:"MsgBody"},res:{MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",ClientSeq:"clientSequence",MsgSeq:"sequence",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgRandom:"random",MsgTimeStamp:"time",MsgContent:"content",ToGroupId:"to",MsgKey:"messageKey",GroupTips:"groupTips",MsgBody:"elements",MsgType:"type",C2CRemainingUnreadCount:"C2CRemainingUnreadList",C2CPairUnreadCount:"C2CPairUnreadList"}}}),this._map.set(ri.GET_PROFANITY_LIST,{head:{...i,servcmd:f.NAME.IM_MSG_AUDIT_MGR+"."+ri.GET_PROFANITY_LIST},body:{version:0,deviceID:"",startIndex:void 0},keyMap:{req:{version:"uint64_version",deviceID:"str_device_id",startIndex:"uint64_start_index"},res:{msg_cmd_error_code:"errorInfo",str_err_msg:"errorMessage",uint32_code:"errorCode",msg_scene_ctl_config:"filterConfig",uint64_c2c_custom_msg_flag:"c2c_custom_message",uint64_c2c_text_msg_flag:"c2c_text_message",uint64_group_custom_msg_flag:"group_custom_message",uint64_group_text_msg_flag:"group_text_message",uint64_group_info_flag:"group_profile",uint64_group_member_info_flag:"group_member_profile",uint64_relation_chain_flag:"sns",uint64_user_info_flag:"user_profile",rpt_msg_dirty_word:"lexicon",str_dirty_word:"profanity",str_replaced_content:"replacement",uint64_filter_type:"filterType",uint64_id:"id",uint64_word_type:"profanityType",uint64_complete_flag:"completeFlag",uint64_next_start_index:"nextStartIndex",uint64_version:"version",uint64_expired_time:"expiredTime"}}}),this._map.set(ri.SEND_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.SEND_C2C_MSG},body:{fromAccount:"",toAccount:"",msgSeq:0,msgRandom:0,msgBody:[],cloudCustomData:void 0,nick:"",avatar:"",msgLifeTime:void 0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",OPPOCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:"",HonorImportance:""}},messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0,forbidCallbackControl:void 0},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",count:"MaxCnt",lastMessageTime:"LastMsgTime",messageKey:"MsgKey",peerAccount:"Peer_Account",data:"Data",description:"Desc",extension:"Ext",type:"MsgType",content:"MsgContent",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",nick:"From_AccountNick",avatar:"From_AccountHeadurl",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"IsNeedReadReceipt",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID",OPPOChannelID:"OPPOChannelID",OPPOCategory:"OPPOCategory",VIVOClassification:"VIVOClassification",VIVOCategory:"VIVOCategory",HonorImportance:"HonorImportance"}}}),this._map.set(ri.SEND_GRP_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ri.SEND_GRP_MSG},body:{fromAccount:"",groupID:"",random:0,clientSequence:0,priority:"",msgBody:[],cloudCustomData:void 0,onlineOnlyFlag:0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",OPPOCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:"",HonorImportance:""}},groupAtInfo:[],messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,topicID:void 0,receiverList:void 0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0,forbidCallbackControl:void 0},keyMap:{req:{to:"GroupId",extension:"Ext",data:"Data",description:"Desc",random:"Random",sequence:"ReqMsgSeq",count:"ReqMsgNumber",type:"MsgType",priority:"MsgPriority",content:"MsgContent",elements:"MsgBody",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",clientSequence:"ClientSeq",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"NeedReadReceipt",receiverList:"To_Account",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID",OPPOChannelID:"OPPOChannelID",OPPOCategory:"OPPOCategory",VIVOClassification:"VIVOClassification",VIVOCategory:"VIVOCategory",HonorImportance:"HonorImportance"},res:{MsgTime:"time",MsgSeq:"sequence"}}}),this._map.set(ri.REVOKE_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.REVOKE_C2C_MSG},body:{msgInfo:{fromAccount:"",toAccount:"",msgTimeStamp:0,msgSeq:0,msgRandom:0}},keyMap:{req:{msgInfo:"MsgInfo",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom"}}}),this._map.set(ri.REVOKE_GRP_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ri.REVOKE_GRP_MSG},body:{groupID:"",msgSeqList:void 0,topicID:""},keyMap:{req:{msgSeqList:"MsgSeqList",msgSeq:"MsgSeq"}}}),this._map.set(ri.GET_C2C_ROAMING_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.GET_C2C_ROAMING_MSG},body:{peerAccount:"",count:15,lastMessageTime:0,messageKey:"",withRecalledMessage:1,direction:0},keyMap:{req:{messageKey:"MsgKey",peerAccount:"Peer_Account",count:"MaxCnt",lastMessageTime:"LastMsgTime",withRecalledMessage:"WithRecalledMsg",direction:"GetDirection"},res:{LastMsgTime:"lastMessageTime",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer"}}}),this._map.set(ri.MODIFY_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.MODIFY_C2C_MSG},body:{from:"",to:"",sequence:0,random:0,time:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(ri.GET_GRP_ROAMING_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_ROAMING_MSG},body:{withRecalledMsg:1,groupID:"",count:15,sequence:"",topicID:void 0},keyMap:{req:{sequence:"ReqMsgSeq",count:"ReqMsgNumber",withRecalledMessage:"WithRecalledMsg"},res:{Random:"random",MsgTime:"time",MsgSeq:"sequence",ReqMsgSeq:"sequence",RspMsgList:"messageList",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgPriority:"priority",MsgBody:"elements",MsgType:"type",MsgContent:"content",IsFinished:"complete",Download_Flag:"downloadFlag",ClientSeq:"clientSequence",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",NextReqMsgSeq:"nextSequence"}}}),this._map.set(ri.SET_C2C_MSG_READ,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.SET_C2C_MSG_READ},body:{C2CMsgReaded:void 0},keyMap:{req:{lastMessageTime:"LastedMsgTime"}}}),this._map.set(ri.SET_C2C_PEER_MUTE_NOTIFICATIONS,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.SET_C2C_PEER_MUTE_NOTIFICATIONS},body:{userIDList:void 0,muteFlag:0},keyMap:{req:{userIDList:"Peer_Account",muteFlag:"Mute_Notifications"}}}),this._map.set(ri.GET_C2C_PEER_MUTE_NOTIFICATIONS,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.GET_C2C_PEER_MUTE_NOTIFICATIONS},body:{toAccount:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Peer_Account"},res:{MuteNotificationsList:"muteFlagList"}}}),this._map.set(ri.SET_GRP_MSG_READ,{head:{...i,servcmd:f.NAME.GRP+"."+ri.SET_GRP_MSG_READ},body:{groupID:void 0,messageReadSeq:void 0,topicID:void 0},keyMap:{req:{messageReadSeq:"MsgReadedSeq"}}}),this._map.set(ri.SET_ALL_MSG_READ,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.SET_ALL_MSG_READ},body:{readAllC2CMessage:0,groupMessageReadInfoList:[]},keyMap:{req:{readAllC2CMessage:"C2CReadAllMsg",groupMessageReadInfoList:"GroupReadInfo",messageSequence:"MsgSeq"},res:{C2CReadAllMsg:"readAllC2CMessage",GroupReadInfoArray:"groupMessageReadInfoList"}}}),this._map.set(ri.DEL_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.DEL_C2C_MSG},body:{fromAccount:"",to:"",keyList:void 0},keyMap:{req:{keyList:"MsgKeyList"}}}),this._map.set(ri.DEL_GRP_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ri.DEL_GRP_MSG},body:{groupID:"",deleter:"",keyList:void 0,topicID:void 0},keyMap:{req:{deleter:"Deleter_Account",keyList:"Seqs"}}}),this._map.set(ri.TRANSLATE_TEXT,{head:{...i,servcmd:f.NAME.IM_OPEN_TRANSLATE+"."+ri.TRANSLATE_TEXT},body:{sourceTextList:void 0,SDKAppID:0,from:0,source:"",target:""},keyMap:{req:{sourceTextList:"SourceText",SDKAppID:"SdkAppId",from:"FromAccount"},res:{TargetText:"translatedTextList",RequestId:"requestID",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(ri.VOICE_TO_TEXT,{head:{...i,servcmd:f.NAME.IM_OPEN_SPEECH+"."+ri.VOICE_TO_TEXT},body:{url:"",SDKAppID:0,format:"",sourceType:0,language:""},keyMap:{req:{url:"BytesUrl",SDKAppID:"Uint32Sdkappid",format:"BytesVoiceFormat",sourceType:"Uint64SourceType",language:"BytesEngServiceType"},res:{BytesRequestid:"requestID",BytesResult:"result",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(ri.MODIFY_GRP_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.MODIFY_GRP_MSG},body:{groupID:"",topicID:void 0,sequence:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(ri.GET_READ_RECEIPT,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_READ_RECEIPT},body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequence:"MsgSeq"}}}),this._map.set(ri.SEND_C2C_READ_RECEIPT,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.SEND_C2C_READ_RECEIPT},body:{peerAccount:"",messageInfoList:void 0},keyMap:{req:{peerAccount:"Peer_Account",messageInfoList:"C2CMsgInfo",fromAccount:"From_Account",toAccount:"To_Account",sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",clientTime:"MsgClientTime"}}}),this._map.set(ri.SEND_READ_RECEIPT,{head:{...i,servcmd:f.NAME.GRP+"."+ri.SEND_READ_RECEIPT},body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequenceList:"MsgSeqList",sequence:"MsgSeq"}}}),this._map.set(ri.GET_READ_RECEIPT_DETAIL,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_READ_RECEIPT_DETAIL},body:{groupID:"",sequence:void 0,flag:0,cursor:0,count:0},keyMap:{req:{sequence:"MsgSeq",count:"Num"},res:{ReadList:"readUserIDList",Read_Account:"userID",UnreadList:"unreadUserIDList",Unread_Account:"userID",IsFinish:"isCompleted"}}}),this._map.set(ri.GET_GRP_RECEIPTS_BY_USERS,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_RECEIPTS_BY_USERS},body:{groupID:"",dataList:void 0},keyMap:{req:{dataList:"MemberReadMsgList",sequence:"MsgSeq",userIDList:"MemberList_Account"},res:{MsgReadList:"dataList",Read_Account:"userID",Read_Time:"readTime"}}}),this._map.set(ri.MODIFY_C2C_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.MODIFY_C2C_MSG_EXT},body:{from:void 0,to:void 0,messageKey:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(ri.GET_C2C_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.GET_C2C_MSG_EXT},body:{from:void 0,to:void 0,messageKey:void 0,startSequence:void 0}}),this._map.set(ri.MODIFY_GRP_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.MODIFY_GRP_MSG_EXT},body:{groupID:void 0,topicID:void 0,messageSequence:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(ri.GET_GRP_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.GET_GRP_MSG_EXT},body:{groupID:void 0,topicID:void 0,messageSequence:void 0,startSequence:void 0}}),this._map.set(ri.ADD_C2C_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.ADD_C2C_MSG_REACTION},body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(ri.RM_C2C_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.RM_C2C_MSG_REACTION},body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(ri.GET_C2C_MSG_REACTIONS,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.GET_C2C_MSG_REACTIONS},body:{from:void 0,to:void 0,messageKeyList:void 0,count:void 0}}),this._map.set(ri.GET_C2C_MSG_REACTION_USER_LIST,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.GET_C2C_MSG_REACTION_USER_LIST},body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,count:void 0}}),this._map.set(ri.ADD_GRP_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.ADD_GRP_MSG_REACTION},body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(ri.RM_GRP_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.RM_GRP_MSG_REACTION},body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(ri.GET_GRP_MSG_REACTIONS,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.GET_GRP_MSG_REACTIONS},body:{groupID:void 0,topicID:void 0,messageSequenceList:void 0,count:void 0},keyMap:{res:{MsgSeq:"messageSequence"}}}),this._map.set(ri.GET_GRP_MSG_REACTION_USER_LIST,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ri.GET_GRP_MSG_REACTION_USER_LIST},body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,nextSeq:void 0,count:void 0}}),this._map.set(ri.GET_C2C_PEER_READ_TIME,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.GET_C2C_PEER_READ_TIME},body:{userIDList:void 0},keyMap:{req:{userIDList:"To_Account"},res:{ReadTime:"peerReadTimeList"}}}),this._map.set(ri.PAGING_GET_CONV_LIST,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.PAGING_GET_CONV_LIST},body:{fromAccount:void 0,timeStamp:void 0,startIndex:void 0,pinnedTimeStamp:void 0,pinnedStartIndex:void 0,orderType:void 0,messageAssistFlag:15,assistFlag:31},keyMap:{req:{messageAssistFlag:"MsgAssistFlags",assistFlag:"AssistFlags",pinnedTimeStamp:"TopTimeStamp",pinnedStartIndex:"TopStartIndex"},res:{SessionItem:"conversations",ToAccount:"groupID",To_Account:"userID",UnreadMsgCount:"unreadCount",MsgGroupReadedSeq:"messageReadSeq",C2cPeerReadTime:"c2cPeerReadTime",LastMsgFlags:"lastMessageFlag",TopFlags:"isPinned",TopTimeStamp:"pinnedTimeStamp",TopStartIndex:"pinnedStartIndex",GroupId:"convGroupID",C2cRemark:"friendRemark",MsgRecvOption:"messageRemindType",GroupIgnoredUnreadSeqCount:"noUnreadCount",GroupNextMsgSeq:"nextMessageSeq"}}}),this._map.set(ri.DEL_CONV,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.DEL_CONV},body:{fromAccount:"",conversationList:void 0,clearHistoryMessage:void 0},keyMap:{req:{toGroupID:"ToGroupid",clearHistoryMessage:"ClearRamble",conversationList:"ContactItem"},res:{ResultItem:"resultList",ToGroupid:"groupID",ResultCode:"code",ResultInfo:"info"}}}),this._map.set(ri.CLEAR_HISTORY_MSG,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.CLEAR_HISTORY_MSG},body:{fromAccount:"",toAccount:void 0,type:1,toGroupID:void 0},keyMap:{req:{toGroupID:"ToGroupid"}}}),this._map.set(ri.PIN_CONV,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.PIN_CONV},body:{fromAccount:"",operationType:1,itemList:void 0},keyMap:{req:{itemList:"RecentContactItem"}}}),this._map.set(ri.DEL_GROUP_AT_TIPS,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.DEL_GROUP_AT_TIPS},body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(ri.SET_CONV_CUSTOM_DATA,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.MARK_CONV},body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(ri.MARK_CONV,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.MARK_CONV},body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(ri.CREATE_CONV_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.CREATE_CONV_GRP},body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"GroupContactItem",groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(ri.DEL_CONV_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.DEL_CONV_GRP},body:{fromAccount:"",groupName:void 0},keyMap:{res:{GroupId:"convGroupID"}}}),this._map.set(ri.RENAME_CONV_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.RENAME_CONV_GRP},body:{fromAccount:"",updateType:void 0,updateGroup:void 0},keyMap:{req:{oldName:"OldGroupName",newName:"NewGroupName",groupID:"ToGroupId",operationType:"ContactOptType",groupName:"OldGroupName",updateItem:"ContactUpdateItem"},res:{ContactOptType:"operationType",ToGroupId:"groupID",GroupId:"convGroupID"}}}),this._map.set(ri.ADD_CONV_TO_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.RENAME_CONV_GRP},body:{fromAccount:"",updateType:void 0,updateGroup:{groupName:void 0,updateGroupType:void 0,updateItem:void 0}}}),this._map.set(ri.DEL_CONV_FROM_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.RENAME_CONV_GRP},body:{fromAccount:"",updateType:void 0,updateGroup:void 0}}),this._map.set(ri.GET_CONV_GRP_LIST,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.GET_CONV_GRP_LIST},body:{fromAccount:"",startIndex:void 0},keyMap:{res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList"}}}),this._map.set(ri.SEARCH_CONV_GRP_MARK,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ri.SEARCH_CONV_GRP_MARK},body:{fromAccount:"",contactItem:void 0},keyMap:{req:{groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList",ContactResultItem:"contactItem"}}}),this._map.set(ri.GET_USER_PROFILE,{head:{...i,servcmd:f.NAME.PROFILE+"."+ri.GET_USER_PROFILE},body:{fromAccount:"",userItem:[]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(ri.UPDATE_MY_PROFILE,{head:{...i,servcmd:f.NAME.PROFILE+"."+ri.UPDATE_MY_PROFILE},body:{fromAccount:"",profileItem:[{tag:ye.NICK,value:""},{tag:ye.GENDER,value:""},{tag:ye.ALLOWTYPE,value:""},{tag:ye.AVATAR,value:""}]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(ri.GET_BL,{head:{...i,servcmd:f.NAME.FD+"."+ri.GET_BL},body:{fromAccount:"",startIndex:0,maxLimited:30}}),this._map.set(ri.ADD_TO_BL,{head:{...i,servcmd:f.NAME.FD+"."+ri.ADD_TO_BL},body:{fromAccount:"",toAccount:[]}}),this._map.set(ri.RM_FROM_BL,{head:{...i,servcmd:f.NAME.FD+"."+ri.RM_FROM_BL},body:{fromAccount:"",toAccount:[]}}),this._map.set(ri.SET_SELF_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.SET_SELF_STATUS},body:{customStatus:""}}),this._map.set(ri.GET_USER_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.GET_USER_STATUS},body:{userIDList:void 0},keyMap:{res:{UserStatusList:"successUserList",ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID",Status:"statusType"}}}),this._map.set(ri.SUB_USER_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.SUB_USER_STATUS},body:{userIDList:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(ri.UNSUB_USER_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.UNSUB_USER_STATUS},body:{userIDList:void 0,unsubscribeAll:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(ri.GET_FD_LIST,{head:{...i,servcmd:f.NAME.FD+"."+ri.GET_FD_LIST},body:{fromAccount:"",startIndex:0,standardSequence:0,customSequence:0},keyMap:{res:{FriendNum:"friendCount",UserDataItem:"resultList",ValueItem:"tagValueList"}}}),this._map.set(ri.ADD_FD,{head:{...i,servcmd:f.NAME.FD+"."+ri.ADD_FD},body:{fromAccount:"",addFriendItem:[],type:""},keyMap:{req:{source:"AddSource",wording:"AddWording",type:"AddType"},res:{ResultItem:"resultList"}}}),this._map.set(ri.UPDATE_FD,{head:{...i,servcmd:f.NAME.FD+"."+ri.UPDATE_FD},body:{fromAccount:"",updateItem:void 0},keyMap:{req:{snsItem:"SnsItem"},res:{ResultItem:"resultList"}}}),this._map.set(ri.DEL_FD,{head:{...i,servcmd:f.NAME.FD+"."+ri.DEL_FD},body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"DeleteType"},res:{ResultItem:"resultList"}}}),this._map.set(ri.GET_FD_PROFILE,{head:{...i,servcmd:f.NAME.FD+"."+ri.GET_FD_PROFILE},body:{fromAccount:"",userIDList:void 0},keyMap:{res:{InfoItem:"resultList",SnsProfileItem:"tagValueList"}}}),this._map.set(ri.CHECK_FD,{head:{...i,servcmd:f.NAME.FD+"."+ri.CHECK_FD},body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"CheckType"},res:{InfoItem:"resultList"}}}),this._map.set(ri.GET_FD_APPLICATION_LIST,{head:{...i,servcmd:f.NAME.FD+"."+ri.GET_FD_APPLICATION_LIST},body:{fromAccount:"",applicationType:"",startTime:0,maxLimited:0,lastSequence:0},keyMap:{res:{PendencyItem:"resultList",AddSource:"source",AddTime:"time",AddWording:"wording",Image:"avatar",UnreadPendencyCount:"unreadCount",To_Account:"userID",PendencyType:"type"}}}),this._map.set(ri.RESPOND_FD_APPLICATION,{head:{...i,servcmd:f.NAME.FD+"."+ri.RESPOND_FD_APPLICATION},body:{fromAccount:"",responseFriendItem:[]},keyMap:{req:{tag:"TagName",action:"ResponseAction"},res:{ResultItem:"resultList"}}}),this._map.set(ri.DEL_FD_APPLICATION,{head:{...i,servcmd:f.NAME.FD+"."+ri.DEL_FD_APPLICATION},body:{fromAccount:"",type:"",userIDList:void 0},keyMap:{req:{type:"PendencyType",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(ri.REPORT_FD_APPLICATION,{head:{...i,servcmd:f.NAME.FD+"."+ri.REPORT_FD_APPLICATION},body:{fromAccount:"",latestTimeStamp:""},keyMap:{req:{latestTimeStamp:"LatestPendencyTimeStamp"}}}),this._map.set(ri.CREATE_FD_GRP,{head:{...i,servcmd:f.NAME.FD+"."+ri.CREATE_FD_GRP},body:{fromAccount:"",groupName:void 0,userIDList:void 0},keyMap:{req:{groupName:"GroupName",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(ri.DEL_FD_GRP,{head:{...i,servcmd:f.NAME.FD+"."+ri.DEL_FD_GRP},body:{fromAccount:"",nameList:void 0},keyMap:{req:{nameList:"GroupName"}}}),this._map.set(ri.GET_FD_GRP_LIST,{head:{...i,servcmd:f.NAME.FD+"."+ri.GET_FD_GRP_LIST},body:{fromAccount:"",lastSequence:0,needFriend:"Need_Friend_Type_Yes"},keyMap:{res:{ResultItem:"resultList",GroupName:"name",FriendNumber:"friendCount",To_Account:"userIDList"}}}),this._map.set(ri.UPDATE_FD_GRP,{head:{...i,servcmd:f.NAME.FD+"."+ri.UPDATE_FD_GRP},body:{fromAccount:"",oldName:"",newName:void 0,updateGroupItem:void 0},keyMap:{req:{oldName:"GroupOldName",newName:"GroupNewName"},res:{UpdateType:"type",ResultItem:"resultList"}}}),this._map.set(ri.GET_GRP_LIST,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_LIST},body:{memberAccount:"",limit:void 0,offset:void 0,groupType:void 0,responseFilter:{groupBaseInfoFilter:void 0,selfInfoFilter:void 0},isSupportTopic:0,needAppDefineData:1},keyMap:{req:{memberAccount:"Member_Account"},res:{GroupIdList:"groups",MsgSeq:"readedSequence",LastRecallTime:"_lastRevokedTime",AppDefinedData:"groupCustomField"}}}),this._map.set(ri.GET_GRP_PROFILE,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_PROFILE},body:{groupIDList:void 0,responseFilter:{groupBaseInfoFilter:void 0,groupCustomFieldFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0}},keyMap:{req:{groupIDList:"GroupIdList",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",groupCustomFieldFilter:"AppDefinedDataFilter_Group",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{GroupIdList:"groups",AppDefinedData:"groupCustomField",AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_Group:"groupCustomFieldFilter",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",InfoSeq:"infoSequence",MemberList:"members",GroupInfo:"groups",ShutUpUntil:"muteUntil",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(ri.CREATE_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ri.CREATE_GRP},body:{type:void 0,name:void 0,groupID:void 0,ownerID:void 0,introduction:void 0,notification:void 0,maxMemberNum:void 0,joinOption:void 0,memberList:void 0,groupCustomField:void 0,memberCustomField:void 0,webPushFlag:1,avatar:"",isSupportTopic:void 0,inviteOption:void 0},keyMap:{req:{ownerID:"Owner_Account",userID:"Member_Account",avatar:"FaceUrl",maxMemberNum:"MaxMemberCount",joinOption:"ApplyJoinOption",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",inviteOption:"InviteJoinOption"},res:{HugeGroupFlag:"avChatRoomFlag",OverJoinedGroupLimit_Account:"overLimitUserIDList"}}}),this._map.set(ri.DISMISS_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ri.DISMISS_GRP},body:{groupID:void 0}}),this._map.set(ri.UPDATE_GRP_PROFILE,{head:{...i,servcmd:f.NAME.GRP+"."+ri.UPDATE_GRP_PROFILE},body:{groupID:void 0,name:void 0,introduction:void 0,notification:void 0,avatar:void 0,joinOption:void 0,groupCustomField:void 0,muteAllMembers:void 0,inviteOption:void 0},keyMap:{req:{groupCustomField:"AppDefinedData",muteAllMembers:"ShutUpAllMember",joinOption:"ApplyJoinOption",avatar:"FaceUrl",inviteOption:"InviteJoinOption"},res:{AppDefinedData:"groupCustomField",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(ri.APPLY_JOIN_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ri.APPLY_JOIN_GRP},body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1,historyMessageFlag:void 0},keyMap:{req:{applyMessage:"ApplyMsg",historyMessageFlag:"HugeGroupHistoryMsgFlag"},res:{HugeGroupFlag:"avChatRoomFlag",AVChatRoomKey:"avChatRoomKey",RspMsgList:"messageList",ToGroupId:"to"}}}),this._map.set(ri.APPLY_JOIN_GRP_NOAUTH,function(){let{a2:e,tinyid:t,...s}=i;return{head:{...s,servcmd:f.NAME.BIG_GRP_NO_AUTH+"."+ri.APPLY_JOIN_GRP},body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1},keyMap:{req:{applyMessage:"ApplyMsg"},res:{HugeGroupFlag:"avChatRoomFlag"}}}}()),this._map.set(ri.QUIT_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ri.QUIT_GRP},body:{groupID:void 0}}),this._map.set(ri.SEARCH_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ri.SEARCH_GRP},body:{groupIDList:void 0,responseFilter:{groupBasePublicInfoFilter:["Type","Name","Introduction","Notification","FaceUrl","CreateTime","Owner_Account","LastInfoTime","LastMsgTime","NextMsgSeq","MemberNum","MaxMemberNum","ApplyJoinOption","InviteJoinOption"]}}}),this._map.set(ri.CHANGE_GRP_OWNER,{head:{...i,servcmd:f.NAME.GRP+"."+ri.CHANGE_GRP_OWNER},body:{groupID:void 0,newOwnerID:void 0},keyMap:{req:{newOwnerID:"NewOwner_Account"}}}),this._map.set(ri.HANDLE_GRP_APPLICATION,{head:{...i,servcmd:f.NAME.GRP+"."+ri.HANDLE_GRP_APPLICATION},body:{groupID:void 0,applicant:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(ri.HANDLE_INVITE_JOIN_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ri.HANDLE_INVITE_JOIN_GRP},body:{groupID:void 0,applicant:void 0,invitee:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",invitee:"Invited_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg"}}}),this._map.set(ri.HANDLE_GRP_INVITATION,{head:{...i,servcmd:f.NAME.GRP+"."+ri.HANDLE_GRP_INVITATION},body:{groupID:void 0,inviter:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{inviter:"Inviter_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(ri.GET_GRP_PENDENCY,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_PENDENCY},body:{startTime:void 0,limit:void 0,handleAccount:void 0},keyMap:{req:{handleAccount:"Handle_Account"},res:{To_Account:"userID",ApplyInviteMsg:"note"}}}),this._map.set(ri.DEL_GRP_SYSTEM_NOTICE,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.DEL_GRP_SYSTEM_NOTICE},body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(ri.AV_POLLING,{head:{...i,servcmd:f.NAME.BIG_GRP_POLLING+"."+ri.AV_POLLING},body:{USP:1,startSeq:1,startBroadcastSeq:void 0,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}}),this._map.set(ri.AV_NOAUTH_POLLING,function(){let{a2:e,tinyid:t,...s}=i;return{head:{...s,servcmd:f.NAME.BIG_GRP_POLLING_NO_AUTH+"."+ri.AV_POLLING},body:{USP:1,startSeq:1,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}}}()),this._map.set(ri.GET_ONLINE_MBR_NUM,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_ONLINE_MBR_NUM},body:{groupID:void 0},keyMap:{res:{OnlineMemberNum:"memberCount"}}}),this._map.set(ri.SET_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ri.SET_GRP_ATTR},body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(ri.MODIFY_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ri.MODIFY_GRP_ATTR},body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(ri.DEL_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ri.DEL_GRP_ATTR},body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key"}}}),this._map.set(ri.CLEAR_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ri.CLEAR_GRP_ATTR},body:{groupID:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]}}),this._map.set(ri.GET_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP_ATTR+"."+ri.GET_GRP_ATTR},body:{groupID:void 0,avChatRoomKey:void 0,groupType:1},keyMap:{req:{avChatRoomKey:"Key",groupType:"GroupType"}}}),this._map.set(ri.GET_GRP_NOTIFY,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_NOTIFY},body:{notifyReqList:[]},keyMap:{req:{notifyReqList:"NotifyReqList"},res:{NextMsgTime:"nextRevokedTime",NotifyMsgList:"notifyList",NotifyRspList:"notifyRspList"}}}),this._map.set(ri.UPDATE_GRP_COUNTER,{head:{...i,servcmd:f.NAME.GRP+"."+ri.UPDATE_GRP_COUNTER},body:{groupID:void 0,counterList:void 0,avChatRoomKey:void 0,mode:void 0},keyMap:{req:{counterList:"GroupCounter"}}}),this._map.set(ri.GET_GRP_COUNTER,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_COUNTER},body:{groupID:void 0,keyList:[],avChatRoomKey:void 0},keyMap:{req:{keyList:"GroupCounterKeys"}}}),this._map.set(ri.CREATE_TOPIC,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ri.CREATE_TOPIC},body:{groupID:void 0,topicName:void 0,avatar:void 0,customData:void 0,topicID:void 0,notification:void 0,introduction:void 0},keyMap:{req:{avatar:"FaceUrl"}}}),this._map.set(ri.DEL_TOPIC,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ri.DEL_TOPIC},body:{groupID:void 0,topicIDList:void 0},keyMap:{req:{topicIDList:"TopicIdList"},res:{DestroyResultItem:"resultList"}}}),this._map.set(ri.UPDATE_TOPIC_PROFILE,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ri.UPDATE_TOPIC_PROFILE},body:{groupID:void 0,topicID:void 0,avatar:void 0,customData:void 0,notification:void 0,introduction:void 0,muteAllMembers:void 0,topicName:void 0},keyMap:{req:{avatar:"FaceUrl",muteAllMembers:"ShutUpAllMember"}}}),this._map.set(ri.GET_TOPIC_LIST,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ri.GET_TOPIC_LIST},body:{groupID:void 0,topicIDList:void 0,MemberInfoFilter:["NoUnreadSeqList"]},keyMap:{req:{topicIDList:"TopicIdList"},res:{TopicAndSelfInfo:"topicInfoList",TopicInfo:"topic",GroupID:"groupID",ShutUpTime:"muteTime",ShutUpAllFlag:"muteAllMembers",LastMsgTime:"lastMessageTime",MsgSeq:"readedSequence",LastMsgSeq:"sequence"}}}),this._map.set(ri.GET_GRP_MBR_LIST,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_MBR_LIST},body:{groupID:void 0,limit:0,offset:void 0,next:void 0,memberRoleFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",MemberList:"members",ShutUpUntil:"muteUntil"}}}),this._map.set(ri.GET_AV_MBR_LIST,{head:{...i,servcmd:f.NAME.GRP_AV+"."+ri.GET_AV_MBR_LIST},body:{groupID:void 0,offset:void 0,filter:void 0},keyMap:{req:{offset:"Timestamp",filter:"Mark"},res:{NextTimestamp:"offset"}}}),this._map.set(ri.GET_GRP_MBR_PROFILE,{head:{...i,servcmd:f.NAME.GRP+"."+ri.GET_GRP_MBR_PROFILE},body:{groupID:void 0,userIDList:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{userIDList:"Member_List_Account",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{MemberList:"members",ShutUpUntil:"muteUntil",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",AppMemberDefinedData:"memberCustomField"}}}),this._map.set(ri.ADD_GRP_MBR,{head:{...i,servcmd:f.NAME.GRP+"."+ri.ADD_GRP_MBR},body:{groupID:void 0,silence:void 0,userIDList:void 0},keyMap:{req:{userID:"Member_Account",userIDList:"MemberList"},res:{MemberList:"members"}}}),this._map.set(ri.DEL_GRP_MBR,{head:{...i,servcmd:f.NAME.GRP+"."+ri.DEL_GRP_MBR},body:{groupID:void 0,userIDList:void 0,reason:void 0},keyMap:{req:{userIDList:"MemberToDel_Account"}}}),this._map.set(ri.BAN_AV_MBR,{head:{...i,servcmd:f.NAME.GRP+"."+ri.BAN_AV_MBR},body:{groupID:void 0,userIDList:void 0,duration:void 0,reason:""},keyMap:{req:{userIDList:"Members_Account",duration:"Duration",reason:"Description"}}}),this._map.set(ri.MODIFY_GRP_MBR_INFO,{head:{...i,servcmd:f.NAME.GRP+"."+ri.MODIFY_GRP_MBR_INFO},body:{groupID:void 0,topicID:void 0,userID:void 0,messageRemindType:void 0,nameCard:void 0,role:void 0,memberCustomField:void 0,muteTime:void 0},keyMap:{req:{userID:"Member_Account",memberCustomField:"AppMemberDefinedData",muteTime:"ShutUpTime",messageRemindType:"MsgFlag"}}}),this._map.set(ri.MARK_AV_MBR_INFO,{head:{...i,servcmd:f.NAME.GRP_AV+"."+ri.MARK_AV_MBR_INFO},body:{groupID:void 0,operationType:1,memberList:[]},keyMap:{req:{operationType:"CommandType",memberList:"MemberList",markType:"Marks",userID:"Member_Account"},res:{CommandType:"operationType",Marks:"markType",Member_Account:"userID"}}}),this._map.set(ri.CS,{head:{...i,servcmd:f.NAME.MSG_SEARCH+"."+ri.CS},body:{keywordList:void 0,keywordListMatchType:"or",account:void 0,groupID:void 0,count:100,cursor:void 0,messageTypeList:void 0,senderUserIDList:void 0,startTime:void 0,endTime:void 0},keyMap:{req:{keywordListMatchType:"MatchType",account:"PeerAccount",groupID:"GroupID",messageTypeList:"MsgTypeList",senderUserIDList:"SendUserIDList",keywords:"Keywords",keywordMatchType:"KeywordMatchType",count:"Count",miniBirthday:"UserBirthStart",maxBirthday:"UserBirthEnd",gender:"UserGenderType",groupTypeList:"GroupType",groupIDList:"GroupIdList"},res:{GroupID:"groupID",UserID:"userID",ErrorCode:"code",ErrorInfo:"message",TotalCount:"totalCount",Count:"messageCount",LastMsgTime:"lastMessageTime",ConversationMsgs:"searchResult",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer",MsgSeq:"sequence",ReqMsgSeq:"sequence",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgContent:"content",ClientSeq:"clientSequence",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",Users:"userList",ProfileItems:"profileItems",StrValue:"value",IntValue:"value",Groups:"groupList",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupOwnerUserID:"ownerID",GroupOwnerUserName:"ownerNick",GroupOwnerTinyID:"ownerTinyID",GroupMemberNum:"memberNum",GroupName:"name",GroupType:"type",GroupMembers:"groupMemberList",GroupMemberUserID:"userID",GroupMemberTinyID:"userTinyID",GroupMemberUserName:"nick",GroupMemberNameCard:"nameCard"}}}),this._map.set(ri.USER_CS,{head:{...i,servcmd:f.NAME.USER_SEARCH+"."+ri.CS},body:{keywords:void 0,keywordMatchType:0,miniBirthday:void 0,maxBirthday:void 0,gender:void 0,count:20,cursor:void 0}}),this._map.set(ri.GRP_CS,{head:{...i,servcmd:f.NAME.GRP_SEARCH+"."+ri.CS},body:{keywords:void 0,keywordMatchType:0,groupType:void 0,count:20,cursor:void 0}}),this._map.set(ri.MBR_CS,{head:{...i,servcmd:f.NAME.GRP_MEMBER_SEARCH+"."+ri.CS},body:{keywords:void 0,keywordMatchType:0,groupType:void 0,groupIDList:void 0,count:20,cursor:void 0}}),this._map.set(ri.SSO_STAT,{head:{...t,servcmd:f.NAME.IM_OPEN_STAT+"."+ri.SSO_STAT},body:{header:{},event:[],quality:[]},keyMap:{req:{SDKType:"sdk_type",SDKVersion:"sdk_version",deviceType:"device_type",platform:"platform",instanceID:"instance_id",traceID:"trace_id",SDKAppID:"sdk_app_id",userID:"user_id",tinyID:"tiny_id",extension:"extension",timestamp:"timestamp",networkType:"network_type",eventType:"event_type",code:"error_code",message:"error_message",moreMessage:"more_message",duplicate:"duplicate",costTime:"cost_time",level:"level",qualityType:"quality_type",reportIndex:"report_index",wholePeriod:"whole_period",totalCount:"total_count",rttCount:"success_count_business",successRateOfRequest:"percent_business",countLessThan1Second:"success_count_business",percentOfCountLessThan1Second:"percent_business",countLessThan3Second:"success_count_platform",percentOfCountLessThan3Second:"percent_platform",successCountOfBusiness:"success_count_business",successRateOfBusiness:"percent_business",successCountOfPlatform:"success_count_platform",successRateOfPlatform:"percent_platform",successCountOfMessageReceived:"success_count_business",successRateOfMessageReceived:"percent_business",avgRTT:"average_value",avgDelay:"average_value",avgValue:"average_value",uiPlatform:"ui_platform"}}}),this._map.set(ri.PING,{head:{...i,servcmd:f.NAME.HEARTBEAT+"."+ri.PING},body:{}}),this._map.set(ri.MSG_PUSH,{head:{...i,servcmd:f.NAME.IM_OPEN_PUSH+"."+ri.MSG_PUSH},body:{},keyMap:{res:{C2cMsgArray:"C2CMessageArray",GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",C2cNotifyMsgArray:"C2CNotifyMessageArray",C2cMsgInfo:"C2CReadReceiptArray",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyAdd_Account:"userID",ProfileImNick:"nick",PendencyType:"applicationType",C2CReadAllMsg:"readAllC2CMessage",IsNeedReadReceipt:"needReadReceipt",Status:"statusType"}}}),this._map.set(ri.MULTI_MSG_PUSH,{head:{...i,servcmd:f.NAME.IM_OPEN_PUSH+"."+ri.MULTI_MSG_PUSH},body:{},keyMap:{res:{GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyType:"applicationType"}}}),this._map.set(ri.MSG_PUSH_ACK,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ri.MSG_PUSH_ACK},body:{sessionData:void 0},keyMap:{req:{sessionData:"SessionData"}}}),this._map.set(ri.STATUS_FORCE_OFFLINE,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.STATUS_FORCE_OFFLINE},body:{},keyMap:{res:{C2cNotifyMsgArray:"C2CNotifyMessageArray",NoticeSeq:"noticeSequence",KickoutMsgNotify:"kickoutMsgNotify",NewInstInfo:"newInstanceInfo"}}}),this._map.set(ri.DOWNLOAD_MERGER_MSG,{head:{...i,servcmd:f.NAME.IM_LONG_MSG+"."+ri.DOWNLOAD_MERGER_MSG},body:{downloadKey:""},keyMap:{res:{Data:"data",Desc:"description",Ext:"extension",Download_Flag:"downloadFlag",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID"}}}),this._map.set(ri.UPLOAD_MERGER_MSG,{head:{...i,servcmd:f.NAME.IM_LONG_MSG+"."+ri.UPLOAD_MERGER_MSG},body:{messageList:[]},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",type:"MsgType",content:"MsgContent",data:"Data",description:"Desc",extension:"Ext",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody"}}}),this._map.set(ri.FOLLOW,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ri.FOLLOW},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"FollowItem"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(ri.UNFOLLOW,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ri.UNFOLLOW},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(ri.GET_FOLLOW_INFO,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ri.GET_FOLLOW_INFO},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{FollowInfo:"followInfoList",To_Account:"userID",FollowerCount:"followersCount",FollowingCount:"followingCount",MutualFollowingCount:"mutualFollowersCount"}}}),this._map.set(ri.GET_FOLLOW,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ri.GET_FOLLOW},body:{fromAccount:"",type:1,nextCursor:"",count:500},keyMap:{req:{type:"FollowType",nextCursor:"StartCursor",count:"WantNum"},res:{FollowItem:"resultList",To_Account:"userID",ProfileItem:"profileList"}}}),this._map.set(ri.CHECK_FOLLOW_TYPE,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ri.CHECK_FOLLOW_TYPE},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(ri.SET_TOKEN,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.SET_TOKEN},body:{tokenID:"",pushMsg:0,sdkAppID:0,businessID:"",deviceBrand:"",deviceToken:"",isTpns:0,isWebUniapp:0,notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:""},keyMap:{req:{tokenID:"TokenID",pushMsg:"PushMsg",sdkAppID:"EnterVersion",businessID:"BusiID",deviceBrand:"InstType",deviceToken:"VarToken",isTpns:"IsTpns",notificationStatus:"NotificationStatus",deviceModel:"DeviceModel",systemVersion:"SystemVersion",pushVersion:"PushPluginVersion"}}}),this._map.set(ri.STAT_FOREGROUND,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.STAT_FOREGROUND},body:{isWebUniapp:0}}),this._map.set(ri.STAT_BACKGROUND,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ri.STAT_BACKGROUND},body:{C2CUnread:0,GroupUnread:0,isWebUniapp:0},keyMap:{req:{c2cUnreadCount:"C2cUnread",groupUnreadCount:"GrpUnread"}}}),this._map.set(ri.PUSH_REPORT,{head:{...i,servcmd:f.NAME.OFFLINE_PUSH_REPORT+"."+ri.PUSH_REPORT},body:{eventList:[]},keyMap:{req:{eventList:"UinappPushEvents",type:"EventType",time:"EventTime",pushId:"ClickExt"}}}),this._map.set(ri.SET_ALL_RECEIVE_MSG_OPT,{head:{...i,servcmd:f.NAME.IM_MSG_LOGIC+"."+ri.SET_ALL_RECEIVE_MSG_OPT},body:{startTime:0,endTime:0,isRepeated:0,messageRemindType:0},keyMap:{req:{messageRemindType:"Level"}}}),this._map.set(ri.GET_ALL_RECEIVE_MSG_OPT,{head:{...i,servcmd:f.NAME.IM_MSG_LOGIC+"."+ri.GET_ALL_RECEIVE_MSG_OPT},body:{toAccount:void 0}})}has(e){return this._map.has(e)}get(e){return this._map.get(e)}update(){this._fillMap()}getKeyMap(e){return this.has(e)?this.get(e).keyMap||{}:(Ce.w(this._n+".getKeyMap unknown P:"+e),{})}getProtocolData(e){let{P:t,data:r}=e,o=this.get(t),n=null;if(r){let e=this._simpleDeepCopy(o),t=this._updateService(r,e),s=t.body,i=Object.create(null);for(let e in s)if(Object.prototype.hasOwnProperty.call(s,e)){if(i[e]=s[e],void 0===r[e])continue;i[e]=r[e]}t.body=i,n=this._getUplinkData(t)}else n=this._getUplinkData(o);return n}_getUplinkData(e){var e=this._dataCleaner(e),t=ft(e.head),t=Qn(e.body,this._getReqKeyMap(t));return e.body=t,e}_updateService(i,r){var o=ft(r.head);if(this._isFromGroupRequest(r)){let{type:e,groupID:t,groupIDList:s=[]}=i;$e(t)&&(t=s[0]||""),ot({type:e,groupID:t})&&(r.head.servcmd=f.NAME.GRP_COMMUNITY+"."+o)}return r}_isFromGroupRequest(e){return e.head.servcmd.includes(f.NAME.GRP)||e.head.servcmd.includes(f.NAME.GRP_ATTR)}_getReqKeyMap(e){e=this.getKeyMap(e);return{...Jn.req,...e.req}}_dataCleaner(e){var t,s=Array.isArray(e)?[]:Object.create(null);for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&He(t)&&null!==e[t]&&void 0!==e[t]&&("object"!=typeof e[t]?s[t]=e[t]:s[t]=this._dataCleaner.bind(this)(e[t]));return s}_simpleDeepCopy(s){var i,r=Object.keys(s),o={};for(let e=0,t=r.length;e<t;e++)i=r[e],Fe(s[i])?o[i]=Array.from(s[i]):we(s[i])?o[i]=this._simpleDeepCopy(s[i]):o[i]=s[i];return o}}let go=[ri.MSG_PUSH_ACK];class mo{constructor(e){this._sessionM=e,this._n="MsgDispatcher",this._eventHandlerMap=new Map,this._eventHandlerMap.set("C2CMessageArray",this._onC2CMsgArray.bind(this)),this._eventHandlerMap.set("groupMessageArray",this._onGroupMsgArray.bind(this)),this._eventHandlerMap.set("groupTips",this._onGroupTips.bind(this)),this._eventHandlerMap.set("C2CNotifyMessageArray",this._onC2CNotifyMsgArray.bind(this)),this._eventHandlerMap.set("C2CReadReceiptArray",this._onC2CReadReceiptArray.bind(this)),this._eventHandlerMap.set("profileModify",this._onProfileModified.bind(this)),this._eventHandlerMap.set("friendListMod",this._onRelationChainModified.bind(this)),this._eventHandlerMap.set("recentContactMod",this._onRecentContact.bind(this)),this._eventHandlerMap.set("readAllC2CMessage",this._onAllMsgRead.bind(this)),this._eventHandlerMap.set("c2cMessageModified",this._onC2CMsgModified.bind(this)),this._eventHandlerMap.set("groupMessageModified",this._onGroupMsgModified.bind(this)),this._eventHandlerMap.set("userStatusList",this._onUserStatusList.bind(this)),this._eventHandlerMap.set("messageExtensionNotify",this._onMsgExtNotify.bind(this)),this._eventHandlerMap.set("messageReactionNotifyList",this._onMsgReactionNotifyList.bind(this)),this._eventHandlerMap.set("messageReactionNotify",this._onMsgReactionNotify.bind(this)),this._eventHandlerMap.set("followChangeList",this._onFollowNotify.bind(this)),this._keys=[...this._eventHandlerMap.keys()]}_onC2CMsgArray(e){var t=this._sessionM.get(ys);e.dataList.forEach(e=>{var t;1===e.isSyncMessage&&(t=e.from,e.from=e.to,e.to=t)}),1===e.needSync&&this._sessionM.get(Us).syncOnNeed(),t.onNewMessage({dataList:e.dataList,isInstantMessage:!0})}_onC2CMsgModified(e){this._sessionM.get(ys).onMsgModified(e)}_onGroupMsgArray(e){var t=this._sessionM.get(vs);t&&t.onNewMessage({event:e.event,dataList:e.dataList,isInstantMessage:!0})}_onGroupMsgModified(e){var t=this._sessionM.get(vs);t&&t.onMsgModified(e)}_onGroupTips(e){var t=this._sessionM.get(vs);if(t){var{event:s,dataList:i,isInstantMessage:r=!0,isSyncingEnded:o}=e;switch(s){case 4:case 6:t.onNewGroupTips({event:s,dataList:i});break;case 5:for(let e=0;e<i.length;e++)if(Fe(i[e].elements.revokedInfos))t.onMsgRevoked({dataList:i});else if(Fe(i[e].elements.groupMessageReadNotice))t.onMsgReadNotice({dataList:i});else{if(!Fe(i[e].elements.readReceiptList)){t.onNewGroupSystemNotice({dataList:i,isInstantMessage:r,isSyncingEnded:o});break}t.onReadReceiptList({dataList:i})}break;case 12:this._sessionM.get(Ds).onNewGroupAtTips({dataList:i});break;default:Ce.l(this._n+`._onGroupTips unknown event:${s} dataList:`,i)}}}_onC2CNotifyMsgArray(e){let t=e["dataList"];if(Fe(t)){let e=this._sessionM.get(ys);t.forEach(s=>{if(be(s))if(s.hasOwnProperty("kickoutMsgNotify")){let{kickoutMsgNotify:{kickType:e,newInstanceInfo:t={}}}=s;1===e?this._sessionM.onMultipleAccountKickedOut(t):2===e?this._sessionM.onMultipleDeviceKickedOut(t):3===e&&this._sessionM.onRestApiKickedOut(t)}else s.hasOwnProperty("c2cMessageRevokedNotify")?e&&e.onMsgRevoked({dataList:t},!0):s.hasOwnProperty("c2cMessageReadReceipt")?e&&e.onMsgReadReceipt({dataList:t}):s.hasOwnProperty("c2cMessageReadNotice")?e&&e.onMsgReadNotice({dataList:t}):s.hasOwnProperty("muteNotificationsSync")&&this._sessionM.get(Ds).onC2CMsgRemindTypeSynced({dataList:t})})}}_onC2CReadReceiptArray(e){this._sessionM.get(ys).onReadReceiptList(e)}_onProfileModified(e){this._sessionM.get(Ts).onProfileModified({dataList:e.dataList});var t=this._sessionM.get(Es);t&&t.onFriendProfileModified({dataList:e.dataList})}_onRelationChainModified(e){this._sessionM.get(Ts).onRelationChainModified({dataList:e.dataList});var t=this._sessionM.get(Es);t&&t.onRelationChainModified({dataList:e.dataList})}_onRecentContact(e){e=e.dataList;if(Fe(e)){let o=this._sessionM.get(Ds);o&&e.forEach(r=>{let e=r["pushType"];if(1===e){let e=r["recentContactDeleteItem"];o.onConvDeleted(e.recentContactList)}else if(2===e){let e=r["recentContactTopItem"];o.onConvPinnedStatus(e.recentContactList,!0)}else if(3===e){let e=r["recentContactTopItem"];o.onConvPinnedStatus(e.recentContactList,!1)}else if(4===e){let e=r["recentContactMarkContact"];o.onConvMarkUpdated(e.recentContactMarkContactItem)}else if(5===e){let e=r["recentContactCreateContactGroup"];o.onConvGroupCreated(e.msgContactGroupContactItem)}else if(6===e){let e=r["recentContactDelContactGroup"];o.onConvGroupDeleted(e.msgGroupItem)}else if(7===e){let e=r["recentContactUpdateContactGroup"],{updateType:t,msgUpdateGroup:s,msgUpdateContact:i}=e;if(1===t){let e=s["updateGroupType"];1===e?o.onConvGroupNameUpdated(s):2===e&&o.onConvInGroupUpdated(s)}else 2===t&&o.onConvAddedToOrDeletedFromGroup(i)}})}}_onAllMsgRead(e){var e=e["dataList"],t=this._sessionM.get(Ds);t&&t.onPushedAllMessageRead(e)}_onUserStatusList(e){this._sessionM.get(Ts).onUserStatusUpdated(e)}_onMsgExtNotify(e){this._sessionM.get(Cs).onMsgExtNotify(e)}_onMsgReactionNotifyList(e){this._sessionM.get(Ys).onReactionNotifyList(e)}_onMsgReactionNotify(e){this._sessionM.get(Ys).onReactionNotify(e)}_onFollowNotify(e){this._sessionM.get(zs).onFollowNotify(e)}_onTopicLatestMsg(e){this._sessionM.get(Ss).onTopicLatestMsg(e)}onMessage(e){var t=e["body"];if(this._filterMsgFromIMOpenPush(e)){var{eventArray:s,isInstantMessage:i,isSyncingEnded:r,needSync:o}=t;if(Fe(s)){var n,a,l;for(let e=0,t=s.length;e<t;e++)if(100===(l=(n=s[e]).event))this._onRoomCustomData(n.content);else if(24===l)this._onAllRcvMsgOptNotify(n);else if(26===l)this._onTopicLatestMsg(n);else{let e=Object.keys(n).find(e=>-1!==this._keys.indexOf(e));e?(a=14===l?{readAllC2CMessage:n[e],groupMessageReadInfoList:n.groupMessageReadNotice||[]}:16===l?{userID:n.userID,timestamp:n.timestamp,readReceiptList:n[e]}:n[e],this._eventHandlerMap.get(e)({event:l,dataList:a,isInstantMessage:i,isSyncingEnded:r,needSync:o})):Ce.l(this._n+".onMessage unknown eventItem:",n)}}}}_onRoomCustomData(e){this._sessionM.get(Bs).onRoomCustomDataReceived(e),Ce.l(this._n+"._onRoomCustomData data:"+e)}_onAllRcvMsgOptNotify(e){this._sessionM.get(Ds).onAllRcvMsgOptNotify(e)}_filterMsgFromIMOpenPush(e){let{head:t,body:s}=e,i=t["servcmd"],r=!1;if(!(r=$e(i)?r:i.includes(f.NAME.IM_CONFIG_MANAGER)||i.includes(f.NAME.OVERLOAD_PUSH)||i.includes(f.NAME.STAT_SERVICE)))return!0;if(i.includes(ri.PUSHED_CLOUD_CTRL_CONFIG))this._sessionM.get(ws).onPushedConfig(s);else if(i.includes(ri.PUSHED_COMMERCIAL_CONFIG))this._sessionM.get(qs).onPushedConfig(s);else if(i.includes(ri.OVERLOAD_NOTIFY))this._sessionM.onPushedServerOverload(s);else if(i.includes(ri.KICK_OTHER)){let e=Date.now(),t=(this._sessionM.reLoginOnKickOther(),new Ti("kickOther")),s=this._sessionM.get(Ms).getLastWsHelloTs(),i=e-s;t.setMessage(`last wshello time:${s} diff:${i}ms`).end()}return!1}}let fo=[{cmd:ri.GET_GRP_PROFILE,interval:1,count:8},{cmd:ri.UPDATE_GRP_PROFILE,interval:1,count:8},{cmd:ri.GET_AV_MBR_LIST,interval:3,count:1},{cmd:ri.GET_GRP_PENDENCY,interval:1,count:15},{cmd:ri.GET_TOPIC_LIST,interval:1,count:10},{cmd:ri.SET_GRP_ATTR,interval:5,count:10},{cmd:ri.MODIFY_GRP_ATTR,interval:5,count:10},{cmd:ri.DEL_GRP_ATTR,interval:5,count:10},{cmd:ri.CLEAR_GRP_ATTR,interval:5,count:10},{cmd:ri.GET_GRP_ATTR,interval:5,count:20},{cmd:ri.UPDATE_GRP_COUNTER,interval:5,count:20},{cmd:ri.GET_GRP_COUNTER,interval:5,count:20},{cmd:ri.SET_ALL_MSG_READ,interval:1,count:1},{cmd:ri.GET_USER_STATUS,interval:5,count:20},{cmd:ri.SUB_USER_STATUS,interval:5,count:20},{cmd:ri.UNSUB_USER_STATUS,interval:5,count:20},{cmd:ri.CS,interval:5,count:20},{cmd:ri.GRP_CS,interval:5,count:20},{cmd:ri.MBR_CS,interval:5,count:20},{cmd:ri.USER_CS,interval:5,count:20},{cmd:ri.CHECK_FOLLOW_TYPE,interval:5,count:20},{cmd:ri.GET_GRP_ROAMING_MSG,interval:1,count:20},{cmd:ri.GET_C2C_ROAMING_MSG,interval:1,count:20}],Mo=new Map,Io=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];for(let e=0,t=Io.length;e<t;e++)Mo.set(e,Io[e]);function Co(s){let i,r,o=s,n="";for(let e=0,t=(o=s.length%8!=0?"0".repeat(8-s.length%8)+s:o).length;e<t;e+=8)i=parseInt(o.slice(e,e+4),2),r=parseInt(o.slice(e+4,e+8),2),n+=Mo.get(i)+Mo.get(r);return n}class To extends oi{constructor(e){super(e),this._n="SessionModule",this._platform=this.getPlatform(),this._pHandler=new po(this),this._msgDispatcher=new mo(this),this._cmdFreqLimitMap=new Map,this._cmdReqInfoMap=new Map,this._serverOverloadInfoMap=new Map,this._incrementalPullContactFlag=!0,this._init(),this.getIEmitInst().on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_init(){this._updateCmdFreqLimitMap(fo)}_onCloudConfig(){var e=this.getCloudConfig("cmd_frequency_limit");$e(e)||(e=JSON.parse(e),this._updateCmdFreqLimitMap(e))}_updateCmdFreqLimitMap(e){e.forEach(e=>{this._cmdFreqLimitMap.set(e.cmd,{interval:e.interval,count:e.count})})}updateProtocolConfig(){this._pHandler.update()}req(e){Ce.d(this._n+".req options:",e);var t=e["P"];if(!this._pHandler.has(t))return Ce.w(this._n+".req unknown P:"+t),ni({code:ei.NO_PROTOCOL});var e=this.getProtocolData(e),s=e.head["servcmd"];let i;return this._isFreqOverLimit(s)?(i=ei.OVER_FREQUENCY_LIMIT,ni({code:i,message:this.getErrMsg(i,this._getCmd(s))})):this._isServerOverload(s)?(i=ei.OPEN_SERVICE_OVERLOAD_ERROR,ni({code:i,message:this.getErrMsg(i,this._getCmd(s))})):(s=this.get(ks),go.includes(t)?s.simplySend(e):s.send(e))}getKeyMap(e){return this._pHandler.getKeyMap(e)}genCommonHead(){var e=this.get(Rs);return{ver:"v4",platform:this._platform,websdkappid:a,websdkversion:r,a2:e.getA2Key()||void 0,tinyid:e.getTinyID()||void 0,status_instid:e.getStatusInstanceID(),sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getA2Key()?void 0:e.getUserID(),usersig:e.getA2Key()?void 0:e.getUserSig(),sdkability:75689843,sdkability_ext:Co(""),cappid:e.getApplicationID(),cs:0}}genCosSpecifiedHead(){var e=this.get(Rs);return{ver:"v4",platform:this._platform,websdkappid:a,websdkversion:r,sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getUserID(),usersig:e.getUserSig(),status_instid:e.getStatusInstanceID(),sdkability:75689843,sdkability_ext:Co(""),cappid:e.getApplicationID(),cs:0}}genSSOReportHead(){var e=this.get(Rs);return{ver:"v4",platform:this._platform,websdkappid:a,websdkversion:r,sdkappid:e.getSDKAppID(),contenttype:"",reqtime:0,identifier:"",usersig:"",status_instid:e.getStatusInstanceID(),sdkability:75689843,sdkability_ext:Co(""),cappid:e.getApplicationID(),cs:0}}getProtocolData(e){return this._pHandler.getProtocolData(e)}trans(e){var{servcmd:e,data:t}=e,e={head:{...this.genCommonHead(),servcmd:e},body:t};return this.get(ks).send(e)}sendComboMessage(e){var{servcmd:e,data:t}=e,e={head:{...this.genCommonHead(),servcmd:e},body:t};return this.get(ks).send(e)}onErrorCodeNotZero(s){let e=s["errorCode"];if(e===ei.HELLO_ANSWER_KICKED_OUT){let{kickType:e,newInstanceInfo:t={}}=s;1===e?this.onMultipleAccountKickedOut(t):2===e?this.onMultipleDeviceKickedOut(t):3===e&&this.onRestApiKickedOut(t)}e!==ei.MSG_A2KEY_EXPIRED&&e!==ei.ACCOUNT_A2KEY_EXPIRED||(this._onUserSigExpired(),this.get(ks).reConnect())}onMessage(e){var t=e["body"],{needAck:t=0,sessionData:s}=t;1===t&&this._sendACK(s),this._msgDispatcher.onMessage(e)}onReconnected(e){this._incrementalPullContactFlag=e<=300,this._reLoginOnReconnected()}reLoginOnKickOther(){Ce.l(this._n+".reLoginOnKickOther"),this._reLogin()}_reLoginOnReconnected(){Ce.l(this._n+"._reLoginOnReconnected"),this._reLogin()}_reLogin(){let a=this._n+"._reLogin";if(this.isLoggedIn()){let e=0;var s=this.get(Ms).getPushModule();s&&(e=s.getUniAppPlatform());let n=new Ti("reLogin");this.req({P:ri.LOGIN,data:{isWebUniapp:e,customInfo:this.get(Rs).getCustomLoginInfo()}}).then(e=>{var{instanceID:e,customStatus:s}=e.data,i=this.get(Rs),r=Cn(s),o=(i.setStatusInstanceID(e),this.get(ks)),e=`socketID:${o.getSocketID()} instanceID:${e} customStatus:`+r,e=(n.setMessage(e).end(!0),Ce.l(a+" ok. "+e),i.getCustomStatus()!==r&&this.get(Ts).onUserStatusUpdated({dataList:[{to:this.getMyUserID(),statusType:t.USER_STATUS_ONLINE,customStatus:s}]}),o.diagnose(),this.get(Ds).syncConvList(this._incrementalPullContactFlag).then(()=>{Ce.l(a+", sync conv list ok."),this.get(Fs).start()}),this.get(vs)),i=(e&&e.updateLocalMainSequenceOnReconnected(),this.get(Ss)),r=(i.resetGetTopicTime(),i.getTopicListOnReconnected(),this.get(zs));r&&r.clearCacheOnReconnected()})}}onMultipleAccountKickedOut(e){this.get(Ms).onMultipleAccountKickedOut(e)}onMultipleDeviceKickedOut(e){this.get(Ms).onMultipleDeviceKickedOut(e)}_onUserSigExpired(){this.get(Ms).onUserSigExpired()}onRestApiKickedOut(e){this.get(Ms).onRestApiKickedOut(e)}_sendACK(e){this.req({P:ri.MSG_PUSH_ACK,data:{sessionData:e}})}_isFreqOverLimit(e){e=e.split(".")[1];if(!this._cmdFreqLimitMap.has(e))return!1;if(!this._cmdReqInfoMap.has(e))return this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1;var{count:t,interval:s}=this._cmdFreqLimitMap.get(e),{startTime:i,requestCount:r}=this._cmdReqInfoMap.get(e);if(Date.now()-i>1e3*s)return this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1;this._cmdReqInfoMap.set(e,{startTime:i,requestCount:r+=1});let o=t<r?!0:!1;return o}_isServerOverload(e){if(!this._serverOverloadInfoMap.has(e))return!1;var{overloadTime:t,waitingTime:s}=this._serverOverloadInfoMap.get(e);let i=!1;return i=Date.now()-t<=1e3*s||(this._serverOverloadInfoMap.delete(e),!1)}_getCmd(e){let t="";if(e.includes(".")){var s,i=e.split(".")[1];for(s in ri)if(ri[s]===i){t=s;break}}return t}onPushedServerOverload(e){var{overloadCommand:e,waitingTime:t}=e;this._serverOverloadInfoMap.set(e,{overloadTime:Date.now(),waitingTime:t}),Ce.w(this._n+`.onPushedServerOverload waitingTime:${t}s cmd:`+this._getCmd(e))}reset(){Ce.l(this._n+".reset"),this._updateCmdFreqLimitMap(fo),this._cmdReqInfoMap.clear(),this._serverOverloadInfoMap.clear(),this._incrementalPullContactFlag=!0}}class yo extends oi{constructor(e){super(e),this._n="CloudControlModule",this._cloudConfig=new Map,this._expiredTime=0,this._version=0,this._isFetching=!1}getCloudConfig(e){return $e(e)?this._cloudConfig:this._cloudConfig.has(e)?this._cloudConfig.get(e):void 0}getServerConfig(e){var t={code:0,data:""};return!$e(e)&&this._cloudConfig.has(e)&&(t.data=this._cloudConfig.get(e)),Promise.resolve(t)}_canFetch(){return this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime}fetchConfig(){let r=this._n+".fetchConfig",e=this._canFetch();if(Ce.l(r+" canFetch:"+e),e){let i=new Ti("fetchCloudCtrlConfig"),e=this.get(Rs).getSDKAppID();this._isFetching=!0,this.req({P:ri.FETCH_CLOUD_CTRL_CONFIG,data:{SDKAppID:e,version:this._version}}).then(e=>{this._isFetching=!1;var{version:t,cloudControlConfig:s}=e.data;i.setMessage(`version:${this._version} newVersion:${t} config:`+s).end(),Ce.l(r+" ok"),this._parse(e.data)}).catch(e=>{this._isFetching=!1,i.setError(e).end(),Ce.l(r+" failed. error:",e),this._setExpiredTime(12e4)})}}onPushedConfig(e){Ce.l(this._n+".onPushedConfig config:",e),new Ti("pushedCloudCtrlConfig").setMessage(`newVersion:${e.version} config:`+e.cloudControlConfig).end(),this._parse(e)}onCheckTimer(e){this._canFetch()&&this.fetchConfig()}_parse(e){var s=this._n+"._parse",{errorCode:t,errorMessage:i,cloudControlConfig:r,version:o,expiredTime:n}=e;if(0===t){if(this._version!==o){let t=null;try{t=JSON.parse(r)}catch(e){this.isPrivateNetWork()||Ce.e(s+" failed. config:",r)}t&&(this._cloudConfig.clear(),Object.keys(t).forEach(e=>{this._cloudConfig.set(e,t[e])}),this._version=o,this.emitIEvt(Yi.CLOUD_CONFIG))}this._setExpiredTime(1e3*n)}else $e(t)?(Ce.l(s+" failed. Invalid message format:",e),this._setExpiredTime(36e5)):(Ce.e(s+` errorCode:${t} errorMessage:`+i),this._setExpiredTime(12e4))}_setExpiredTime(e){this._expiredTime=Date.now()+e}reset(){Ce.l(this._n+".reset"),this._cloudConfig.clear(),this._expiredTime=0,this._version=0,this._isFetching=!1}}class vo extends oi{constructor(e){super(e),this._n="RecoverMsgModule",this.PULL_LIMIT_COUNT=15}start(){this._recoverGroupChat(),this._recoverC2CChat()}_recoverGroupChat(){let e=this._getLocalConvList().filter(e=>e.type===t.CONV_GROUP&&e.groupProfile.type!==t.GRP_AVCHATROOM),i=this.get(Ds),r,o,n,a,l,d=[];e.forEach(e=>{var{conversationID:e,lastMessage:s}=e;o=e.replace(t.CONV_GROUP,""),r=i.getLocalLastMessage(e),s&&0!==s.lastSequence&&r&&(a=s.lastSequence,n=r.sequence,l=a-n,0<n)&&1<=l&&l<300?this._recoverGroupMsg({groupID:o,localLastMessageSequence:n,remoteLastMessageSequence:a}):d.push(o)}),this._getGroupNotice(d)}_recoverC2CChat(){let e=this._getLocalConvList().filter(e=>e.type===t.CONV_C2C),s=this.get(Ds),i,r,o,n,a=[Promise.resolve()];e.forEach(e=>{var{conversationID:e,lastMessage:t}=e;i=s.getLocalLastMessage(e),t&&0!==t.lastTime&&i&&(o=t.lastTime,r=i.time,n=o-r,0<r)&&1<=n&&n<=600&&a.push(this._recoverC2CMsg({conversationID:e,localLastMessageTime:r,remoteLastMessageTime:o}))}),Promise.all(a).then(()=>{Ce.l(this._n+"._recoverC2CChat all done"),this.get(Us).syncOnReconnected()})}_getLocalConvList(){return this.get(Ds).getLocalConvList()}_recoverGroupMsg(e){let l=this._n+"._recoverGroupMsg",{groupID:d,localLastMessageSequence:c,remoteLastMessageSequence:_}=(Ce.l(l+" options:",e),e),u=JSON.stringify(e),h=new Ti("_recoverGroupMsg");h.setMessage(u),this._getGroupRoamingMsg({groupID:d,sequence:c}).then(e=>{var{complete:o,messageList:n}=e.data;if(!$e(n)){let e=n[0].sequence,s=n.map(e=>e.sequence),i=u+` complete:${o} sequenceList:`+s;Ce.l(l+" "+i),e!==c&&e<_&&2!==o&&this._recoverGroupMsg({groupID:d,localLastMessageSequence:e,remoteLastMessageSequence:_}),h.setMessage(i).end();var a=this.get(vs);1<n.length&&n.sort((e,t)=>e.sequence-t.sequence);let r=!1;for(let e=0,s=n.length;e<s;e++)if(n[e].from===t.CONV_SYSTEM){r=!0;break}if(r)for(let s=0,e=n.length;s<e;s++){let e=n[s];e.from!==t.CONV_SYSTEM?a.onNewMessage({dataList:[e],isInstantMessage:!1,updateUnreadCount:!1}):a.onNewGroupTips({event:e.event,dataList:[e]})}else a.onNewMessage({dataList:n,isInstantMessage:!1,updateUnreadCount:!1})}}).catch(e=>{h.setError(e).end(),Ce.w(l+" failed. error:",e)})}_getGroupNotice(s){var e=s.length;if(Ce.l(this._n+"._getGroupNotice length:"+e),0!==e){var i=this.get(vs);if(e<=10)i.getNotice(s);else{let t=Math.floor(e/10);5<=t&&(t=5);for(let e=0;e<=t;e++)i.getNotice(s.slice(10*e,10*(e+1)))}}}_getGroupRoamingMsg(e){var{groupID:e,sequence:t}=e;return this.req({P:ri.GET_GRP_ROAMING_MSG,data:{groupID:e,count:this.PULL_LIMIT_COUNT,sequence:t+this.PULL_LIMIT_COUNT-1}})}_recoverC2CMsg(e){let r=this._n+"._recoverC2CMsg",{conversationID:o,localLastMessageTime:t,remoteLastMessageTime:n}=(Ce.l(r+" options:",e),e),a=JSON.stringify(e),l=new Ti("_recoverC2CMsg");return l.setMessage(a),this._getC2CRoamingMsg({conversationID:o,time:t}).then(e=>{var{complete:t,messageList:s}=e.data;if(!$e(s)){let e=s.length;this.get(ys).onNewMessage({dataList:s,isInstantMessage:!0});var i=s[e-1].time,s=s.map(e=>e.random),s=a+` complete:${t} randomList:`+s;if(Ce.l(r+" "+s),l.setMessage(s).end(),i<n&&1!==t)return this._recoverC2CMsg({conversationID:o,localLastMessageTime:i,remoteLastMessageTime:n})}}).catch(e=>{l.setError(e).end(),Ce.w(r+" failed. error:",e)})}_getC2CRoamingMsg(e){var{conversationID:e,time:s}=e;return this.req({P:ri.GET_C2C_ROAMING_MSG,data:{peerAccount:e.replace(t.CONV_C2C,""),count:this.PULL_LIMIT_COUNT+1,lastMessageTime:s,direction:1}})}reset(){Ce.l(this._n+".reset")}}class Eo{constructor(){this._n="AvgE2EDelay",this._e2eDelayArray=[]}addMessageDelay(e){e=me()-e;0<=e&&this._e2eDelayArray.push(e)}_calcAvg(e,t){if(0===t)return 0;let s=0;return e.forEach(e=>{s+=e}),Mt(s/t,1)}_calcCountWithLimit(e){let{e2eDelayArray:t,min:s,max:i}=e;return t.filter(e=>s<=e&&e<i).length}_calcPercent(e,t){let s=Mt(e/t*100,2);return s=100<s?100:s}_checkE2EDelayException(o,t){var n=o.filter(e=>t<e);if(0<n.length){let e=n.length,t=Math.min(...n),s=Math.max(...n),i=this._calcAvg(n,e),r=Mt(e/o.length*100,2);50<r&&new Ti("messageE2EDelayException").setMessage(`count:${e} min:${t} max:${s} avg:${i} percent:`+r).setLevel("warning").end()}}getStatResult(){var e,t,s,i,r,o,n=this._e2eDelayArray.length;return 0===n?null:(e=[...this._e2eDelayArray],t=this._calcCountWithLimit({e2eDelayArray:e,min:0,max:1}),s=this._calcCountWithLimit({e2eDelayArray:e,min:1,max:3}),i=this._calcPercent(t,n),r=this._calcPercent(s,n),o=this._calcAvg(e,n),this._checkE2EDelayException(e,3),e.length=0,this.reset(),{totalCount:n,countLessThan1Second:t,percentOfCountLessThan1Second:i,countLessThan3Second:s,percentOfCountLessThan3Second:r,avgDelay:o})}reset(){this._e2eDelayArray.length=0}}class So{constructor(){this._n="AvgRTT",this._requestCount=0,this._rttArray=[]}addRequestCount(){this._requestCount+=1}addRTT(e){this._rttArray.push(e)}_calcTotalCount(){return this._requestCount}_calcRTTCount(e){return e.length}_calcSuccessRateOfRequest(e,t){if(0===t)return 0;let s=Mt(e/t*100,2);return s=100<s?100:s}_calcAvg(e,t){if(0===t)return 0;let s=0;return e.forEach(e=>{s+=e}),parseInt(s/t)}_calcMax(){return Math.max(...this._rttArray)}_calcMin(){return Math.min(...this._rttArray)}getStatResult(){var e,t,s=this._calcTotalCount(),i=[...this._rttArray];return 0===s?null:(e=this._calcRTTCount(i),t=this._calcSuccessRateOfRequest(e,s),i=this._calcAvg(i,e),Ce.l(`${this._n}.getStatResult max:${this._calcMax()} min:${this._calcMin()} avg:`+i),this.reset(),{totalCount:s,rttCount:e,successRateOfRequest:t,avgRTT:i})}reset(){this._requestCount=0,this._rttArray.length=0}}class Do{constructor(){this._map=new Map}initMap(e){e.forEach(e=>{this._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})})}addTotalCount(e){return!($e(e)||!this._map.has(e)||(this._map.get(e).totalCount+=1,0))}addSuccessCount(e){return!($e(e)||!this._map.has(e)||(this._map.get(e).successCount+=1,0))}addFailedCountOfUserSide(e){return!($e(e)||!this._map.has(e)||(this._map.get(e).failedCountOfUserSide+=1,0))}addCost(e,t){return!($e(e)||!this._map.has(e)||(this._map.get(e).costArray.push(t),0))}addFileSize(e,t){return!($e(e)||!this._map.has(e)||(this._map.get(e).fileSizeArray.push(t),0))}_calcSuccessRateOfBusiness(e){if($e(e)||!this._map.has(e))return-1;e=this._map.get(e);let t=Mt(e.successCount/e.totalCount*100,2);return t=100<t?100:t}_calcSuccessRateOfPlatform(e){if($e(e)||!this._map.has(e))return-1;var t=this._map.get(e);let s=this._calcSuccessCountOfPlatform(e)/t.totalCount*100;return s=100<(s=Mt(s,2))?100:s}_calcTotalCount(e){return $e(e)||!this._map.has(e)?-1:this._map.get(e).totalCount}_calcSuccessCountOfBusiness(e){return $e(e)||!this._map.has(e)?-1:this._map.get(e).successCount}_calcSuccessCountOfPlatform(e){return $e(e)||!this._map.has(e)?-1:(e=this._map.get(e)).successCount+e.failedCountOfUserSide}_calcAvg(e){return $e(e)||!this._map.has(e)?-1:e===hi?this._calcAvgSpeed(e):this._calcAvgCost(e)}_calcAvgCost(e){var t=this._map.get(e).costArray.length;if(0===t)return 0;let s=0;return this._map.get(e).costArray.forEach(e=>{s+=e}),parseInt(s/t)}_calcAvgSpeed(e){let t=0,s=0;return this._map.get(e).costArray.forEach(e=>{t+=e}),this._map.get(e).fileSizeArray.forEach(e=>{s+=e}),parseInt(1e3*s/t)}getStatResult(e){var t,s,i,r,o,n=this._calcTotalCount(e);return 0===n?null:(t=this._calcSuccessCountOfBusiness(e),s=this._calcSuccessRateOfBusiness(e),i=this._calcSuccessCountOfPlatform(e),r=this._calcSuccessRateOfPlatform(e),o=this._calcAvg(e),this.reset(e),{totalCount:n,successCountOfBusiness:t,successRateOfBusiness:s,successCountOfPlatform:i,successRateOfPlatform:r,avgValue:o})}reset(e){$e(e)?this._map.clear():this._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})}}class Ro{constructor(){this._lastMap=new Map,this._currentMap=new Map}initMap(e){e.forEach(e=>{this._lastMap.set(e,new Map),this._currentMap.set(e,new Map)})}addMessageSequence(s){let{key:i,message:e}=s;if($e(i)||!this._lastMap.has(i)||!this._currentMap.has(i))return!1;var{conversationID:r,sequence:o}=e,r=r.replace(t.CONV_GROUP,"");if(0===this._lastMap.get(i).size)this._addCurrentMap(s);else if(this._lastMap.get(i).has(r)){let e=this._lastMap.get(i).get(r),t=e.length-1;o>e[0]&&o<e[t]?(e.push(o),e.sort(),this._lastMap.get(i).set(r,e)):this._addCurrentMap(s)}else this._addCurrentMap(s);return!0}_addCurrentMap(e){var{key:e,message:s}=e,{conversationID:s,sequence:i}=s,s=s.replace(t.CONV_GROUP,"");this._currentMap.get(e).has(s)||this._currentMap.get(e).set(s,[]),this._currentMap.get(e).get(s).push(i)}_copyData(t){if(!$e(t)){this._lastMap.set(t,new Map);let e=this._lastMap.get(t);for(var[s,i]of this._currentMap.get(t))e.set(s,i);e=null,this._currentMap.set(t,new Map)}}getStatResult(e){if($e(this._currentMap.get(e))||$e(this._lastMap.get(e)))return null;if(0===this._lastMap.get(e).size)return this._copyData(e),null;let i=0,r=0;if(this._lastMap.get(e).forEach((e,t)=>{var e=[...e.values()],s=e.length;i+=e[s-1]-e[0]+1,r+=s}),0===i)return null;let t=Mt(r/i*100,2);return 100<t&&(t=100),this._copyData(e),{totalCount:i,successCountOfMessageReceived:r,successRateOfMessageReceived:t}}reset(){this._currentMap.clear(),this._lastMap.clear()}}class Lo extends oi{constructor(e){super(e),this._n="QualityStatModule",this.TAG="im-ssolog-quality-stat",this.reportIndex=0,this.wholePeriod=!1,this._qualityItems=[ai,ci,li,ui,di,_i,hi,pi,gi,mi],this._messageSentItems=[li,ui,di,_i,hi],this._messageReceivedItems=[pi,gi,mi],this.REPORT_INTERVAL=120,this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._statInfoArr=[],this._avgRTT=new So,this._avgE2EDelay=new Eo,this._rateMessageSent=new Do,this._rateMessageReceived=new Ro;e=this.getIEmitInst();e.on(Yi.A2KEY_AND_TINYID_UPDATED,this._onLoginSuccess,this),e.on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_onLoginSuccess(){this._rateMessageSent.initMap(this._messageSentItems),this._rateMessageReceived.initMap(this._messageReceivedItems);var e=this.get(Ls),t=e.getItem(this.TAG,!1);!Oe(t)&&xe(t.forEach)&&(Ce.l(this._n+"._onLoginSuccess. logs count:"+t.length),t.forEach(e=>{this._statInfoArr.push(e)}),e.removeItem(this.TAG,!1))}_onCloudConfig(){var e=this.getCloudConfig("q_rpt_interval"),t=this.getCloudConfig("q_rpt_sdkappid_bl"),s=this.getCloudConfig("q_rpt_tinyid_wl");$e(e)||(this.REPORT_INTERVAL=Number(e)),$e(t)||(this.REPORT_SDKAPPID_BLACKLIST=t.split(",").map(e=>Number(e))),$e(s)||(this.REPORT_TINYID_WHITELIST=s.split(","))}onCheckTimer(e){this.isLoggedIn()&&e%this.REPORT_INTERVAL==0&&(this.wholePeriod=!0,this._report())}addRequestCount(){this._avgRTT.addRequestCount()}addRTT(e){this._avgRTT.addRTT(e)}addMessageDelay(e){this._avgE2EDelay.addMessageDelay(e)}addTotalCount(e){this._rateMessageSent.addTotalCount(e)||Ce.w(this._n+".addTotalCount invalid key:",e)}addSuccessCount(e){this._rateMessageSent.addSuccessCount(e)||Ce.w(this._n+".addSuccessCount invalid key:",e)}addFailedCountOfUserSide(e){this._rateMessageSent.addFailedCountOfUserSide(e)||Ce.w(this._n+".addFailedCountOfUserSide invalid key:",e)}addCost(e,t){this._rateMessageSent.addCost(e,t)||Ce.w(this._n+".addCost invalid key or cost:",e,t)}addFileSize(e,t){this._rateMessageSent.addFileSize(e,t)||Ce.w(this._n+".addFileSize invalid key or size:",e,t)}addMessageSequence(e){this._rateMessageReceived.addMessageSequence(e)||Ce.w(this._n+".addMessageSequence invalid key:",e.key)}_getQualityItem(e){let t={},s=Ii[this.get(Os).getNetworkType()];$e(s)&&(s=8);var i={qualityType:fi[e],timestamp:pe(),networkType:s,extension:""};switch(e){case ai:t=this._avgRTT.getStatResult();break;case ci:t=this._avgE2EDelay.getStatResult();break;case li:case ui:case di:case _i:case hi:t=this._rateMessageSent.getStatResult(e);break;case pi:case gi:case mi:t=this._rateMessageReceived.getStatResult(e)}return null===t?null:{...i,...t}}_report(e){let t=[],s=null;$e(e)?this._qualityItems.forEach(e=>{null!==(s=this._getQualityItem(e))&&(s.reportIndex=this.reportIndex,s.wholePeriod=this.wholePeriod,t.push(s))}):null!==(s=this._getQualityItem(e))&&(s.reportIndex=this.reportIndex,s.wholePeriod=this.wholePeriod,t.push(s)),Ce.d(this._n+"._report",t),0<this._statInfoArr.length&&(t=t.concat(this._statInfoArr),this._statInfoArr=[]);var e=this.get(Rs),i=e.getSDKAppID(),e=e.getTinyID();0<(t=It(this.REPORT_SDKAPPID_BLACKLIST,i)&&!Ct(this.REPORT_TINYID_WHITELIST,e)?[]:t).length&&this._doReport(t)}_doReport(t){var e={header:An(this),quality:t};this.req({P:ri.SSO_STAT,data:{...e}}).then(()=>{this.reportIndex++,this.wholePeriod=!1}).catch(e=>{Ce.w(this._n+"._doReport failed. error:",e),this._statInfoArr=this._statInfoArr.concat(t),this._flushAtOnce()})}_flushAtOnce(){var t=this.get(Ls),s=t.getItem(this.TAG,!1),i=this._statInfoArr,r=this._n+"._flushAtOnce";if(Oe(s))Ce.l(r+" count:"+i.length),t.setItem(this.TAG,i,!0,!1);else{let e=i.concat(s);10<e.length&&(e=e.slice(0,10)),Ce.l(r+" count:"+e.length),t.setItem(this.TAG,e,!0,!1)}this._statInfoArr=[]}reset(){Ce.l(this._n+".reset"),this._report(),this.reportIndex=0,this.wholePeriod=!1,this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._avgRTT.reset(),this._avgE2EDelay.reset(),this._rateMessageSent.reset(),this._rateMessageReceived.reset()}}class Ao extends oi{constructor(e){super(e),this._n="WorkerTimerModule",this._isWorkerEnabled=!0,this._workerTimer=null,this._timerID=-1,this._init(),this.getIEmitInst().on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}isWorkerEnabled(){return this._isWorkerEnabled&&ie}startWorkerTimer(){Ce.l(this._n+".startWorkerTimer"),this._workerTimer&&this._workerTimer.postMessage("start")}stopWorkerTimer(){Ce.l(this._n+".stopWorkerTimer"),this._workerTimer&&this._workerTimer.postMessage("stop")}_init(){if(ie){var e=URL.createObjectURL(new Blob(['let interval = -1;onmessage = function(event) {  if (event.data === "start") {    if (interval > 0) {      clearInterval(interval);    }    interval = setInterval(() => {      postMessage("");    }, 1000);    postMessage(interval);  } else if (event.data === "stop") {    clearInterval(interval);    interval = -1;  }};'],{type:"application/javascript; charset=utf-8"}));this._workerTimer=new Worker(e);let t=this;this._workerTimer.onmessage=function(e){e.data?(t._timerID=e.data,Ce.l(t._n+"._init seed:"+t._timerID)):t._m.onCheckTimer()}}}_onCloudConfig(){var e=this.getCloudConfig("enable_worker");Ce.l(this._n+"._onCloudConfig enableWorker:"+e),$e(e)||"1"===e?!this._isWorkerEnabled&&ie&&(this._isWorkerEnabled=!0,this.startWorkerTimer(),this._m.onWorkerTimerEnabled()):this._isWorkerEnabled&&ie&&(this._isWorkerEnabled=!1,this.stopWorkerTimer(),this._m.onWorkerTimerDisabled())}terminate(){Ce.l(this._n+".terminate"),this._workerTimer&&(this._workerTimer.terminate(),this._workerTimer=null,this._timerID=-1)}getTimerID(){return this._timerID}reset(){Ce.l(this._n+".reset")}}class Oo{constructor(e){this._commercialConfigM=e,this._n="PurchasedFeatureHandler",this._isCSPluginReported=!1,this._featureMap=new Map}isValidPurchaseBits(e){return e&&"string"==typeof e&&1<=e.length&&e.length<=64&&/[01]{1,64}/.test(e)}parsePurchaseBits(s){if(this.isValidPurchaseBits(s)){this._featureMap.clear();var r;for(let e=s.length-1,t=0;0<=e;e--,t++)r=(t<32?new i(0,Math.pow(2,t)):new i(Math.pow(2,t-32),0)).toString(),"1"===s[e]?this._featureMap.set(r,!0):this._featureMap.set(r,!1)}else Ce.w(this._n+".parsePurchaseBits invalid purchasebits:"+s)}hasPurchasedFeature(e){return!!this._featureMap.get(e)}isFeatureEnabled(e){var s=parseInt(e).toString(2);let r=void 0,o=!0;for(let e=s.length-1,t=0;0<=e;e--,t++)if("1"===s.charAt(e)&&(r=(t<32?new i(0,Math.pow(2,t)):new i(Math.pow(2,t-32),0)).toString(),!this._featureMap.get(r))){o=!1;break}return Ce.l(`${this._n}.isFeatureEnabled decimalNumber:${e} key:${r} ret:`+o),ii({enabled:o})}isFeatureEnabledForStat(e){var s=parseInt(e).toString(2);let r=void 0;for(let e=s.length-1,t=0;0<=e;e--,t++)if("1"===s.charAt(e)){if(r=(t<32?new i(0,Math.pow(2,t)):new i(Math.pow(2,t-32),0)).toString(),!this._featureMap.get(r))break;{let t="",s=0;if(r===M.PLUGIN_TRANSLATE?(t="plugin_translate",s=16):r===M.PLUGIN_VOICE_TO_TEXT?(t="plugin_voice_to_text",s=17):r===M.PLUGIN_CS?(t="plugin_cs",s=14):r===M.PLUGIN_PUSH?(t="plugin_push",s=13):r===M.PLUGIN_BOT?(t="plugin_bot",s=15):r===M.MSG_REACTION&&(t="plugin_emoji_reaction",s=18),""!==t){let e=this._commercialConfigM.get(Rs).getUIPlatform();new Ti(t).setCode(s).setUIPlatform(e).end(),Ce.l(`${this._n}.isFeatureEnabledForStat ${t} code:${s} uiPlatform:`+e)}}}}isCSPluginEnabled(){var e;this._isCSPluginReported||(e=this._commercialConfigM.get(Rs).getUIPlatform(),new Ti("plugin_search").setCode(6).setUIPlatform(e).end(),this._isCSPluginReported=!0)}clear(){this._featureMap.clear(),this._isCSPluginReported=!1}}class No{constructor(e){this._m=e,this._n="CommercialConfigModule",this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler=new Oo(this)}_canFetch(){return this.get(Rs).isLoggedIn()?!this._isFetching&&Date.now()>=this._expiredTime:(this._expiredTime=Date.now()+2e3,!1)}onCheckTimer(e){this._canFetch()&&this.fetchConfig()}fetchConfig(){let e=this._canFetch(),i=this._n+".fetchConfig";if(Ce.l(i+" canFetch:"+e),e){let t=new Ti("fetchCommercialConfig"),e=this.get(Rs).getSDKAppID(),s=this.get(Gs);this._isFetching=!0,s.req({P:ri.FETCH_COMMERCIAL_CONFIG,data:{SDKAppID:e}}).then(e=>{t.setMessage("purchaseBits:"+e.data.purchaseBits).end(),Ce.l(i+" ok."),this._parseConfig(e.data),this._isFetching=!1}).catch(e=>{t.setError(e).end(),this._isFetching=!1})}}onPushedConfig(e){var t=this._n+".onPushedConfig data:"+JSON.stringify(e);Ce.l(t),new Ti("pushedCommercialConfig").setMessage("purchaseBits:"+e.purchaseBits).end(),this._parseConfig(e)}_parseConfig(e){var t=this._n+"._parseConfig",{errorCode:s,errorMessage:i,purchaseBits:r,expiredTime:o}=e;0===s?(this._purchasedFeatureHandler.parsePurchaseBits(r),this._expiredTime=Date.now()+1e3*o):$e(s)?(Ce.l(t+" failed. Invalid message format:",e),this._setExpiredTimeOnResponseError(36e5)):(Ce.e(t+` errorCode:${s} errorMessage:`+i),this._setExpiredTimeOnResponseError(12e4))}_setExpiredTimeOnResponseError(e){this._expiredTime=Date.now()+e}canIUse(e){return this._purchasedFeatureHandler.hasPurchasedFeature(e)}isFeatureEnabled(e){return this._purchasedFeatureHandler.isFeatureEnabled(e)}isFeatureEnabledForStat(e){this._purchasedFeatureHandler.isFeatureEnabledForStat(e)}isCSPluginEnabled(){this._purchasedFeatureHandler.isCSPluginEnabled()}get(e){return this._m.get(e)}reset(){Ce.l(this._n+".reset"),this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler.clear()}}class Po extends oi{constructor(e){super(e),this._m=e,this._n="OfflinePushModule",this._offlinePushPlugin=void 0,this._androidPushConfig={huaweiPushBussinessId:"",xiaomiPushBussinessId:"",xiaomiPushAppId:"",xiaomiPushAppKey:"",meizuPushBussinessId:"",meizuPushAppId:"",meizuPushAppKey:"",vivoPushBussinessId:"",fcmPushBussinessId:"",oppoPushBussinessId:"",oppoPushAppKey:"",oppoPushAppSecret:"",honorPushBussinessId:""},this._deviceToken="",this._businessID=0,this._iosBusinessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0}registerPlugin(e){var t,s,i,r,o,n,a,l,d,c,_,u,h;P?(this._offlinePushPlugin=e["tim-offline-push-plugin"],{huaweiBusinessID:t,xiaomiBusinessID:s,xiaomiAppID:i,xiaomiAppKey:r,meizuBusinessID:o,meizuAppID:n,meizuAppKey:a,vivoBusinessID:l,oppoBusinessID:d,oppoAppKey:c,oppoAppSecret:_,honorBusinessID:u,iosBusinessID:h}=e.offlinePushConfig||{},this._androidPushConfig.huaweiPushBussinessId=t,this._androidPushConfig.xiaomiPushBussinessId=s,this._androidPushConfig.xiaomiPushAppId=i,this._androidPushConfig.xiaomiPushAppKey=r,this._androidPushConfig.meizuPushBussinessId=o,this._androidPushConfig.meizuPushAppId=n,this._androidPushConfig.meizuPushAppKey=a,this._androidPushConfig.vivoPushBussinessId=l,this._androidPushConfig.oppoPushBussinessId=d,this._androidPushConfig.oppoPushAppKey=c,this._androidPushConfig.oppoPushAppSecret=_,this._androidPushConfig.honorPushBussinessId=u,new Ti("registerPlugin").setMessage("tim-offline-push-plugin").setMoreMessage("isExist:"+!$e(this._offlinePushPlugin)).end(!0),Ce.l(this._n+".registerPlugin ok. offlinePushConfig:"+JSON.stringify(e.offlinePushConfig)),this._iosBusinessID=h,this._setAppShowListener()):this.warn("OfflinePushInUniapp")}init(){this._isWebUniapp=this.getUniAppPlatform(),this._getDeviceToken()}_getDeviceToken(){let a=this._n+"._getDeviceToken";if(xe(this._offlinePushPlugin.getDeviceToken)){let n=`androidPushConfig:${JSON.stringify(this._androidPushConfig)}, iosBusinessID:`+this._iosBusinessID;Ce.l(a+" start. "+n),new Ti("_getDeviceToken").setMessage(n).end(!0),this._offlinePushPlugin.getDeviceToken(this._androidPushConfig,r=>{let o=new Ti("getDeviceTokenRes"),{code:e,msg:t}=r;if(0===e){let{deviceToken:e,deviceBrand:t,deviceType:s,bussinessId:i}=r.data;this._deviceToken=e,this._businessID=i||this._iosBusinessID,n=`deviceToken:${e}, deviceBrand:${t||s}, businessID:`+this._businessID,Ce.l(a+" ok. "+n),o.setMessage(n).end(!0),this._setToken()}else o.setMessage(`code:${e}, msg:`+t).end(!0),Ce.e(a+" failed. error:",r)})}else Ce.e(a+" getDeviceToken is not a function")}canIUseOfflinePush(){return P&&!$e(this._offlinePushPlugin)}_setAppShowListener(){let t=this._n+"._setAppShowListener";$e(this._offlinePushPlugin)?Ce.e(t+" offlinePushPlugin is undefined"):xe(this._offlinePushPlugin.setAppShowListener)?(new Ti("_setAppShowListener").end(!0),Ce.l(t+" start"),this._offlinePushPlugin.setAppShowListener(e=>{e=(e||{}).appShow;new Ti("setAppShowListenerRes").setMessage("appShow:"+e).end(!0),Ce.l(t+" ok. appShow:"+e),this._m.isReady()&&(0===e?(this._getConvUnreadCount(),this._onBackground()):1===e&&this._onForeground())})):Ce.e(t+" setAppShowListener is not a function")}getDeviceBrand(){var e;if(!$e(this._offlinePushPlugin)&&xe(this._offlinePushPlugin.getDeviceType))return e=(this._offlinePushPlugin.getDeviceType()||{})["deviceType"],Ce.l(this._n+".getDeviceBrand ok. deviceType:"+e),e}_setToken(){let t=this._n+"._setToken",e=this.get(Rs),s,i=1,r="",n="";Oe(this._deviceToken)&&(i=0);var a=this.getUniAppPlatform(),l=this.getDeviceBrand();a===o.IOS||a===o.IPAD||a===o.MAC?n=this._deviceToken:a===o.ANDROID&&(r=this._deviceToken);let d=new Ti("offlinePushSetToken");return s=`deviceToken:${n||r}, businessID:${this._businessID}, deviceBrand:${l}, isWebUniapp:${this._isWebUniapp}, pushMsg:${i}, platform:`+a,d.setMessage(s),Ce.l(t+" "+s),this.req({P:ri.SET_TOKEN,data:{tokenID:r,pushMsg:i,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:l,deviceToken:n,isWebUniapp:this._isWebUniapp}}).then(e=>(d.end(),Ce.l(t+" ok"),e)).catch(e=>(d.setError(e).end(),Ce.e(t+" failed. error:",e),ni(e)))}_getConvUnreadCount(){this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(Ds).getLocalConvList().forEach(e=>{e.type===t.CONV_C2C&&(this._c2cUnreadCount+=e.unreadCount),e.type===t.CONV_GROUP&&(this._groupUnreadCount+=e.unreadCount)})}_onBackground(){let t=this._n+"._onBackground",s=new Ti("_onBackground");this.req({P:ri.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(e=>(s.setMessage(`c2cUnreadCount: ${this._c2cUnreadCount}, groupUnreadCount: `+this._groupUnreadCount).end(),Ce.l(t+" ok"),e)).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_onForeground(){let t=this._n+"._onForeground",s=new Ti("_onForeground");this.req({P:ri.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(e=>(s.end(),Ce.l(t+" ok"),e)).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}getUniAppPlatform(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?o.IOS:"android"===e?o.ANDROID:1002===t?o.IPAD:1001===t?o.MAC:void 0}reset(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,Ce.l(this._n+".reset")}}class Uo extends oi{constructor(e){super(e),this._m=e,this._n="TIMPushModule",this._pluginName="TIMPush",this._pushPlugin=void 0,this._androidPushConfig={},this._deviceToken="",this._businessID=0,this._iOSBusinessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,this._deviceInfo={notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:"1.0.1",packageName:""}}registerPlugin(e){var t,s,i;P?(t=this._n+".registerPlugin",{androidConfig:s,iOSConfig:i}=(this._pushPlugin=e["tim-push"],this._getDeviceInfo(),e.pushConfig||{}),we(s)&&(this._androidPushConfig=s[this._deviceInfo.packageName]),s=(i||{}).iOSBusinessID,this._iOSBusinessID=s,i=!$e(this._pushPlugin),new Ti("registerPlugin").setMessage(this._pluginName).setMoreMessage("isExisted:"+i).end(!0),Ce.l(t+" ok. pushConfig:"+JSON.stringify(e.pushConfig)),i?(this._setAppShowListener(),this._setPushEventReportListener()):Ce.e(t+` ${this._pluginName} is undefined`)):this.warn("TIMPushInUniapp")}init(){this._isWebUniapp=this.getUniAppPlatform(),this._reportEventCacheList(),this._getDeviceToken(),this.get(qs).isFeatureEnabledForStat(Math.pow(2,41))}_reportEventCacheList(){let o=this._n+"._reportEventCacheList";xe(this._pushPlugin.getPushEventCacheList)?(new Ti("_reportEventCacheList").end(!0),this._pushPlugin.getPushEventCacheList(e=>{var{code:t,data:{eventList:s}}=e,i=new Ti("getPushEventCacheListRes");if(i.setCode(t),0!==t)i.setMessage("res:"+JSON.stringify(e)).end(!0),Ce.e(o+" failed. error:"+JSON.stringify(e));else{t=s.length<10?"eventList:"+JSON.stringify(s):"eventList.length:"+s.length;Ce.l(o+" ok. "+t),i.setMessage(t).end(!0);for(var r={...e.data,eventList:[]};0<s.length;)r.eventList=s.splice(0,40),this._pushReport(r)}})):Ce.e(this._pluginName+".getPushEventCacheList is not a function")}_getDeviceToken(){let a=this._n+"._getDeviceToken";if(xe(this._pushPlugin.getDeviceToken)){let n=`androidPushConfig:${JSON.stringify(this._androidPushConfig)} iOSBusinessID:`+this._iOSBusinessID;Ce.l(a+" start. "+n),new Ti("_getDeviceToken").setMessage(n).end(!0),this._pushPlugin.getDeviceToken(this._androidPushConfig,r=>{let{code:e,msg:t}=r,o=new Ti("getDeviceTokenRes");if(o.setCode(e),0===e){let{deviceToken:e,deviceBrand:t,deviceType:s,bussinessId:i}=r.data;this._deviceToken=e,this._businessID=i||this._iOSBusinessID,n=`deviceToken:${e} deviceBrand:${t||s} businessID:`+this._businessID,Ce.l(a+" ok. "+n),o.setMessage(n).end(!0),void this._setToken()}else o.setMessage(t).end(!0),Ce.e(a+" failed. error:"+JSON.stringify(r))})}else Ce.e(this._pluginName+".getDeviceToken is not a function")}_getDeviceInfo(){var r=this._n+"._getDeviceInfo";if(xe(this._pushPlugin.getDeviceInfo)){let e=this._pushPlugin.getDeviceInfo(),{code:t,data:s}=e,i=new Ti("_getDeviceInfo");if(i.setCode(t),0===t){this._deviceInfo={...this._deviceInfo,...s},this._deviceInfo.pushVersion||(this._deviceInfo.pushVersion="1.0.1");let e="deviceInfo:"+JSON.stringify(this._deviceInfo);Ce.l(r+" ok. "+e),void i.setMessage(e).end(!0)}else i.setMessage("deviceInfoRes:"+JSON.stringify(e)).end(!0),Ce.e(r+" failed. error:"+JSON.stringify(e))}else Ce.e(this._pluginName+".getDeviceInfo is not a function")}canIUseTIMPush(){return P&&!$e(this._pushPlugin)}_setAppShowListener(){let t=this._n+"._setAppShowListener";xe(this._pushPlugin.setAppShowListener)?(new Ti("_setAppShowListener").end(!0),Ce.l(t+" start"),this._pushPlugin.setAppShowListener(e=>{e=(e||{}).appShow;new Ti("setAppShowListenerRes").setMessage("appShow:"+e).end(!0),Ce.l(t+" ok. appShow:"+e),this._m.isReady()&&(0===e?(this._getConvUnreadCount(),this._onBackground()):1===e&&this._onForeground())})):Ce.e(this._pluginName+".setAppShowListener is not a function")}_setPushEventReportListener(){let o=this._n+"._setPushEventReportListener";xe(this._pushPlugin.setPushEventReportListener)?(new Ti("_setPushEventReportListener").end(!0),this._pushPlugin.setPushEventReportListener(e=>{var{code:t,data:s}=e,i=s["eventList"],r=new Ti("setPushEventReportListenerRes");if(r.setCode(t),0===t){let e="eventList:"+JSON.stringify(i);Ce.l(o+" ok. "+e),r.setMessage(e).end(!0),void(this._m.isReady()&&Fe(i)&&0<i.length&&this._pushReport(s))}else r.setMessage("res:"+JSON.stringify(e)).end(!0),Ce.e(o+" failed. error:"+JSON.stringify(e))})):Ce.e(this._pluginName+".setPushEventReportListener is not a function")}getDeviceBrand(){var e;if(!$e(this._pushPlugin)&&xe(this._pushPlugin.getDeviceType))return e=(this._pushPlugin.getDeviceType()||{})["deviceType"],Ce.l(this._n+".getDeviceBrand ok. deviceType:"+e),e}_setToken(){let t=this._n+"._setToken",e=this.get(Rs),s,i=1,r="",n="";Oe(this._deviceToken)&&(i=0);var a=this.getUniAppPlatform(),l=this.getDeviceBrand();a===o.IOS||a===o.IPAD||a===o.MAC?n=this._deviceToken:a===o.ANDROID&&(r=this._deviceToken);let d={tokenID:r,pushMsg:i,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:l,deviceToken:n,isWebUniapp:this._isWebUniapp,...this._deviceInfo},c=new Ti("_setToken");s="data:"+JSON.stringify(d),c.setMessage(s),Ce.l(t+" "+s),this.req({P:ri.SET_TOKEN,data:d}).then(()=>{c.end(),Ce.w(t+" ok")}).catch(e=>{c.setError(e).end(),Ce.e(t+" failed. error:",e),ni(e)})}_getConvUnreadCount(){this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(Ds).getLocalConvList().forEach(e=>{e.type===t.CONV_C2C&&(this._c2cUnreadCount+=e.unreadCount),e.type===t.CONV_GROUP&&(this._groupUnreadCount+=e.unreadCount)})}_onBackground(){let t=this._n+"._onBackground",s=new Ti("_onBackground");this.req({P:ri.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(()=>{s.setMessage(`c2cUnreadCount:${this._c2cUnreadCount} groupUnreadCount:`+this._groupUnreadCount).end(),Ce.l(t+" ok")}).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_onForeground(){let t=this._n+"._onForeground",s=new Ti("_onForeground");this.req({P:ri.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(()=>{s.end(),Ce.l(t+" ok")}).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_pushReport(e){let t=this._n+"._pushReport",s=new Ti("_pushReport");this.req({P:ri.PUSH_REPORT,data:{eventList:e.eventList}}).then(()=>{s.end(),this._notifyReportSuccess(e)}).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_notifyReportSuccess(e){!$e(this._pushPlugin)&&xe(this._pushPlugin.notifyReportSuccess)&&(this._pushPlugin.notifyReportSuccess(e),Ce.l(this._n+"._notifyReportSuccess ok"))}getUniAppPlatform(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?o.IOS:"android"===e?o.ANDROID:1002===t?o.IPAD:1001===t?o.MAC:void 0}reset(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,Ce.l(this._n+".reset")}}class Go extends oi{constructor(e){super(e),this._n="ProfanityFilterModule",this._plugin=null,this._filterConfigMap=new Map,this._startIndex=0,this._version=0,this._canIUseLexicon=!1,this._isFetching=!1,this._expiredTime=0}init(){var e=this.get(Ps).getPlugin("tim-profanity-filter-plugin");e&&(this._plugin=new e({logger:Ce,isArray:Fe,isMap:Ne,isDevMode:this.isDevMode()}),this._getLexicon())}onCheckTimer(){this._plugin&&this._canIUseLexicon&&this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime&&this._getLexicon()}filterMessage(n,e){let a=!0;if(this._plugin&&this._canIUseLexicon&&(!e||!e.messageControlInfo||!0!==e.messageControlInfo.excludedFromContentModeration)){let{type:s,conversationType:o}=n;if(s===t.MSG_TEXT||s===t.MSG_CUSTOM){let e=this._n+".filterMessage",r;if(Ce.l(""+e),s===t.MSG_TEXT){if(o===t.CONV_C2C?r=I:o===t.CONV_GROUP&&(r=T),!this._isConfigOn(r))return a;let{type:e,modifiedText:s}=this._plugin.filter(n.payload.text);1===e?a=!1:2===e&&(n.payload.text=s)}else if(s===t.MSG_CUSTOM){if(o===t.CONV_C2C?r=C:o===t.CONV_GROUP&&(r=y),!this._isConfigOn(r))return a;let e=this._plugin.filter(n.payload.data),s=this._plugin.filter(n.payload.description),i=this._plugin.filter(n.payload.extension);1===e.type||1===s.type||1===i.type?a=!1:(2===e.type&&(n.payload.data=e.modifiedText),2===s.type&&(n.payload.description=s.modifiedText),2===i.type&&(n.payload.extension=i.modifiedText))}Ce.l(e+" done. isAllowedToSend:"+a)}}return a}filterText(e,t){var s=this._n+".filterText",i={isAllowedToSend:!0,modifiedText:e};return this._plugin&&this._canIUseLexicon&&this._isConfigOn(t)&&(Ce.l(s),{type:t,modifiedText:e}=this._plugin.filter(e),1===t?i.isAllowedToSend=!1:2===t&&(i.modifiedText=e),Ce.l(s+" done. ret:",i)),i}_getLexicon(){let c=new Ti("profanityFilter"),_=this._n+"._getLexicon";this._isFetching=!0,this.req({P:ri.GET_PROFANITY_LIST,data:{startIndex:this._startIndex,version:this._version}}).then(e=>{var{errorInfo:e,filterConfig:t,lexicon:s,strToken:i,completeFlag:r,nextStartIndex:o,version:n,expiredTime:a}=e.data,{errorCode:l,errorMessage:d}=e;return 0!==l?(this._isFetching=!1,Ce.w(_+" failed. error:",e),void c.setCode(l).setMessage(d).end()):(this._onFilterConfig(t),this._getToken(i),1===r?(Ce.l(_+` done. version:${n} expiredTime:`+a),this._version=n,this._canIUseLexicon=!0,this._isFetching=!1,this._expiredTime=Date.now()+1e3*a,void this._plugin.onLexiconCompleted(s)):(this._startIndex=o,this._plugin.onLexiconSliced(s),void this._getLexicon()))}).catch(e=>{c.setError(e).end(),this._isFetching=!1,Ce.l(_+" failed. error:",e)})}_onFilterConfig(t){Oe(t)||(this._filterConfigMap.clear(),Object.keys(t).forEach(e=>{this._filterConfigMap.set(e,t[e])}),Ce.l(`${this._n}._onFilterConfig. keys:${Array.from(this._filterConfigMap.keys())} values:`+Array.from(this._filterConfigMap.values())))}_isConfigOn(e){return 1===this._filterConfigMap.get(e)}_getToken(s){if(ke(s)){var i=s.length;let t="";if(i%2==0)for(let e=0;e<=i-1;e+=2)t=(t+=s[e+1])+s[e];else{for(let e=0;e<i-1;e+=2)t=(t+=s[e+1])+s[e];t+=s[i-1]}this._plugin.onToken(t)}}reset(){Ce.l(this._n+".reset"),this._plugin&&(this._plugin.reset(),this._plugin=null),this._filterConfigMap.clear(),this._startIndex=0,this._version=0,this._canIUseLexicon=!1,this._isFetching=!1,this._expiredTime=0}}class ko{constructor(e){this._m=e,this._n="TransCmdModule",this._TRTCCommandList=["tui_room_svr.*","callkit_records_svr.*","room_engine_srv.*","room_engine_http_srv.*","room_engine_mic.*","live_engine_srv.*","live_engine_http_srv.*","live_engine_pk.*","trtc_ai_service.*","call_engine_srv.*"],this._TRTCCommandMap=new Map,this._setTRTCCommandMap(),this._m.getIEmitInst().on(Yi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){var e=this._m.get(ws).getCloudConfig("rtc_cmd");$e(e)||((e=JSON.parse(e)).forEach(e=>{this._TRTCCommandList.includes(e)||this._TRTCCommandList.push(e)}),this._setTRTCCommandMap())}_setTRTCCommandMap(){var s;for(let e=0,t=this._TRTCCommandList.length;e<t;e++)s=this._TRTCCommandList[e].split(".")[0],this._TRTCCommandMap.set(s,1)}onRoomCustomDataReceived(t){this._m.getOEmitInst().emit(e.ROOM_CUSTOM_DATA_RECEIVED,t)}sendTRTCCustomData(e){var{serviceCommand:e,data:t}=e;let s=f.NAME.TUIROOM_SVR+".*";return $e(e)||(s=e),this._isValidServiceCommand(s)?this._trans({servcmd:s,data:t}):ni({code:ei.INVALID_TRTC_CMD})}_trans(e){Ce.d(this._n+"._trans. options:"+JSON.stringify(e));var{servcmd:e,data:t}=e;return this._m.get(Gs).trans({servcmd:e,data:ke(t)?JSON.parse(t):t})}_isValidServiceCommand(e){return e.endsWith(".*")?this._TRTCCommandList.includes(e):(e=e.split(".")[0],this._TRTCCommandMap.has(e))}isTRTCCommand(e){e=e.split(".")[0];return this._TRTCCommandMap.has(e)}reset(){Ce.l(this._n+".reset")}}class wo{constructor(e){this._m=e,this._n="ErrMsgModule",this.TIM_ERROR_ASSISTANCE="tim_error_assistance",this.STORAGE_EXPIRES_TIME=6048e5,this._map=new Map,this._init()}_init(){var t=this._getStorageModule().getItem(this.TIM_ERROR_ASSISTANCE,!1);if(t){let e;try{e=JSON.parse(t)}catch(e){this._getStorageModule().removeItem(this.TIM_ERROR_ASSISTANCE,!1),Ce.w(this._n+"._init error:",e)}e&&(this._needToUpdate(e)?this._fetch():this._fillMap(e.message))}else this._fetch()}_needToUpdate(e){var{localSavedTime:e,localSavedVersion:t}=e,e=e&&(new Date).getTime()-e>=this.STORAGE_EXPIRES_TIME,t=!t||"3.5.3"!==t;return Ce.l(this._n+`._needToUpdate isTimeout:${e} isDifferentVersion:`+t),e||t}_fetch(){if(!this._m.get(Rs).isPrivateNetWork()){let s="https://web.sdk.qcloud.com/im/download/error-message/v3/0.0.7/tim-error-message.txt",i="application/x-www-form-urlencoded;charset=UTF-8",r=this._n+"._fetch ok in",o=this;if(k)$.request({url:s,method:"GET",timeout:3e3,header:{"content-type":i},dataType:"text",success:e=>{o._fillAndSave(e.data),Ce.l(r+" mini program")},fail:()=>{}});else{let e=new XMLHttpRequest,t=setTimeout(()=>{e.abort()},3e3);e.onreadystatechange=function(){4===e.readyState&&(t&&clearTimeout(t),200!==e.status&&304!==e.status||(Ce.l(r+" browser"),o._fillAndSave(e.responseText)))},e.open("GET",s,!0),e.setRequestHeader("Content-type",i),e.send()}}}_fillAndSave(e){this._fillMap(e),this._getStorageModule().setItem(this.TIM_ERROR_ASSISTANCE,JSON.stringify({message:e,localSavedTime:(new Date).getTime(),localSavedVersion:"3.5.3"}),!0,!1)}_getStorageModule(){return this._m.get(Ls)}_fillMap(e){this._map.clear();var t,s,i=e.split(";\n"),r=i.length,o=new RegExp(/'/g);for(let e=0;e<r;e++)if(s=i[e].indexOf(":"),t=i[e].slice(0,s),s=i[e].slice(s+1,i[e].length),!t.startsWith("//")){if($e(s))continue;this._map.set(t,s.replace(o,""))}}get(e){var{isIntl:e,key:t,replacement1:s,replacement2:i}=e;let r=e?t+"_en":t+"_cn",o=(!this._map.has(r)&&this._map.has(t)&&(r=t),"");return this._map.has(r)&&(o=this._map.get(r),$e(s)||(o=o.replace("$replacement1",s)),$e(i)||(o=o.replace("$replacement2",i))),o}reset(){Ce.l(this._n+".reset")}}var bo=Gn(function(e,t){var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;t.assign=function(e){for(var t,s,i=Array.prototype.slice.call(arguments,1);i.length;){var r=i.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var o in r)t=r,s=o,Object.prototype.hasOwnProperty.call(t,s)&&(e[o]=r[o])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var i={arraySet:function(e,t,s,i,r){if(t.subarray&&e.subarray)e.set(t.subarray(s,s+i),r);else for(var o=0;o<i;o++)e[r+o]=t[s+o]},flattenChunks:function(e){for(var t,s,i,r=0,o=0,n=e.length;o<n;o++)r+=e[o].length;for(i=new Uint8Array(r),o=t=0,n=e.length;o<n;o++)s=e[o],i.set(s,t),t+=s.length;return i}},r={arraySet:function(e,t,s,i,r){for(var o=0;o<i;o++)e[r+o]=t[s+o]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,i)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,r))},t.setTyped(s)}),Fo=(bo.assign,bo.shrinkBuf,bo.setTyped,bo.Buf8,bo.Buf16,bo.Buf32,function(e,t,s,i){for(var r=65535&e|0,o=e>>>16&65535|0,n=0;0!==s;){for(s-=n=2e3<s?2e3:s;o=o+(r=r+t[i++]|0)|0,--n;);r%=65521,o%=65521}return r|o<<16|0}),$o=function(){for(var e=[],t=0;t<256;t++){for(var s=t,i=0;i<8;i++)s=1&s?3988292384^s>>>1:s>>>1;e[t]=s}return e}(),qo=function(e,t,s,i){var r=$o,o=i+s;e^=-1;for(var n=i;n<o;n++)e=e>>>8^r[255&(e^t[n])];return-1^e},xo=function(e,t){var s,i,r,o,n,a,l=e.state,d=e.next_in,c=e.input,_=d+(e.avail_in-5),u=e.next_out,h=e.output,p=u-(t-e.avail_out),g=u+(e.avail_out-257),m=l.dmax,f=l.wsize,M=l.whave,I=l.wnext,C=l.window,v=l.hold,T=l.bits,y=l.lencode,E=l.distcode,D=(1<<l.lenbits)-1,S=(1<<l.distbits)-1;e:do{for(T<15&&(v+=c[d++]<<T,T+=8,v+=c[d++]<<T,T+=8),s=y[v&D];;){if(v>>>=i=s>>>24,T-=i,0==(i=s>>>16&255))h[u++]=65535&s;else{if(!(16&i)){if(0==(64&i)){s=y[(65535&s)+(v&(1<<i)-1)];continue}if(32&i){l.mode=12;break e}e.msg="invalid literal/length code",l.mode=30;break e}for(r=65535&s,(i&=15)&&(T<i&&(v+=c[d++]<<T,T+=8),r+=v&(1<<i)-1,v>>>=i,T-=i),T<15&&(v+=c[d++]<<T,T+=8,v+=c[d++]<<T,T+=8),s=E[v&S];;){if(v>>>=i=s>>>24,T-=i,!(16&(i=s>>>16&255))){if(0==(64&i)){s=E[(65535&s)+(v&(1<<i)-1)];continue}e.msg="invalid distance code",l.mode=30;break e}if(o=65535&s,T<(i&=15)&&(v+=c[d++]<<T,(T+=8)<i)&&(v+=c[d++]<<T,T+=8),(o+=v&(1<<i)-1)>m){e.msg="invalid distance too far back",l.mode=30;break e}if(v>>>=i,T-=i,o>(i=u-p)){if((i=o-i)>M&&l.sane){e.msg="invalid distance too far back",l.mode=30;break e}if(a=C,(n=0)===I){if(n+=f-i,i<r){for(r-=i;h[u++]=C[n++],--i;);n=u-o,a=h}}else if(I<i){if(n+=f+I-i,(i-=I)<r){for(r-=i;h[u++]=C[n++],--i;);if(n=0,I<r){for(r-=i=I;h[u++]=C[n++],--i;);n=u-o,a=h}}}else if(n+=I-i,i<r){for(r-=i;h[u++]=C[n++],--i;);n=u-o,a=h}for(;2<r;)h[u++]=a[n++],h[u++]=a[n++],h[u++]=a[n++],r-=3;r&&(h[u++]=a[n++],1<r)&&(h[u++]=a[n++])}else{for(n=u-o;h[u++]=h[n++],h[u++]=h[n++],h[u++]=h[n++],2<(r-=3););r&&(h[u++]=h[n++],1<r)&&(h[u++]=h[n++])}break}}break}}while(d<_&&u<g);d-=r=T>>3,v&=(1<<(T-=r<<3))-1,e.next_in=d,e.next_out=u,e.avail_in=d<_?_-d+5:5-(d-_),e.avail_out=u<g?g-u+257:257-(u-g),l.hold=v,l.bits=T},Vo=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Bo=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Ko=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],Ho=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],Wo=function(e,t,s,i,r,o,n,a){for(var l,d,c,_,u,h,p,g,m,f=a.bits,M=0,I=0,C=0,v=0,T=0,y=0,E=0,D=0,S=0,R=0,O=null,L=0,A=new bo.Buf16(16),N=new bo.Buf16(16),P=null,U=0,M=0;M<=15;M++)A[M]=0;for(I=0;I<i;I++)A[t[s+I]]++;for(T=f,v=15;1<=v&&0===A[v];v--);if(v<T&&(T=v),0===v)r[o++]=20971520,r[o++]=20971520,a.bits=1;else{for(C=1;C<v&&0===A[C];C++);for(T<C&&(T=C),M=D=1;M<=15;M++)if((D=(D<<1)-A[M])<0)return-1;if(0<D&&(0===e||1!==v))return-1;for(N[1]=0,M=1;M<15;M++)N[M+1]=N[M]+A[M];for(I=0;I<i;I++)0!==t[s+I]&&(n[N[t[s+I]]++]=I);if(h=0===e?(O=P=n,19):1===e?(O=Vo,L-=257,P=Bo,U-=257,256):(O=Ko,P=Ho,-1),M=C,u=o,E=I=R=0,c=-1,_=(S=1<<(y=T))-1,1===e&&852<S||2===e&&592<S)return 1;for(;;){for(m=n[I]<h?(g=0,n[I]):n[I]>h?(g=P[U+n[I]],O[L+n[I]]):(g=96,0),l=1<<(p=M-E),C=d=1<<y;r[u+(R>>E)+(d-=l)]=p<<24|g<<16|m|0,0!==d;);for(l=1<<M-1;R&l;)l>>=1;if(0!==l?R=(R&l-1)+l:R=0,I++,0==--A[M]){if(M===v)break;M=t[s+n[I]]}if(T<M&&(R&_)!==c){for(u+=C,D=1<<(y=M-(E=0===E?T:E));y+E<v&&!((D-=A[y+E])<=0);)y++,D<<=1;if(S+=1<<y,1===e&&852<S||2===e&&592<S)return 1;r[c=R&_]=T<<24|y<<16|u-o|0}}0!==R&&(r[u+R]=M-E<<24|64<<16|0),a.bits=T}return 0};function Yo(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function zo(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new bo.Buf16(320),this.work=new bo.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function jo(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new bo.Buf32(852),t.distcode=t.distdyn=new bo.Buf32(592),t.sane=1,t.back=-1,0):-2}function Jo(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,jo(e)):-2}function Xo(e,t){var s,i;return!e||!e.state||(i=e.state,t<0?(s=0,t=-t):(s=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t))?-2:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=s,i.wbits=t,Jo(e))}function Zo(e,t){var s;return e?(s=new zo,(e.state=s).window=null,0!==(s=Xo(e,t))&&(e.state=null),s):-2}var Qo,er,tr=!0;function sr(e){if(tr){var t;for(Qo=new bo.Buf32(512),er=new bo.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Wo(1,e.lens,0,288,Qo,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Wo(2,e.lens,0,32,er,0,e.work,{bits:5}),tr=!1}e.lencode=Qo,e.lenbits=9,e.distcode=er,e.distbits=5}function ir(e,t,s,i){var r,e=e.state;return null===e.window&&(e.wsize=1<<e.wbits,e.wnext=0,e.whave=0,e.window=new bo.Buf8(e.wsize)),i>=e.wsize?(bo.arraySet(e.window,t,s-e.wsize,e.wsize,0),e.wnext=0,e.whave=e.wsize):((r=e.wsize-e.wnext)>i&&(r=i),bo.arraySet(e.window,t,s-i,r,e.wnext),(i-=r)?(bo.arraySet(e.window,t,s-i,i,0),e.wnext=i,e.whave=e.wsize):(e.wnext+=r,e.wnext===e.wsize&&(e.wnext=0),e.whave<e.wsize&&(e.whave+=r))),0}var nr={inflateReset:Jo,inflateReset2:Xo,inflateResetKeep:jo,inflateInit:function(e){return Zo(e,15)},inflateInit2:Zo,inflate:function(e,t){var s,i,r,o,n,a,l,d,c,_,u,h,p,g,m,f,M,I,C,v,T,y,E,D,S=0,R=new bo.Buf8(4),O=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return-2;12===(s=e.state).mode&&(s.mode=13),n=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,d=s.hold,c=s.bits,_=a,u=l,y=0;e:for(;;)switch(s.mode){case 1:if(0===s.wrap)s.mode=13;else{for(;c<16;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(2&s.wrap&&35615===d)R[s.check=0]=255&d,R[1]=d>>>8&255,s.check=qo(s.check,R,2,0),c=d=0,s.mode=2;else if(s.flags=0,s.head&&(s.head.done=!1),!(1&s.wrap)||(((255&d)<<8)+(d>>8))%31)e.msg="incorrect header check",s.mode=30;else if(8!=(15&d))e.msg="unknown compression method",s.mode=30;else{if(c-=4,T=8+(15&(d>>>=4)),0===s.wbits)s.wbits=T;else if(T>s.wbits){e.msg="invalid window size",s.mode=30;break}s.dmax=1<<T,e.adler=s.check=1,s.mode=512&d?10:12,c=d=0}}break;case 2:for(;c<16;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(s.flags=d,8!=(255&s.flags)){e.msg="unknown compression method",s.mode=30;break}if(57344&s.flags){e.msg="unknown header flags set",s.mode=30;break}s.head&&(s.head.text=d>>8&1),512&s.flags&&(R[0]=255&d,R[1]=d>>>8&255,s.check=qo(s.check,R,2,0)),c=d=0,s.mode=3;case 3:for(;c<32;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}s.head&&(s.head.time=d),512&s.flags&&(R[0]=255&d,R[1]=d>>>8&255,R[2]=d>>>16&255,R[3]=d>>>24&255,s.check=qo(s.check,R,4,0)),c=d=0,s.mode=4;case 4:for(;c<16;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}s.head&&(s.head.xflags=255&d,s.head.os=d>>8),512&s.flags&&(R[0]=255&d,R[1]=d>>>8&255,s.check=qo(s.check,R,2,0)),c=d=0,s.mode=5;case 5:if(1024&s.flags){for(;c<16;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}s.length=d,s.head&&(s.head.extra_len=d),512&s.flags&&(R[0]=255&d,R[1]=d>>>8&255,s.check=qo(s.check,R,2,0)),c=d=0}else s.head&&(s.head.extra=null);s.mode=6;case 6:if(1024&s.flags&&((h=(h=s.length)>a?a:h)&&(s.head&&(T=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Array(s.head.extra_len)),bo.arraySet(s.head.extra,i,o,h,T)),512&s.flags&&(s.check=qo(s.check,i,h,o)),a-=h,o+=h,s.length-=h),s.length))break e;s.length=0,s.mode=7;case 7:if(2048&s.flags){if(0===a)break e;for(h=0;T=i[o+h++],s.head&&T&&s.length<65536&&(s.head.name+=String.fromCharCode(T)),T&&h<a;);if(512&s.flags&&(s.check=qo(s.check,i,h,o)),a-=h,o+=h,T)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=8;case 8:if(4096&s.flags){if(0===a)break e;for(h=0;T=i[o+h++],s.head&&T&&s.length<65536&&(s.head.comment+=String.fromCharCode(T)),T&&h<a;);if(512&s.flags&&(s.check=qo(s.check,i,h,o)),a-=h,o+=h,T)break e}else s.head&&(s.head.comment=null);s.mode=9;case 9:if(512&s.flags){for(;c<16;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(d!==(65535&s.check)){e.msg="header crc mismatch",s.mode=30;break}c=d=0}s.head&&(s.head.hcrc=s.flags>>9&1,s.head.done=!0),e.adler=s.check=0,s.mode=12;break;case 10:for(;c<32;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}e.adler=s.check=Yo(d),c=d=0,s.mode=11;case 11:if(0===s.havedict)return e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,s.hold=d,s.bits=c,2;e.adler=s.check=1,s.mode=12;case 12:if(5===t||6===t)break e;case 13:if(s.last)d>>>=7&c,c-=7&c,s.mode=27;else{for(;c<3;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}switch(s.last=1&d,--c,3&(d>>>=1)){case 0:s.mode=14;break;case 1:if(sr(s),s.mode=20,6!==t)break;d>>>=2,c-=2;break e;case 2:s.mode=17;break;case 3:e.msg="invalid block type",s.mode=30}d>>>=2,c-=2}break;case 14:for(d>>>=7&c,c-=7&c;c<32;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if((65535&d)!=(d>>>16^65535)){e.msg="invalid stored block lengths",s.mode=30;break}if(s.length=65535&d,c=d=0,s.mode=15,6===t)break e;case 15:s.mode=16;case 16:if(h=s.length){if(0===(h=l<(h=a<h?a:h)?l:h))break e;bo.arraySet(r,i,o,h,n),a-=h,o+=h,l-=h,n+=h,s.length-=h}else s.mode=12;break;case 17:for(;c<14;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(s.nlen=257+(31&d),d>>>=5,c-=5,s.ndist=1+(31&d),d>>>=5,c-=5,s.ncode=4+(15&d),d>>>=4,c-=4,286<s.nlen||30<s.ndist){e.msg="too many length or distance symbols",s.mode=30;break}s.have=0,s.mode=18;case 18:for(;s.have<s.ncode;){for(;c<3;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}s.lens[O[s.have++]]=7&d,d>>>=3,c-=3}for(;s.have<19;)s.lens[O[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,E={bits:s.lenbits},y=Wo(0,s.lens,0,19,s.lencode,0,s.work,E),s.lenbits=E.bits,y){e.msg="invalid code lengths set",s.mode=30;break}s.have=0,s.mode=19;case 19:for(;s.have<s.nlen+s.ndist;){for(;f=(S=s.lencode[d&(1<<s.lenbits)-1])>>>16&255,M=65535&S,!((m=S>>>24)<=c);){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(M<16)d>>>=m,c-=m,s.lens[s.have++]=M;else{if(16===M){for(D=m+2;c<D;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(d>>>=m,c-=m,0===s.have){e.msg="invalid bit length repeat",s.mode=30;break}T=s.lens[s.have-1],h=3+(3&d),d>>>=2,c-=2}else if(17===M){for(D=m+3;c<D;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}T=0,h=3+(7&(d>>>=m)),d>>>=3,c=c-m-3}else{for(D=m+7;c<D;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}T=0,h=11+(127&(d>>>=m)),d>>>=7,c=c-m-7}if(s.have+h>s.nlen+s.ndist){e.msg="invalid bit length repeat",s.mode=30;break}for(;h--;)s.lens[s.have++]=T}}if(30===s.mode)break;if(0===s.lens[256]){e.msg="invalid code -- missing end-of-block",s.mode=30;break}if(s.lenbits=9,E={bits:s.lenbits},y=Wo(1,s.lens,0,s.nlen,s.lencode,0,s.work,E),s.lenbits=E.bits,y){e.msg="invalid literal/lengths set",s.mode=30;break}if(s.distbits=6,s.distcode=s.distdyn,E={bits:s.distbits},y=Wo(2,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,E),s.distbits=E.bits,y){e.msg="invalid distances set",s.mode=30;break}if(s.mode=20,6===t)break e;case 20:s.mode=21;case 21:if(6<=a&&258<=l){e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,s.hold=d,s.bits=c,xo(e,u),n=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,d=s.hold,c=s.bits,12===s.mode&&(s.back=-1);break}for(s.back=0;f=(S=s.lencode[d&(1<<s.lenbits)-1])>>>16&255,M=65535&S,!((m=S>>>24)<=c);){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(f&&0==(240&f)){for(I=m,C=f,v=M;f=(S=s.lencode[v+((d&(1<<I+C)-1)>>I)])>>>16&255,M=65535&S,!(I+(m=S>>>24)<=c);){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}d>>>=I,c-=I,s.back+=I}if(d>>>=m,c-=m,s.back+=m,s.length=M,0===f){s.mode=26;break}if(32&f){s.back=-1,s.mode=12;break}if(64&f){e.msg="invalid literal/length code",s.mode=30;break}s.extra=15&f,s.mode=22;case 22:if(s.extra){for(D=s.extra;c<D;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}s.length+=d&(1<<s.extra)-1,d>>>=s.extra,c-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=23;case 23:for(;f=(S=s.distcode[d&(1<<s.distbits)-1])>>>16&255,M=65535&S,!((m=S>>>24)<=c);){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(0==(240&f)){for(I=m,C=f,v=M;f=(S=s.distcode[v+((d&(1<<I+C)-1)>>I)])>>>16&255,M=65535&S,!(I+(m=S>>>24)<=c);){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}d>>>=I,c-=I,s.back+=I}if(d>>>=m,c-=m,s.back+=m,64&f){e.msg="invalid distance code",s.mode=30;break}s.offset=M,s.extra=15&f,s.mode=24;case 24:if(s.extra){for(D=s.extra;c<D;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}s.offset+=d&(1<<s.extra)-1,d>>>=s.extra,c-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){e.msg="invalid distance too far back",s.mode=30;break}s.mode=25;case 25:if(0===l)break e;if(s.offset>(h=u-l)){if((h=s.offset-h)>s.whave&&s.sane){e.msg="invalid distance too far back",s.mode=30;break}p=h>s.wnext?(h-=s.wnext,s.wsize-h):s.wnext-h,h>s.length&&(h=s.length),g=s.window}else g=r,p=n-s.offset,h=s.length;for(l-=h=l<h?l:h,s.length-=h;r[n++]=g[p++],--h;);0===s.length&&(s.mode=21);break;case 26:if(0===l)break e;r[n++]=s.length,l--,s.mode=21;break;case 27:if(s.wrap){for(;c<32;){if(0===a)break e;a--,d|=i[o++]<<c,c+=8}if(u-=l,e.total_out+=u,s.total+=u,u&&(e.adler=s.check=(s.flags?qo:Fo)(s.check,r,u,n-u)),u=l,(s.flags?d:Yo(d))!==s.check){e.msg="incorrect data check",s.mode=30;break}c=d=0}s.mode=28;case 28:if(s.wrap&&s.flags){for(;c<32;){if(0===a)break e;a--,d+=i[o++]<<c,c+=8}if(d!==(4294967295&s.total)){e.msg="incorrect length check",s.mode=30;break}c=d=0}s.mode=29;case 29:y=1;break e;case 30:y=-3;break e;case 31:return-4;default:return-2}return e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,s.hold=d,s.bits=c,(s.wsize||u!==e.avail_out&&s.mode<30&&(s.mode<27||4!==t))&&ir(e,e.output,e.next_out,u-e.avail_out),_-=e.avail_in,u-=e.avail_out,e.total_in+=_,e.total_out+=u,s.total+=u,s.wrap&&u&&(e.adler=s.check=(s.flags?qo:Fo)(s.check,r,u,e.next_out-u)),e.data_type=s.bits+(s.last?64:0)+(12===s.mode?128:0)+(20===s.mode||15===s.mode?256:0),y=(0==_&&0===u||4===t)&&0===y?-5:y},inflateEnd:function(e){var t;return e&&e.state?((t=e.state).window&&(t.window=null),e.state=null,0):-2},inflateGetHeader:function(e,t){return!e||!e.state||0==(2&(e=e.state).wrap)?-2:((e.head=t).done=!1,0)},inflateSetDictionary:function(e,t){var s,i=t.length;return!e||!e.state||0!==(s=e.state).wrap&&11!==s.mode?-2:11===s.mode&&Fo(1,t,i,0)!==s.check?-3:ir(e,t,i,i)?(s.mode=31,-4):(s.havedict=1,0)},inflateInfo:"pako inflate (from Nodeca project)"},or=!0,rr=!0;try{String.fromCharCode.apply(null,[0])}catch(e){or=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){rr=!1}for(var ar=new bo.Buf8(256),cr=0;cr<256;cr++)ar[cr]=252<=cr?6:248<=cr?5:240<=cr?4:224<=cr?3:192<=cr?2:1;function lr(e,t){if(t<65534&&(e.subarray&&rr||!e.subarray&&or))return String.fromCharCode.apply(null,bo.shrinkBuf(e,t));for(var s="",i=0;i<t;i++)s+=String.fromCharCode(e[i]);return s}ar[254]=ar[254]=1;var ur=function(e){for(var t,s,i,r,o=e.length,n=0,a=0;a<o;a++)55296==(64512&(s=e.charCodeAt(a)))&&a+1<o&&56320==(64512&(i=e.charCodeAt(a+1)))&&(s=65536+(s-55296<<10)+(i-56320),a++),n+=s<128?1:s<2048?2:s<65536?3:4;for(t=new bo.Buf8(n),a=r=0;r<n;a++)55296==(64512&(s=e.charCodeAt(a)))&&a+1<o&&56320==(64512&(i=e.charCodeAt(a+1)))&&(s=65536+(s-55296<<10)+(i-56320),a++),s<128?t[r++]=s:(s<2048?t[r++]=192|s>>>6:(s<65536?t[r++]=224|s>>>12:(t[r++]=240|s>>>18,t[r++]=128|s>>>12&63),t[r++]=128|s>>>6&63),t[r++]=128|63&s);return t},dr=function(e){for(var t=new bo.Buf8(e.length),s=0,i=t.length;s<i;s++)t[s]=e.charCodeAt(s);return t},_r=function(e,t){for(var s,i,r=t||e.length,o=new Array(2*r),n=0,a=0;a<r;)if((s=e[a++])<128)o[n++]=s;else if(4<(i=ar[s]))o[n++]=65533,a+=i-1;else{for(s&=2===i?31:3===i?15:7;1<i&&a<r;)s=s<<6|63&e[a++],i--;1<i?o[n++]=65533:s<65536?o[n++]=s:(s-=65536,o[n++]=55296|s>>10&1023,o[n++]=56320|1023&s)}return lr(o,n)},hr=function(e,t){for(var s=(t=(t=t||e.length)>e.length?e.length:t)-1;0<=s&&128==(192&e[s]);)s--;return!(s<0||0===s)&&s+ar[e[s]]>t?s:t},pr={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8},gr={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},mr=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0},fr=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1},Mr=Object.prototype.toString;function Ir(e){if(!(this instanceof Ir))return new Ir(e);this.options=bo.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options,e=(t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits)&&(t.windowBits=-15),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new mr,this.strm.avail_out=0,nr.inflateInit2(this.strm,t.windowBits));if(e!==pr.Z_OK)throw new Error(gr[e]);if(this.header=new fr,nr.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=ur(t.dictionary):"[object ArrayBuffer]"===Mr.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw)&&(e=nr.inflateSetDictionary(this.strm,t.dictionary))!==pr.Z_OK)throw new Error(gr[e])}function Cr(e,t){t=new Ir(t);if(t.push(e,!0),t.err)throw t.msg||gr[t.err];return t.result}Ir.prototype.push=function(e,t){var s,i,r,o,n,a=this.strm,l=this.options.chunkSize,d=this.options.dictionary,c=!1;if(this.ended)return!1;i=t===~~t?t:!0===t?pr.Z_FINISH:pr.Z_NO_FLUSH,"string"==typeof e?a.input=dr(e):"[object ArrayBuffer]"===Mr.call(e)?a.input=new Uint8Array(e):a.input=e,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new bo.Buf8(l),a.next_out=0,a.avail_out=l),(s=(s=nr.inflate(a,pr.Z_NO_FLUSH))===pr.Z_NEED_DICT&&d?nr.inflateSetDictionary(this.strm,d):s)===pr.Z_BUF_ERROR&&!0===c&&(s=pr.Z_OK,c=!1),s!==pr.Z_STREAM_END&&s!==pr.Z_OK)return this.onEnd(s),!(this.ended=!0)}while(!a.next_out||0!==a.avail_out&&s!==pr.Z_STREAM_END&&(0!==a.avail_in||i!==pr.Z_FINISH&&i!==pr.Z_SYNC_FLUSH)||("string"===this.options.to?(r=hr(a.output,a.next_out),o=a.next_out-r,n=_r(a.output,r),a.next_out=o,a.avail_out=l-o,o&&bo.arraySet(a.output,a.output,r,o,0),this.onData(n)):this.onData(bo.shrinkBuf(a.output,a.next_out))),0===a.avail_in&&0===a.avail_out&&(c=!0),(0<a.avail_in||0===a.avail_out)&&s!==pr.Z_STREAM_END);return(i=s===pr.Z_STREAM_END?pr.Z_FINISH:i)===pr.Z_FINISH?(s=nr.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===pr.Z_OK):i!==pr.Z_SYNC_FLUSH||(this.onEnd(pr.Z_OK),!(a.avail_out=0))},Ir.prototype.onData=function(e){this.chunks.push(e)},Ir.prototype.onEnd=function(e){e===pr.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=bo.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Tr={Inflate:Ir,inflate:Cr,inflateRaw:function(e,t){return(t=t||{}).raw=!0,Cr(e,t)},ungzip:Cr},yr={},vr=((0,bo.assign)(yr,Tr,pr),yr);class Er{constructor(e){this._m=e,this._n="InflateModule",this._bLogForInflateOK=!1,this._bLogForInflateError=!1}inflate(e){var e=new Uint8Array(e).slice(4),t=Date.now();let s;try{s=vr.inflate(e,{to:"string"}),this._bLogForInflateOK||(this._bLogForInflateOK=!0,new Ti("inflateOK").end())}catch(e){return this._bLogForInflateError?void 0:(this._bLogForInflateError=!0,void new Ti("inflateError").setMessage(e).end())}var e=e.length+4,i=s.length;return Ce.d(`inflate ok. zipped:${e} unzipped:${i} compression ratio:${Math.round(100*(i-e)/i)}% cost:`+(Date.now()-t)),s}reset(){Ce.l(this._n+".reset"),this._bLogForInflateOK=!1,this._bLogForInflateError=!1}}class Sr{constructor(s){var e=new Ti("sdkConstruct");if(this._n="ModuleManager",this._isReady=!1,this._reason=ei.USER_NOT_LOGGED_IN,this._startLoginTs=0,this._map=new Map,this._optionalModuleMap=new Map,this._codeMsgForTUIMap=new Map,this._iEmitter=null,this._oEmitter=null,this._checkCount=0,this._checkTimer=-1,this._map.set(Rs,new vn(this,s)),this._map.set(Js,new Er(this)),this._map.set(Os,new Un(this)),this._map.set(qs,new No(this)),this._map.set(ws,new yo(this)),this._map.set(bs,new Ao(this)),this._map.set($s,new Lo(this)),this._map.set(ks,new ho(this)),this._map.set(Gs,new To(this)),this._map.set(Ms,new Sn(this)),this._map.set(Is,new Kn(this)),this._map.set(Cs,new Hn(this)),this._map.set(Ys,new Wn(this)),this._map.set(Ks,new Yn(this)),this._map.set(Ts,new yn(this)),this._map.set(ys,new Wi(this)),this._map.set(Ds,new _n(this)),this._map.set(Ss,new mn(this)),this._map.set(Ls,new Rn(this)),this._map.set(Hs,new wo(this)),this._map.set(As,new On(this)),this._map.set(Ns,new $n(this)),this._map.set(Ps,new zn(this)),this._map.set(Us,new jn(this)),this._map.set(Fs,new vo(this)),this._map.set(xs,new Po(this)),this._map.set(js,new Uo(this)),this._map.set(Vs,new Go(this)),this._map.set(Bs,new ko(this)),this._eventThrottleMap=new Map,this._eventThrottling=s.eventThrottling,this._map.get(Rs).isPartialUpdatedConvs()&&(this._eventThrottling=!1),be(s.modules)){let t;Object.keys(s.modules).forEach(e=>{t=s.modules[e],"group-module"===e?this._map.set(vs,new t(this)):"relationship-module"===e?this._map.set(Es,new t(this)):"signaling-module"===e?this._map.set(Ws,new t(this)):"follow-module"===e?this._map.set(zs,new t(this)):"cloud-search-module"===e&&this._map.set(Xs,new t(this)),this._optionalModuleMap.set(e,1)}),this._map.get(Rs).setUsingChatCore(!0)}else this._map.has(vs)||this._map.get(Rs).setUsingChatCore(!0);var{instanceID:t,SDKAppID:i}=s,t=`instanceID:${t} SDKAppID:${i} isIntl:${this._map.get(Rs).isIntl()} isUsingChatCore:${this._map.get(Rs).isUsingChatCore()} host:${ht()} isIOSWebView:${re} platform:${V} canIUseInflate:${this.canIUseInflate()} workerAvailable:${ie} eventThrottling:${this._eventThrottling} UserAgent:`+q;Ti.bindEventStatModule(this._map.get(As)),Ti.bindNetMonitorModule(this._map.get(Os)),e.setMessage(t+" "+function(){let t="";if(k)try{var{model:e,version:s,system:i,platform:r,SDKVersion:o}=$.getSystemInfoSync();t=`model:${e} version:${s} system:${i} platform:${r} SDKVersion:`+o}catch(e){t=""}return t}()).end(),Ce.i("SDK "+t),Qs.prototype._getErrMsg=this.getErrMsg.bind(this),this._readyList=void 0,this._ssoLogForReady=null,this._initReadyList()}_startTimer(){var e=this._map.get(bs),t=e.isWorkerEnabled();Ce.l(this._n+`.startTimer isWorkerEnabled:${t} seed:`+this._checkTimer),t?e.startWorkerTimer():this._startMainThreadTimer()}_startMainThreadTimer(){this._checkTimer<0&&(this._checkTimer=setInterval(this.onCheckTimer.bind(this),1e3)),Ce.l(this._n+"._startMainThreadTimer seed:"+this._checkTimer)}stopTimer(){var e=this._map.get(bs),t=e.isWorkerEnabled();Ce.l(this._n+`.stopTimer isWorkerEnabled:${t} seed:`+this._checkTimer),t?e.stopWorkerTimer():this._stopMainThreadTimer()}_stopMainThreadTimer(){Ce.l(this._n+"._stopMainThreadTimer"),0<this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=-1,this._checkCount=0)}_stopMainThreadSocket(){Ce.l(this._n+"._stopMainThreadSocket");var e=this._map.get(ks);e.setIsWorkerEnabled(!0),e.reConnect()}_startMainThreadSocket(){Ce.l(this._n+"._startMainThreadSocket");var e=this._map.get(ks);e.setIsWorkerEnabled(!1),e.reConnect()}onWorkerTimerEnabled(){Ce.l(this._n+".onWorkerTimerEnabled, disable main thread timer and socket"),this._stopMainThreadTimer(),this._stopMainThreadSocket()}onWorkerTimerDisabled(){Ce.l(this._n+".onWorkerTimerDisabled, enable main thread timer and socket"),this._startMainThreadTimer(),this._startMainThreadSocket()}onCheckTimer(){this._checkCount+=1;for(var[,e]of this._map)e.onCheckTimer&&e.onCheckTimer(this._checkCount)}_initReadyList(){this._readyList=[this._map.get(Ms)],this._readyList.forEach(e=>{e.ready(()=>this._onModuleReady())})}_onModuleReady(){let t=!0;if(this._readyList.forEach(e=>{e.isReady()||(t=!1)}),t&&!this._isReady){this._isReady=!0,this._oEmitter.emit(e.SDK_READY);let t=Date.now()-this._startLoginTs;Ce.w(`SDK is ready. cost ${t} ms`),this._startLoginTs=Date.now();var s=this._ssoLogForReady.getStartTs()+he;this._ssoLogForReady.setMessage(t).start(s).end()}}login(){0===this._startLoginTs&&(ge(),this._startLoginTs=Date.now(),this._startTimer(),this._map.get(Os).start(),this._ssoLogForReady=new Ti("sdkReady"),this._reason=ei.LOGGING_IN)}onLoginFailed(){this._startLoginTs=0}getOEmitInst(){return null===this._oEmitter&&(this._oEmitter=new kn,si(this._oEmitter),this._oEmitter._emit=this._oEmitter.emit,this._oEmitter.emit=function(s,t){if(this._canIUseSignaling()&&(s===e.MESSAGE_RECEIVED&&this.get(Ws).onNewMessageList(t),s===e.MESSAGE_MODIFIED)&&this.get(Ws).onMessageModified(t),s===e.CONVERSATION_LIST_UPDATED||s===e.FRIEND_LIST_UPDATED||s===e.GROUP_LIST_UPDATED||s===e.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED)if(!1!==this._eventThrottling)if(this._eventThrottleMap.has(s)){let e=Date.now(),t=this._eventThrottleMap.get(s);e-t.last<=1e3?(-1<t.timeoutID&&clearTimeout(t.timeoutID),t.timeoutID=setTimeout(()=>{t.last=Date.now(),this._oEmitter._emit.apply(this._oEmitter,[s,{name:s,data:this._getEventData(s)}])},1e3)):(t.last=e,this._oEmitter._emit.apply(this._oEmitter,[s,{name:s,data:this._getEventData(s)}]))}else this._eventThrottleMap.set(s,{last:Date.now(),timeoutID:-1}),this._oEmitter._emit.apply(this._oEmitter,[s,{name:s,data:this._getEventData(s)}]);else this._oEmitter._emit.apply(this._oEmitter,[s,{name:s,data:this._getEventData(s)}]);else this._oEmitter._emit.apply(this._oEmitter,[s,{name:s,data:t}])}.bind(this)),this._oEmitter}_canIUseSignaling(){var e=this.get(Ws);return!!e&&e.canIUseSignaling()}_getEventData(t){return t===e.CONVERSATION_LIST_UPDATED?this._map.get(Rs).isPartialUpdatedConvs()?this._map.get(Ds).getPartialUpdatedConvs():this._map.get(Ds).getLocalConvList():t===e.FRIEND_LIST_UPDATED?this._map.get(Es).getLocalFriendList(!1):t===e.GROUP_LIST_UPDATED?this._map.get(vs).getLocalGroupList():t===e.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?this._map.get(Ds).getTotalUnreadCount():t===e.CONVERSATION_ID_LIST_UPDATED?this._map.get(Ds).getUpdatedConvIDList():void 0}getIEmitInst(){return null===this._iEmitter&&(this._iEmitter=new kn,this._iEmitter._emit=this._iEmitter.emit,this._iEmitter.emit=function(e,t){e=be(t)&&t.data?[e,{name:e,data:t.data}]:[e,{name:e,data:t}];this._iEmitter._emit.apply(this._iEmitter,e)}.bind(this)),this._iEmitter}hasModule(e){return this._map.has(e)}get(e){return this._map.get(e)}canIUseModule(e){return!this._map.get(Rs).isUsingChatCore()||this._optionalModuleMap.has(e)}canIUseInflate(){return!!this._map.get(Js)}isReady(){return this._isReady}isIntl(){return this.get(Rs).isIntl()}getNotReadyReason(){return this._reason}setNotReadyReason(e){this._reason=e}getErrMsg(e,t,s){return this._map.get(Hs).get({key:e,replacement1:t,replacement2:s,isIntl:this.isIntl()})}warn(e,t,s){e=this.getErrMsg(e,t,s);e&&Ce.w(e)}onError(t){var s=`code:${t.code} message:`+t.message;Ce.w("Oops! "+s),new Ti("error").setMessage(s).setLevel("error").end(),this.getOEmitInst().emit(e.ERROR,t)}restartTimer(){Ce.l(this._n+".restartTimer"),this.stopTimer(),this._startTimer();var e=this.get(vs);e&&e.restartPolling()}getTimerID(){var e=this._map.get(bs);return e.isWorkerEnabled()?e.getTimerID():this._checkTimer}getPollingTimerID(e){return this._map.get(vs).getPollingTimerID(e)}statTUIKeyFeatures(e){var{code:e,msg:t=""}=e,s=e+t;this._codeMsgForTUIMap.has(s)||(this._codeMsgForTUIMap.set(s,1),s=this.get(Rs).getUIPlatform(),new Ti("tui_key_features").setCode(e).setMessage(t).setUIPlatform(s).end())}reset(){Ce.l(this._n+".reset"),ge();for(let[,e]of this._map)e.reset&&e.reset();this._startLoginTs=0,this._initReadyList(),this._isReady=!1,this.stopTimer(),this._oEmitter.emit(e.SDK_NOT_READY);for(let[,e]of this._eventThrottleMap)-1<e.timeoutID&&clearTimeout(e.timeoutID);this._eventThrottleMap.clear(),this._codeMsgForTUIMap.clear()}}class Dr{constructor(e){this._funcMap=new Map,this._m=e,this._n="SafetyCallback",this._reportCount=0}defense(e,t,s){if("string"!=typeof e)return null;if(0===e.length)return null;if("function"!=typeof t)return null;if(this._funcMap.has(e)&&this._funcMap.get(e).has(t))return this._funcMap.get(e).get(t);this._funcMap.has(e)||this._funcMap.set(e,new Map);let i=null;return this._funcMap.get(e).has(t)?i=this._funcMap.get(e).get(t):(i=this._pack(e,t,s),this._funcMap.get(e).set(t,i)),i}defenseOnce(e,t,s){return"function"!=typeof t?null:this._pack(e,t,s)}find(e,t){return"string"!=typeof e||0===e.length||"function"!=typeof t?null:this._funcMap.has(e)&&this._funcMap.get(e).has(t)?this._funcMap.get(e).get(t):(this._m.warn("ListenerFnNotFound",e),null)}delete(e,t){return"function"==typeof t&&!!this._funcMap.has(e)&&!!this._funcMap.get(e).has(t)&&(this._funcMap.get(e).delete(t),0===this._funcMap.get(e).size&&this._funcMap.delete(e),!0)}_pack(t,s,i){let o=this;return function(){try{s.apply(i,Array.from(arguments))}catch(s){let i=Object.values(e).indexOf(t),r="CallbackError";if(-1!==i){let t=Object.keys(e)[i];o._m.warn(r,t,s)}o._reportCount<5&&(new Ti(r).setMessage("eventName:"+t).setMoreMessage(s.message).end(),o._reportCount+=1)}}}destroy(){this._funcMap.clear()}reset(){Ce.l(this._n+".reset"),this._reportCount=0}}class Rr{constructor(e){e={SDKAppID:e.SDKAppID,unlimitedAVChatRoom:e.unlimitedAVChatRoom||!1,scene:e.scene||"",oversea:e.oversea||!1,instanceID:_t(),devMode:e.devMode||!1,testEnv:e.testEnv||!1,proxyServer:e.proxyServer||void 0,fileUploadProxy:e.fileUploadProxy||void 0,fileDownloadProxy:e.fileDownloadProxy||e.fileUploadProxy||void 0,eventThrottling:!1!==e.eventThrottling,partialUpdatedConversations:!0===e.partialUpdatedConversations,disableIndependentDomain:!0===e.disableIndependentDomain,modules:e.modules||void 0};this._m=new Sr(e),this._safetyCallbackFactory=new Dr(this._m)}onError(e){this._m.onError(e)}login(e){return this._m.login(),this._get(Ms).login(e)}logout(){return this._get(Ms).logout().then(e=>(this._safetyCallbackFactory.reset(),this._m.reset(),e))}getLoginUser(){return this._get(Ms).getLoginUser()}getServerTime(){return pe()}isReady(){return this._m.isReady()}isIntl(){return this._m.isIntl()}getNotReadyReason(){return this._m.getNotReadyReason()}getErrMsg(e,t,s){return this._m.getErrMsg(e,t,s)}_get(e){return this._m.get(e)}destroy(){let t=this._get(Rs),s=t.getSDKAppID();return Ce.w(`destroy ${s} `+t.getInstanceID()),this.logout().finally(()=>{this._safetyCallbackFactory.destroy(),this._m.stopTimer(),this._get(bs).terminate(),this._get(ks).dealloc(),this._m.getOEmitInst().emit(e.SDK_DESTROY,{SDKAppID:s})})}on(e,t,s){Ce.d("on","eventName:"+e),this._m.getOEmitInst().on(e,this._safetyCallbackFactory.defense(e,t,s),s)}once(e,t,s){Ce.d("once","eventName:"+e),this._m.getOEmitInst().once(e,this._safetyCallbackFactory.defenseOnce(e,t,s),s||this)}off(e,t,s,i){Ce.d("off","eventName:"+e);var r=this._safetyCallbackFactory.find(e,t);null!==r&&(this._m.getOEmitInst().off(e,r,s,i),this._safetyCallbackFactory.delete(e,t))}registerPlugin(e){($e(e["tim-push"])?$e(e["tim-offline-push-plugin"])?this._get(Ps):this._get(xs):this._get(js)).registerPlugin(e)}setLogLevel(e){if(e<=0){let e=this.getErrMsg("TIM_ASCII_ART");e&&console.log(e);var t=this.getErrMsg("API_REFER");if(t){let e="IM SDK API ->";Et()?console.log(`%c ${e} %c`,"background:#ff9d00; padding:1px; border-radius:3px; color: #fff","background:transparent",t):console.log(e,t)}t=this.getErrMsg("DOCS_GUIDE"),t=(t&&console.log(t),this.getErrMsg("IOS_WEBVIEW_WARNING"));re&&t&&console.warn(t)}Ce.setLevel(e)}createTextMessage(e){return this._get(Is).createTextMessage(e)}createTextAtMessage(e){return this._get(Is).createTextMessage(e)}createImageMessage(e){return this._get(Is).createImageMessage(e)}createAudioMessage(e){return this._get(Is).createAudioMessage(e)}createVideoMessage(e){return this._get(Is).createVideoMessage(e)}createCustomMessage(e){return this._get(Is).createCustomMessage(e)}createFaceMessage(e){return this._get(Is).createFaceMessage(e)}createFileMessage(e){return this._get(Is).createFileMessage(e)}createLocationMessage(e){return this._get(Is).createLocationMessage(e)}createMergerMessage(e){return this._get(Is).createMergerMessage(e)}downloadMergerMessage(e){return e.type!==t.MSG_MERGER?ni({code:ei.MSG_MERGER_TYPE_INVALID}):Oe(e.payload.downloadKey)?ni({code:ei.MSG_MERGER_KEY_INVALID}):this._get(Is).downloadMergerMessage(e).catch(e=>ni({code:ei.MSG_MERGER_DOWNLOAD_FAIL}))}createForwardMessage(e){return this._get(Is).createForwardMessage(e)}sendMessage(e,t){return e instanceof xi?this._get(Is).sendMessageInstance(e,t):ni({code:ei.MSG_INSTANCE_REQUIRED})}callExperimentalAPI(e,t){return"sendComboMessage"===e?this._get(Ks).sendMessage(t):"handleGroupInvitation"===e?this._get(vs).handleGroupInvitation(t):"isCommercialAbilityEnabled"===e?this._get(qs).isFeatureEnabled(t):"isFeatureEnabledForStat"===e?this._get(qs).isFeatureEnabledForStat(t):"isIntl"===e?this.isIntl():"sendTRTCCustomData"===e||"sendRoomCustomData"===e?this._get(Bs).sendTRTCCustomData(t):"getTimerID"===e?this._m.getTimerID():"getPollingTimerID"===e?this._m.getPollingTimerID(t):"setApplicationID"!==e?"getServerConfig"===e?this._get(ws).getServerConfig(t):"canIUseModule"===e?this._m.canIUseModule(t):"startMessageLongPolling"===e?this._get(vs).startMessageLongPolling(t):"stopMessageLongPolling"===e?this._get(vs).stopMessageLongPolling(t):"disableMessagePullOnInvite"===e?this._get(Ds).disableMsgPullOnInvite(t):"clearLocalMessage"===e?this._get(Ds).clearMemMsg(t,!1):"setCustomLoginInfo"===e?this._get(Rs).setCustomLoginInfo(t):"statTUIKeyFeatures"===e?this._m.statTUIKeyFeatures(t):"getGroupReceiptsByUsers"===e?this._get(vs).getGroupReceiptsByUsers(t):ni({code:ei.INVALID_OPERATION}):(this._get(Rs).setApplicationID(t),void this._get(Gs).updateProtocolConfig())}revokeMessage(e){return this._get(Is).revokeMessage(e)}resendMessage(e,t){return e instanceof xi?this._get(Is).resendMessage(e,t):ni({code:ei.MSG_INSTANCE_REQUIRED})}deleteMessage(e){return this._get(Is).deleteMessage(e)}translateText(e){return this._get(Is).translateText(e)}convertVoiceToText(e){return this._get(Is).convertVoiceToText(e)}setMessageExtensions(e,t){return this._get(Cs).setMessageExtensions(e,t)}getMessageExtensions(e){return this._get(Cs).getMessageExtensions(e)}deleteMessageExtensions(e,t){return this._get(Cs).deleteMessageExtensions(e,t)}addMessageReaction(e,t){return this._get(Ys).addMessageReaction(e,t)}removeMessageReaction(e,t){return this._get(Ys).removeMessageReaction(e,t)}getMessageReactions(e){return this._get(Ys).getMessageReactions(e)}getAllUserListOfMessageReaction(e){return this._get(Ys).getAllUserListOfMessageReaction(e)}modifyMessage(e){return this._get(Is).modifyRemoteMessage(e)}getMessageList(e){return this._get(Ds).getMessageList(e)}getMessageListHopping(e){return this._get(Ds).getMessageListHopping(e)}sendMessageReadReceipt(e){return this._get(Ds).sendReadReceipt(e)}getMessageReadReceiptList(e){return this._get(Ds).getReadReceiptList(e)}getGroupMessageReadMemberList(e){var t=this._get(vs);return t?t.getReadReceiptDetail(e):ni({code:ei.NO_MODULE})}findMessage(e){return this._get(Ds).findMessage(e)}setMessageRead(e){return this._get(Ds).setMessageRead(e)}getConversationList(e){return this._get(Ds).getConvList(e)}getConversationProfile(e){return this._get(Ds).getConversationProfile(e)}deleteConversation(e){return this._get(Ds).deleteConversation(e)}setConversationDraft(e){return this._get(Ds).setConvDraft(e)}clearHistoryMessage(e){return this._get(Ds).clearHistoryMessage(e)}pinConversation(e){return this._get(Ds).pinConversation(e)}setAllMessageRead(e){return this._get(Ds).setAllMessageRead(e)}setMessageRemindType(e){return this._get(Ds).setMessageRemindType(e)}setAllReceiveMessageOpt(e){return this._get(Ds).setAllRcvMsgOpt(e)}getAllReceiveMessageOpt(){return this._get(Ds).getAllRcvMsgOpt()}getTotalUnreadMessageCount(){return this._get(Ds).getTotalUnreadCount()}setConversationCustomData(e){return this._get(Ds).setConvCustomData(e)}markConversation(e){return this._get(Ds).markConv(e)}getConversationGroupList(){return this._get(Ds).getConvGroupList()}createConversationGroup(e){return this._get(Ds).createConvGroup(e)}deleteConversationGroup(e){return this._get(Ds).deleteConvGroup(e)}renameConversationGroup(e){return this._get(Ds).renameConvGroup(e)}addConversationsToGroup(e){return this._get(Ds).addConvsToGroup(e)}deleteConversationsFromGroup(e){return this._get(Ds).deleteConvsFromGroup(e)}searchCloudMessages(e){var t=this._get(Xs);return t?t.searchCloudMessages(e):ni({code:ei.NO_MODULE})}searchCloudUsers(e){var t=this._get(Xs);return t?t.searchCloudUsers(e):ni({code:ei.NO_MODULE})}searchCloudGroups(e){var t=this._get(Xs);return t?t.searchCloudGroups(e):ni({code:ei.NO_MODULE})}searchCloudGroupMembers(e){var t=this._get(Xs);return t?t.searchCloudGroupMembers(e):ni({code:ei.NO_MODULE})}getMyProfile(){return this._get(Ts).getMyProfile()}getUserProfile(e){return this._get(Ts).getUserProfile(e)}updateMyProfile(e){return this._get(Ts).updateMyProfile(e)}getBlacklist(){return this._get(Ts).getLocalBlacklist()}addToBlacklist(e){return this._get(Ts).addBlacklist(e)}removeFromBlacklist(e){return this._get(Ts).deleteBlacklist(e)}setSelfStatus(e){return this._get(Ts).setSelfStatus(e)}getUserStatus(e){return this._get(Ts).getUserStatus(e)}subscribeUserStatus(e){return this._get(Ts).subscribeUserStatus(e)}unsubscribeUserStatus(e){return this._get(Ts).unsubscribeUserStatus(e)}getFriendList(){var e=this._get(Es);return e?e.getLocalFriendList():ni({code:ei.NO_MODULE})}addFriend(e){var t=this._get(Es);return t?t.addFriend(e):ni({code:ei.NO_MODULE})}deleteFriend(e){var t=this._get(Es);return t?t.deleteFriend(e):ni({code:ei.NO_MODULE})}checkFriend(e){var t=this._get(Es);return t?t.checkFriend(e):ni({code:ei.NO_MODULE})}getFriendProfile(e){var t=this._get(Es);return t?t.getFriendProfile(e):ni({code:ei.NO_MODULE})}updateFriend(e){var t=this._get(Es);return t?t.updateFriend(e):ni({code:ei.NO_MODULE})}getFriendApplicationList(){var e=this._get(Es);return e?e.getLocalFriendApplicationList():ni({code:ei.NO_MODULE})}acceptFriendApplication(e){var t=this._get(Es);return t?t.acceptFriendApplication(e):ni({code:ei.NO_MODULE})}refuseFriendApplication(e){var t=this._get(Es);return t?t.refuseFriendApplication(e):ni({code:ei.NO_MODULE})}deleteFriendApplication(e){var t=this._get(Es);return t?t.deleteFriendApplication(e):ni({code:ei.NO_MODULE})}setFriendApplicationRead(){var e=this._get(Es);return e?e.setFriendApplicationRead():ni({code:ei.NO_MODULE})}getFriendGroupList(){var e=this._get(Es);return e?e.getLocalFriendGroupList():ni({code:ei.NO_MODULE})}createFriendGroup(e){var t=this._get(Es);return t?t.createFriendGroup(e):ni({code:ei.NO_MODULE})}deleteFriendGroup(e){var t=this._get(Es);return t?t.deleteFriendGroup(e):ni({code:ei.NO_MODULE})}addToFriendGroup(e){var t=this._get(Es);return t?t.addToFriendGroup(e):ni({code:ei.NO_MODULE})}removeFromFriendGroup(e){var t=this._get(Es);return t?t.removeFromFriendGroup(e):ni({code:ei.NO_MODULE})}renameFriendGroup(e){var t=this._get(Es);return t?t.renameFriendGroup(e):ni({code:ei.NO_MODULE})}followUser(e){var t=this._get(zs);return t?t.followUser(e):ni({code:ei.NO_MODULE})}unfollowUser(e){var t=this._get(zs);return t?t.unfollowUser(e):ni({code:ei.NO_MODULE})}getMyFollowersList(e){var t=this._get(zs);return t?t.getMyFollowersList(e):ni({code:ei.NO_MODULE})}getMyFollowingList(e){var t=this._get(zs);return t?t.getMyFollowingList(e):ni({code:ei.NO_MODULE})}getMutualFollowersList(e){var t=this._get(zs);return t?t.getMutualFollowersList(e):ni({code:ei.NO_MODULE})}getUserFollowInfo(e){var t=this._get(zs);return t?t.getUserFollowInfo(e):ni({code:ei.NO_MODULE})}checkFollowType(e){var t=this._get(zs);return t?t.checkFollowType(e):ni({code:ei.NO_MODULE})}getGroupList(){var e=this._get(vs);return e?e.getGroupList():ni({code:ei.NO_MODULE})}getGroupProfile(e){var t=this._get(vs);return t?t.getGroupProfile(e):ni({code:ei.NO_MODULE})}createGroup(e){var t=this._get(vs);return t?t.createGroup(e):ni({code:ei.NO_MODULE})}dismissGroup(e){var t=this._get(vs);return t?t.dismissGroup(e):ni({code:ei.NO_MODULE})}updateGroupProfile(e){var t=this._get(vs);return t?t.updateGroupProfile(e):ni({code:ei.NO_MODULE})}joinGroup(e){var t=this._get(vs);return t?t.joinGroup(e):ni({code:ei.NO_MODULE})}quitGroup(e){var t=this._get(vs);return t?t.quitGroup(e):ni({code:ei.NO_MODULE})}searchGroupByID(e){var t=this._get(vs);return t?t.searchGroupByID(e):ni({code:ei.NO_MODULE})}getGroupOnlineMemberCount(e){var t=this._get(vs);return t?t.getGroupOnlineMemberCount(e):ni({code:ei.NO_MODULE})}changeGroupOwner(e){var t=this._get(vs);return t?t.changeGroupOwner(e):ni({code:ei.NO_MODULE})}getGroupApplicationList(){var e=this._get(vs);return e?e.getGroupApplicationList():ni({code:ei.NO_MODULE})}handleGroupApplication(e){var t=this._get(vs);return t?t.handleGroupApplication(e):ni({code:ei.NO_MODULE})}initGroupAttributes(e){var t=this._get(vs);return t?t.initGroupAttributes(e):ni({code:ei.NO_MODULE})}setGroupAttributes(e){var t=this._get(vs);return t?t.setGroupAttributes(e):ni({code:ei.NO_MODULE})}deleteGroupAttributes(e){var t=this._get(vs);return t?t.deleteGroupAttributes(e):ni({code:ei.NO_MODULE})}getGroupAttributes(e){var t=this._get(vs);return t?t.getGroupAttributes(e):ni({code:ei.NO_MODULE})}setGroupCounters(e){var t=this._get(vs);return t?t.setGroupCounters(e):ni({code:ei.NO_MODULE})}increaseGroupCounter(e){var t=this._get(vs);return t?t.increaseGroupCounter(e):ni({code:ei.NO_MODULE})}decreaseGroupCounter(e){var t=this._get(vs);return t?t.decreaseGroupCounter(e):ni({code:ei.NO_MODULE})}getGroupCounters(e){var t=this._get(vs);return t?t.getGroupCounters(e):ni({code:ei.NO_MODULE})}getGroupMemberList(e){var t=this._get(vs);return t?t.getGroupMemberList(e):ni({code:ei.NO_MODULE})}getGroupMemberProfile(e){var t=this._get(vs);return t?t.getGroupMemberProfile(e):ni({code:ei.NO_MODULE})}addGroupMember(e){var t=this._get(vs);return t?t.addGroupMember(e):ni({code:ei.NO_MODULE})}deleteGroupMember(e){var t=this._get(vs);return t?t.deleteGroupMember(e):ni({code:ei.NO_MODULE})}setGroupMemberMuteTime(e){var t=this._get(vs);return t?t.setGroupMemberMuteTime(e):ni({code:ei.NO_MODULE})}setGroupMemberRole(e){var t=this._get(vs);return t?t.setGroupMemberRole(e):ni({code:ei.NO_MODULE})}setGroupMemberNameCard(e){var t=this._get(vs);return t?t.setGroupMemberNameCard(e):ni({code:ei.NO_MODULE})}setGroupMemberCustomField(e){var t=this._get(vs);return t?t.setGroupMemberCustomField(e):ni({code:ei.NO_MODULE})}markGroupMemberList(e){var t=this._get(vs);return t?t.markGroupMemberList(e):ni({code:ei.NO_MODULE})}getJoinedCommunityList(){return this._get(Ss).getJoinedCommunityList()}createTopicInCommunity(e){return this._get(Ss).createTopicInCommunity(e)}deleteTopicFromCommunity(e){return this._get(Ss).deleteTopicFromCommunity(e)}updateTopicProfile(e){return this._get(Ss).updateTopicProfile(e)}getTopicList(e){return this._get(Ss).getTopicList(e)}addSignalingListener(e,t,s){var i=this._get(Ws);i&&i.addSignalingListener(e,this._safetyCallbackFactory.defense(e,t,s),s)}removeSignalingListener(e,t,s){var i,r=this._safetyCallbackFactory.find(e,t);null!==r&&(i=this._get(Ws))&&(i.removeSignalingListener(e,r,s),this._safetyCallbackFactory.delete(e,t))}invite(e){var t=this._get(Ws);return t?t.invite(e):ni({code:ei.NO_MODULE})}inviteSync(e,t,s){var i=this._get(Ws);return i?i.inviteSync(e,t,s):""}inviteInGroup(e){var t=this._get(Ws);return t?t.invite(e):ni({code:ei.NO_MODULE})}inviteInGroupSync(e,t,s){var i=this._get(Ws);return i?i.inviteSync(e,t,s):""}cancel(e){var t=this._get(Ws);return t?t.cancel(e):ni({code:ei.NO_MODULE})}accept(e){var t=this._get(Ws);return t?t.accept(e):ni({code:ei.NO_MODULE})}reject(e){var t=this._get(Ws);return t?t.reject(e):ni({code:ei.NO_MODULE})}getSignalingInfo(e){var t=this._get(Ws);return t?t.getSignalingInfo(e):null}modifyInvitation(e){var t=this._get(Ws);return t?t.modifyInvitation(e):ni({code:ei.NO_MODULE})}}let Lr={login:1,logout:1,getLoginUser:1,destroy:1,on:1,off:1,ready:1,setLogLevel:1,joinGroup:1,quitGroup:1,registerPlugin:1,getGroupOnlineMemberCount:1,isReady:1,addSignalingListener:1,removeSignalingListener:1,callExperimentalAPI:1};function Ar(e,t){var s;return!(!e.isReady()&&1!==Lr[t])||(s={code:s=e.getNotReadyReason(),message:e.getErrMsg(s)+` | ${t} | `+e.getErrMsg(ei.SDK_IS_NOT_READY)},e.onError(s),s)}let Or={},Nr={create:function(t){var i="TencentCloudChat.create";let r=0;var o=t["SDKAppID"];if(Ge(o))r=o;else if(r=parseInt(o),isNaN(o))return Ce.e(i+" failed. Failed to parse the SDKAppID, please check the arguments"),null;if(r&&Or[r])return Or[r];Ce.l(i);o=new Rr({...t,SDKAppID:r}),o.on(e.SDK_DESTROY,e=>{Or[e.data.SDKAppID]=null,delete Or[e.data.SDKAppID]}),t=function(r){let e=Object.create(null);return Object.keys(fs).forEach(i=>{if(r[i]){let t=new s;e[i]=function(){var e=Array.from(arguments);return t.use(function(e,t){var s=Ar(r,i);return!0===s?t():ni(s)}).use(function(e,t){if(!0===Lt(e,ms[i],i))return t()}).use(function(e,t){return r[i].apply(r,e)}),t.run(e)}}}),e}(o);return Or[r]=t,ms.hookGetAPITips(o.getErrMsg.bind(o)),Ce.l(i+" ok"),t}};Nr.TYPES=t,Nr.EVENT=e,Nr.TSignaling={NEW_INVITATION_RECEIVED:"newInvitationReceived",INVITEE_ACCEPTED:"ts_invitee_accepted",INVITEE_REJECTED:"ts_invitee_rejected",INVITATION_CANCELLED:"ts_invitation_cancelled",INVITATION_TIMEOUT:"ts_invitation_timeout",INVITATION_MODIFIED:"ts_invitation_modified",ACTION_TYPE_UNKNOWN:0,ACTION_TYPE_INVITE:1,ACTION_TYPE_CANCEL_INVITE:2,ACTION_TYPE_ACCEPT_INVITE:3,ACTION_TYPE_REJECT_INVITE:4,ACTION_TYPE_INVITE_TIMEOUT:5},Nr.VERSION="3.5.3",Ce.l("TencentCloudChat.VERSION:"+Nr.VERSION);export{Nr as default};