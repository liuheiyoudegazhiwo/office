
<html>
  <head>
    <title>LVB Timeshift Sprite Tester</title>
  </head>
  <body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    Play Domain: <input id="playDomain" type="text" size="64" value="5000.liveplay.myqcloud.com"><br/>
    Play Path: <input id="playPath" type="text" size="64" value="testflv"><br/>
    Stream Id: <input id="playStreamId" type="text" size="64" value="5000_sprite_test_old"><br/>
    Player StartTime: <input id="playStarttime" type="datetime-local"><br/>
    Player EndTime: <input id="playEndtime" type="datetime-local"><br/> 
    Query Mode: <input id="queryMode" type="text" value="1"><br/> 
    <button id="getSpriteConfig">GetSpriteConfig</button><b style="color:Tomato;">Step1</b><br/>
    <p id="status"></p> 

    URL: <input id="playUrl" type="text" size="128" >
    <button id="play">Play</button><b style="color:Tomato;">Step2</b><br/>      
    <video height="600" id="video" controls></video>
    <img id="imgSpriteSub" referrerpolicy="no-referrer" width="0" height="0">
    @<img id="imgSprite" referrerpolicy="no-referrer" width="0" height="0">

    <p>Sprite Info:</p>
    Prefix: <input type="text" id="picPrefix" disabled="disabled" size="100" value="https://images.cnblogs.com/cnblogs_com/rubylouvre/199042/o_s"></br>
    Width: <input type="text" id="picWidth" disabled="disabled" value="100"></br>
    Height: <input type="text" id="picHeight" disabled="disabled" value="100"></br>
    Columns: <input type="text" id="picColumns" disabled="disabled" value="4"></br>
    Rows: <input type="text" id="picRows" disabled="disabled" value="3"></br>
    Interval: <input type="text" id="picInterval" disabled="disabled" value="10"></br>
    Playback Offset: <input type="time" id="playOffset" step="1" value="00:00:00">
    <button id="showSprite">Show Sprite</button> <b style="color:Tomato;">Step3</b>
    <p id="spriteStatus"></p>

    <script>
    // global vars
    var gSpriteConfig = [{}];
    var gConfigIndex = 0;
    var gRelativeOffset = 0;

    // global init
    var now = new Date();
    var utcStart = new Date(now.getTime() + 8*3600*1000 - 3600*1000);
    var utcEnd = new Date(now.getTime() + 8*3600*1000 + 3600*1000);    
    $('#playStarttime').val(utcStart.toISOString().substr(0,16));
    $('#playEndtime').val(utcEnd.toISOString().substr(0,16));    
    $('#getSpriteConfig').click(function(){getSpriteConfig();});
    $('#play').click(function(){play();});
    $('#showSprite').click(function(){showSprite();});
    $('#playOffset').on('input', function(){updateSpriteInfo();});

    
    // functions
    function getPlayOffset() { // playoffset in seconds
		var tVal = $("#playOffset").val();
		var tArray = tVal.split(":");
		return parseInt(tArray[0]) * 3600 + parseInt(tArray[1]) * 60 + parseInt(tArray[2]);
    }
    function getPlayStarttime() {
		var playStarttime = new Date($('#playStarttime').val());
		return playStarttime.getTime() / 1000;
    }
    function getPlayEndtime() {
		var playEndtime = new Date($('#playEndtime').val());
		return playEndtime.getTime() / 1000;
    }

    function getSpriteConfig() {
      var playStarttime = getPlayStarttime();
      var playEndtime = getPlayEndtime();
      var urlPrefix = "http://" + $('#playDomain').val() +
      		      "/" +  $('#playPath').val() +
                      "/" +  $('#playStreamId').val();
      var spriteUrl = urlPrefix +
                    ".json?txTimeshift=on&tsFormat=unix" +
                    "&tsSpritemode=" + $('#queryMode').val() +
                    "&tsStart=" + playStarttime +
                    "&tsEnd=" + playEndtime;
      // xrh req              
      $.get(spriteUrl, function(data, status){
        var statusInfo = spriteUrl + "</br>===></br>" + data + "</br>---</br>";        
        gSpriteConfig = JSON.parse(data);
		gSpriteConfig.sort((a, b) => {
	    	return a.start_time - b.start_time; // ascending order
	  	});
		for (let i = 0; i < gSpriteConfig.length; i++) {
			var ssConf = gSpriteConfig[i];
			if (i == 0 && playStarttime > ssConf.start_time) {
				ssConf.hidden_dur = playStarttime - ssConf.start_time;
				ssConf.play_dur = ssConf.end_time - playStarttime;
				if (ssConf.hasOwnProperty("duration"))
				{
					// estimate previous play duration
					ssConf.play_dur = ssConf.duration * ssConf.play_dur / (ssConf.end_time - ssConf.start_time);
					ssConf.hidden_dur = ssConf.duration - ssConf.play_dur;
				}
			} else {
				ssConf.hidden_dur = 0;
				ssConf.play_dur = ssConf.end_time - ssConf.start_time;
				if (ssConf.hasOwnProperty("duration"))
					ssConf.play_dur = ssConf.duration;
			}
			var unixStart = new Date(ssConf.start_time * 1000);
			var unixEnd = new Date(ssConf.end_time * 1000);
			statusInfo += "[" + unixStart.toLocaleString() + ", " + unixEnd.toLocaleString() + "], " + ssConf.duration + "</br>";
		}
        
        // set status info
        $("#status").html(statusInfo);        
        var playUrl = urlPrefix + ".m3u8?txTimeshift=on&tsFormat=unix" + /* &tsEventmode=on */
                    "&tsStart=" + playStarttime +
                    "&tsEnd=" + playEndtime;
        $("#playUrl").val(playUrl);
        
        updateSpriteInfo();
      });
    }
    
    function updateSpriteInfo() {
		if (gSpriteConfig.length == 0)
		    return;
		
		// calculate the right sid(session) and play offset(within session)
		var playOffset = getPlayOffset();
		var sumDuration = 0;
		gRelativeOffset = playOffset;
		for (let i = 0; i < gSpriteConfig.length; i++) {
			if (playOffset < sumDuration + gSpriteConfig[i].play_dur) {
				gConfigIndex = i;
				gRelativeOffset = playOffset - sumDuration + gSpriteConfig[i].hidden_dur;
				break;
			}
			sumDuration += gSpriteConfig[i].play_dur;
		}

		var sprite = gSpriteConfig[gConfigIndex];
		$("#picPrefix").val("http://" + $('#playDomain').val() + sprite.path);
		$("#picWidth").val(sprite.width);
		$("#picHeight").val(sprite.height);
		$("#picColumns").val(sprite.cols);
		$("#picRows").val(sprite.rows);
		$("#picInterval").val(sprite.interval);  
    }

    function showSprite() {
      // calculate sprite image info
      var picPrefix = $("#picPrefix").val();
      var picWidth = parseInt($("#picWidth").val());
      var picHeight = parseInt($("#picHeight").val());
      var picColumns = parseInt($("#picColumns").val());
      var picRows = parseInt($("#picRows").val());
      var picInterval = parseInt($("#picInterval").val());
        
      var picNo = Math.floor(gRelativeOffset / (picInterval * picColumns * picRows));
      var picOffset = Math.floor(gRelativeOffset % (picInterval * picColumns * picRows) / picInterval)

      // show status
      var picUrl = picPrefix + picNo + ".jpg";
      $("#spriteStatus").html("sprite pic no: " + picNo + 
			  				  ", sprite inner offset: " + picOffset + 
							  ", relative play offset(s): " + gRelativeOffset);

      // hardcode for test
      if (picUrl.indexOf("images.cnblogs.com") >= 0) {
        cnPicNo = picNo + 1;
        cnPicNo = cnPicNo.toString();
        while (cnPicNo.length < 3)
          cnPicNo = "0" + cnPicNo;
        picUrl = picPrefix + cnPicNo + ".jpg";
      }
      picUrl += "?txTimeshift=on"

      // show sprite
      $("#imgSprite").attr("height", picHeight * picRows);
      $("#imgSprite").attr("width", picWidth * picColumns);
      $("#imgSprite").attr("src", picUrl);

      var xpos = -Math.floor(picOffset % picColumns) * picWidth;
      var ypos = -Math.floor(picOffset / picColumns) * picHeight;
      $("#imgSpriteSub").attr("height", picHeight);
      $("#imgSpriteSub").attr("width", picWidth);
      $("#imgSpriteSub").css("background", "url(" + picUrl + ") " + xpos + "px " + ypos + "px");
    }
    
    function play() {     
      var playUrl = $('#playUrl').val(); // 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'    
      var video = document.getElementById('video');
      if (Hls.isSupported()) {
        var hls = new Hls({
          debug: true,
        });
        hls.loadSource(playUrl);
        hls.attachMedia(video);
        hls.on(Hls.Events.MEDIA_ATTACHED, function () {
          video.muted = true;
          video.play();
        });
      }
      // hls.js is not supported on platforms that do not have Media Source Extensions (MSE) enabled.
      // When the browser has built-in HLS support (check using `canPlayType`), we can provide an HLS manifest (i.e. .m3u8 URL) directly to the video element through the `src` property.
      // This is using the built-in support of the plain video element, without using hls.js.
      else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = playUrl;
        video.addEventListener('canplay', function () {
          video.play();
        });
      }
    }
    </script>
 </body>
</html>

