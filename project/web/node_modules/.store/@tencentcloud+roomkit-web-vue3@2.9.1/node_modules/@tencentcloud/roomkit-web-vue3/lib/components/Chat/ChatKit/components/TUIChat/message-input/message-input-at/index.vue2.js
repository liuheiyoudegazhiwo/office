"use strict";
Object.defineProperties(exports, { __esModule: { value: true }, [Symbol.toStringTag]: { value: "Module" } });
const Vue = require("vue");
const TUIChatEngine = require("@tencentcloud/chat-uikit-engine");
const universalApi = require("@tencentcloud/universal-api");
require("../../../../adapter-vue.js");
const env = require("../../../../utils/env.js");
const index = require("../../../common/BottomPopup/index.vue.js");
const _hoisted_1 = {
  ref: "dialog",
  class: "member-list"
};
const _hoisted_2 = {
  key: 0,
  class: "member-list-title"
};
const _hoisted_3 = { class: "title" };
const _hoisted_4 = { class: "member-list-box" };
const _hoisted_5 = ["onClick"];
const _hoisted_6 = ["src"];
const _hoisted_7 = { class: "member-list-box-body-name" };
const _sfc_main = /* @__PURE__ */ Vue.defineComponent({
  __name: "index",
  emits: ["onAtListOpen", "insertAt"],
  setup(__props, { expose: __expose, emit: __emit }) {
    const emits = __emit;
    const MessageInputAt = Vue.ref();
    const memberListItems = Vue.ref();
    const showAtList = Vue.ref(false);
    const memberList = Vue.ref();
    const allMemberList = Vue.ref();
    const showMemberList = Vue.ref();
    const isGroup = Vue.ref(false);
    const position = Vue.ref({
      left: 0,
      top: 0
    });
    const selectedIndex = Vue.ref(0);
    const currentConversationID = Vue.ref("");
    const all = {
      userID: TUIChatEngine.TYPES.MSG_AT_ALL,
      nick: "所有人",
      isAll: true,
      avatar: "https://web.sdk.qcloud.com/im/assets/images/at.svg"
    };
    TUIChatEngine.TUIStore.watch(TUIChatEngine.StoreName.CONV, {
      currentConversationID: (id) => {
        var _a, _b;
        if (id !== currentConversationID.value) {
          currentConversationID.value = id;
          memberList.value = [];
          allMemberList.value = [];
          showMemberList.value = [];
          isGroup.value = false;
          TUIChatEngine.TUIStore.update(TUIChatEngine.StoreName.CUSTOM, "memberList", memberList.value);
          if ((_a = currentConversationID == null ? void 0 : currentConversationID.value) == null ? void 0 : _a.startsWith("GROUP")) {
            isGroup.value = true;
            const groupID = (_b = currentConversationID == null ? void 0 : currentConversationID.value) == null ? void 0 : _b.substring(5);
            TUIChatEngine.TUIGroupService.switchGroup(groupID);
          } else {
            TUIChatEngine.TUIGroupService.switchGroup("");
          }
        }
      }
    });
    TUIChatEngine.TUIStore.watch(TUIChatEngine.StoreName.GRP, {
      currentGroupMemberList: (list) => {
        memberList.value = list;
        allMemberList.value = [all, ...memberList.value];
        showMemberList.value = allMemberList.value;
        TUIChatEngine.TUIStore.update(TUIChatEngine.StoreName.CUSTOM, "memberList", memberList.value);
      }
    });
    const toggleAtList = (show) => {
      if (!isGroup.value) {
        return;
      }
      showAtList.value = show;
      if (showAtList.value) {
        emits("onAtListOpen");
      }
    };
    const handleAtListPosition = (positionData) => {
      position.value = positionData;
    };
    const setCurrentSelectIndex = (index2) => {
      var _a, _b;
      selectedIndex.value = index2;
      (_b = (_a = memberListItems.value) == null ? void 0 : _a[selectedIndex.value]) == null ? void 0 : _b.scrollIntoView(false);
    };
    const setShowMemberList = (list) => {
      showMemberList.value = list;
    };
    universalApi.TUIGlobal.toggleAtList = toggleAtList;
    universalApi.TUIGlobal.handleAtListPosition = handleAtListPosition;
    universalApi.TUIGlobal.setCurrentSelectIndex = setCurrentSelectIndex;
    universalApi.TUIGlobal.setShowMemberList = setShowMemberList;
    __expose({
      toggleAtList
    });
    Vue.watch(
      () => [position.value, MessageInputAt == null ? void 0 : MessageInputAt.value],
      () => {
        var _a;
        if (env.isH5 || !(MessageInputAt == null ? void 0 : MessageInputAt.value) || !((_a = MessageInputAt == null ? void 0 : MessageInputAt.value) == null ? void 0 : _a.style)) {
          return;
        }
        MessageInputAt.value.style.left = position.value.left + "px";
        MessageInputAt.value.style.top = position.value.top - MessageInputAt.value.clientHeight + "px";
      }
    );
    const closeAt = () => {
      showAtList.value = false;
      showMemberList.value = allMemberList.value;
      position.value = {
        left: 0,
        top: 0
      };
    };
    const selectItem = (index2) => {
      var _a;
      if (env.isPC && universalApi.TUIGlobal.selectItem) {
        universalApi.TUIGlobal.selectItem(index2);
      } else {
        if ((_a = showMemberList == null ? void 0 : showMemberList.value) == null ? void 0 : _a.length) {
          const item = showMemberList == null ? void 0 : showMemberList.value[index2];
          emits("insertAt", {
            id: item == null ? void 0 : item.userID,
            label: (item == null ? void 0 : item.nick) || (item == null ? void 0 : item.userID)
          });
        }
      }
      closeAt();
    };
    const handleMemberAvatar = (item) => {
      return (item == null ? void 0 : item.avatar) || "https://web.sdk.qcloud.com/component/TUIKit/assets/avatar_21.png";
    };
    const handleMemberName = (item) => {
      return (item == null ? void 0 : item.nick) ? item == null ? void 0 : item.nick : item == null ? void 0 : item.userID;
    };
    return (_ctx, _cache) => {
      return Vue.openBlock(), Vue.createBlock(index.default, {
        show: Vue.unref(showAtList),
        onOnClose: closeAt
      }, {
        default: Vue.withCtx(() => [
          Vue.createElementVNode("div", {
            ref_key: "MessageInputAt",
            ref: MessageInputAt,
            class: Vue.normalizeClass([Vue.unref(env.isPC) ? "message-input-at" : "message-input-at-h5"])
          }, [
            Vue.createElementVNode("div", _hoisted_1, [
              !Vue.unref(env.isPC) ? (Vue.openBlock(), Vue.createElementBlock("header", _hoisted_2, [
                Vue.createElementVNode("span", _hoisted_3, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.选择提醒的人")), 1)
              ])) : Vue.createCommentVNode("", true),
              Vue.createElementVNode("ul", _hoisted_4, [
                (Vue.openBlock(true), Vue.createElementBlock(Vue.Fragment, null, Vue.renderList(Vue.unref(showMemberList), (item, index2) => {
                  return Vue.openBlock(), Vue.createElementBlock("li", {
                    key: index2,
                    ref_for: true,
                    ref_key: "memberListItems",
                    ref: memberListItems,
                    class: Vue.normalizeClass(["member-list-box-body", [index2 === Vue.unref(selectedIndex) && "selected"]]),
                    onClick: ($event) => selectItem(index2)
                  }, [
                    Vue.createElementVNode("img", {
                      class: "member-list-box-body-avatar",
                      src: handleMemberAvatar(item)
                    }, null, 8, _hoisted_6),
                    Vue.createElementVNode("span", _hoisted_7, Vue.toDisplayString(handleMemberName(item)), 1)
                  ], 10, _hoisted_5);
                }), 128))
              ])
            ], 512)
          ], 2)
        ]),
        _: 1
      }, 8, ["show"]);
    };
  }
});
exports.default = _sfc_main;
