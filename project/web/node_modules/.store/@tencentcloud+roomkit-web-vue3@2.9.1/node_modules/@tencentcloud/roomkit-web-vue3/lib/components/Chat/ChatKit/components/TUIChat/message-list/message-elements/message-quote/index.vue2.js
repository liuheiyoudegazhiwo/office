"use strict";
Object.defineProperties(exports, { __esModule: { value: true }, [Symbol.toStringTag]: { value: "Module" } });
const Vue = require("vue");
require("../../../../../adapter-vue.js");
const TUIChatEngine = require("@tencentcloud/chat-uikit-engine");
const universalApi = require("@tencentcloud/universal-api");
const env = require("../../../../../utils/env.js");
const index$1 = require("../../../../common/Toast/index.js");
const _interface = require("./interface.js");
const index = require("../../../emoji-config/index.js");
const type = require("../../../../common/Toast/type.js");
const _hoisted_1 = {
  key: 0,
  class: "revoked-text"
};
const _hoisted_2 = {
  key: 1,
  class: "max-double-line"
};
const _sfc_main = /* @__PURE__ */ Vue.defineComponent({
  __name: "index",
  props: {
    message: { default: () => ({}) }
  },
  emits: ["scrollTo", "blinkMessage"],
  setup(__props, { emit: __emit }) {
    const emits = __emit;
    const props = __props;
    let selfAddValue = 0;
    const messageQuoteText = Vue.ref("");
    const hasQuoteContent = Vue.ref(false);
    const messageQuoteContent = Vue.ref({});
    const isMessageRevoked = Vue.computed(() => {
      var _a;
      try {
        const cloudCustomData = JSON.parse(((_a = props.message) == null ? void 0 : _a.cloudCustomData) || "{}");
        const quotedMessageModel = TUIChatEngine.TUIStore.getMessageModel(cloudCustomData.messageReply.messageID);
        return quotedMessageModel == null ? void 0 : quotedMessageModel.isRevoked;
      } catch (error) {
        return true;
      }
    });
    Vue.onMounted(() => {
      var _a;
      try {
        const cloudCustomData = JSON.parse(((_a = props.message) == null ? void 0 : _a.cloudCustomData) || "{}");
        hasQuoteContent.value = Boolean(cloudCustomData.messageReply);
        if (hasQuoteContent.value) {
          messageQuoteContent.value = cloudCustomData.messageReply;
          messageQuoteText.value = performQuoteContent(messageQuoteContent.value);
        }
      } catch (error) {
        hasQuoteContent.value = false;
      }
    });
    function performQuoteContent(params) {
      let messageKey = "";
      let quoteContent = "";
      switch (params.messageType) {
        case _interface.MessageQuoteTypeEnum.TYPE_TEXT:
          messageKey = "[文本]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_CUSTOM:
          messageKey = "[自定义消息]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_IMAGE:
          messageKey = "[图片]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_SOUND:
          messageKey = "[音频]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_VIDEO:
          messageKey = "[视频]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_FILE:
          messageKey = "[文件]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_LOCATION:
          messageKey = "[地理位置]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_FACE:
          messageKey = "[动画表情]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_GROUP_TIPS:
          messageKey = "[群提示]";
          break;
        case _interface.MessageQuoteTypeEnum.TYPE_MERGER:
          messageKey = "[聊天记录]";
          break;
        default:
          messageKey = "[消息]";
          break;
      }
      if ([
        _interface.MessageQuoteTypeEnum.TYPE_TEXT,
        _interface.MessageQuoteTypeEnum.TYPE_MERGER
      ].includes(params.messageType)) {
        quoteContent = params.messageAbstract;
      }
      return quoteContent ? quoteContent : TUIChatEngine.TUITranslateService.t(`TUIChat.${messageKey}`);
    }
    async function scrollToOriginalMessage() {
      var _a;
      if (isMessageRevoked.value) {
        return;
      }
      const originMessageID = (_a = messageQuoteContent.value) == null ? void 0 : _a.messageID;
      const currentMessageList = TUIChatEngine.TUIStore.getData(TUIChatEngine.StoreName.CHAT, "messageList");
      const isOriginalMessageInScreen = currentMessageList.some((msg) => msg.ID === originMessageID);
      if (originMessageID && isOriginalMessageInScreen) {
        try {
          const scrollViewRect = await universalApi.getBoundingClientRect("#messageScrollList", "messageList");
          const originalMessageRect = await universalApi.getBoundingClientRect("#tui-" + originMessageID, "messageList");
          const { scrollTop } = await universalApi.getScrollInfo("#messageScrollList", "messageList");
          const finalScrollTop = originalMessageRect.top + scrollTop - scrollViewRect.top - selfAddValue++ % 2;
          const isNeedScroll = originalMessageRect.top < scrollViewRect.top;
          if (!env.isUniFrameWork && window) {
            const scrollView = document.getElementById("messageScrollList");
            if (isNeedScroll && scrollView) {
              scrollView.scrollTop = finalScrollTop;
            }
          } else if (env.isUniFrameWork && isNeedScroll) {
            emits("scrollTo", finalScrollTop);
          }
          emits("blinkMessage", originMessageID);
        } catch (error) {
          console.error(error);
        }
      } else {
        index$1.Toast({
          message: TUIChatEngine.TUITranslateService.t("TUIChat.无法定位到原消息"),
          type: type.default.WARNING
        });
      }
    }
    return (_ctx, _cache) => {
      return Vue.unref(hasQuoteContent) ? (Vue.openBlock(), Vue.createElementBlock("div", {
        key: 0,
        class: Vue.normalizeClass({
          "reference-content": true,
          "reverse": _ctx.message.flow === "out"
        }),
        onClick: scrollToOriginalMessage
      }, [
        Vue.unref(isMessageRevoked) ? (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_1, Vue.toDisplayString(Vue.unref(TUIChatEngine.TUITranslateService).t("TUIChat.引用内容已撤回")), 1)) : (Vue.openBlock(), Vue.createElementBlock("div", _hoisted_2, Vue.toDisplayString(Vue.unref(messageQuoteContent).messageSender) + ": " + Vue.toDisplayString(Vue.unref(index.transformTextWithKeysToEmojiNames)(Vue.unref(messageQuoteText))), 1))
      ], 2)) : Vue.createCommentVNode("", true);
    };
  }
});
exports.default = _sfc_main;
